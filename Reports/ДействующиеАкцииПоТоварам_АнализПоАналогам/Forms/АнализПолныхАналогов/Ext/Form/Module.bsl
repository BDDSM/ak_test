
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ТекДата", НачалоДня(ТекущаяДата()));
	Запрос.Текст = "ВЫБРАТЬ
	               |	АналогиНоменклатурыТовары.Номенклатура,
	               |	АналогиНоменклатурыТовары.Ссылка КАК АналогиСсылка
	               |ПОМЕСТИТЬ ВТ_ТоварыАналогов
	               |ИЗ
	               |	Справочник.АналогиНоменклатуры.Товары КАК АналогиНоменклатурыТовары
	               |ГДЕ
	               |	АналогиНоменклатурыТовары.Ссылка.ПолностьюЗаменяемыйТовар = ИСТИНА
	               |	И АналогиНоменклатурыТовары.Номенклатура.ПометкаУдаления = ЛОЖЬ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ВТ_ТоварыАналогов.АналогиСсылка КАК АналогиСсылка,
	               |	ЕСТЬNULL(НоменклатураАкции.ДатаНачала, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаНачала,
	               |	ЕСТЬNULL(НоменклатураАкции.ДатаОкончания, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаОкончания,
	               |	ЕСТЬNULL(НоменклатураАкции.ПриПокупкеШтук, -1) КАК ПриПокупкеШтук,
	               |	ЕСТЬNULL(НоменклатураАкции.ДействуетЦена_Скидка, -1) КАК ДействуетЦена_Скидка
	               |ИЗ
	               |	ВТ_ТоварыАналогов КАК ВТ_ТоварыАналогов
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.Акции КАК НоменклатураАкции
	               |		ПО ВТ_ТоварыАналогов.Номенклатура = НоменклатураАкции.Ссылка
	               |			И (НоменклатураАкции.ДатаОкончания >= &ТекДата)
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	АналогиСсылка";
	
	Результаты = Запрос.ВыполнитьПакет();
	
	ВыборкаАналоги = Результаты[1].Выбрать();
	Пока ВыборкаАналоги.СледующийПоЗначениюПоля("АналогиСсылка") Цикл
		Счетчик = 0;
		Пока ВыборкаАналоги.Следующий() Цикл
			Счетчик = Счетчик + 1;
		КонецЦикла;
		Если Счетчик > 1 Тогда
			СтрокаДоб = ТабАналоги.Добавить();
			СтрокаДоб.Аналог = ВыборкаАналоги.АналогиСсылка;
		КонецЕсли;	
	КонецЦикла;	
	
КонецПроцедуры
