
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	СтандартнаяОбработка=Ложь;	

	СтрокаПодключения = ПолныеПрава.ПолучитьСтрокуПодключения_Бух();
	
	v82COMОбъект = Новый COMОбъект(ПолныеПрава.ПолучитьВерсиюКомОбъекта_Бух() + ".COMConnector");
	Попытка
		v82 = v82COMОбъект.Connect(СтрокаПодключения);
		ПодключениеУстановлено=Истина;
	Исключение
		ПодключениеУстановлено=Ложь;
		Сообщить("Не удалось подключитьс к базе бухгалтерии");
		Возврат;
	КонецПопытки;
	
	Запрос=v82.NewObject("Запрос");  
	
	
	КомпоновщикНастроек.ЗагрузитьНастройки(КомпоновщикНастроек.ПолучитьНастройки());
	Для каждого Параметр из КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы Цикл
		Если СокрЛП(Параметр.Параметр)="ПериодОтчета" Тогда
			Запрос.УстановитьПараметр("ДатаС",Параметр.Значение.ДатаНачала);
			Запрос.УстановитьПараметр("ДатаПо",Параметр.Значение.ДатаОкончания);
			Прервать;
		КонецЕсли;
	КонецЦикла;	
    	
	     ТекстЗапроса="ВЫБРАТЬ
                  |	ВЫБОР
                  |		КОГДА ХозрасчетныйОборотыДтКт.СчетКт.Родитель = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
                  |			ТОГДА ХозрасчетныйОборотыДтКт.СчетКт
                  |		ИНАЧЕ ХозрасчетныйОборотыДтКт.СчетКт.Родитель
                  |	КОНЕЦ КАК КоррСчет,
                  |	ХозрасчетныйОборотыДтКт.СуммаОборот КАК БухСуммаОборот,
                  |	ХозрасчетныйОборотыДтКт.Организация КАК Организация,
                  |	ХозрасчетныйОборотыДтКт.Регистратор,
                  |	""В дебет"" КАК ВидКорреспонденции,
                  |	0 КАК БухНачОст,
                  |	0 КАК БухКонОст,
                  |	ХозрасчетныйОборотыДтКт.СубконтоДт1.НомерСчета КАК НомерСчета,
                  |	ХозрасчетныйОборотыДтКт.СубконтоДт3.Код КАК КодФизЛица,
                  |	ХозрасчетныйОборотыДтКт.СубконтоДт3.Наименование КАК НаименованиеФизЛица
                  |ПОМЕСТИТЬ Выборка
                  |ИЗ
                  |	РегистрБухгалтерии.Хозрасчетный.ОборотыДтКт(&ДатаС, &ДатаПо, Регистратор, СчетДт = &Счет55_04, , , , ) КАК ХозрасчетныйОборотыДтКт
                  |
				  |СГРУППИРОВАТЬ ПО
				  |	ХозрасчетныйОборотыДтКт.СуммаОборот,
				  |	ХозрасчетныйОборотыДтКт.Организация,
				  |	ХозрасчетныйОборотыДтКт.Регистратор,
				  |	ВЫБОР
				  |		КОГДА ХозрасчетныйОборотыДтКт.СчетКт.Родитель = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
				  |			ТОГДА ХозрасчетныйОборотыДтКт.СчетКт
				  |		ИНАЧЕ ХозрасчетныйОборотыДтКт.СчетКт.Родитель
				  |	КОНЕЦ,
				  |	ХозрасчетныйОборотыДтКт.СубконтоДт1.НомерСчета,
				  |	ХозрасчетныйОборотыДтКт.СубконтоДт3.Код,
				  |	ХозрасчетныйОборотыДтКт.СубконтоДт3.Наименование
                  |
                  |ОБЪЕДИНИТЬ ВСЕ
                  |
                  |ВЫБРАТЬ
                  |	ВЫБОР
                  |		КОГДА ХозрасчетныйОборотыДтКт.СчетДт.Родитель = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
                  |			ТОГДА ХозрасчетныйОборотыДтКт.СчетДт
                  |		ИНАЧЕ ХозрасчетныйОборотыДтКт.СчетДт.Родитель
                  |	КОНЕЦ,
                  |	-ХозрасчетныйОборотыДтКт.СуммаОборот,
                  |	ХозрасчетныйОборотыДтКт.Организация,
                  |	ХозрасчетныйОборотыДтКт.Регистратор,
                  |	""В кредит"",
                  |	0,
                  |	0,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт1.НомерСчета,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт3.Код,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт3.Наименование
                  |ИЗ
                  |	РегистрБухгалтерии.Хозрасчетный.ОборотыДтКт(&ДатаС, &ДатаПо, Регистратор, , , СчетКт = &Счет55_04, , ) КАК ХозрасчетныйОборотыДтКт
                  |
                  |СГРУППИРОВАТЬ ПО
                  |	-ХозрасчетныйОборотыДтКт.СуммаОборот,
                  |	ХозрасчетныйОборотыДтКт.Регистратор,
                  |	ВЫБОР
                  |		КОГДА ХозрасчетныйОборотыДтКт.СчетДт.Родитель = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПустаяСсылка)
                  |			ТОГДА ХозрасчетныйОборотыДтКт.СчетДт
                  |		ИНАЧЕ ХозрасчетныйОборотыДтКт.СчетДт.Родитель
                  |	КОНЕЦ,
                  |	ХозрасчетныйОборотыДтКт.Организация,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт1.НомерСчета,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт3.Код,
                  |	ХозрасчетныйОборотыДтКт.СубконтоКт3.Наименование
                  |
                  |ОБЪЕДИНИТЬ ВСЕ
                  |
                  |ВЫБРАТЬ
                  |	NULL,
                  |	0,
                  |	ХозрасчетныйОстатки.Организация,
                  |	NULL,
                  |	""Остатки"",
                  |	ХозрасчетныйОстатки.СуммаОстаток,
                  |	0,
                  |	ХозрасчетныйОстатки.Субконто1.НомерСчета,
                  |	ХозрасчетныйОстатки.Субконто3.Код,
                  |	ХозрасчетныйОстатки.Субконто3.Наименование
                  |ИЗ
                  |	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаС, Счет = &Счет55_04, , ) КАК ХозрасчетныйОстатки
                  |
                  |ОБЪЕДИНИТЬ ВСЕ
                  |
                  |ВЫБРАТЬ
                  |	NULL,
                  |	0,
                  |	ХозрасчетныйОстатки.Организация,
                  |	NULL,
                  |	""Остатки"",
                  |	0,
                  |	ХозрасчетныйОстатки.СуммаОстаток,
                  |	ХозрасчетныйОстатки.Субконто1.НомерСчета,
                  |	ХозрасчетныйОстатки.Субконто3.Код,
                  |	ХозрасчетныйОстатки.Субконто3.Наименование
                  |ИЗ
                  |	РегистрБухгалтерии.Хозрасчетный.Остатки(ДОБАВИТЬКДАТЕ(&ДатаПо, СЕКУНДА, 1), Счет = &Счет55_04, , ) КАК ХозрасчетныйОстатки
                  |;
                  |
                  |////////////////////////////////////////////////////////////////////////////////
                  |ВЫБРАТЬ
                  |	Выборка.КоррСчет.Код КАК КоррСчет,
                  |	СУММА(Выборка.БухСуммаОборот) КАК БухСуммаОборот,
                  |	Выборка.Организация.ИНН КАК ИНН_Организации,
                  |	ПРЕДСТАВЛЕНИЕ(Выборка.Регистратор) КАК Регистратор,
                  //|	Выборка.ВидКорреспонденции,
                  |	СУММА(Выборка.БухНачОст) КАК БухНачОст,
                  |	СУММА(Выборка.БухКонОст) КАК БухКонОст,
                  |	Выборка.НомерСчета,
                  |	Выборка.КодФизЛица,
                  |	Выборка.НаименованиеФизЛица
                  |ИЗ
                  |	Выборка КАК Выборка
                  |
                  |СГРУППИРОВАТЬ ПО
                  |	Выборка.КоррСчет,
                  |	Выборка.Организация,
                  //|	Выборка.ВидКорреспонденции,
                  |	Выборка.КоррСчет.Код,
                  |	Выборка.Организация.ИНН,
                  |	Выборка.НомерСчета,
                  |	Выборка.КодФизЛица,
                  |	Выборка.НаименованиеФизЛица,
                  |	ПРЕДСТАВЛЕНИЕ(Выборка.Регистратор)";

	
	Запрос.Текст=ТекстЗапроса;

	Запрос.УстановитьПараметр("Счет55_04",v82.ПланыСчетов.Хозрасчетный.НайтиПоКоду("55.04"));
	
	
	
	Выборка=Запрос.Выполнить().Выбрать();
	
	ДанныеБух=Новый ТаблицаЗначений;
	ДанныеБух.Колонки.Добавить("КоррСчет");
	ДанныеБух.Колонки.Добавить("Организация");
	ДанныеБух.Колонки.Добавить("БухСуммаОборот");
	ДанныеБух.Колонки.Добавить("Регистратор");
	//ДанныеБух.Колонки.Добавить("ВидКорреспонденции");
	ДанныеБух.Колонки.Добавить("БухНачОст");
	ДанныеБух.Колонки.Добавить("БухКонОст");
	ДанныеБух.Колонки.Добавить("НомерСчета");
	ДанныеБух.Колонки.Добавить("КодФизЛица");
	ДанныеБух.Колонки.Добавить("НаименованиеФизЛица");
	ДанныеБух.Колонки.Добавить("БанковскийСчет");
	ДанныеБух.Колонки.Добавить("ФизЛицо");
		
	ТекстЗапроса="ВЫБРАТЬ
	             |	Организации.ИНН,
	             |	Организации.Ссылка
	             |ИЗ
	             |	Справочник.Организации КАК Организации
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ФизическиеЛица.Код,
	             |	ФизическиеЛица.Наименование,
	             |	ФизическиеЛица.Ссылка
	             |ИЗ
	             |	Справочник.ФизическиеЛица КАК ФизическиеЛица
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	БанковскиеСчета.Ссылка,
	             |	БанковскиеСчета.НомерСчета
	             |ИЗ
	             |	Справочник.БанковскиеСчета КАК БанковскиеСчета";
				 //|ГДЕ
				 //|	БанковскиеСчета.Владелец ССЫЛКА Справочник.Организации";
	ЗапросОрг=Новый Запрос(ТекстЗапроса);			 
	Результат=ЗапросОрг.ВыполнитьПакет();
	КэшОрганизаций=Результат[0].Выгрузить();
	КэшФизЛиц=Результат[1].Выгрузить();
	КэшСчетов=Результат[2].Выгрузить();
	
	Пока Выборка.Следующий() Цикл
		НС=ДанныеБух.Добавить();
		ЗаполнитьЗначенияСвойств(НС, Выборка);
		Нашли=КэшОрганизаций.Найти(Выборка.ИНН_Организации);
		Если ЗначениеЗаполнено(Нашли) Тогда
			НС.Организация=Нашли.Ссылка;
		Иначе	
			Сообщить("Не нашёл в этой базе Организацию с ИНН "+Выборка.ИНН_Организации);
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(Выборка.КодФизЛица) Тогда
			Нашли=КэшФизЛиц.Найти(Выборка.КодФизЛица,"Код");
			Если ЗначениеЗаполнено(Нашли) Тогда
				НС.ФизЛицо=Нашли.Ссылка;
			Иначе	
				Нашли=КэшФизЛиц.Найти(Выборка.НаименованиеФизЛица,"Наименование");
				Если ЗначениеЗаполнено(Нашли) Тогда
					НС.ФизЛицо=Нашли.Ссылка;
				Иначе	
					Сообщить("Не нашёл в этой базе физлицо "+Выборка.НаименованиеФизЛица);
				КонецЕсли;	
			КонецЕсли;	
		Иначе
			НС.ФизЛицо = Справочники.ФизическиеЛица.ПустаяСсылка();
		КонецЕсли;	
		Нашли=КэшСчетов.Найти(Выборка.НомерСчета);
		Если ЗначениеЗаполнено(Нашли) Тогда
			НС.БанковскийСчет=Нашли.Ссылка;
		Иначе	
			Сообщить("Не нашёл в этой базе счет "+Выборка.НомерСчета);
		КонецЕсли;	
	КонецЦикла;	
    		
	//	//Получаем схему из макета
	//СхемаКомпоновкиДанных = ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");

	//Из схемы возьмем настройки по умолчанию
	Настройки = КомпоновщикНастроек.Настройки;

	//Помещаем в переменную данные о расшифровке данных
	ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;

	//Формируем макет, с помощью компоновщика макета
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;

	//Передаем в макет компоновки схему, настройки и данные расшифровки
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных,
	                                        Настройки, ДанныеРасшифровки);

	ВнешниеНаборыДанных=Новый Структура;

	ВнешниеНаборыДанных.Вставить("ДанныеБух",ДанныеБух);										
											
	//Выполним компоновку с помощью процессора компоновки
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки,ВнешниеНаборыДанных,
	                                                   ДанныеРасшифровки);

	//Очищаем поле табличного документа

	//Выводим результат в табличный документ
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);

	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);

	

КонецПроцедуры
