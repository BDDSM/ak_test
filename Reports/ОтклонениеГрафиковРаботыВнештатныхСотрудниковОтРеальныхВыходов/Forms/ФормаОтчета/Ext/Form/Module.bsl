
&НаСервере
Процедура СформироватьОтчетВТаблицу()
	
	//Макет компоновки 
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(Отчеты.ОтклонениеГрафиковРаботыВнештатныхСотрудниковОтРеальныхВыходов.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных")
													, Отчет.КомпоновщикНастроек.ПолучитьНастройки(),,,Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
	
	//Компоновка данных
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки);
	
	//Вывод результата
	ТабРезультат = Новый ТаблицаЗначений();
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	ПроцессорВывода.УстановитьОбъект(ТабРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
	Если ТабРезультат.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;	
	
	МассивТТ = Новый Массив();
	МинДата = '39990101';
	МаксДата = '00010101';
	Для Каждого СтрокаТаб Из ТабРезультат Цикл
		МинДата = Мин(СтрокаТаб.Период, МинДата);
		МаксДата = Макс(СтрокаТаб.Период, МаксДата);
		Если ЗначениеЗаполнено(СтрокаТаб.ТТ_Гр) Тогда
			МассивТТ.Добавить(СтрокаТаб.ТТ_Гр);
		ИначеЕсли ЗначениеЗаполнено(СтрокаТаб.ТТ_ЛУ) Тогда
			МассивТТ.Добавить(СтрокаТаб.ТТ_ЛУ);	
		КонецЕсли;	
	КонецЦикла;
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЛистУчета.Ссылка,
	               |	НАЧАЛОПЕРИОДА(ЛистУчета.Дата, ДЕНЬ) КАК Дата,
	               |	ЛистУчета.ТорговаяТочка
	               |ИЗ
	               |	Документ.ЛистУчета КАК ЛистУчета
	               |ГДЕ
	               |	ЛистУчета.Проведен = ИСТИНА
	               |	И НАЧАЛОПЕРИОДА(ЛистУчета.Дата, ДЕНЬ) МЕЖДУ &ДатаНач И &ДатаКон
	               |	И ЛистУчета.ТорговаяТочка В(&МассивТТ)";
				   
	Запрос.УстановитьПараметр("ДатаНач", НачалоДня(МинДата));
	Запрос.УстановитьПараметр("ДатаКон", КонецДня(МаксДата));
	Запрос.УстановитьПараметр("МассивТТ", МассивТТ);
	ТабКеш = Запрос.Выполнить().Выгрузить();
	Для Каждого СтрокаТаб Из ТабРезультат Цикл
		СтрокаДоб = ТаблицаКЗаписи.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаДоб, СтрокаТаб);
		//СтрокаДоб.Записать = Истина;
		СтрокиКеш = Новый Массив();
		Если ЗначениеЗаполнено(СтрокаТаб.ТТ_Гр) Тогда
			СтрокиКеш = ТабКеш.НайтиСтроки(Новый Структура("Дата, ТорговаяТочка", СтрокаТаб.Период, СтрокаТаб.ТТ_Гр));
		ИначеЕсли ЗначениеЗаполнено(СтрокаТаб.ТТ_ЛУ) Тогда
			СтрокиКеш = ТабКеш.НайтиСтроки(Новый Структура("Дата, ТорговаяТочка", СтрокаТаб.Период, СтрокаТаб.ТТ_ЛУ));
		КонецЕсли;
		Если СтрокиКеш.Количество() > 0 Тогда
			СтрокаДоб.ЛистУчета = СтрокиКеш[0].Ссылка;
		КонецЕсли;	
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	
	ТаблицаКЗаписи.Очистить();
	СформироватьОтчетВТаблицу();
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДанными(Команда)
	
	//ТаблицаКЗаписи.Очистить();
	//СформироватьОтчетВТабДок();
	СкомпоноватьРезультат();
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьФлажки(Команда)
	
	Для Каждого СтрокаТаб Из ТаблицаКЗаписи Цикл
		СтрокаТаб.Записать = Ложь;
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьФлажки(Команда)
	
	Для Каждого СтрокаТаб Из ТаблицаКЗаписи Цикл
		СтрокаТаб.Записать = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьДанныеВЛистыСервер()
	
	УстановитьПривилегированныйРежим(Истина);
	
	//ТабЗначений = РеквизитФормыВЗначение("ТаблицаКЗаписи");
	ТабЗначений = ТаблицаКЗаписи.Выгрузить();
	КолвоСтрок = ТабЗначений.Количество();
	Для н = 1 По КолвоСтрок Цикл
		Если ТабЗначений[КолвоСтрок - н].Записать = Ложь
			ИЛИ НЕ ЗначениеЗаполнено(ТабЗначений[КолвоСтрок - н].ЛистУчета) Тогда
			ТабЗначений.Удалить(КолвоСтрок - н);
		КонецЕсли;	
	КонецЦикла;	
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	Таб.ЛистУчета,
	               |	Таб.Сотрудник,
				   |	Таб.ТТ_Гр,
	               |	Таб.КоличествоЧасов_Гр
	               |ПОМЕСТИТЬ ВТ_Данные
	               |ИЗ
	               |	&Таб КАК Таб
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВТ_Данные.ЛистУчета КАК ЛистУчета,
	               |	ВТ_Данные.Сотрудник,
				   |	ВТ_Данные.ТТ_Гр,
	               |	ВТ_Данные.КоличествоЧасов_Гр
	               |ИЗ
	               |	ВТ_Данные КАК ВТ_Данные
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ЛистУчета
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВТ_Данные";
				   
	Запрос.УстановитьПараметр("Таб", ТабЗначений);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.СледующийПоЗначениюПоля("ЛистУчета") Цикл
		ДокОбъект = Выборка.ЛистУчета.ПолучитьОбъект();
		ТабПродавцы = ДокОбъект.ВнештатныеСотрудники.Выгрузить();
		Пока Выборка.Следующий() Цикл
			СтрокаТаб = ТабПродавцы.Найти(Выборка.Сотрудник, "Сотрудник");
			Если НЕ ЗначениеЗаполнено(Выборка.ТТ_Гр) Тогда
				Если СтрокаТаб <> Неопределено Тогда
					ТабПродавцы.Удалить(СтрокаТаб);
				КонецЕсли;	
			Иначе	
				Если СтрокаТаб = Неопределено Тогда
					СтрокаТаб = ТабПродавцы.Добавить();
					СтрокаТаб.Сотрудник = Выборка.Сотрудник;
				КонецЕсли;
				Если СтрокаТаб <> Неопределено Тогда
					СтрокаТаб.КоличествоЧасов = Выборка.КоличествоЧасов_Гр;
				КонецЕсли;	
			КонецЕсли;	
		КонецЦикла;
		ДокОбъект.ВнештатныеСотрудники.Загрузить(ТабПродавцы);
		ДокОбъект.ДополнительныеСвойства.Вставить("ВыполняетсяЗаписьТолькоПродавцов", Истина);
		ДокОбъект.Записать(РежимЗаписиДокумента.Запись);
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьДанныеВЛисты(Команда)
	
	Ответ = Вопрос("Записать отмеченные строки в листы учета?", РежимДиалогаВопрос.ДаНет, 120, КодВозвратаДиалога.Да);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;	
	
	ЗаписатьДанныеВЛистыСервер();
	ТаблицаКЗаписи.Очистить();
	СформироватьОтчетВТаблицу();
	
КонецПроцедуры


