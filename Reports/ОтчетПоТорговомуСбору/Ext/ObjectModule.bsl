
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА ГОД(ФинансовыйДвиженияССубконто.Период) > 2016
		|			ТОГДА ФинансовыйДвиженияССубконто.Организация
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ФинансовыйДвиженияССубконто.СчетКт = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|					ТОГДА ФинансовыйДвиженияССубконто.СубконтоКт1
		|				ИНАЧЕ ФинансовыйДвиженияССубконто.СубконтоДт1
		|			КОНЕЦ
		|	КОНЕЦ КАК Организация,
		|	ФинансовыйДвиженияССубконто.Регистратор КАК Документ,
		|	ВЫБОР
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.РасходИзБанка
		|			ТОГДА ПОДСТРОКА(ФинансовыйДвиженияССубконто.Регистратор.ПоказательПериода, 7, 1) + "" "" + ПОДСТРОКА(ФинансовыйДвиженияССубконто.Регистратор.ПоказательПериода, 8, 3)
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.НачислениеТорговогоСбора
		|			ТОГДА ГОД(ФинансовыйДвиженияССубконто.Регистратор.КварталОбработки)
		|	КОНЕЦ КАК Год,
		|	ВЫБОР
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.РасходИзБанка
		|			ТОГДА ПОДСТРОКА(ФинансовыйДвиженияССубконто.Регистратор.ПоказательПериода, 5, 1)
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.НачислениеТорговогоСбора
		|			ТОГДА КВАРТАЛ(ФинансовыйДвиженияССубконто.Регистратор.КварталОбработки)
		|	КОНЕЦ КАК Квартал,
		|	ВЫБОР
		|		КОГДА ФинансовыйДвиженияССубконто.СчетКт = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|			ТОГДА ФинансовыйДвиженияССубконто.СубконтоКт2
		|		ИНАЧЕ ФинансовыйДвиженияССубконто.СубконтоДт2
		|	КОНЕЦ КАК ВидНалога,
		|	ФинансовыйДвиженияССубконто.Сумма,
		|	ВЫБОР
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.РасходИзБанка
		|			ТОГДА ВЫБОР
		|					КОГДА ФинансовыйДвиженияССубконто.Регистратор.КодОКТМО ЕСТЬ NULL
		|						ТОГДА ФинансовыйДвиженияССубконто.Регистратор.КодОКАТО
		|					ИНАЧЕ ФинансовыйДвиженияССубконто.Регистратор.КодОКТМО
		|				КОНЕЦ
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ФинансовыйДвиженияССубконто.СубконтоДт1 ССЫЛКА Справочник.СтруктурныеЕдиницы
		|					ТОГДА ФинансовыйДвиженияССубконто.СубконтоДт1.ОКТМО
		|			КОНЕЦ
		|	КОНЕЦ КАК ОКТМО,
		|	ВЫБОР
		|		КОГДА ФинансовыйДвиженияССубконто.Регистратор ССЫЛКА Документ.РасходИзБанка
		|			ТОГДА ФинансовыйДвиженияССубконто.Регистратор.Комментарий
		|		ИНАЧЕ ФинансовыйДвиженияССубконто.Содержание
		|	КОНЕЦ КАК Содержание,
		|	ФинансовыйДвиженияССубконто.СчетКт КАК КорСчет
		|ПОМЕСТИТЬ втДанные
		|ИЗ
		|	РегистрБухгалтерии.Финансовый.ДвиженияССубконто(
		|			&ДатаНачала,
		|			&ДатаОкончания,
		|			Субконто2 В (&ВидыНалогов)
		|				И Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН),
		|			,
		|			) КАК ФинансовыйДвиженияССубконто
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втДанные.Документ,
		|	втДанные.Год,
		|	втДанные.Квартал КАК Квартал,
		|	""Не заполнено     "" КАК ПериодРасчетов,
		|	0 КАК ГодЧисло,
		|	0 КАК КварталЧисло,
		|	втДанные.ОКТМО,
		|	ВЫБОР
		|		КОГДА втДанные.КорСчет <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|			ТОГДА втДанные.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Оплата,
		|	ВЫБОР
		|		КОГДА втДанные.КорСчет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|			ТОГДА втДанные.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Начисление,
		|	ВЫБОР
		|		КОГДА втДанные.КорСчет <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|			ТОГДА втДанные.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ - ВЫБОР
		|		КОГДА втДанные.КорСчет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН)
		|			ТОГДА втДанные.Сумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Разница,
		|	втДанные.ВидНалога,
		|	втДанные.Содержание,
		|	втДанные.КорСчет,
		|	втДанные.Организация
		|ИЗ
		|	втДанные КАК втДанные";
	
	
	
	
	//Запрос = Новый Запрос;
	//Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	ФинансовыйОбороты.Субконто2 КАК ВидНалога,
	//	|	ФинансовыйОбороты.КорСчет,
	//	|	ВЫБОР
	//	|		КОГДА ФинансовыйОбороты.Регистратор ССЫЛКА Документ.РасходИзБанка
	//	|			ТОГДА ФинансовыйОбороты.Регистратор.КодОКТМО
	//	|		ИНАЧЕ ВЫБОР
	//	|				КОГДА ФинансовыйОбороты.КорСубконто1 ССЫЛКА Справочник.СтруктурныеЕдиницы
	//	|					ТОГДА ФинансовыйОбороты.КорСубконто1.ОКТМО
	//	|			КОНЕЦ
	//	|	КОНЕЦ КАК ОКТМО,
	//	|	ФинансовыйОбороты.Организация,
	//	|	ФинансовыйОбороты.СуммаОборот,
	//	|	ФинансовыйОбороты.Регистратор КАК Документ,
	//	|	ВЫБОР
	//	|		КОГДА ФинансовыйОбороты.Регистратор ССЫЛКА Документ.РасходИзБанка
	//	|			ТОГДА ПОДСТРОКА(ФинансовыйОбороты.Регистратор.ПоказательПериода, 7, 1) + "" "" + ПОДСТРОКА(ФинансовыйОбороты.Регистратор.ПоказательПериода, 8, 3)
	//	|		КОГДА ФинансовыйОбороты.Регистратор ССЫЛКА Документ.НачислениеТорговогоСбора
	//	|			ТОГДА ГОД(ФинансовыйОбороты.Регистратор.КварталОбработки)
	//	|	КОНЕЦ КАК Год,
	//	|	ВЫБОР
	//	|		КОГДА ФинансовыйОбороты.Регистратор ССЫЛКА Документ.РасходИзБанка
	//	|			ТОГДА ПОДСТРОКА(ФинансовыйОбороты.Регистратор.ПоказательПериода, 5, 1)
	//	|		КОГДА ФинансовыйОбороты.Регистратор ССЫЛКА Документ.НачислениеТорговогоСбора
	//	|			ТОГДА КВАРТАЛ(ФинансовыйОбороты.Регистратор.КварталОбработки)
	//	|	КОНЕЦ КАК Квартал
	//	|ПОМЕСТИТЬ втДанные
	//	|ИЗ
	//	|	РегистрБухгалтерии.Финансовый.Обороты(&ДатаНачала, &ДатаОкончания, Авто, Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.НалогиУН), , Субконто2 В (&ВидыНалогов), , ) КАК ФинансовыйОбороты
	//	|;
	//	|
	//	|////////////////////////////////////////////////////////////////////////////////
	//	|ВЫБРАТЬ
	//	|	втДанные.ВидНалога,
	//	|	втДанные.КорСчет,
	//	|	втДанные.ОКТМО,
	//	|	втДанные.Организация,
	//	|	втДанные.Документ,
	//	|	ВЫБОР
	//	|		КОГДА втДанные.СуммаОборот < 0
	//	|			ТОГДА -втДанные.СуммаОборот
	//	|	КОНЕЦ КАК Начисление,
	//	|	ВЫБОР
	//	|		КОГДА втДанные.СуммаОборот > 0
	//	|			ТОГДА втДанные.СуммаОборот
	//	|	КОНЕЦ КАК Оплата,
	//	|	втДанные.Год,
	//	|	втДанные.Квартал КАК Квартал,
	//	|	""Не заполнено     "" КАК ПериодРасчетов,
	//	|	0 КАК ГодЧисло,
	//	|	0 КАК КварталЧисло,
	//	|	втДанные.СуммаОборот КАК Разница
	//	|ИЗ
	//	|	втДанные КАК втДанные";
	
	Запрос.УстановитьПараметр("ВидыНалогов", КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ВидыНалогов")).Значение);
	Запрос.УстановитьПараметр("ДатаНачала", КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ДатаНачала")).Значение);
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ДатаОкончания")).Значение));
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Для каждого Строка из Результат Цикл
		
		Если Не ЗначениеЗаполнено(Строка.ОКТМО) Тогда
			если ТипЗнч(Строка.Документ) = Тип("ДокументСсылка.РасходИзБанка") Тогда
				если ЗначениеЗаполнено(Строка.Документ.КодОКАТО) Тогда
					Строка.ОКТМО = Строка.Документ.КодОКАТО;
				КонецЕсли;
			КонецЕсли;
			Если Не ЗначениеЗаполнено(Строка.ОКТМО) Тогда
				Строка.ОКТМО = НайтиВСтрокеОКТМО(Строка.Содержание);
			КонецЕсли;	
		КонецЕсли;	
		Если ЗначениеЗаполнено(Строка.Квартал) Тогда
			
			Если ТипЗнч(Строка.Год) = Тип("Строка") И ТипЗнч(Строка.Квартал) = Тип("Строка") Тогда
				Год = СтрЗаменить(Строка.Год,Символы.НПП,"");
				Год = СтрЗаменить(Год," ","");
				Строка.ПериодРасчетов = Год  +" квартал "+  Строка.Квартал;	
			Иначе
				Год = СтрЗаменить(Строка.Год,Символы.НПП,"");
				Год = СтрЗаменить(Год," ","");
				Строка.ПериодРасчетов = Год +" квартал " +  Строка(Строка.Квартал);			
			КонецЕсли;
			Строка.ГодЧисло = Число(Год);
			Строка.КварталЧисло = Число(Строка.Квартал);
			
		Иначе
			Строка.ПериодРасчетов = "Не заполнено";
			Строка.ГодЧисло = 0;
			Строка.КварталЧисло = 0;

		КонецЕсли;	
	КонецЦикла;	
	Результат.Сортировать("ГодЧисло УБЫВ, КварталЧисло УБЫВ");
	
	СтандартнаяОбработка = Ложь;
	//
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("ТаблицаДанные", Результат);
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, КомпоновщикНастроек.ПолучитьНастройки(), ДанныеРасшифровки);
	
	//Компоновка данных
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);

	ПроцессорВывода.Вывести(ПроцессорКомпоновки);	
	
	
КонецПроцедуры


Функция НайтиВСтрокеОКТМО(Строка) 
	
   МассивЧисел = Новый Массив; 
   СтрокаЧисел = "";

	Для Индекс = 1 По СтрДлина(Строка) Цикл
   
		Символ = Сред(Строка, Индекс, 1); 
		
		Если КодСимвола(Символ) >= 48 И КодСимвола(Символ) <= 57 Тогда 
			СтрокаЧисел = СтрокаЧисел + Символ;
		ИначеЕсли СтрДлина(СтрокаЧисел) > 0 Тогда
			МассивЧисел.Добавить(СтрокаЧисел);
			
			СтрокаЧисел = "";
		КонецЕсли;
	  
	КонецЦикла;
	
	Если СтрокаЧисел <> "" Тогда
		МассивЧисел.Добавить(СтрокаЧисел );				  
	КонецЕсли;
		

	Для каждого элемент из МассивЧисел Цикл
				
		Если СтрДлина(элемент) = 8 Тогда
			Возврат элемент;
			
		КонецЕсли;
		
	КонецЦикла;	
	
	Возврат "";

КонецФункции