
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ПериодРассылки.ДатаНачала = Параметры.ДатаНачала;
	ПериодРассылки.ДатаОкончания = Параметры.ДатаОкончания;		
	СпособФормирования = "МаксимальныйРасход";
	СформироватьТаблицуРассылки();
	
КонецПроцедуры

Процедура СформироватьТаблицуРассылки()
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РасходыНаМобильнуюСвязьОбороты.СимКарта КАК СимКарта,
		|	РасходыНаМобильнуюСвязьОбороты.Оператор,
		|	РасходыНаМобильнуюСвязьОбороты.ПериодМесяц КАК ПериодМесяц,
		|	ВЫБОР
		|		КОГДА ПривязкаТелефоновСрезПоследних.Номер ЕСТЬ NULL
		|			ТОГДА ""Неопределено""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаТелефоновСрезПоследних.Привязка ЕСТЬ NULL
		|					ТОГДА ""Привязка не установлена""
		|				ИНАЧЕ ПривязкаТелефоновСрезПоследних.Привязка
		|			КОНЕЦ
		|	КОНЕЦ КАК Привязка,
		|	ВЫБОР
		|		КОГДА ПривязкаТелефоновСрезПоследних.Номер ЕСТЬ NULL
		|			ТОГДА ""Сим-карта не зарегистрирована""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаТелефоновСрезПоследних.Назначение ЕСТЬ NULL
		|					ТОГДА ""Назначение не указано""
		|				ИНАЧЕ ПривязкаТелефоновСрезПоследних.Назначение
		|			КОНЕЦ
		|	КОНЕЦ КАК Назначение,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот КАК АбонентскаяПлата,
		|	РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот КАК МобильнаяСвязь,
		|	РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот КАК SMSMMS,
		|	РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот КАК Интернет,
		|	РасходыНаМобильнуюСвязьОбороты.РоумингОборот КАК Роуминг,
		|	РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот КАК ДополнительныеУслуги,
		|	РасходыНаМобильнуюСвязьОбороты.СкидкаОборот КАК Скидка,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот + РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот + РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот + РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот + РасходыНаМобильнуюСвязьОбороты.РоумингОборот + РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот - РасходыНаМобильнуюСвязьОбороты.СкидкаОборот КАК Итого,
		|	ЛОЖЬ КАК СопоставленаПриФормировании,
		|	ИСТИНА КАК Сопоставлена
		|ПОМЕСТИТЬ втРезультат
		|ИЗ
		|	РегистрНакопления.РасходыНаМобильнуюСвязь.Обороты(&ДатаНачала, &ДатаОкончания, Авто, СимКарта ССЫЛКА Справочник.СлужебныеSIMКарты) КАК РасходыНаМобильнуюСвязьОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаТелефонов.СрезПоследних(&ДатаОкончания, ) КАК ПривязкаТелефоновСрезПоследних
		|		ПО РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаТелефоновСрезПоследних.Номер
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ПривязкаПоКоду.Ссылка, РасходыНаМобильнуюСвязьОбороты.СимКарта),
		|	РасходыНаМобильнуюСвязьОбороты.Оператор,
		|	РасходыНаМобильнуюСвязьОбороты.ПериодМесяц,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ""Неопределено""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаПоКоду.Привязка ЕСТЬ NULL
		|					ТОГДА ""Привязка не установлена""
		|				ИНАЧЕ ПривязкаПоКоду.Привязка
		|			КОНЕЦ
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ""Сим-карта не зарегистрирована""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаПоКоду.Назначение ЕСТЬ NULL
		|					ТОГДА ""Назначение не указано""
		|				ИНАЧЕ ПривязкаПоКоду.Назначение
		|			КОНЕЦ
		|	КОНЕЦ,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот,
		|	РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот,
		|	РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот,
		|	РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот,
		|	РасходыНаМобильнуюСвязьОбороты.РоумингОборот,
		|	РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот,
		|	РасходыНаМобильнуюСвязьОбороты.СкидкаОборот,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот + РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот + РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот + РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот + РасходыНаМобильнуюСвязьОбороты.РоумингОборот + РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот - РасходыНаМобильнуюСвязьОбороты.СкидкаОборот,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ,
		|	ЛОЖЬ
		|ИЗ
		|	РегистрНакопления.РасходыНаМобильнуюСвязь.Обороты(&ДатаНачала, &ДатаОкончания, Авто, НЕ СимКарта ССЫЛКА Справочник.СлужебныеSIMКарты) КАК РасходыНаМобильнуюСвязьОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СлужебныеSIMКарты.Ссылка КАК Ссылка,
		|			СлужебныеSIMКарты.Код КАК Код11,
		|			ПОДСТРОКА(СлужебныеSIMКарты.Код, 2, 10) КАК Код10,
		|			ПривязкаТелефоновСрезПоследних.Привязка КАК Привязка,
		|			ПривязкаТелефоновСрезПоследних.Назначение КАК Назначение
		|		ИЗ
		|			Справочник.СлужебныеSIMКарты КАК СлужебныеSIMКарты
		|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаТелефонов.СрезПоследних(&ДатаОкончания, ) КАК ПривязкаТелефоновСрезПоследних
		|				ПО СлужебныеSIMКарты.Ссылка = ПривязкаТелефоновСрезПоследних.Номер) КАК ПривязкаПоКоду
		|		ПО (РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаПоКоду.Код11
		|				ИЛИ РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаПоКоду.Код10)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втРезультат.СимКарта) КАК Количество,
		|	СУММА(втРезультат.Итого) КАК Сумма,
		|	ВЫБОР
		|		КОГДА втРезультат.Привязка ССЫЛКА Справочник.ФизическиеЛица
		|			ТОГДА втРезультат.Привязка
		|		ИНАЧЕ СоставСотрудники.Сотрудник
		|	КОНЕЦ КАК Ответственный,
		|	втРезультат.СимКарта
		|ПОМЕСТИТЬ втОбщийРезультат
		|ИЗ
		|	втРезультат КАК втРезультат
		//+++ AK suvv 2018.06.08 ИП-00018376.01
		//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаОкончания, ТипРоли.Код = ""PomoshnikTerrUpravlyushego"") КАК СоответствиеОбъектРольСрезПоследних
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаОкончания, (ТипРоли.Код = ""PomoshnikTerrUpravlyushego"" или ТипРоли.Код = ""PomoshnikStorRozn"")) КАК СоответствиеОбъектРольСрезПоследних
		//--- AK suvv
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				МАКСИМУМ(РолиПользователейСоставРоли.Сотрудник) КАК Сотрудник,
		|				РолиПользователей.Ссылка КАК Ссылка
		|			ИЗ
		|				Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
		|					ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РолиПользователей КАК РолиПользователей
		|					ПО РолиПользователейСоставРоли.Ссылка = РолиПользователей.Ссылка
		|			
		|			СГРУППИРОВАТЬ ПО
		|				РолиПользователей.Ссылка) КАК СоставСотрудники
		|			ПО СоответствиеОбъектРольСрезПоследних.РольПользователя = СоставСотрудники.Ссылка
		|		ПО втРезультат.Привязка = СоответствиеОбъектРольСрезПоследних.Объект
		|
		|СГРУППИРОВАТЬ ПО
		|	ВЫБОР
		|		КОГДА втРезультат.Привязка ССЫЛКА Справочник.ФизическиеЛица
		|			ТОГДА втРезультат.Привязка
		|		ИНАЧЕ СоставСотрудники.Сотрудник
		|	КОНЕЦ,
		|	втРезультат.СимКарта
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(втОбщийРезультат.Сумма) / СУММА(втОбщийРезультат.Количество) КАК СреднееЗначение
		|ПОМЕСТИТЬ втСреднееЗначение
		|ИЗ
		|	втОбщийРезультат КАК втОбщийРезультат
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втОбщийРезультат.Количество,
		|	втОбщийРезультат.Сумма,
		|	втОбщийРезультат.Ответственный,
		|	втОбщийРезультат.СимКарта
		|ПОМЕСТИТЬ втРезультатВышеСреднего
		|ИЗ
		|	втОбщийРезультат КАК втОбщийРезультат,
		|	втСреднееЗначение КАК втСреднееЗначение
		|ГДЕ
		|	(&Отбор1
		|			ИЛИ втОбщийРезультат.Сумма > втСреднееЗначение.СреднееЗначение)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(втРезультатВышеСреднего.Сумма) / СУММА(втРезультатВышеСреднего.Количество) КАК Среднее
		|ПОМЕСТИТЬ втСреднееВышеСреднего
		|ИЗ
		|	втРезультатВышеСреднего КАК втРезультатВышеСреднего
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втРезультатВышеСреднего.Количество,
		|	втРезультатВышеСреднего.Сумма,
		|	втРезультатВышеСреднего.Ответственный,
		|	втРезультатВышеСреднего.СимКарта
		|ПОМЕСТИТЬ втКонечныйРезультат
		|ИЗ
		|	втРезультатВышеСреднего КАК втРезультатВышеСреднего,
		|	втСреднееВышеСреднего КАК втСреднееВышеСреднего
		|ГДЕ
		|	(&Отбор2
		|			ИЛИ втРезультатВышеСреднего.Сумма > втСреднееВышеСреднего.Среднее)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(втКонечныйРезультат.Сумма) КАК Сумма,
		|	втКонечныйРезультат.Ответственный,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ втКонечныйРезультат.СимКарта) КАК Количество,
		|	ИСТИНА КАК Флаг,
		|	ЛОЖЬ КАК Отправлено,
		|	ДАТАВРЕМЯ(1, 1, 1) КАК ДатаОтправки
		|ИЗ
		|	втКонечныйРезультат КАК втКонечныйРезультат
		|
		|СГРУППИРОВАТЬ ПО
		|	втКонечныйРезультат.Ответственный
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	втКонечныйРезультат.Ответственный,
		|	втКонечныйРезультат.СимКарта
		|ИЗ
		|	втКонечныйРезультат КАК втКонечныйРезультат
		|ГДЕ
		|	НЕ втКонечныйРезультат.Ответственный ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ПериодРассылки.ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ПериодРассылки.ДатаОкончания));
	
	Если СпособФормирования = "Все" Тогда
		Запрос.УстановитьПараметр("Отбор1", Истина);
		Запрос.УстановитьПараметр("Отбор2", Истина);
	ИначеЕсли СпособФормирования = "ВышеСреднего" Тогда
		Запрос.УстановитьПараметр("Отбор1", Ложь);
		Запрос.УстановитьПараметр("Отбор2", Истина);
	Иначе	
		Запрос.УстановитьПараметр("Отбор1", Ложь);
		Запрос.УстановитьПараметр("Отбор2", Ложь);
	КонецЕсли;	
	
	КС = Новый КвалификаторыСтроки(100);
	Массив = Новый Массив;
	Массив.Добавить(Тип("Строка"));
	ОписаниеТиповС = Новый ОписаниеТипов(Массив, , КС);

	РезультатЗапроса = Запрос.ВыполнитьПакет();
	РезультатТаблица = РезультатЗапроса[6].Выгрузить();
	РезультатТаблица.Колонки.Добавить("Почта",ОписаниеТиповС);	
	Для Каждого СтрокаТаблицы из РезультатТаблица Цикл
		
		СтрокаТаблицы.Почта = СформироватьСтрокуАдресов(СтрокаТаблицы.Ответственный);
		Если СтрокаТаблицы.Почта = "" Тогда
			СтрокаТаблицы.Почта = "zakaz_u@izbenka.msk.ru";
		КонецЕсли;	
			
	КонецЦикла;	
	
	ТаблицаРассылки.Загрузить(РезультатТаблица);
	
	ИтогоКоличество = РезультатТаблица.Итог("Количество");
	ИтогоСумма      = РезультатТаблица.Итог("Сумма");
	
	РезультатСимКартаОтветственный = РезультатЗапроса[7].Выгрузить();	
	СимкартыОтветственные.Загрузить(РезультатСимКартаОтветственный);	
	
	
КонецПроцедуры	

Функция СформироватьТабличныйДокумент(Ответственный = Неопределено,СимКарты) //+++АК LAGP 2018.06.06 ИП-00018863 Рассылка всем всё, добавлено "=Неопределено"
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РасходыНаМобильнуюСвязьОбороты.СимКарта КАК СимКарта,
		|	РасходыНаМобильнуюСвязьОбороты.Оператор,
		|	РасходыНаМобильнуюСвязьОбороты.ПериодМесяц КАК ПериодМесяц,
		|	ВЫБОР
		|		КОГДА ПривязкаТелефоновСрезПоследних.Номер ЕСТЬ NULL
		|			ТОГДА ""Неопределено""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаТелефоновСрезПоследних.Привязка ЕСТЬ NULL
		|					ТОГДА ""Привязка не установлена""
		|				ИНАЧЕ ПривязкаТелефоновСрезПоследних.Привязка
		|			КОНЕЦ
		|	КОНЕЦ КАК Привязка,
		|	ВЫБОР
		|		КОГДА ПривязкаТелефоновСрезПоследних.Номер ЕСТЬ NULL
		|			ТОГДА ""Сим-карта не зарегистрирована""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаТелефоновСрезПоследних.Назначение ЕСТЬ NULL
		|					ТОГДА ""Назначение не указано""
		|				ИНАЧЕ ПривязкаТелефоновСрезПоследних.Назначение
		|			КОНЕЦ
		|	КОНЕЦ КАК Назначение,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот КАК АбонентскаяПлата,
		|	РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот КАК МобильнаяСвязь,
		|	РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот КАК SMSMMS,
		|	РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот КАК Интернет,
		|	РасходыНаМобильнуюСвязьОбороты.РоумингОборот КАК Роуминг,
		|	РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот КАК ДополнительныеУслуги,
		|	РасходыНаМобильнуюСвязьОбороты.СкидкаОборот КАК Скидка,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот + РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот + РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот + РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот + РасходыНаМобильнуюСвязьОбороты.РоумингОборот + РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот - РасходыНаМобильнуюСвязьОбороты.СкидкаОборот КАК Итого,
		|	ЛОЖЬ КАК СопоставленаПриФормировании,
		|	ИСТИНА КАК Сопоставлена
		|ПОМЕСТИТЬ втРезультат
		|ИЗ
		|	РегистрНакопления.РасходыНаМобильнуюСвязь.Обороты(&ДатаНачала, &ДатаОкончания, Авто, СимКарта ССЫЛКА Справочник.СлужебныеSIMКарты) КАК РасходыНаМобильнуюСвязьОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаТелефонов.СрезПоследних(&ДатаОкончания, ) КАК ПривязкаТелефоновСрезПоследних
		|		ПО РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаТелефоновСрезПоследних.Номер
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ПривязкаПоКоду.Ссылка, РасходыНаМобильнуюСвязьОбороты.СимКарта),
		|	РасходыНаМобильнуюСвязьОбороты.Оператор,
		|	РасходыНаМобильнуюСвязьОбороты.ПериодМесяц,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ""Неопределено""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаПоКоду.Привязка ЕСТЬ NULL
		|					ТОГДА ""Привязка не установлена""
		|				ИНАЧЕ ПривязкаПоКоду.Привязка
		|			КОНЕЦ
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ""Сим-карта не зарегистрирована""
		|		ИНАЧЕ ВЫБОР
		|				КОГДА ПривязкаПоКоду.Назначение ЕСТЬ NULL
		|					ТОГДА ""Назначение не указано""
		|				ИНАЧЕ ПривязкаПоКоду.Назначение
		|			КОНЕЦ
		|	КОНЕЦ,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот,
		|	РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот,
		|	РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот,
		|	РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот,
		|	РасходыНаМобильнуюСвязьОбороты.РоумингОборот,
		|	РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот,
		|	РасходыНаМобильнуюСвязьОбороты.СкидкаОборот,
		|	РасходыНаМобильнуюСвязьОбороты.АбонентскаяПлатаОборот + РасходыНаМобильнуюСвязьОбороты.МобильнаяСвязьОборот + РасходыНаМобильнуюСвязьОбороты.SMSMMSОборот + РасходыНаМобильнуюСвязьОбороты.ИнтернетОборот + РасходыНаМобильнуюСвязьОбороты.РоумингОборот + РасходыНаМобильнуюСвязьОбороты.ДополнительныеУслугиОборот - РасходыНаМобильнуюСвязьОбороты.СкидкаОборот,
		|	ВЫБОР
		|		КОГДА ПривязкаПоКоду.Ссылка ЕСТЬ NULL
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ,
		|	ЛОЖЬ
		|ИЗ
		|	РегистрНакопления.РасходыНаМобильнуюСвязь.Обороты(&ДатаНачала, &ДатаОкончания, Авто, НЕ СимКарта ССЫЛКА Справочник.СлужебныеSIMКарты) КАК РасходыНаМобильнуюСвязьОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СлужебныеSIMКарты.Ссылка КАК Ссылка,
		|			СлужебныеSIMКарты.Код КАК Код11,
		|			ПОДСТРОКА(СлужебныеSIMКарты.Код, 2, 10) КАК Код10,
		|			ПривязкаТелефоновСрезПоследних.Привязка КАК Привязка,
		|			ПривязкаТелефоновСрезПоследних.Назначение КАК Назначение
		|		ИЗ
		|			Справочник.СлужебныеSIMКарты КАК СлужебныеSIMКарты
		|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПривязкаТелефонов.СрезПоследних(&ДатаОкончания, ) КАК ПривязкаТелефоновСрезПоследних
		|				ПО СлужебныеSIMКарты.Ссылка = ПривязкаТелефоновСрезПоследних.Номер) КАК ПривязкаПоКоду
		|		ПО (РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаПоКоду.Код11
		|				ИЛИ РасходыНаМобильнуюСвязьОбороты.СимКарта = ПривязкаПоКоду.Код10)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втРезультат.СимКарта,
		|	втРезультат.Оператор,
		|	втРезультат.ПериодМесяц,
		|	втРезультат.Привязка,
		|	втРезультат.Назначение,
		|	втРезультат.АбонентскаяПлата,
		|	втРезультат.МобильнаяСвязь,
		|	втРезультат.SMSMMS,
		|	втРезультат.Интернет,
		|	втРезультат.Роуминг,
		|	втРезультат.ДополнительныеУслуги,
		|	втРезультат.Скидка,
		|	втРезультат.Итого,
		|	втРезультат.СопоставленаПриФормировании,
		|	втРезультат.Сопоставлена,
		|	ВЫБОР
		|		КОГДА втРезультат.Привязка ССЫЛКА Справочник.ФизическиеЛица
		|			ТОГДА втРезультат.Привязка
		|		ИНАЧЕ СоставСотрудники.Сотрудник
		|	КОНЕЦ КАК Ответственный
		|ПОМЕСТИТЬ втРезультатСОтветсвенным
		|ИЗ
		|	втРезультат КАК втРезультат
		//+++ AK suvv 2018.06.08 ИП-00018376.01
		//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаОкончания, ТипРоли.Код = ""PomoshnikTerrUpravlyushego"") КАК СоответствиеОбъектРольСрезПоследних
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаОкончания, (ТипРоли.Код = ""PomoshnikTerrUpravlyushego"" или ТипРоли.Код = ""PomoshnikStorRozn"")) КАК СоответствиеОбъектРольСрезПоследних
		//--- AK suvv
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				МАКСИМУМ(РолиПользователейСоставРоли.Сотрудник) КАК Сотрудник,
		|				РолиПользователей.Ссылка КАК Ссылка
		|			ИЗ
		|				Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
		|					ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РолиПользователей КАК РолиПользователей
		|					ПО РолиПользователейСоставРоли.Ссылка = РолиПользователей.Ссылка
		|			
		|			СГРУППИРОВАТЬ ПО
		|				РолиПользователей.Ссылка) КАК СоставСотрудники
		|			ПО СоответствиеОбъектРольСрезПоследних.РольПользователя = СоставСотрудники.Ссылка
		|		ПО втРезультат.Привязка = СоответствиеОбъектРольСрезПоследних.Объект
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	втРезультатСОтветсвенным.СимКарта,
		|	втРезультатСОтветсвенным.Оператор,
		|	втРезультатСОтветсвенным.ПериодМесяц,
		|	втРезультатСОтветсвенным.Привязка,
		|	втРезультатСОтветсвенным.Назначение,
		|	втРезультатСОтветсвенным.АбонентскаяПлата,
		|	втРезультатСОтветсвенным.МобильнаяСвязь,
		|	втРезультатСОтветсвенным.SMSMMS,
		|	втРезультатСОтветсвенным.Интернет,
		|	втРезультатСОтветсвенным.Роуминг,
		|	втРезультатСОтветсвенным.ДополнительныеУслуги,
		|	втРезультатСОтветсвенным.Скидка,
		|	втРезультатСОтветсвенным.Итого КАК Итого
		
		//+++АК LAGP 2018.06.14 ИП-00018863.01 Убрать лишние колонки
		//|	втРезультатСОтветсвенным.СопоставленаПриФормировании,
		//|	втРезультатСОтветсвенным.Сопоставлена,
		//|	втРезультатСОтветсвенным.Ответственный
		//---АК LAGP
		
		|ИЗ
		|	втРезультатСОтветсвенным КАК втРезультатСОтветсвенным
		|ГДЕ
		|	втРезультатСОтветсвенным.СимКарта В(&СимКарты)
		|
		|УПОРЯДОЧИТЬ ПО
		|	Итого УБЫВ";
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ПериодРассылки.ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ПериодРассылки.ДатаОкончания));
	Если ЗначениеЗаполнено(Ответственный) Тогда
		Запрос.Текст = Запрос.Текст +  " И втРезультатСОтветсвенным.Ответственный = &Ответственный";
		Запрос.УстановитьПараметр("Ответственный", Ответственный);
	КонецЕсли;	
	Запрос.УстановитьПараметр("СимКарты", СимКарты);
	
	 
	РезультатЗапроса = Запрос.Выполнить().Выгрузить();
	
	Если  РезультатЗапроса.Количество() = 0  тогда
		Возврат Неопределено;
	КонецЕсли;	
	
	РезультатТабДок = Новый ТабличныйДокумент;
	построитель = Новый ПостроительОтчета;
	построитель.ИсточникДанных = Новый ОписаниеИсточникаДанных(РезультатЗапроса);
	построитель.Вывести(РезультатТабДок);
	ИмяФайла = ПолучитьИмяВременногоФайла("xls");
	
	//+++АК LAGP 2018.06.14 ИП-00018863.01 Выделение колонки "Итого"
	
	//+++АК sole 2018.07.06  Этот Код стрельнул в пятницу вечером и был отключен
	// Спасибо Паша!!!
	КонецВыделеннойОбласти = 4 + РезультатЗапроса.Количество();
	РезультатТабДок.Область("R5C14:R" + Формат(КонецВыделеннойОбласти, "ЧГ=0") + "C14").ЦветФона = WebЦвета.Желтый; //+++АК LAGP 2018.07.08 ИП-00018863.01 Добавил формат для числового значения.
	//---АК sole 2018.07.06
	
	//---АК LAGP
	
	РезультатТабДок.Записать(ИмяФайла, ТипФайлаТабличногоДокумента.XLS);
	
	Возврат ИмяФайла;
	
КонецФункции	

Функция СформироватьСтрокуАдресов(ФизическоеЛицо)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	КонтактнаяИнформация.Представление
		|ИЗ
		|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		|ГДЕ
		|	КонтактнаяИнформация.Объект = &Объект
		|	И КонтактнаяИнформация.Тип = &Тип";
	
	Запрос.УстановитьПараметр("Объект", ФизическоеЛицо);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Результат = "";
	ЭтоПервый = Истина;
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если не ЭтоПервый тогда
			Результат = Результат + ";"	
		КонецЕсли;	
		Результат = Результат +   СокрЛП(ВыборкаДетальныеЗаписи.Представление);
		ЭтоПервый = Ложь;
	КонецЦикла;
	
	Возврат Результат;
		
	
	
КонецФункции	

&НаСервере
Процедура ОтправитьНаСервере()
	
	УчетнаяЗапись = ОбщиеПроцедуры.ПолучитьУчетнуюЗаписьДляРассылки();
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
	
	Почта = Новый ИнтернетПочта;
	Почта.Подключиться(Профиль);
	
	Индикатор = 0;
	ВсегоКОтправке = 0;
	
	Для каждого получатель Из ТаблицаРассылки Цикл
			
		Если Получатель.Флаг и ЗначениеЗаполнено(Получатель.Почта) Тогда
			ВсегоКОтправке = ВсегоКОтправке + 1;
		КонецЕсли;
	КонецЦикла;
	
	Элементы.Индикатор.МаксимальноеЗначение = ВсегоКОтправке;
	
	//+++АК LAGP 2018.06.06 ИП-00018863 Рассылка всем всё
	СимКарты = СформироватьМассивСимКарт(); 
	ИмяФайлаВложения = СформироватьТабличныйДокумент(,СимКарты);
	//---АК LAGP
	
	Для каждого получатель Из ТаблицаРассылки Цикл
		
		Если НЕ Получатель.Флаг Тогда
			Продолжить;
		КонецЕсли;	
		
		
		Тема = "Рассылка расходов на мобильную связь";
		Текст = "";
		Если СпособФормирования = "Все" Тогда
			Текст = Текст + "Вариант рассылки: все расходы" + Символы.ПС;
		ИначеЕсли СпособФормирования = "ВышеСреднего" Тогда
			Текст = Текст + "Вариант рассылки: выше среднего" + Символы.ПС;
		Иначе	
			Текст = Текст + "Вариант рассылки: превышение" + Символы.ПС;			
		КонецЕсли;	
		
		//+++АК LAGP 2018.06.06 ИП-00018863 Рассылка всем всё
		//СимКарты = СформироватьМассивСимКарт(получатель.Ответственный);
		//ИмяФайлаВложения = СформироватьТабличныйДокумент(получатель.Ответственный,СимКарты);
		//---АК LAGP
						
    	ОтправитьПисьмо(УчетнаяЗапись, Почта, Получатель.Почта, Тема, Текст, ИмяФайлаВложения);
    	Индикатор = Индикатор+1;
    	Получатель.отправлено = Истина;
    	получатель.Период = ТекущаяДата();
		
		МенеджерЗаписи = РегистрыСведений.РассылкаМобильнаяСвязь.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(МенеджерЗаписи,получатель);
		МенеджерЗаписи.ДатаНачала = ДатаНачала;
		МенеджерЗаписи.ДатаОкончания = ДатаОкончания;
		МенеджерЗаписи.СпособФормирования = СпособФормирования;
		МенеджерЗаписи.Записать();
		
	КонецЦикла; 
	
	Почта.Отключиться();
	
КонецПроцедуры

Функция СформироватьМассивСимКарт(Ответственный = Неопределено)
	
	Отбор = Новый Структура;
	
	//+++АК LAGP 2018.06.06 ИП-00018863 Рассылка всем всё
	//ТаблицаСотбором = СимкартыОтветственные.Выгрузить().Скопировать(Отбор);
	Если НЕ Ответственный = Неопределено Тогда
		Отбор.Вставить("Ответственный",Ответственный);
		ТаблицаСотбором = СимкартыОтветственные.Выгрузить().Скопировать(Отбор);
	Иначе
		ТаблицаСотбором = СимкартыОтветственные.Выгрузить().Скопировать();
	КонецЕсли;		
	//---АК LAGP		
		
	Результат = ТаблицаСотбором.ВыгрузитьКолонку("Симкарта");
	
	Возврат Результат;
	
КонецФункции	

Процедура ОтправитьПисьмо(УчетнаяЗапись, Почта, АдресПолучателя, Тема, ТекстПисьма,ИмяФайла)
	
//	АдресПолучателя = "";
	
	СпАдресов=Новый СписокЗначений;
	МассивАдресов=Справочники.Контрагенты.РазложитьСтрокуВМассивПодстрок(АдресПолучателя,";");	
	Для каждого Эл Из МассивАдресов Цикл
		Если ЗначениеЗаполнено(Эл) Тогда
			СпАдресов.Добавить(Сокрлп(Эл));
		КонецЕсли; 
	КонецЦикла; 
	СпАдресов.Добавить("lagp@automacon.ru");
	
	Письмо = Новый ИнтернетПочтовоеСообщение;
	
	Письмо.ИмяОтправителя  = ""+СокрЛП(УчетнаяЗапись)+"";
	Письмо.Отправитель     = ""+СокрЛП(УчетнаяЗапись)+"";
	
	Письмо.Тексты.Добавить(ТекстПисьма,ТипТекстаПочтовогоСообщения.ПростойТекст);
	
	Письмо.Вложения.Добавить(ИмяФайла);
	Письмо.Тема=Тема;
	
	Для каждого Адрес Из СпАдресов Цикл
		Получатель = Письмо.Получатели.Добавить();
		Получатель.Адрес = Адрес.Значение;
	КонецЦикла;	
	
	Почта.Послать(Письмо);
	
КонецПроцедуры

&НаКлиенте
Процедура Отправить(Команда)
	ОтправитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ВыделитьВсе(Команда)
	
	для Каждого СтрокаТаблицы из ТаблицаРассылки Цикл
		СтрокаТаблицы.Флаг = Истина;	
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьВыделение(Команда)
	для Каждого СтрокаТаблицы из ТаблицаРассылки Цикл
		СтрокаТаблицы.Флаг = Ложь;	
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура СпособФормированияПриИзменении(Элемент)
	СформироватьТаблицуРассылки();
КонецПроцедуры

&НаКлиенте
Процедура СформироватьТаблицу(Команда)
	СформироватьТаблицуРассылки();
КонецПроцедуры

&НаКлиенте
Процедура ПериодРассылкиПриИзменении(Элемент)
	СформироватьТаблицуРассылки();
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаРассылкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	ОткрытьРасшифровку();
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьРасшифровку()
	ТекущиеДанные = Элементы.ТаблицаРассылки.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
	
		ПараметрыЗапроса = Новый Структура("ДатаНачала,ДатаОкончания,Ответственный,СимКарты");	
		ПараметрыЗапроса.ДатаНачала = ПериодРассылки.ДатаНачала;
		ПараметрыЗапроса.ДатаОкончания = ПериодРассылки.ДатаОкончания;
	    ПараметрыЗапроса.Ответственный = ТекущиеДанные.Ответственный;
		МассивСимКарт = СформироватьМассивСимКарт(ТекущиеДанные.Ответственный);
		ПараметрыЗапроса.СимКарты = МассивСимКарт;
		ОткрытьФорму("Отчет.АК_ОтчетПоРасходамНаМобильнуюСвязь.Форма.ФормаРасшифровки",ПараметрыЗапроса);
		
	КонецЕсли;
КонецПроцедуры	