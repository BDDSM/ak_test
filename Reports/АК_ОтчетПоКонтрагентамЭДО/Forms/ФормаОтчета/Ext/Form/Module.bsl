
&НаКлиенте
Процедура РезультатОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	Данные = ПолучитьИзВременногоХранилища(ДанныеРасшифровки);
	Если ТипЗнч(Расшифровка) = Тип("Булево") Тогда
		СтандартнаяОбработка = Ложь;      	
	ИначеЕсли  Данные.Элементы[Расшифровка].ПолучитьПоля()[0].Поле = "Ссылка.КомментарийЭДО" Тогда
		
		СтандартнаяОбработка = Ложь;      	
		
		СтруктураДанных = Новый Структура("Ссылка", Данные.Элементы[Расшифровка - 2].ПолучитьПоля().Найти("Ссылка").Значение);
		//СтруктураДанных = ПолучитьДанныеРасшифровки(Расшифровка, СтруктураДанных);			
		//
		ДобавитьКомментарий(СтруктураДанных, Элемент.ТекущаяОбласть);       			
		
	КонецЕсли;	
КонецПроцедуры


&НаКлиенте
Процедура ДобавитьКомментарий(СтруктураДанных, ТекущаяОбласть)	
	Комментарий = ТекущаяОбласть.Текст; 
	
	Если ВвестиЗначение(Комментарий, "Комментарий ЭДО:") = Истина Тогда
		
		Если ЗначениеЗаполнено(СтруктураДанных.Ссылка) = Истина И ТипЗнч(СтруктураДанных.Ссылка) = Тип("СправочникСсылка.Контрагенты") Тогда
			СпрОбъект = СтруктураДанных.Ссылка.ПолучитьОбъект();
			СпрОбъект.КомментарийЭДО = Комментарий;
			СпрОбъект.КомментарийЭДОАвтор = ПараметрыСеанса.ТекущийПользователь;
			СпрОбъект.КомментарийЭДОДата = ТекущаяДата();
			СпрОбъект.ОбменДанными.Загрузка = Истина;
			СпрОбъект.Записать();			
		КонецЕсли;	
		
		ТекущаяОбласть.Текст = Комментарий;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Функция ПолучитьДанныеРасшифровки(Расшифровка, СтруктураДанных, ОбъектРасшифровки=Неопределено)

    Данные = ПолучитьИзВременногоХранилища(ДанныеРасшифровки);
    ОбъектРасшифровки = Данные.Элементы[Расшифровка].ПолучитьПоля()[0].Значение;
    Если Данные <> Неопределено Тогда
        Для каждого ЭлементДанных Из СтруктураДанных Цикл
            Родитель = Данные.Элементы[Расшифровка];
            Пока Истина Цикл
                МассивРодителей = Родитель.ПолучитьРодителей();
                Если МассивРодителей.Количество() = 0 Тогда
                    Прервать;
                КонецЕсли;
                Родитель = Родитель.ПолучитьРодителей()[0];
                Если ТипЗнч(Родитель) = Тип("ЭлементРасшифровкиКомпоновкиДанныхПоля") Тогда
                    Если ЭлементДанных.Значение = Неопределено Тогда
                        Поле = Родитель.ПолучитьПоля().Найти(ЭлементДанных.Ключ);
                    Иначе
                        Поле = Родитель.ПолучитьПоля().Найти(ЭлементДанных.Значение);
                    КонецЕсли; 
                    Если Поле <> Неопределено Тогда
                        СтруктураДанных.Вставить(ЭлементДанных.Ключ, Поле.Значение);
                        Прервать;
					КонецЕсли;
				Иначе
					
                КонецЕсли;
            КонецЦикла;
        
        КонецЦикла; 
    КонецЕсли; 
    
    Возврат СтруктураДанных;
    
КонецФункции // ПолучитьДанныеРасшифровки()

