
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	УстановитьПривилегированныйРежим(Истина);
	
			
	// Подготовим и выведем отчет.
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	
	НастройкиКомпоновкиДанных = КомпоновщикНастроек.ПолучитьНастройки();
	
	Если ДанныеРасшифровки = Неопределено тогда
		ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
	КонецЕсли;
	СКД=Отчеты.ОтчетПоСтатусамРекламныхМатериалов.ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	МакетКомп=КомпоновщикМакета.Выполнить(СКД,НастройкиКомпоновкиДанных, ДанныеРасшифровки, ,
	Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
	ПроцКД=Новый ПроцессорКомпоновкиДанных;
	ПроцКД.Инициализировать(МакетКомп);
	ПроцВыв=Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	ТЗРезультат=Новый ТаблицаЗначений;
	ПроцВыв.УстановитьОбъект(ТЗРезультат);
	
	ПроцВыв.НачатьВывод();
	Ит=0;
	Пока Истина Цикл
		ЭлементРезультатаКомпоновкиДанных = 
		ПроцКД.Следующий();
		Если ЭлементРезультатаКомпоновкиДанных = Неопределено Тогда
			Прервать;
		КонецЕсли;
		ПроцВыв.ВывестиЭлемент(ЭлементРезультатаКомпоновкиДанных);
		Ит=Ит+1;
		Если Ит=201 Тогда
			//Прервать;
		КонецЕсли; 
	КонецЦикла;
	
	
	ДатаНачала = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ДатаНачала")).ИдентификаторПользовательскойНастройки);
	ДатаОкончания = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ДатаОкончания")).ИдентификаторПользовательскойНастройки);
	
	Если ДатаНачала = Неопределено Тогда
		Возврат;
	Иначе
		
		НачалоПериода = ДатаНачала;
		КонецПериода  = ДатаОкончания;
		
		
	
		ЗапросПоступившей = Новый Запрос();
		ЗапросПоступившей.Текст = "ВЫБРАТЬ
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	""ПереданоВСборку"" КАК Операция,
		                          |	ДвижениеКонвертовРеклама.ТТ,
		                          |	МИНИМУМ(ДвижениеКонвертовРеклама.Период) КАК Период,
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата
		                          |ПОМЕСТИТЬ вт1
		                          |ИЗ
		                          |	РегистрСведений.ДвижениеКонвертовРеклама КАК ДвижениеКонвертовРеклама
		                          |ГДЕ
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата МЕЖДУ &Дата1 И &Дата2
		                          |	И ДвижениеКонвертовРеклама.ПереданоВСборку
		                          |
		                          |СГРУППИРОВАТЬ ПО
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	ДвижениеКонвертовРеклама.ТТ
		                          |;
		                          |
		                          |////////////////////////////////////////////////////////////////////////////////
		                          |ВЫБРАТЬ
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	""ПогруженоНаПаллет"" КАК Операция,
		                          |	ДвижениеКонвертовРеклама.ТТ,
		                          |	МИНИМУМ(ДвижениеКонвертовРеклама.Период) КАК Период,
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата
		                          |ПОМЕСТИТЬ вт2
		                          |ИЗ
		                          |	РегистрСведений.ДвижениеКонвертовРеклама КАК ДвижениеКонвертовРеклама
		                          |ГДЕ
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата МЕЖДУ &Дата1 И &Дата2
		                          |	И ДвижениеКонвертовРеклама.ПогруженоНаПаллет
		                          |
		                          |СГРУППИРОВАТЬ ПО
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	ДвижениеКонвертовРеклама.ТТ
		                          |;
		                          |
		                          |////////////////////////////////////////////////////////////////////////////////
		                          |ВЫБРАТЬ
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	""ОтгруженоСкладом"" КАК Операция,
		                          |	ДвижениеКонвертовРеклама.ТТ,
		                          |	МИНИМУМ(ДвижениеКонвертовРеклама.Период) КАК Период,
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата
		                          |ПОМЕСТИТЬ вт3
		                          |ИЗ
		                          |	РегистрСведений.ДвижениеКонвертовРеклама КАК ДвижениеКонвертовРеклама
		                          |ГДЕ
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата МЕЖДУ &Дата1 И &Дата2
		                          |	И ДвижениеКонвертовРеклама.ВПути
		                          |
		                          |СГРУППИРОВАТЬ ПО
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	ДвижениеКонвертовРеклама.ТТ
		                          |;
		                          |
		                          |////////////////////////////////////////////////////////////////////////////////
		                          |ВЫБРАТЬ
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	""ПринятТТ"" КАК Операция,
		                          |	ДвижениеКонвертовРеклама.ТТ,
		                          |	МИНИМУМ(ДвижениеКонвертовРеклама.Период) КАК Период,
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата
		                          |ПОМЕСТИТЬ вт4
		                          |ИЗ
		                          |	РегистрСведений.ДвижениеКонвертовРеклама КАК ДвижениеКонвертовРеклама
		                          |ГДЕ
		                          |	ДвижениеКонвертовРеклама.Заявка.Дата МЕЖДУ &Дата1 И &Дата2
		                          |	И ДвижениеКонвертовРеклама.ПринятТТ
		                          |
		                          |СГРУППИРОВАТЬ ПО
		                          |	ДвижениеКонвертовРеклама.Заявка,
		                          |	ДвижениеКонвертовРеклама.ТТ
		                          |;
		                          |
		                          |////////////////////////////////////////////////////////////////////////////////
		                          |ВЫБРАТЬ
		                          |	вт1.Заявка,
		                          |	вт1.Операция,
		                          |	вт1.ТТ,
		                          |	вт1.Период,
		                          |	вт1.ЗаявкаДата
		                          |ИЗ
		                          |	вт1 КАК вт1
		                          |
		                          |ОБЪЕДИНИТЬ ВСЕ
		                          |
		                          |ВЫБРАТЬ
		                          |	вт2.Заявка,
		                          |	вт2.Операция,
		                          |	вт2.ТТ,
		                          |	вт2.Период,
		                          |	вт2.ЗаявкаДата
		                          |ИЗ
		                          |	вт2 КАК вт2
		                          |
		                          |ОБЪЕДИНИТЬ ВСЕ
		                          |
		                          |ВЫБРАТЬ
		                          |	вт3.Заявка,
		                          |	вт3.Операция,
		                          |	вт3.ТТ,
		                          |	вт3.Период,
		                          |	вт3.ЗаявкаДата
		                          |ИЗ
		                          |	вт3 КАК вт3
		                          |
		                          |ОБЪЕДИНИТЬ ВСЕ
		                          |
		                          |ВЫБРАТЬ
		                          |	вт4.Заявка,
		                          |	вт4.Операция,
		                          |	вт4.ТТ,
		                          |	вт4.Период,
		                          |	вт4.ЗаявкаДата
		                          |ИЗ
		                          |	вт4 КАК вт4";
		
		ЗапросПоступившей.УстановитьПараметр("Дата1", (НачалоДня(НачалоПериода.Значение)));
		ЗапросПоступившей.УстановитьПараметр("Дата2", (КонецДня(КонецПериода.Значение)));
		
		ТЗРез = ЗапросПоступившей.Выполнить().Выгрузить();
		
		
		МасОп=Новый Массив;
		МасОп.Добавить("ПереданоВСборку");
		МасОп.Добавить("ПогруженоНаПаллет");
		МасОп.Добавить("ОтгруженоСкладом");
		МасОп.Добавить("ПринятТТ");
		ТЗЗаявки=ТЗРез.Скопировать();
		ТЗЗаявки.Свернуть("ЗаявкаДата,Заявка,ТТ");
		ТЗЗаявки.Сортировать("ЗаявкаДата,Заявка,ТТ");
		
		Мак=Отчеты.ОтчетПоСтатусамРекламныхМатериалов.ПолучитьМакет("Макет");
		ОблНачало=Мак.ПолучитьОбласть("Шапка|Начало");
		ОблСтатус=Мак.ПолучитьОбласть("Шапка|Статус");
		//ДокументРезультат=Новый ТабличныйДокумент;
		ДокументРезультат.Вывести(ОблНачало);
		Для каждого Эл Из МасОп Цикл
			ОблСтатус=Мак.ПолучитьОбласть("Шапка|Статус");
			ОблСтатус.Параметры.Статус=Эл;
			ДокументРезультат.Присоединить(ОблСтатус);
		КонецЦикла; 
		
		Для каждого Стр Из ТЗЗаявки Цикл
			МасСтр=ТЗРезультат.найтиСтроки(Новый Структура("Заявка",Стр.Заявка));
			Если НЕ МасСтр.Количество() Тогда
				Продолжить;
			КонецЕсли; 
			МасСтр=ТЗРезультат.найтиСтроки(Новый Структура("ТТ",Стр.ТТ));
			Если НЕ МасСтр.Количество() Тогда
				Продолжить;
			КонецЕсли; 
			
			
			ОблНачало=Мак.ПолучитьОбласть("Строка|Начало");
			ЗаполнитьЗначенияСвойств(ОблНачало.Параметры,Стр);
			ДокументРезультат.Вывести(ОблНачало);
			Для каждого Эл Из МасОп Цикл
				
				ОблСтатус=Мак.ПолучитьОбласть("Строка|Статус");
				МасСтр=ТЗРез.НайтиСтроки(Новый Структура("Заявка,ТТ,Операция",Стр.Заявка,Стр.ТТ,Эл));
				
				Если МасСтр.Количество() Тогда
					ОблСтатус.Параметры.Период=МасСтр[0].Период;
				Иначе	
				КонецЕсли; 
				ДокументРезультат.Присоединить(ОблСтатус);
				
			КонецЦикла; 
		КонецЦикла; 
		ДокументРезультат.ФиксацияСверху=1;
		
    КонецЕсли;
КонецПроцедуры
