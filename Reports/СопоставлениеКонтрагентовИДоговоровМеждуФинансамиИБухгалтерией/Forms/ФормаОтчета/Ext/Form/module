
Процедура ДействияФормыСформирвоать(Кнопка)
		СтрокаПодключения = ПолныеПрава.ПолучитьСтрокуПодключения_Бух();
	
	v82COMОбъект = Новый COMОбъект(ПолныеПрава.ПолучитьВерсиюКомОбъекта_Бух() + ".COMConnector");
	Попытка
		v82 = v82COMОбъект.Connect(СтрокаПодключения);
		ПодключениеУстановлено=Истина;
	Исключение
		ПодключениеУстановлено=Ложь;
		Сообщить("Не удалось подключитьс к базе финансов");
		Возврат;
	КонецПопытки;
	ТекстЗапроса="ВЫБРАТЬ
	             |	ДоговорыКонтрагентов.Код КАК БП_Код,
	             |	ДоговорыКонтрагентов.Наименование КАК БП_Наименование,
	             |	ДоговорыКонтрагентов.Организация.Наименование КАК Организация,
	             |	ДоговорыКонтрагентов.Номер КАК БП_Номер,
	             |	ДоговорыКонтрагентов.Дата КАК БП_Дата,
	             |	ПРЕДСТАВЛЕНИЕ(ДоговорыКонтрагентов.ВидДоговора) КАК БП_ВидДоговора,
	             |	ДоговорыКонтрагентов.Владелец.Наименование КАК БП_ВладелецНаименование,
	             |	ДоговорыКонтрагентов.Владелец.ИНН КАК БП_ВладелецИНН,
	             |	ДоговорыКонтрагентов.Владелец.КПП КАК БП_ВладелецКПП,
	             |	ДоговорыКонтрагентов.Владелец.НаименованиеПолное КАК БП_ВладелецНаименованиеПолное,
	             |	ИСТИНА КАК БазаБП
	             |ИЗ
	             |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	             |ГДЕ
	             |	НЕ ДоговорыКонтрагентов.ПометкаУдаления
	             |	И ДоговорыКонтрагентов.Организация.ИНН = &ИНН";
	запрос=v82.NewObject("Запрос");  
	запрос.текст = ТекстЗапроса;			 
	Запрос.установитьПараметр("ИНН",Организация.ИНН);
	Выборка=Запрос.Выполнить().Выбрать();
	
	ТЗБП=Новый ТаблицаЗначений;
	ТЗБП.Колонки.Добавить("БП_Код");
	ТЗБП.Колонки.Добавить("БП_Наименование");
	ТЗБП.Колонки.Добавить("Организация");
	ТЗБП.Колонки.Добавить("БП_Номер");
	ТЗБП.Колонки.Добавить("БП_Дата");
	ТЗБП.Колонки.Добавить("БП_ВидДоговора");
	ТЗБП.Колонки.Добавить("БП_ВладелецНаименование");
	ТЗБП.Колонки.Добавить("БП_ВладелецИНН");
	ТЗБП.Колонки.Добавить("БП_ВладелецКПП");
	ТЗБП.Колонки.Добавить("БП_ВладелецНаименованиеПолное");
	
	ТЗБП.Колонки.Добавить("Упр_Код");
	ТЗБП.Колонки.Добавить("Упр_Наименование");
	ТЗБП.Колонки.Добавить("Упр_Номер");
	ТЗБП.Колонки.Добавить("Упр_Дата");
	ТЗБП.Колонки.Добавить("Упр_ВидДоговора");
	ТЗБП.Колонки.Добавить("Упр_ВладелецНаименование");
	ТЗБП.Колонки.Добавить("Упр_ВладелецИНН");
	ТЗБП.Колонки.Добавить("Упр_ВладелецКПП");
	ТЗБП.Колонки.Добавить("Упр_ВладелецНаименованиеПолное");
	Пока Выборка.следующий() Цикл
		Если Не ЗначениеЗаполнено(Выборка.Организация) Тогда
			продолжить;
		КонецЕсли;
		Если нАЙТИ(Нрег(Выборка.БП_Наименование),"(нал)")>0 Тогда
			продолжить;
		КонецЕсли;
		НС=ТЗБП.Добавить();
		ЗаполнитьЗначенияСвойств(НС,Выборка);
	КонецЦикла;	
	
	ТекстЗапроса="ВЫБРАТЬ
	             |	ДоговорыКонтрагентов.Код КАК Упр_Код,
	             |	ДоговорыКонтрагентов.Наименование КАК Упр_Наименование,
	             |	ДоговорыКонтрагентов.Организация.Наименование КАК Организация,
	             |	ДоговорыКонтрагентов.Номер КАК Упр_Номер,
	             |	ДоговорыКонтрагентов.Дата КАК Упр_Дата,
	             |	ПРЕДСТАВЛЕНИЕ(ДоговорыКонтрагентов.ВидДоговора) КАК Упр_ВидДоговора,
	             |	ДоговорыКонтрагентов.Владелец.Наименование КАК Упр_ВладелецНаименование,
	             |	ДоговорыКонтрагентов.Владелец.ИНН КАК Упр_ВладелецИНН,
	             |	ДоговорыКонтрагентов.Владелец.КПП КАК Упр_ВладелецКПП,
	             |	ДоговорыКонтрагентов.Владелец.НаименованиеПолное КАК Упр_ВладелецНаименованиеПолное,
	             |	ИСТИНА КАК БазаФинансов
	             |ИЗ
	             |	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	             |ГДЕ
	             |	НЕ ДоговорыКонтрагентов.ПометкаУдаления
	             |	И ДоговорыКонтрагентов.Организация.ИНН = &ИНН";
				 
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.установитьПараметр("ИНН",Организация.ИНН);
	Выборка=Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Не ЗначениеЗаполнено(Выборка.Организация) Тогда
			продолжить;
		КонецЕсли;
		Если нАЙТИ(Нрег(Выборка.Упр_Наименование),"(нал)")>0 Тогда
			продолжить;
		КонецЕсли;
		СтруктураПоиска=Новый Структура;
		СтруктураПоиска.Вставить("БП_ВладелецНаименование",Выборка.Упр_ВладелецНаименование);
		СтруктураПоиска.Вставить("БП_ВладелецИНН",Выборка.Упр_ВладелецИНН);
		СтруктураПоиска.Вставить("БП_ВладелецКПП",Выборка.Упр_ВладелецКПП);
		//СтруктураПоиска.Вставить("БП_ВидДоговора",Выборка.Упр_ВидДоговора);
		//СтруктураПоиска.Вставить("БП_Наименование",Выборка.Упр_Наименование);
		СтруктураПоиска.Вставить("БП_Код",Выборка.Упр_Код);
		СтруктураПоиска.Вставить("Организация",Выборка.Организация);
		НайденныеСтроки=ТЗБП.НайтиСтроки(СтруктураПоиска);
		Если НайденныеСтроки.Количество()>0 Тогда
			ЗаполнитьЗначенияСвойств(НайденныеСтроки[0],выборка);
		Иначе
			НС=ТЗБП.Добавить();
			ЗаполнитьЗначенияСвойств(НС,выборка);
		КонецЕсли;	
		
	КонецЦикла;	
	
		
	ВнешниеНаборыДанных = Новый Структура; 
	ВнешниеНаборыДанных.Вставить("ДанныеБП",ТЗБП); 
	
	СхемаКомпоновкиДанных = ПолучитьМакет("ОсновнаяСхемаКомпоновкиДанных");
	//Настройки = СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
    ДанныеРасшифровки = Новый ДанныеРасшифровкиКомпоновкиДанных;
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	//МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки);
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, КомпоновщикНастроек.Настройки,ДанныеРасшифровки);
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
    ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных);
	
	//ДокументРезультат = Новый ТабличныйДокумент;
	ЭлементыФормы.Результат.Очистить();
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
    ПроцессорВывода.УстановитьДокумент(ЭлементыФормы.Результат);

	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);

КонецПроцедуры
