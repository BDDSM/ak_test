
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	ДатаНачала = '00010101';
	Для Каждого ПользПоле Из КомпоновщикНастроек.ПользовательскиеНастройки.Элементы Цикл
		Если ТипЗнч(ПользПоле) = Тип("ЗначениеПараметраНастроекКомпоновкиДанных")
			И Строка(ПользПоле.Параметр) = "НовыеЦенникиСДаты" Тогда
			ДатаНачала = ПользПоле.Значение.Дата;
		КонецЕсли;	
	КонецЦикла;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаДобавления", ДатаНачала);
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЦенникиКПечатиВМагазинах.Магазин,
	               |	ЦенникиКПечатиВМагазинах.Номенклатура,
	               |	ЦенникиКПечатиВМагазинах.ОписаниеПричиныПечати,
	               |	ЦенникиКПечатиВМагазинах.ДатаДобавления КАК ДатаОбновленияЦенника
	               |ИЗ
	               |	РегистрСведений.ЦенникиКПечатиВМагазинах КАК ЦенникиКПечатиВМагазинах
	               |ГДЕ
	               |	ЦенникиКПечатиВМагазинах.ДатаДобавления >= &ДатаДобавления";
				   
	ТаблицаДанных = Новый ТаблицаЗначений();
	ТаблицаДанных.Колонки.Добавить("ДатаОбновленияЦенника", Новый ОписаниеТипов("Дата"));
	ТаблицаДанных.Колонки.Добавить("Причина", Новый ОписаниеТипов("Строка",, Новый КвалификаторыСтроки(150, ДопустимаяДлина.Переменная)));
	ТаблицаДанных.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаДанных.Колонки.Добавить("Магазин", Новый ОписаниеТипов("СправочникСсылка.СтруктурныеЕдиницы"));
	ТаблицаДанных.Колонки.Добавить("НовыйПоказатель", Новый ОписаниеТипов("Строка",, Новый КвалификаторыСтроки(150, ДопустимаяДлина.Переменная)));
	ТаблицаДанных.Колонки.Добавить("ПолноеОписание", Новый ОписаниеТипов("Строка",, Новый КвалификаторыСтроки(150, ДопустимаяДлина.Переменная)));
								
	СтандартнаяОбработка = Ложь;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ПричиныПечати = Выборка.ОписаниеПричиныПечати;
		Для н = 1 По СтрЧислоСтрок(ПричиныПечати) Цикл
			СтрокаЧастьПричины = СтрПолучитьСтроку(ПричиныПечати, н);
			Если Найти(СтрокаЧастьПричины, "Новая цена:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новая цена";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новая цена: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новая цена по акции:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новая цена по акции";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новая цена по акции: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новая страна происхождения:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новая страна происхождения";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новая страна происхождения: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новое название товара:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новое название товара";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новое название товара: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;	
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новый вес упаковки:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новый вес упаковки";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новый вес упаковки: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;		
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новый срок годности:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новый срок годности";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новый срок годности: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;			
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новая фишка:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новая фишка";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новая фишка: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;				
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новое название акции:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новое название акции";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новое название акции: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;					
			ИначеЕсли Найти(СтрокаЧастьПричины, "Новый комментарий акции:") > 0 Тогда
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = "Новый комментарий акции";
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = СтрЗаменить(СтрокаЧастьПричины, "Новый комментарий акции: ", "");
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;						
			Иначе	
				СтрокаДоб = ТаблицаДанных.Добавить();
				СтрокаДоб.Причина = СтрокаЧастьПричины;
				СтрокаДоб.ДатаОбновленияЦенника = Выборка.ДатаОбновленияЦенника;
				СтрокаДоб.Номенклатура = Выборка.Номенклатура;
				СтрокаДоб.Магазин = Выборка.Магазин;
				СтрокаДоб.НовыйПоказатель = "";
				СтрокаДоб.ПолноеОписание = СтрокаЧастьПричины;
			КонецЕсли;	
		КонецЦикла;	
	КонецЦикла;	
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("ТабДанные", ТаблицаДанных);
	
	//Макет компоновки 
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, КомпоновщикНастроек.ПолучитьНастройки(), ДанныеРасшифровки);
	
	//Компоновка данных
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	//Вывод результата
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
КонецПроцедуры
