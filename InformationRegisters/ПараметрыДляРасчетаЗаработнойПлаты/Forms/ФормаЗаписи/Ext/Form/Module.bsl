
&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	
	// Проверки пересечения процентов
	МассивОшибок = Новый Массив;
	ПроверитьПересечениеПроцентовВТаблице("НастройкиПремииЗаВыкладку", "Настройки премии за выкладку", МассивОшибок, Отказ);
	ПроверитьПересечениеПроцентовВТаблице("НастройкиПремииЗаТайника", "Настройки премии за тайника", МассивОшибок, Отказ);
	ПроверитьПересечениеПроцентовВТаблице("НастройкиОпросПоСкайпу", "Найстройки начислений за опрос по скайпу", МассивОшибок, Отказ);
	
	Если Отказ Тогда
		Для Каждого Ошибка Из МассивОшибок Цикл
			Сообщить(Ошибка);
		КонецЦикла;
		Сообщить("Устраните ошибки и повторите запись.");
		
		Возврат;
	КонецЕсли;
	
	//
	НастройкиЗаВыкладку = РеквизитФормыВЗначение("НастройкиПремииЗаВыкладку");
	ТекущийОбъект.НастройкиПремииЗаВыкладку = Новый ХранилищеЗначения(НастройкиЗаВыкладку);
	
	//
	НастройкиЗаТайника = РеквизитФормыВЗначение("НастройкиПремииЗаТайника");
	ТекущийОбъект.НастройкиПремииЗаТайника = Новый ХранилищеЗначения(НастройкиЗаТайника);
	
	//
	тзНастройкиОпросПоСкайпу = РеквизитФормыВЗначение("НастройкиОпросПоСкайпу");
	ТекущийОбъект.НастройкиОпросПоСкайпу = Новый ХранилищеЗначения(тзНастройкиОпросПоСкайпу);
	
КонецПроцедуры


&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	НастройкиЗаВыкладку = ТекущийОбъект.НастройкиПремииЗаВыкладку.Получить();
	Если НастройкиЗаВыкладку <> Неопределено Тогда
		ЗначениеВРеквизитФормы(НастройкиЗаВыкладку, "НастройкиПремииЗаВыкладку");
	КонецЕсли;	
	
	НастройкиЗаТайника = ТекущийОбъект.НастройкиПремииЗаТайника.Получить();
	Если НастройкиЗаТайника <> Неопределено Тогда
		ЗначениеВРеквизитФормы(НастройкиЗаТайника, "НастройкиПремииЗаТайника");
	КонецЕсли;	
	
	тзНастройкиОпросПоСкайпу = ТекущийОбъект.НастройкиОпросПоСкайпу.Получить();
	Если тзНастройкиОпросПоСкайпу <> Неопределено Тогда
		ЗначениеВРеквизитФормы(тзНастройкиОпросПоСкайпу, "НастройкиОпросПоСкайпу");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере 
Процедура ПроверитьПересечениеПроцентовВТаблице(ИмяТаблицы, СинонимИмениТаблицы, МассивОшибок, Отказ)
	
	ТаблицаДляПроверки = РеквизитФормыВЗначение(ИмяТаблицы);
	ТаблицаДляПроверки.Сортировать("ПроцентС");
	
	КонтрольноеЧисло = -1;
	Для Каждого СтрТЗ Из ТаблицаДляПроверки Цикл
		
		Если КонтрольноеЧисло >= СтрТЗ.ПроцентС Тогда
			Отказ = Истина;
			МассивОшибок.Добавить("В таблице <<" + СинонимИмениТаблицы + ">> пересечение процентных ставок");
			
			Прервать;
		КонецЕсли;
		
		КонтрольноеЧисло = СтрТЗ.ПроцентС;
		
		Если КонтрольноеЧисло >= СтрТЗ.ПроцентПо Тогда
			Отказ = Истина;
			МассивОшибок.Добавить("В таблице <<" + СинонимИмениТаблицы + ">> пересечение процентных ставок");
			
			Прервать;
		КонецЕсли;
		
		КонтрольноеЧисло = СтрТЗ.ПроцентПо;
		
		// Проверка на процент > 100%
		Если СтрТЗ.ПроцентС > 100 ИЛИ СтрТЗ.ПроцентПо > 100 Тогда
			Отказ = Истина;
			МассивОшибок.Добавить("В таблице <<" + СинонимИмениТаблицы + ">> сущестуют процентные ставки превышающие 100%");
			
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры


