
&НаКлиенте
Процедура ХарактеристикаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	// выбор характеристики
	ПараметрыОткрытияФормыВыбора = Новый Структура;
    ПараметрыОткрытияФормыВыбора.Вставить("Отбор", Новый Структура("Владелец, Неактивная", Запись.Номенклатура, Ложь));
	ФормаВыбора = ПолучитьФорму("Справочник.ХарактеристикиНоменклатуры.ФормаВыбора", ПараметрыОткрытияФормыВыбора, Элемент);
	//ФормаВыбора.ЭлементыФормы.СправочникСписок.НастройкаОтбора.Неактивная.Доступность = Ложь;
	ВыбХарактеристика = ФормаВыбора.ОткрытьМодально();
	Если ВыбХарактеристика = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСтруктуруОстатков()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Дата"				, Запись.Дата);
	Запрос.УстановитьПараметр("Номенклатура"		, Запись.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика"		, Запись.Характеристика);
	Запрос.УстановитьПараметр("ТорговаяТочка"		, Запись.ТорговаяТочка);
	Запрос.УстановитьПараметр("СписокТТ"			, ЭтаФорма.СписокТТ);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница"	, ЭтаФорма.СтруктурнаяЕдиница);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ОстаткиТоваровНаСкладах.КоличествоОстаток) КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Склад.Владелец = &СтруктурнаяЕдиница
	|				И Склад.ВидСклада = ЗНАЧЕНИЕ(Перечисление.ВидыСкладов.Оптовый)
	|				И Номенклатура = &Номенклатура
	|				И (Номенклатура.НеВедетсяУчетПоХарактеристикам
	|					ИЛИ Характеристика = &Характеристика)) КАК ОстаткиТоваровНаСкладах
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ОстаткиРаспределенныеПоТТ.Количество) КАК Количество
	|ИЗ
	|	РегистрСведений.ОстаткиРаспределенныеПоТТ КАК ОстаткиРаспределенныеПоТТ
	|ГДЕ
	|	ОстаткиРаспределенныеПоТТ.Дата = &Дата
	|	И ОстаткиРаспределенныеПоТТ.Номенклатура = &Номенклатура
	|	И ОстаткиРаспределенныеПоТТ.Характеристика = &Характеристика
	|	И ОстаткиРаспределенныеПоТТ.ТорговаяТочка В(&СписокТТ)
	|	И НЕ ОстаткиРаспределенныеПоТТ.ТорговаяТочка = &ТорговаяТочка";
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	СтруктураОстатков = Новый Структура;
	
	мОстаток = 0;
	Выборка = РезультатыЗапроса[0].Выбрать();
	Если Выборка.Следующий()
			 И ЗначениеЗаполнено(Выборка.Количество) Тогда
		мОстаток = Выборка.Количество;
	КонецЕсли;
	СтруктураОстатков.Вставить("ОстатокНаСкладе", мОстаток);
	
	мОстаток = 0;
	Выборка = РезультатыЗапроса[1].Выбрать();
	Если Выборка.Следующий()
			 И ЗначениеЗаполнено(Выборка.Количество) Тогда
		мОстаток = Выборка.Количество;
	КонецЕсли;
	СтруктураОстатков.Вставить("ОстатокРаспределения", мОстаток);
	
	Возврат СтруктураОстатков;
	
КонецФункции

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Если НЕ ЭтаФорма.СтруктурнаяЕдиница.Пустая()
			И НЕ ТекущийОбъект.Количество < ЭтаФорма.ТекущееКоличество Тогда
		СтруктураОстатков = ПолучитьСтруктуруОстатков();
		
		ДоступныйОстатокНаСкладе = СтруктураОстатков.ОстатокНаСкладе - СтруктураОстатков.ОстатокРаспределения;
		
		Если ТекущийОбъект.Количество > ДоступныйОстатокНаСкладе Тогда
			Сообщить("Запись невозможна!" + Символы.ПС + "Недостаточно остатка на складе " + ЭтаФорма.СтруктурнаяЕдиница +
						?(НЕ ДоступныйОстатокНаСкладе = 0, " (" + Формат(ДоступныйОстатокНаСкладе, "ЧГ=") + ").", " (0)."));
			Отказ = Истина;
		КонецЕсли;
 	КонецЕсли;

	Если НЕ Отказ Тогда
		ТекущийОбъект.ДатаРаспределения = ТекущаяДата();
		ТекущийОбъект.Автор				= ПараметрыСеанса.ТекущийПользователь;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтаФорма.СтруктурнаяЕдиница = ЭтаФорма.Параметры.п_Склад;
	ЭтаФорма.СписокТТ 			= ЭтаФорма.Параметры.СписокТТ;
	
	Если ЭтаФорма.СтруктурнаяЕдиница.Пустая() Тогда
		//Сообщить("Редактирование возможно только из интерфейса обработки ""Прогнозирование продаж""!");
		//Отказ = Истина; //mind 2014-07-27 отключил отказ, чтобы дать возможность редактировать
	КонецЕсли;
	
	Если ЭтаФорма.Параметры.Свойство("п_Дата") Тогда
		Запись.Дата 			= ЭтаФорма.Параметры.п_Дата;
	КонецЕсли;
	Если ЭтаФорма.Параметры.Свойство("п_ТорговаяТочка") Тогда
		Запись.ТорговаяТочка 	= ЭтаФорма.Параметры.п_ТорговаяТочка;
	КонецЕсли;
	Если ЭтаФорма.Параметры.Свойство("п_Характеристика") Тогда
		Запись.Характеристика 	= ЭтаФорма.Параметры.п_Характеристика;
	КонецЕсли;
	Если ЭтаФорма.Параметры.Свойство("п_Номенклатура") Тогда
		Запись.Номенклатура 	= ЭтаФорма.Параметры.п_Номенклатура;
	КонецЕсли;
	Если ЭтаФорма.Параметры.Свойство("п_Количество") Тогда
		Запись.Количество 		= ЭтаФорма.Параметры.п_Количество;
	КонецЕсли;
	
	ЭтаФорма.ТекущееКоличество = Запись.Количество;
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ЭтаФорма.ТекущееКоличество = ТекущийОбъект.Количество;
	
КонецПроцедуры
