//+++АК LAGP 2018.05.04 ИП-00018465 Объект создан. Учет расчетов с ТТПерекресток.

Процедура ПередЗаписью(Отказ, Замещение)
	
	МассивПраваРедактированиеРегистраПривязкаСтороннихМагазиновКДоговорам = УправлениеДопПравамиПользователей.ПрочитатьЗначениеПраваПользователя(ПланыВидовХарактеристик.ПраваПользователей.РедактированиеРегистраПривязкаСтороннихМагазиновКДоговорам,Ложь,ПараметрыСеанса.ТекущийПользователь);	
	ПравоПривязкаСтороннихМагазиновКДоговорам = МассивПраваРедактированиеРегистраПривязкаСтороннихМагазиновКДоговорам[0];
	
	Если НЕ ПравоПривязкаСтороннихМагазиновКДоговорам Тогда
		Сообщить("У вас нет дополнительного права ""Редактирование регистра ""Привязка сторонних магазинов к договорам""""");
		Отказ = Истина;	
	КонецЕсли;	
		
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПривязкаСтороннихМагазиновКДоговорамСрезПоследних.Период,
	|	ПривязкаСтороннихМагазиновКДоговорамСрезПоследних.ДоговорКонтрагента,
	|	ПривязкаСтороннихМагазиновКДоговорамСрезПоследних.СтруктурнаяЕдиница
	|ИЗ
	|	РегистрСведений.ПривязкаСтороннихМагазиновКДоговорам.СрезПоследних(
	|			,
	|			ДоговорКонтрагента.ПометкаУдаления = ЛОЖЬ
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И Активный = ИСТИНА) КАК ПривязкаСтороннихМагазиновКДоговорамСрезПоследних";
	
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", ЭтотОбъект.Отбор.СтруктурнаяЕдиница.Значение);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
	Пока ВыборкаДетальныеЗаписи.Следующий() И НЕ Замещение Цикл			
		Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияВопроса", ЭтотОбъект, ВыборкаДетальныеЗаписи);
		ПоказатьВопрос(Оповещение, "В базе уже существует активная привязка с этой структурной единицей: договор - " + ВыборкаДетальныеЗаписи.ДоговорКонтрагента + ", владелец - " + ВыборкаДетальныеЗаписи.ДоговорКонтрагента.Владелец + "." + Символы.ПС + "Желаете изменить активность?", РежимДиалогаВопрос.ДаНет, 0, КодВозвратаДиалога.Да, "Дубль");
	КонецЦикла;	
	
КонецПроцедуры

Процедура ПослеЗакрытияВопроса(Результат, ВыборкаДетальныеЗаписи) Экспорт
 
    Если Результат = КодВозвратаДиалога.Да Тогда
    	ЗаменяемаяЗапись = РегистрыСведений.ПривязкаСтороннихМагазиновКДоговорам.СоздатьМенеджерЗаписи();
		ЗаменяемаяЗапись.Период 			= ВыборкаДетальныеЗаписи.Период;
        ЗаменяемаяЗапись.ДоговорКонтрагента = ВыборкаДетальныеЗаписи.ДоговорКонтрагента;
		ЗаменяемаяЗапись.СтруктурнаяЕдиница = ВыборкаДетальныеЗаписи.СтруктурнаяЕдиница;
		ЗаменяемаяЗапись.Активный     = Ложь;	
		ЗаменяемаяЗапись.Записать();	
		Сообщить("Активность на старой записи убрана.");
    КонецЕсли;	
 
КонецПроцедуры