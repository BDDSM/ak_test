
&НаСервере
Функция ПолучитьДатуСледующейНедели(Номенклатура, Технолог)
	
	//
	РезультатДата = 0;
	
	//
	ТЗ = "ВЫБРАТЬ
	     |	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(МАКСИМУМ(УЕК_ПланыПродажПоДнямНедели.Дата), НЕДЕЛЯ, 1), НЕДЕЛЯ) КАК Дата
	     |ИЗ
	     |	РегистрСведений.УЕК_ПланыПродажПоДнямНедели КАК УЕК_ПланыПродажПоДнямНедели
	     |ГДЕ
	     |	УЕК_ПланыПродажПоДнямНедели.Номенклатура = &Номенклатура
	     |	И УЕК_ПланыПродажПоДнямНедели.Технолог = &Технолог";
		 
	//
	ПЗ = Новый ПостроительЗапроса;
	ПЗ.Текст = ТЗ;
	
	//
	ПЗ.Параметры.Вставить("Номенклатура", Номенклатура);
	ПЗ.Параметры.Вставить("Технолог", Технолог);
	
	//
	ПЗ.Выполнить();
	
	//
	Выборка = ПЗ.Результат.Выбрать();
	Если Выборка.Следующий() Тогда
		
		//
		РезультатДата = Выборка.Дата;
	
	КонецЕсли; 
	
	//
	Возврат РезультатДата;

КонецФункции // ()

&НаСервере
Функция ПолучитьНомерНеделиПоДате(Дата)
	
	//
	РезультатНомерНедели = 0;
	
	//
	ТЗ = "ВЫБРАТЬ
	     |	СоответствиеДатДнямНедели.НомерНедели
	     |ИЗ
	     |	РегистрСведений.СоответствиеДатДнямНедели КАК СоответствиеДатДнямНедели
	     |ГДЕ
	     |	СоответствиеДатДнямНедели.Дата = &Дата";
		 
	//
	ПЗ = Новый ПостроительЗапроса;
	ПЗ.Текст = ТЗ;
	
	//
	ПЗ.Параметры.Вставить("Дата", Дата);
	
	//
	ПЗ.Выполнить();
	
	//
	Выборка = ПЗ.Результат.Выбрать();
	Если Выборка.Следующий() Тогда
		
		//
		РезультатНомерНедели = Выборка.НомерНедели;
	
	КонецЕсли; 
	
	//
	Возврат РезультатНомерНедели;

КонецФункции // ()

&НаСервере
Функция ПолучитьДатуПоНомеруНедели(НомерНедели)
	
	//
	РезультатДата = 0;
	
	//
	ТЗ = "ВЫБРАТЬ
	     |	СоответствиеДатДнямНедели.Дата
	     |ИЗ
	     |	РегистрСведений.СоответствиеДатДнямНедели КАК СоответствиеДатДнямНедели
	     |ГДЕ
	     |	СоответствиеДатДнямНедели.НомерНедели = &НомерНедели";
		 
	//
	ПЗ = Новый ПостроительЗапроса;
	ПЗ.Текст = ТЗ;
	
	//
	ПЗ.Параметры.Вставить("НомерНедели", НомерНедели);
	
	//
	ПЗ.Выполнить();
	
	//
	Выборка = ПЗ.Результат.Выбрать();
	Если Выборка.Следующий() Тогда
		
		//
		РезультатДата = Выборка.Дата;
	
	КонецЕсли; 
	
	//
	Возврат РезультатДата;

КонецФункции // ()

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//ДОБАВЛЕНИЕ НОВОЙ ЗАПИСИ
	Если Параметры.Ключ.Пустой() Тогда
	
		//
		Параметры.Свойство("Номенклатура", Запись.Номенклатура);
		Параметры.Свойство("Технолог", Запись.Технолог);	
		
		//
		Запись.Дата  = ПолучитьДатуСледующейНедели(Запись.Номенклатура, Запись.Технолог); 
		Если НЕ ЗначениеЗаполнено(Запись.Дата) Тогда
			Запись.Дата = НачалоНедели(ТекущаяДата() + 7*24*60*60);
		КонецЕсли; 
		
		//
		Запись.НомерНедели = ПолучитьНомерНеделиПоДате(Запись.Дата);
		
		//
		Запись.ДатаВыставленияПлана = НачалоНедели(ТекущаяДата());
		Запись.НомерНеделиВыставленияПлана = ПолучитьНомерНеделиПоДате(Запись.ДатаВыставленияПлана);
		
		//
		Запись.Автор = ПараметрыСеанса.ТекущийПользователь;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	//
	ТекущийОбъект.Дата = ПолучитьДатуПоНомеруНедели(Запись.НомерНедели);
	
КонецПроцедуры
