

Процедура ОбновитьЦеныСервер()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Обработки.ЗагрузкаДанныхИзAccess.ЗагрузитьДанныеОНачальныхЦенахЗакупки(НачалоМесяца(ДобавитьМесяц(ТекущаяДата(), -1)));
	ДатаОбработки = НачалоМесяца(ДобавитьМесяц(ТекущаяДата(), -1)) + 86400;
	Пока ДатаОбработки <= ТекущаяДата() Цикл
		Обработки.ЗагрузкаДанныхИзAccess.ЗагрузитьДанныеОЦенахЗакупки(ДатаОбработки);
		ДатаОбработки = ДатаОбработки + 86400;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьЦены(Команда)
	
	Предупреждение("Синхронизация цен с Акцессом отключена!", 60);
	Возврат;
	
	ОбновитьЦеныСервер();
	Элементы.Список.Обновить();
	
КонецПроцедуры

Функция НетПраваУдалятьНеРекламныйМатериал(мНоменклатура)
	
	Возврат УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(ПланыВидовХарактеристик.ПраваПользователей.ПолныеПраваПоРекламнымМатериалам, Ложь)
				И НЕ мНоменклатура.РекламныйМатериал;
	
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЕстьПравоРедактировать = УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(ПланыВидовХарактеристик.ПраваПользователей.РедактированиеРегистраЦеныПоставщиков, Ложь)
								ИЛИ УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(ПланыВидовХарактеристик.ПраваПользователей.ПолныеПраваПоРекламнымМатериалам, Ложь);
	ЭтаФорма.ТолькоПросмотр = НЕ ЕстьПравоРедактировать;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка) //+++АК mika 2018.02.21 ИП-00017932
	
	Если ЗначениеЗаполнено(Элемент.ТекущиеДанные.Документ) Тогда                         
		СтандартнаяОбработка = Ложь;
		ОткрытьЗначение(Элемент.ТекущиеДанные.Документ);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр) //+++АК mika 2018.02.21 ИП-00017505
	
	Если Копирование Тогда
		Элемент.ТекущиеДанные.Документ = ПредопределенноеЗначение("Документ.ИзменениеЗакупочныхЦен.ПустаяСсылка");
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура СписокПередУдалением(Элемент, Отказ)
	
	ТекВыделенныеСтроки = Элемент.ВыделенныеСтроки;
	
	Для Каждого ВыделеннаяСтрока Из ТекВыделенныеСтроки Цикл
		ТекДанные = Элемент.ДанныеСтроки(ВыделеннаяСтрока);
		
		Если НетПраваУдалятьНеРекламныйМатериал(ТекДанные.Номенклатура) Тогда
			Сообщить("Нет прав на удаление цен поставщиков не рекламного материала (""" + Строка(ТекДанные.Номенклатура) + """)!");
			Отказ = Истина;
		КонецЕсли;
		
		//+++АК mika 2018.02.21 ИП-00017505
		Если ЗначениеЗаполнено(ТекДанные.Документ) Тогда
			Сообщить("Изменить текущую запись можно только через документ: " + ТекДанные.Документ);
			Отказ = Истина;
		КонецЕсли;
		//---АК mika

	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПередНачаломИзменения(Элемент, Отказ) 
	
	Если ЗначениеЗаполнено(Элемент.ТекущиеДанные.Документ) Тогда
		Сообщить("Изменить текущую запись можно только через документ: " + Элемент.ТекущиеДанные.Документ);
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование) //+++АК mika 2017.11.29 ИП-00016603.01
	
	Если Копирование Тогда
		//+++АК MIND 2017.12.07 не ожидал ..
		//Элемент.ТекущиеДанные.Документ = Документы.ИзменениеЗакупочныхЦен.ПустаяСсылка();
		Элемент.ТекущиеДанные.Документ = ПредопределенноеЗначение("Документ.ИзменениеЗакупочныхЦен.ПустаяСсылка");
	КонецЕсли;

КонецПроцедуры





