
Процедура ПередЗаписью(Отказ, Замещение)
	//+++АК POZM 2018.07.26 ИП-00019351
	Если ЭтотОбъект.ДополнительныеСвойства.Свойство("ОбработанныеПользователи") = Ложь Тогда
		ЭтотОбъект.ДополнительныеСвойства.Вставить("ОбработанныеПользователи",Новый Соответствие);
	КонецЕсли;	
	Для каждого Запись Из ЭтотОбъект Цикл
	
		ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи.Вставить(Запись.Пользователь,Запись.Пользователь);
	
	КонецЦикла; 
	//---АК POZM 	
	//запишем в лог
	Если ЭтотОбъект.ДополнительныеСвойства.Свойство("БылаОчистка") = Ложь
		И ЭтотОбъект.Количество() = 0 Тогда
		УстановитьПривилегированныйРежим(Истина);
		Набор = РегистрыСведений.ГраницыЗапретаИзмененияДанных.СоздатьНаборЗаписей();
		ОтборОрганизация = ЭтотОбъект.Отбор.Найти("Организация");
		ОтборПользователь = ЭтотОбъект.Отбор.Найти("Пользователь");
		Если ОтборОрганизация <> Неопределено
			ИЛИ ОтборПользователь <> Неопределено Тогда
			Если ОтборОрганизация <> Неопределено Тогда
				Набор.Отбор.Организация.Установить(ОтборОрганизация.Значение);
			КонецЕсли;
			Если ОтборПользователь <> Неопределено Тогда
				Набор.Отбор.Пользователь.Установить(ОтборПользователь.Значение);
			КонецЕсли;
			Набор.Прочитать();
			//+++АК POZM 2018.08.01 ИП-00019351
			Для каждого Запись Из Набор Цикл
	
				ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи.Вставить(Запись.Пользователь,Запись.Пользователь);
			
			КонецЦикла; 
			
			Набор.ДополнительныеСвойства.Вставить("ОбработанныеПользователи",ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи);
			//---АК POZM 
			Для Каждого ЗаписьСерт Из Набор Цикл
				Запись = РегистрыСведений.ЛогированиеИзмененийРегистраГраницЗапрета.СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(Запись, ЗаписьСерт);
				Запись.Период = ТекущаяДата();
				Запись.Тип = 0;
				Запись.Действие = "Удалена запись";
				Запись.Ответственный = ПараметрыСеанса.ТекущийПользователь;
				Запись.Записать();
				
				ЗапросПодчиненных = Новый Запрос();
				ЗапросПодчиненных.УстановитьПараметр("ТекПользователь", ПараметрыСеанса.ТекущийПользователь);
				ЗапросПодчиненных.Текст = "ВЫБРАТЬ
				                          |	ГраницыЗапретаИзмененияДанных.Пользователь
				                          |ИЗ
				                          |	РегистрСведений.ГраницыЗапретаИзмененияДанных КАК ГраницыЗапретаИзмененияДанных
				                          |ГДЕ
				                          |	ГраницыЗапретаИзмененияДанных.Пользователь В
				                          |			(ВЫБРАТЬ
				                          |				ПользователиПодчиненныеПользователи.Пользователь
				                          |			ИЗ
				                          |				Справочник.Пользователи.ПодчиненныеПользователи КАК ПользователиПодчиненныеПользователи
				                          |			ГДЕ
				                          |				ПользователиПодчиненныеПользователи.Ссылка = &Ссылка И ПользователиПодчиненныеПользователи.Ссылка <> &ТекПользователь)";
										  
				ЗапросПодчиненных.УстановитьПараметр("Ссылка", ЗаписьСерт.Пользователь);
				Выборка = ЗапросПодчиненных.Выполнить().Выбрать();
				Пока Выборка.Следующий() Цикл
					//+++АК POZM 2018.08.01 ИП-00019333 
					Если ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи.Получить(Выборка.Пользователь)<> Неопределено Тогда
						Продолжить;
					Иначе
						ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи.Вставить(Выборка.Пользователь,Выборка.Пользователь);
					КонецЕсли;	
					//---АК POZM 
					Набор = РегистрыСведений.ГраницыЗапретаИзмененияДанных.СоздатьНаборЗаписей();
					Набор.Отбор.Пользователь.Установить(Выборка.Пользователь);
					//+++АК POZM 2018.08.01 ИП-00019333 
					Набор.ДополнительныеСвойства.Вставить("ОбработанныеПользователи",ЭтотОбъект.ДополнительныеСвойства.ОбработанныеПользователи);
					//---АК POZM 
					Набор.Записать();
				КонецЦикла;	
				
			КонецЦикла;	
			ЭтотОбъект.ДополнительныеСвойства.Вставить("БылаОчистка", Истина);
		КонецЕсли;
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ, Замещение)
	
	Если ЭтотОбъект.ДополнительныеСвойства.Свойство("БылаОчистка") = Ложь Тогда
		УстановитьПривилегированныйРежим(Истина);
		Для Каждого ЗаписьСерт Из ЭтотОбъект Цикл
			Запись = РегистрыСведений.ЛогированиеИзмененийРегистраГраницЗапрета.СоздатьМенеджерЗаписи();
			ЗаполнитьЗначенияСвойств(Запись, ЗаписьСерт);
			Запись.Период = ТекущаяДата();
			Запись.Тип = 1;
			Запись.Действие = "Добавлена запись";
			Запись.Ответственный = ПараметрыСеанса.ТекущийПользователь;
			Запись.Записать();
		КонецЦикла;
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	Для каждого Запись Из ЭтотОбъект Цикл
		Если ЗначениеЗаполнено(Запись.ГраницаЗапретаИзмененийНДС) 
			И ЗначениеЗаполнено(Запись.ГраницаЗапретаИзменений) 
			И Запись.ГраницаЗапретаИзменений < Запись.ГраницаЗапретаИзмененийНДС Тогда
			#Если Клиент Тогда
				Сообщить("Граница запрета изменений НДС не может быть больше границы запрета изменений");			
			#КонецЕсли
			Отказ = Истина;
			
		КонецЕсли;	
	КонецЦикла;	
КонецПроцедуры
