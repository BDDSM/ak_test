
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ТекущийПользователь = ПараметрыСеанса.ТекущийПользователь;
	
	УстановитьДоступностьЭлементов();

КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	СтруктураПараметров = Новый Структура("Организация, ВидАттестации, ФизЛицо, ВремяНачалаТестирования", 
			Запись.Организация, Запись.ВидАттестации, Запись.ФизЛицо, Запись.Период);
			
	ПроверитьНеобходимостьГенерацииНовогоНомераКлиент(СтруктураПараметров);		
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьДоступностьЭлементов()
	
	Элементы.ПротоколПринял.ТолькоПросмотр = НЕ РольДоступна("ПолныеПрава");	
	
КонецПроцедуры

&НаКлиенте
Процедура ПройденаПриИзменении(Элемент)
	
	Запись.ПротоколПринял = ТекущийПользователь;
	
КонецПроцедуры

&НаКлиенте
Процедура НапечататьПротоколКлиент()
	
	НапечататьПротоколАттестации(Новый Структура("Организация, ВидАттестации, ФизЛицо, Период", Запись.Организация, Запись.ВидАттестации, Запись.ФизЛицо, Запись.Период));
	
	Если ТабДок.Области.Количество()> 0 Тогда
		ОткрытьФорму("ОбщаяФорма.ФормаПечати", Новый Структура("ТабДок", ТабДок));
	Иначе
		ПоказатьПредупреждение(,"Отсутствуют данные по установленному отбору! Печать протокола невозможна!");
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура НапечататьПротоколАттестации(СтруктураПараметров)
	
	РегистрыСведений.ИтогиПрохожденияАттестацииСотрудников.НапечататьПротоколАттестации(СтруктураПараметров, ТабДок);
	
КонецПроцедуры

&НаКлиенте
Процедура РаспечататьПротокол(Команда)
	
	НапечататьПротоколКлиент();

КонецПроцедуры

&НаСервере
Процедура ПроверитьНеобходимостьГенерацииНовогоНомераКлиент(СтруктураПараметров)
	
	Если НЕ ЗначениеЗаполнено(Запись.НомерПротокола) Тогда
		Если НЕ ЗначениеЗаполнено(Запись.Период) Тогда
			Запись.Период = НачалоДня(ТекущаяДата());
			СтруктураПараметров.ВремяНачалаТестирования = Запись.Период;
		КонецЕсли;
		
		Для Каждого ЭлементСтруктуры Из СтруктураПараметров Цикл
			Если НЕ ЗначениеЗаполнено(ЭлементСтруктуры.Значение) Тогда
				Возврат;
			КонецЕсли;
		КонецЦикла;
		
		СгенерироватьНомерПротоколаСервер(СтруктураПараметров);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СгенерироватьНомерПротоколаСервер(СтруктураПараметров)
	
	Запись.НомерПротокола = РегистрыСведений.ИтогиПрохожденияАттестацииСотрудников.СгенерироватьНомерПротокола(СтруктураПараметров);
	
КонецПроцедуры

#КонецОбласти

