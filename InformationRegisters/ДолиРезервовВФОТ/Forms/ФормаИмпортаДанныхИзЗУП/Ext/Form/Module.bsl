
&НаКлиенте
Процедура СобратьДанные(Команда)
	СобратьДанныеСервер();
КонецПроцедуры

&НаСервере
Процедура СобратьДанныеСервер()
	ТекстЗапроса="ВЫБРАТЬ
             |	СотрудникиОрганизаций.Физлицо,
             |	МАКСИМУМ(ВЫБОР
             |			КОГДА СотрудникиОрганизаций.Должность.Наименование = ""Продавец-консультант""
             |				ТОГДА ИСТИНА
             |			ИНАЧЕ ЛОЖЬ
             |		КОНЕЦ) КАК Продавец
             |ПОМЕСТИТЬ ПродавецНеПродавец
             |ИЗ
             |	Справочник.СотрудникиОрганизаций КАК СотрудникиОрганизаций
             |
             |СГРУППИРОВАТЬ ПО
             |	СотрудникиОрганизаций.Физлицо
             |;
             |
             |////////////////////////////////////////////////////////////////////////////////
             |ВЫБРАТЬ
             |	СУММА(ВЫБОР
             |			КОГДА ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СчетКт.Код = ""70""
             |				ТОГДА ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Сумма
             |			ИНАЧЕ 0
             |		КОНЕЦ) КАК ФОТ,
             |	СУММА(ВЫБОР
             |			КОГДА ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СчетКт.Код = ""70""
             |					И ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СчетДт.Код = ""96""
             |				ТОГДА ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Сумма
             |			ИНАЧЕ 0
             |		КОНЕЦ) КАК ОТпускные,
             |	НАЧАЛОПЕРИОДА(ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Дата, МЕСЯЦ) КАК Период,
             |	АК_СотрудникиУпрПодразделенийСрезПоследних.Подразделение,
             |	ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Организация,
             |	ПродавецНеПродавец.Продавец
             |ПОМЕСТИТЬ Предварительно
             |ИЗ
             |	Документ.ОтражениеЗарплатыВРеглУчете.ОтражениеВУчете КАК ОтражениеЗарплатыВРеглУчетеОтражениеВУчете
             |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АК_СотрудникиУпрПодразделений.СрезПоследних КАК АК_СотрудникиУпрПодразделенийСрезПоследних
             |		ПО ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СубконтоКт1 = АК_СотрудникиУпрПодразделенийСрезПоследних.ФизЛицо
             |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПродавецНеПродавец КАК ПродавецНеПродавец
             |		ПО ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СубконтоКт1 = ПродавецНеПродавец.Физлицо
             |ГДЕ
             |	ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Проведен
             |	И ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Дата МЕЖДУ &ДатаС И &ДатаПо
             |	И ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.СчетКт.Код = ""70""
             |	И (ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Организация.ИНН = &ИННОрганизации
             |			ИЛИ &ПоВсемОрганизациям)
             |
             |СГРУППИРОВАТЬ ПО
             |	НАЧАЛОПЕРИОДА(ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Дата, МЕСЯЦ),
             |	АК_СотрудникиУпрПодразделенийСрезПоследних.Подразделение,
             |	ОтражениеЗарплатыВРеглУчетеОтражениеВУчете.Ссылка.Организация,
             |	ПродавецНеПродавец.Продавец
             |;
             |
             |////////////////////////////////////////////////////////////////////////////////
             |ВЫБРАТЬ
             |	Предварительно.ФОТ КАК СуммаФОТ,
             |	Предварительно.ОТпускные КАК СуммаОтпусков,
             |	Предварительно.Период КАК Период,
             |	Предварительно.Подразделение КАК Подразделение,
			 |	Предварительно.Подразделение.Наименование КАК ПодразделениеНаименование,
             |	Предварительно.ОТпускные / Предварительно.ФОТ КАК Коэффициент,
             |	Предварительно.Организация КАК Организация,
             |	Предварительно.Продавец КАК Продавцы
             |ИЗ
             |	Предварительно КАК Предварительно
             |
             |УПОРЯДОЧИТЬ ПО
             |	Организация,
             |	Подразделение,
             |	Период";


		СтрокаПодключения = ПолныеПрава.ПолучитьСтрокуПодключения_Зуп();
		v82COMОбъект = Новый COMОбъект(ПолныеПрава.ПолучитьВерсиюКомОбъекта_Зуп() + ".COMConnector");

		Попытка
			v82 = v82COMОбъект.Connect(СтрокаПодключения);
			ПодключениеУстановлено=Истина;
		Исключение
			
			ПодключениеУстановлено=Ложь;
			Сообщить("Не удалось подключиться к базе зарплаты");
			Возврат;
			
		КонецПопытки;
		запрос=v82.NewObject("Запрос");  
		запрос.текст = ТекстЗапроса;
		Запрос.УстановитьПараметр("ДатаС",Период.ДатаНачала);
		Запрос.УстановитьПараметр("ДатаПо",КонецМесяца(Период.ДатаОкончания));
		Запрос.УстановитьПараметр("ИННОрганизации",Организация.ИНН);
		Если ЗначениеЗаполнено(Организация) Тогда
			Запрос.УстановитьПараметр("ПоВсемОрганизациям",Ложь);
		Иначе
			Запрос.УстановитьПараметр("ПоВсемОрганизациям",истина);
		КонецЕсли;	
		Выборка=Запрос.Выполнить().Выбрать();
        Данные.Очистить();
		Пока Выборка.Следующий() Цикл
			Стр=Данные.Добавить();
			ЗаполнитьЗначенияСвойств(Стр,Выборка);
			Если ЗначениеЗаполнено(Выборка.ПодразделениеНаименование) Тогда
				Стр.ЦФО=Справочники.СтруктурныеЕдиницы.ПолучитьСсылку(Новый УникальныйИдентификатор(v82.XmlСтрока(Выборка.Подразделение.УникальныйИдентификатор())));
			КонецЕсли;	
			Стр.Организация=Справочники.Организации.НайтиПоРеквизиту("ИНН",Выборка.Организация.ИНН);
		КонецЦикла;	
		

КонецПроцедуры	

&НаКлиенте
Процедура Записать(Команда)
	ОповеститьОВыборе(Данные);
	//Закрыть();
КонецПроцедуры
