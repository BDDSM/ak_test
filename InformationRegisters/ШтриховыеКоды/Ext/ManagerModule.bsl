
Функция ПроверкаШтрихКода(ШтрихКод, Номенклатура, Характеристика, ВыводитьСообщения = Истина) Экспорт //+++АК mika 2018.02.16 ИП-00017931 Добавлен параметр "ВыводитьСообщения"
	Результат = Истина;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ШтрихкодыНоменклатуры.ШтрихКод,
	|	ШтрихкодыНоменклатуры.Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика,
	|	ПРЕДСТАВЛЕНИЕ(ШтрихкодыНоменклатуры.Номенклатура) КАК НоменклатураПредставление,
	|	ПРЕДСТАВЛЕНИЕ(ШтрихкодыНоменклатуры.Характеристика) КАК ХарактеристикаПредставление
	|ИЗ
	|	РегистрСведений.ШтриховыеКоды КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.ШтрихКод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ОписаниеОшибки = НСтр("ru='Такой штрихкод уже назначен для номенклатуры %Номенклатура%'");
		ОписаниеОшибки = СтрЗаменить(ОписаниеОшибки, "%Номенклатура%", """" + Выборка.НоменклатураПредставление + """"
		                + ?(ЗначениеЗаполнено(Выборка.ХарактеристикаПредставление), " " + НСтр("ru='с характеристикой'") + " """ + Выборка.ХарактеристикаПредставление + """", ""));
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ОписаниеОшибки;
		Сообщение.Поле = "Запись.Штрихкод";
		Сообщение.Сообщить();
		Результат = Ложь
		
	КонецЕсли;
	
	Если СтрДлина(ШтрихКод) = 7 Тогда //это весовой, проверим повторяемость необходимых символов
		Запрос = Новый Запрос();
		//Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		//Запрос.УстановитьПараметр("Характеристика", Характеристика);
		Запрос.УстановитьПараметр("ШтрихКод", "%" + Сред(ШтрихКод, 3, 5) + "%");
		Запрос.Текст = "ВЫБРАТЬ
		               |	ПРЕДСТАВЛЕНИЕ(ШтриховыеКоды.Номенклатура) КАК НоменклатураПредставление,
		               |	ПРЕДСТАВЛЕНИЕ(ШтриховыеКоды.Характеристика) КАК ХарактеристикаПредставление,
		               |	ШтриховыеКоды.ШтрихКод
		               |ИЗ
		               |	РегистрСведений.ШтриховыеКоды КАК ШтриховыеКоды
		               |ГДЕ
		               |	ШтриховыеКоды.ШтрихКод ПОДОБНО &ШтрихКод";
					   
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			Если СтрДлина(Выборка.ШтрихКод) = 7
				И Сред(Выборка.ШтрихКод, 3, 5) = Сред(ШтрихКод, 3, 5) Тогда
				Если ВыводитьСообщения Тогда //+++АК mika 2018.02.16 ИП-00017931
					ОписаниеОшибки = НСтр("ru='Данный идентификатор весового уже назначен для номенклатуры %Номенклатура%'");
					ОписаниеОшибки = СтрЗаменить(ОписаниеОшибки, "%Номенклатура%", """" + Выборка.НоменклатураПредставление + """"
					+ ?(ЗначениеЗаполнено(Выборка.ХарактеристикаПредставление), " " + НСтр("ru='с характеристикой'") + " """ + Выборка.ХарактеристикаПредставление + """", ""));
					Сообщить(ОписаниеОшибки);
				КонецЕсли;
				Результат = Ложь;
			КонецЕсли;	
		КонецЦикла;	
	КонецЕсли;	
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьШтрихКодНоменклатуры(Номенклатура, Характеристика) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ШтрихкодыНоменклатуры.ШтрихКод,
		|	ШтрихкодыНоменклатуры.Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика
		|ИЗ
		|	РегистрСведений.ШтриховыеКоды КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Номенклатура = &Номенклатура
		|	И ШтрихкодыНоменклатуры.Характеристика = &Характеристика");
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Характеристика);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда Возврат ""; КонецЕсли;
	
	ВыборкаЗапроса = РезультатЗапроса.Выбрать();
	ВыборкаЗапроса.Следующий();
	Возврат ВыборкаЗапроса.ШтрихКод;
	
КонецФункции

Функция ГенерироватьНовыйШтрихКод_(Номенклатура) Экспорт //+++АК mika 2018.02.16 ИП-00017931 (Старая процедура отчключена. Добавлен:"_")
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ШтриховыеКоды_НастройкиФормирования.ГенерироватьВесовойШкДляШтучногоТовара,
	               |	ШтриховыеКоды_НастройкиФормирования.ПрефиксШтучногоТовара,
	               |	ШтриховыеКоды_НастройкиФормирования.ДопПрефикс,
	               |	ШтриховыеКоды_НастройкиФормирования.СчетчикШКШтучногоТовара,
	               |	ШтриховыеКоды_НастройкиФормирования.ПрефиксВесового,
	               |	ШтриховыеКоды_НастройкиФормирования.СчетчикВесового,
	               |	ШтриховыеКоды_НастройкиФормирования.ДлинаКодаНоменклатура
	               |ИЗ
	               |	РегистрСведений.ШтриховыеКоды_НастройкиФормирования КАК ШтриховыеКоды_НастройкиФормирования";
	ТабНастройки = Запрос.Выполнить().Выгрузить();
	Если ТабНастройки.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	СтруктураНастроек = ТабНастройки[0];
	
	ГенерироватьВесовойШкДляШтучногоТовара=СтруктураНастроек.ГенерироватьВесовойШкДляШтучногоТовара;
	
	Если НЕ Номенклатура.Весовой Тогда
		Префикс=Формат(СтруктураНастроек.ПрефиксШтучногоТовара,"ЧГ=0");
		Префикс=Префикс+Формат(СтруктураНастроек.ДопПрефикс,"ЧЦ=3; ЧВН=");
		Константа = СтруктураНастроек.СчетчикШКШтучногоТовара;
		НовыйСчетчик = Формат(Константа + 1,"ЧГ=0");
		ЗаписьНастройка = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(ЗаписьНастройка, СтруктураНастроек);
		ЗаписьНастройка.СчетчикШКШтучногоТовара = НовыйСчетчик;
		ЗаписьНастройка.Записать();
		Если ГенерироватьВесовойШкДляШтучногоТовара тогда
			ШК=Строка(Префикс)+ДобавитьСлева(Формат(НовыйСчетчик,"ЧГ=0"),2,"0");
		иначе
			ШК=Префикс+ДобавитьСлева(НовыйСчетчик,7,"0");
			КонтрольнаяЦифраШтрихКода(ШК);
		Конецесли;
		
		
	Иначе
		
		НовыйСчетчик = СтруктураНастроек.СчетчикВесового + 1;
		ЗаписьНастройка = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(ЗаписьНастройка, СтруктураНастроек);
		ЗаписьНастройка.СчетчикВесового = НовыйСчетчик;
		ЗаписьНастройка.Записать();
		
		ШК=Строка(СтруктураНастроек.ПрефиксВесового)+ДобавитьСлева(Формат(НовыйСчетчик,"ЧГ=0"),СтруктураНастроек.ДлинаКодаНоменклатура,"0");
	КонецЕсли;
	
	//проверка на совпадение ШК, если находим то рекурсивно вызываем еще одну генерацию
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ШтриховыеКоды.Номенклатура
	|ИЗ
	|	РегистрСведений.ШтриховыеКоды КАК ШтриховыеКоды
	|ГДЕ
	|	ШтриховыеКоды.ШтрихКод = &ШтрихКод");
	Запрос.УстановитьПараметр("ШтрихКод",ШК);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат ШК;
	Иначе
		ШК = ГенерироватьНовыйШтрихКод(Номенклатура);
	КонецЕсли;

	// Vold: ДЛЯ ИЗМЕНЕНИЯ работает только в транзакции---
	Возврат ШК;
КонецФункции
	  
Функция ДобавитьСлева(Строка1,Длина,Строка2) Экспорт
	Строка0 = Строка1;
	Пока СтрДлина( Строка0 ) < Длина Цикл
		Строка0 = Строка2 + Строка0;
	КонецЦикла;
	Строка0 = Прав( Строка0, Длина );
	Возврат Строка0;
КонецФункции

Процедура КонтрольнаяЦифраШтрихКода(ШтрКод)
	Если СтрДлина(ШтрКод)<>12 Тогда
		Возврат;
	КонецЕсли;	
	Четн = 0;
	Для Индекс = 1 По 6 Цикл
		Четн = Четн + Число(Сред(ШтрКод,2*Индекс,1));
	КонецЦикла;
	Четн = Четн * 3;
	Нечетн = 0;
	Для Индекс = 1 По 6 Цикл
		Нечетн = Нечетн + Число(Сред(ШтрКод,2*Индекс-1,1));
	КонецЦикла;
	КонтЦифра=(Четн+Нечетн)/10-Цел((Четн+Нечетн)/10);
	КонтЦифра=10-Цел(КонтЦифра*10);
	Если КонтЦифра = 10 Тогда
		КонтЦифра = 0;
	КонецЕсли;
	ШтрКод = ШтрКод + Строка(КонтЦифра);
КонецПроцедуры

// Генерирует новые штрихкоды с контролем уникальность в разрезе префиков штучного и весового товаров
// Для "штучного товара" "сквозная" генерация по всем торговым маркам в разрезе префикса (т.е. используется единый счетчик для одинаковых префиксов).
// Для "весового товара" "сквозная" генерация по всем торговым маркам, независимо от префикса.
//
// Параметры:
//  Номенклатура  - <Тип.СправочникСсылка.Номенклатура> - Номенклатура 
//
Функция ГенерироватьНовыйШтрихКод(Номенклатура) Экспорт //+++АК mika 2018.02.16 ИП-00017931
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос();
		
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ШтриховыеКоды_НастройкиФормирования.ТорговаяМарка,
	|	ШтриховыеКоды_НастройкиФормирования.ГенерироватьВесовойШкДляШтучногоТовара,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.ПрефиксШтучногоТовара) КАК ПрефиксШтучногоТовара,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.ДопПрефикс) КАК ДопПрефикс,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.СчетчикШКШтучногоТовара) КАК СчетчикШКШтучногоТовара,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.ПрефиксВесового) КАК ПрефиксВесового,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.СчетчикВесового) КАК СчетчикВесового,
	|	СРЕДНЕЕ(ШтриховыеКоды_НастройкиФормирования.ДлинаКодаНоменклатура) КАК ДлинаКодаНоменклатура,
	|	МАКСИМУМ(ШтриховыеКоды_НастройкиФормирования1.СчетчикШКШтучногоТовара) КАК ТекСчетчикШКШтучногоТовара,
	|	МАКСИМУМ(ШтриховыеКоды_НастройкиФормирования2.СчетчикВесового) КАК ТекСчетчикВесового
	|ИЗ
	|	РегистрСведений.ШтриховыеКоды_НастройкиФормирования КАК ШтриховыеКоды_НастройкиФормирования
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтриховыеКоды_НастройкиФормирования КАК ШтриховыеКоды_НастройкиФормирования1
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтриховыеКоды_НастройкиФормирования КАК ШтриховыеКоды_НастройкиФормирования2
	|		ПО (ИСТИНА)
	|
	|СГРУППИРОВАТЬ ПО
	|	ШтриховыеКоды_НастройкиФормирования.ТорговаяМарка,
	|	ШтриховыеКоды_НастройкиФормирования.ГенерироватьВесовойШкДляШтучногоТовара";
	
	ТабНастройки = Запрос.Выполнить().Выгрузить();
	Если ТабНастройки.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	//Получение настроек по текущей торговой марке
	НайденныеСтроки = ТабНастройки.НайтиСтроки(Новый Структура("ТорговаяМарка", Номенклатура.ТорговаяМарка));
	Если НайденныеСтроки.Количество() > 0 Тогда
		СтруктураНастроек = НайденныеСтроки[0];	
	Иначе
		Возврат "";
	КонецЕсли;
	                                       
	ГенерироватьВесовойШкДляШтучногоТовара = СтруктураНастроек.ГенерироватьВесовойШкДляШтучногоТовара;
	
	Если НЕ Номенклатура.Весовой Тогда
		
		Префикс = Формат(СтруктураНастроек.ПрефиксШтучногоТовара,"ЧГ=0");
		Префикс = Префикс+Формат(СтруктураНастроек.ДопПрефикс,"ЧЦ=3; ЧВН=");
		НовыйСчетчик = Формат(СтруктураНастроек.ТекСчетчикШКШтучногоТовара + 1,"ЧГ=0");
		
		//Получение всех настроек штрихкодирования
		НаборЗаписей = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьНаборЗаписей();
		НаборЗаписей.Прочитать();
		
		Для Каждого ЗаписьНабора Из НаборЗаписей Цикл
			Если ЗаписьНабора.ПрефиксШтучногоТовара = СтруктураНастроек.ПрефиксШтучногоТовара Тогда
				//Запись через менеджер(только совпадающие по штучному префиксу записи)
				ЗаписьНастройка = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(ЗаписьНастройка, ЗаписьНабора);
				ЗаписьНастройка.СчетчикШКШтучногоТовара = НовыйСчетчик;
				ЗаписьНастройка.Записать();
			КонецЕсли;
		КонецЦикла;
		
		Если ГенерироватьВесовойШкДляШтучногоТовара тогда
			ШК=Строка(Префикс)+ДобавитьСлева(Формат(НовыйСчетчик,"ЧГ=0"),2,"0");
		иначе
			ШК=Префикс+ДобавитьСлева(НовыйСчетчик,7,"0");
			КонтрольнаяЦифраШтрихКода(ШК);
		Конецесли;
		
		
	Иначе
		
		НовыйСчетчик = СтруктураНастроек.ТекСчетчикВесового + 1;

		НаборЗаписей = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьНаборЗаписей();
		НаборЗаписей.Прочитать();
		
		Для Каждого ЗаписьНабора Из НаборЗаписей Цикл
			//Запись через менеджер(Единый счетчик для всех префиксов весового товара)
			//Если ЗаписьНабора.ПрефиксВесового = СтруктураНастроек.ПрефиксВесового Тогда
				ЗаписьНастройка = РегистрыСведений.ШтриховыеКоды_НастройкиФормирования.СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(ЗаписьНастройка, ЗаписьНабора);
				ЗаписьНастройка.СчетчикВесового = НовыйСчетчик;
				ЗаписьНастройка.Записать();
			//КонецЕсли;
		КонецЦикла;
		
		ШК = Строка(СтруктураНастроек.ПрефиксВесового)+ДобавитьСлева(Формат(НовыйСчетчик,"ЧГ=0"), СтруктураНастроек.ДлинаКодаНоменклатура,"0");
		
	КонецЕсли;
	
	//Дополнительная проверка наличия ШК
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ШтриховыеКоды.Номенклатура
	|ИЗ
	|	РегистрСведений.ШтриховыеКоды КАК ШтриховыеКоды
	|ГДЕ
	|	ШтриховыеКоды.ШтрихКод = &ШтрихКод");
	Запрос.УстановитьПараметр("ШтрихКод",ШК);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат ШК;
	Иначе
		ШК = ГенерироватьНовыйШтрихКод(Номенклатура);
	КонецЕсли;

	Возврат ШК;

КонецФункции
