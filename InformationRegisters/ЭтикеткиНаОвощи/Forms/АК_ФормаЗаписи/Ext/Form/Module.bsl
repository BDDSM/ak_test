
Функция ПолучитьПоставщика()

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Номенклатура"	, Запись.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика"	, Запись.Характеристика);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЦеныПоставщиковСрезПоследних.Поставщик
	|ИЗ
	|	РегистрСведений.ЦеныПоставщиков.СрезПоследних(
	|			,
	|			Номенклатура = &Номенклатура
	|				И Характеристика = &Характеристика) КАК ЦеныПоставщиковСрезПоследних";
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Поставщик;
	КонецЕсли;
	
	Возврат Справочники.Контрагенты.ПустаяСсылка();

КонецФункции

Функция ПолучитьСрокГодности()
	
	ТекХарактеристика = Запись.Характеристика;
	
	Если ЗначениеЗаполнено(ТекХарактеристика.СрокГодности)
			И ЗначениеЗаполнено(ТекХарактеристика.ТипСрокаГодности) Тогда
		
        Возврат ТекХарактеристика.СрокГодности * ТекХарактеристика.ТипСрокаГодности.КоэффициентВСутках;
		
	КонецЕсли;

	Возврат 0;
	
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СрокГодностиИзХарактеристики = ПолучитьСрокГодности();
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	// запись страны происхождения в характеристику
	СвойствоСтранаПроисхождения = ПланыВидовХарактеристик.СвойстваОбъектов.НайтиПоНаименованию("Страна происхождения");
	Если НЕ СвойствоСтранаПроисхождения = Неопределено
			И НЕ Запись.Характеристика.Пустая() Тогда
		
		СтранаПроисхожденияКЗаписи = СокрЛП(Запись.СтранаПроисхождения);
		СпрСтрана = Справочники.КлассификаторСтранМира.НайтиПоНаименованию(СтранаПроисхожденияКЗаписи);
		Если НЕ СпрСтрана.Пустая() Тогда
			СтранаПроисхожденияКЗаписи = СпрСтрана;
		КонецЕсли;
		
		//
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Объект"	, Запись.Характеристика);
		Запрос.УстановитьПараметр("Свойство", СвойствоСтранаПроисхождения);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗначенияСвойствОбъектов.Значение КАК Значение
		|ИЗ
		|	РегистрСведений.ЗначенияСвойствОбъектов КАК ЗначенияСвойствОбъектов
		|ГДЕ
		|	ЗначенияСвойствОбъектов.Объект = &Объект
		|	И ЗначенияСвойствОбъектов.Свойство = &Свойство";
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Если ЗначениеЗаполнено(Запись.СтранаПроисхождения) Тогда
				СтрокаКПроверке = "";
				Если ТипЗнч(Выборка.Значение) = Тип("Строка") Тогда
					СтрокаКПроверке = Справочники.КлассификаторСтранМира.НайтиПоНаименованию(Выборка.Значение).Наименование;
				ИначеЕсли ТипЗнч(Выборка.Значение) = Тип("СправочникСсылка.КлассификаторСтранМира") Тогда
					СтрокаКПроверке = Выборка.Значение.Наименование;
				КонецЕсли;
				Если НЕ СокрЛП(СтрокаКПроверке) = ""
						И СокрЛП(НРег(СтрокаКПроверке)) = СокрЛП(НРег(Запись.СтранаПроисхождения)) Тогда
					Возврат;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		//
		МенеджерЗаписи = РегистрыСведений.ЗначенияСвойствОбъектов.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Объект 	= Запись.Характеристика;
		МенеджерЗаписи.Свойство = СвойствоСтранаПроисхождения;
		МенеджерЗаписи.Значение = СтранаПроисхожденияКЗаписи;
		МенеджерЗаписи.Записать();
		
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура ХарактеристикаПриИзменении(Элемент)
	
	Запись.Поставщик = ПолучитьПоставщика();
	
	СрокГодностиИзХарактеристики = ПолучитьСрокГодности();
	
КонецПроцедуры

Процедура СрокГодностиПриИзмененииСервер()
	
	УстановитьПривилегированныйРежим(Истина);
	
	// запись сроков годности в характеристику
	ОбХар = Запись.Характеристика.ПолучитьОбъект();
	ОбХар.СрокГодности		= СрокГодностиИзХарактеристики;
	ОбХар.ТипСрокаГодности	= Справочники.ТипыСроковГодности.НайтиПоКоду("000000001");
	ОбХар.Записать();
	
КонецПроцедуры

&НаКлиенте
Процедура СрокГодностиПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Запись.Характеристика) Тогда
		СрокГодностиПриИзмененииСервер();
	КонецЕсли;
	
КонецПроцедуры
 