
Процедура ПриОткрытии()
	
	ОтборП = РегистрСведенийСписок.Отбор.Пользователь;
	ОтборП.Использование 	= Истина;
	ОтборП.ВидСравнения 	= ВидСравнения.Равно;
	//+++ AK suvv 19.06.2018 ИП-00018230
	//ОтборП.Значение 		= ОбработкаФорум.ТекущийПользователь;
	ТекПользовательФорума   = ПолучитьТекущегоПользователяФорума();
	ОтборП.Значение         = ТекПользовательФорума;
	//--- AK suvv
	
КонецПроцедуры

//+++ AK suvv 19.06.2018 ИП-00018230
// перенесена из модуля формы обработки Форум
Функция ПолучитьТекущегоПользователяФорума()  
	
	Попытка //типовая 
		
		Если НЕ ЗначениеЗаполнено(ПараметрыСеанса.ТекущийПользователь) Тогда
			ВызватьИсключение "Пользователь не авторизован в программе (нет в справочнике пользователи)";
		КонецЕсли;	
		
		Пользователь = Справочники.ФорумПользователи.НайтиПоРеквизиту("Пользователь", ПараметрыСеанса.ТекущийПользователь);
		Если НЕ ЗначениеЗаполнено(Пользователь) Тогда
			ПользовательОб = Справочники.ФорумПользователи.СоздатьЭлемент();
			ПользовательОб.Код 					= ПараметрыСеанса.ТекущийПользователь.Код;
			ПользовательОб.Наименование 		= ПараметрыСеанса.ТекущийПользователь.Наименование;
			ПользовательОб.Пользователь 		= ПараметрыСеанса.ТекущийПользователь;
			ПользовательОб.Аватар 				= БиблиотекаКартинок.NoAvatar;
			ПользовательОб.КоличествоСообщений 	= 0;
			ПользовательОб.Записать();
			Пользователь = ПользовательОб.Ссылка;
		КонецЕсли;
		
	Исключение //не типовая ипользуем функцию ИмяПользователя()
		
		Пользователь = Справочники.ФорумПользователи.НайтиПоНаименованию(ИмяПользователя(), Истина);
		Если НЕ ЗначениеЗаполнено(Пользователь) Тогда
			ПользовательОб = Справочники.ФорумПользователи.СоздатьЭлемент();
			ПользовательОб.Код 			= ИмяПользователя();
			ПользовательОб.Наименование = ИмяПользователя();
			//ПользовательОб.Пользователь = ПараметрыСеанса.ТекущийПользователь;
			ПользовательОб.Аватар 		= БиблиотекаКартинок.NoAvatar;
			ПользовательОб.КоличествоСообщений = 0;
			ПользовательОб.Записать();
			Пользователь = ПользовательОб.Ссылка;
		КонецЕсли;
		
	КонецПопытки;
	
	Возврат Пользователь;
	
КонецФункции //--- AK suvv

Процедура РегистрСведенийСписокТемаПриИзменении(Элемент)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Форум.Тема,
	|	МАКСИМУМ(Форум.Номер) КАК Номер
	|ИЗ
	|	РегистрСведений.Форум КАК Форум
	|
	|СГРУППИРОВАТЬ ПО
	|	Форум.Тема";
	ТЗ = Запрос.Выполнить().Выгрузить();
	Если ТЗ.Количество() Тогда
		ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные.Номер = ТЗ[0].Номер;
	КонецЕсли;	
	//+++ AK suvv 19.06.2018 ИП-00018230
	//ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные.Пользователь = ОбработкаФорум.ТекущийПользователь;
	ЭлементыФормы.РегистрСведенийСписок.ТекущиеДанные.Пользователь = ПолучитьТекущегоПользователяФорума();
	//--- AK suvv
	
КонецПроцедуры
