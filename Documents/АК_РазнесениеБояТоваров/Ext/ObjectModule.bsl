//АК БЕЛН 13.08.2017+
Процедура ПриЗаписи(Отказ)
	УстановитьПривилегированныйРежим(Истина);
	МасТТ=Новый Массив;
	Для каждого Стр Из ТорговыеТочки Цикл
		Если Стр.Внимание Тогда
			МасТТ.Добавить(Стр.ТорговаяТочка);
		КонецЕсли; 
	КонецЦикла; 

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ Различные
		|	СоответствиеОбъектРольСрезПоследних.Объект,
		|	РолиПользователейСоставРоли.Сотрудник,
		|	СоответствиеОбъектРольСрезПоследних.РольПользователя
		|ИЗ
		|	РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(
		|			&Дата,
		//+++ AK suvv 2018.06.08 ИП-00018376.01
		//|			ТипРоли = &ТипРоли
		|			(ТипРоли = &ТипРоли ИЛИ ТипРоли = &ТипРолиСторонняяРозница)
		//--- AK suvv
		|				И Объект В (&Объекты)) КАК СоответствиеОбъектРольСрезПоследних
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
		|		ПО (ВЫБОР
		|				КОГДА СоответствиеОбъектРольСрезПоследних.РольПользователя в иерархии (&Группа2)
		|					ТОГДА РолиПользователейСоставРоли.Ссылка.Код = ""00053""
		|				КОГДА СоответствиеОбъектРольСрезПоследних.РольПользователя в иерархии (&Группа3)
		|					ТОГДА РолиПользователейСоставРоли.Ссылка.Код = ""00064""
		|				КОГДА СоответствиеОбъектРольСрезПоследних.РольПользователя в иерархии (&Группа1)
		|					ТОГДА РолиПользователейСоставРоли.Ссылка.Код = ""00071""
		|               Иначе РолиПользователейСоставРоли.Ссылка=&ГруппаР
		|			КОНЕЦ)";

	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("Объекты", МасТТ);
	Запрос.УстановитьПараметр("Группа1", Справочники.РолиПользователей.НайтиПоКоду("00039"));
	Запрос.УстановитьПараметр("Группа2", Справочники.РолиПользователей.НайтиПоКоду("00048"));
	Запрос.УстановитьПараметр("Группа3", Справочники.РолиПользователей.НайтиПоКоду("00057"));
	Запрос.УстановитьПараметр("ГруппаР", Справочники.РолиПользователей.НайтиПоКоду("00076"));
	
	Запрос.УстановитьПараметр("ТипРоли", ПланыВидовХарактеристик.ТипыРолейПользователя.ПомощникТерриториальногоУправляющего);
	//+++ AK suvv 2018.06.08 ИП-00018376.01 
	Запрос.УстановитьПараметр("ТипРолиСторонняяРозница", ПланыВидовХарактеристик.ТипыРолейПользователя.ПомощникСтороннейРозницы);
	//--- AK suvv
	Результат = Запрос.Выполнить();

	ТЗАдресаты = Результат.Выгрузить();
 

	
	
	Для каждого Стр Из ТорговыеТочки Цикл
		Если Стр.Внимание Тогда
			СтрАдр=ТЗАдресаты.Найти(Стр.ТорговаяТочка);	
			Если СтрАдр=Неопределено Тогда
				Продолжить;
			КонецЕсли; 
			МасФЛ=Новый Массив;
			МасФл.Добавить(СтрАдр.Сотрудник);
			ОтправитьПисьмо("Внимание! Неправильный бой - "+Строка(Стр.ТорговаяТочка)+", "+Строка(Стр.Номенклатура)+", количество - "+Строка(Стр.Колво)+", сумма - "+Строка(Стр.Сумма),МасФЛ,Стр.АдресКартинки);

		КонецЕсли; 
	КонецЦикла; 
	
КонецПроцедуры

Процедура ОтправитьПисьмо(Текст,МасФЛ,СтрФайл)
	
	СтруктураНовогоПисьма 	= Новый Структура;
	СтруктураНовогоПисьма.Вставить("ВидТекста", Перечисления.ВидыТекстовЭлектронныхПисем.Текст);
	
	СписокФайловВложений 	= Новый СписокЗначений;
	
	КоличествоКартинокПоСтроке=СтрЧислоВхождений(СтрФайл,"№№№№");
	МассивКартинок=Новый Массив;
	ОсталосьОбработать=СокрЛП(СтрФайл);
	Пока ОсталосьОбработать<>"" и КоличествоКартинокПоСтроке>0 цикл
		ОсталосьОбработать=Сред(ОсталосьОбработать,5);//отрезаем первые символы
		НачалоСледующейКартинки=Найти(ОсталосьОбработать,"№№№№");
		Если НачалоСледующейКартинки>0 тогда
			ТекущаяКартинка=Лев(ОсталосьОбработать,НачалоСледующейКартинки-1);
			ОсталосьОбработать=Сред(ОсталосьОбработать,НачалоСледующейКартинки);
		Иначе
			ТекущаяКартинка=ОсталосьОбработать;
			ОсталосьОбработать="";
		КонецЕсли;
		Если ЗначениеЗаполнено(СокрЛП(ТекущаяКартинка)) Тогда
			СписокФайловВложений.Добавить(Новый Структура("ИмяФайла",ТекущаяКартинка));
		КонецЕсли; 
    КонецЦикла;
	//
	СтруктураНовогоПисьма.Вставить("Тема", Текст);
	СтруктураНовогоПисьма.Вставить("Тело", Текст);
	
	
	
	СтруктураНовогоПисьма.Вставить("СписокФайловВложений", СписокФайловВложений);
	
	Кому 			= Новый СписокЗначений;
	
	//
 
	
	
	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Объект", МасФЛ);
	Запрос.Текст =                                                                                   
	"ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект В(&Объект)
	|	И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)";
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество()>0 Тогда
		Пока Выборка.Следующий() Цикл
			Если Кому.НайтиПоЗначению(Выборка.Представление) = Неопределено Тогда
				Кому.Добавить(Выборка.Представление);
			КонецЕсли; 
		КонецЦикла;
	Иначе
		Возврат;
	КонецЕсли;
	
	СтруктураНовогоПисьма.Вставить("Кому", Кому);
	
	
	СтрКому = "";
	Для каждого Эл Из Кому Цикл
		СтрКому = СтрКому + Эл.Значение + "; ";
	КонецЦикла; 
	Попытка
		ОбщегоНазначенияКлиентСервер.ОтправитьПисьмоПоПочте(СтруктураНовогоПисьма);
		Сообщить("Отправлено письмо о предупреждении на " + СтрКому);
	Исключение
		Сообщить(ОписаниеОшибки());
	КонецПопытки; 
	
	
КонецПроцедуры
//АК БЕЛН 13.06.2017-
