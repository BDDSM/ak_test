
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПутьНаКлиенте = КаталогМоиДокументы() + "VideoCallRecords\";
	КаталогНаДиске = Новый Файл(ПутьНаКлиенте);
    Если КаталогНаДиске.Существует() Тогда
        
    Иначе
		СоздатьКаталог(КаталогНаДиске);
	КонецЕсли;	
	Если ПодключитьРасширениеРаботыСФайлами() = Ложь Тогда
		УстановитьРасширениеРаботыСФайлами(); 
	КонецЕсли;
	
	НайденныеФайлы = НайтиФайлы(ПутьНаКлиенте, "*.*");
	Для каждого Файл Из НайденныеФайлы Цикл
		НС = ТабФайловКПрикреплению.Добавить();
		НС.Путь = Файл.ПолноеИмя;
	КонецЦикла;	

КонецПроцедуры

&НаКлиенте
Функция КаталогМоиДокументы() Экспорт
	
	App = Новый COMОбъект("Shell.Application");
	
	Folder = App.Namespace(5);
	
	Результат = "";
	
	Попытка
		
		Результат = Folder.Self.Path;
		
	Исключение
		
		Результат = "";
		
	КонецПопытки;
	
	Если Результат = "" Тогда
		
		Результат = КаталогВременныхФайлов();
		
	КонецЕсли; 
	
	//
	Возврат Результат + "\";
	
КонецФункции

&НаКлиенте
Процедура ДобавитьФайлы(Команда)
	Режим = РежимДиалогаВыбораФайла.Открытие;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Каталог = ПутьНаКлиенте;
	ДиалогОткрытияФайла.МножественныйВыбор = Истина;
	ДиалогОткрытияФайла.Заголовок = "Выберите файлы с записью экзамена";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
	    МассивФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
	    Для Каждого ИмяФайла Из МассивФайлов Цикл
	        НС = ТабФайловКПрикреплению.Добавить();
			НС.Путь = ИмяФайла;
	    КонецЦикла;
	Иначе
	    
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ПутьХраненияВидеоНаСервере()
	
	Возврат Константы.ПутьХраненияВидеоТестированияПродавцов.Получить();
	
КонецФункции


&НаСервере
Процедура ПереместитьФайлИзХранилищаВПапкуХраненияВидеоНаСервере(АдресВХранилище,НовоеИмя,Расширение)
	
	ДвоичныеДанные 		= ПолучитьИзВременногоХранилища(АдресВХранилище);
	ИмяВременногоФайла 	= ПолучитьИмяВременногоФайла(Расширение); 
	
	ДвоичныеДанные.Записать(ИмяВременногоФайла);
	
	ПереместитьФайл(ИмяВременногоФайла,НовоеИмя);
	
КонецПроцедуры	

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	ПутьНаСервере = ПутьХраненияВидеоНаСервере();
	Для каждого Стр Из Объект.ВидеоЗаписи Цикл
	
		Если СокрЛП(Стр.ПутьКФайлуВидео) = "" Тогда
		
			Объект.ВидеоЗаписи.Удалить(Объект.ВидеоЗаписи.Индекс(Стр));
		
		КонецЕсли; 
	
	КонецЦикла; 
	//Объект.ВидеоЗаписи.Очистить();
	Для каждого СтрокаФайла Из ТабФайловКПрикреплению Цикл
	
		Состояние("Передача на сервер файла "+СтрокаФайла.Путь);
		
		Попытка
			НС = Объект.ВидеоЗаписи.Добавить();
			Файл = Новый Файл(СтрокаФайла.Путь);
			ДвоичДанные = Новый ДвоичныеДанные(СтрокаФайла.Путь);
			Адрес = ПоместитьВоВременноеХранилище(ДвоичДанные, Новый УникальныйИдентификатор);
			ИмяТекущегоФайла = "Экз_" + СокрЛП(Объект.Продавец) + "_Стр_" + НС.НомерСтроки + Формат(Объект.Дата, "ДФ=ddMMyyyy") + "_"+файл.Расширение;
			НС.ПутьКФайлуВидео = ПутьНаСервере + "\" + ИмяТекущегоФайла;
			ПереместитьФайлИзХранилищаВПапкуХраненияВидеоНаСервере(Адрес, НС.ПутьКФайлуВидео, Файл.Расширение);
			УдалитьФайлы(СтрокаФайла.Путь);
			ТабФайловКПрикреплению.Удалить(ТабФайловКПрикреплению.Индекс(СтрокаФайла));
		Исключение	
			Сообщение = Новый СообщениеПользователю();
		    Сообщение.Текст = "Ошибка при помещении файла в хранилище: " + Файл.ПолноеИмя+ОписаниеОШибки();
		    
		    Сообщение.УстановитьДанные(Объект.Ссылка);
		    Сообщение.Сообщить();
			
			Продолжить;
		КонецПопытки;
		
	
	КонецЦикла; 
	

КонецПроцедуры
