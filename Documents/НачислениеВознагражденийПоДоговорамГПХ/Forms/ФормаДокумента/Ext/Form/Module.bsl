

&НаСервере
Функция ЭтоРуководительПодразделения()
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("Пользователь", ПараметрыСеанса.ТекущийПользователь);
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	ПраваПользователейНаРедактированиеГрафиков.Подразделение
	               |ИЗ
	               |	РегистрСведений.ПраваПользователейНаРедактированиеГрафиков КАК ПраваПользователейНаРедактированиеГрафиков
	               |ГДЕ
	               |	ПраваПользователейНаРедактированиеГрафиков.Пользователь = &Пользователь";
				   
	Результат = Запрос.Выполнить();
	Возврат (НЕ Результат.Пустой());
	
КонецФункции

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтаФорма.Элементы.СоставПодписан.ТолькоПросмотр = Истина;
	
	Элементы.Статус.Доступность = ЭтоРуководительПодразделения();
	
	Если Объект.Статус.Пустая() Тогда
		Объект.Статус = Перечисления.СтатусСогласования.НеСогласовано;
	КонецЕсли;
	
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	Иначе
		Если ПараметрыСеанса.ТекущийПользователь <> Объект.Ответственный Тогда
			Если ПараметрыСеанса.ТекущийПользователь = Объект.Утверждающий Тогда
				СделатьВсеНедоступнымиКромеСтатуса();
			Иначе
				Право1 = ПланыВидовХарактеристик.ПраваПользователей.ПросмотрВсехНачисленийГПХ;
				ЗначПрава1 = УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(Право1, Ложь);
				Если ЗначПрава1 = Истина Тогда
					ЭтаФорма.ТолькоПросмотр = Истина;	
				Иначе
					Отказ = Истина;
					Сообщить("Недостаточно прав на просмотр документа");
					Возврат;
				КонецЕсли;
			КонецЕсли;
		Иначе
			Если Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусСогласования.Согласовано") Тогда
				Если ПараметрыСеанса.ТекущийПользователь = Объект.Утверждающий Тогда
					СделатьВсеНедоступнымиКромеСтатуса();
				Иначе
					ЭтаФорма.ТолькоПросмотр = Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		//+++АК sole 2018.10.02 ИП-00019785.02
		Если ЭтаФорма.Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусСогласования.НаСогласовании") Тогда
			СделатьВсеНедоступнымиКромеСтатуса();
		КонецЕсли;
		//---АК sole 2018.10.02 ИП-00019785.02
		
		ГраницаЗапретаРедактирования = Константы.ГраницаЗапретаРедактированияНачисленияПремий.Получить();
		Если КонецДня(ГраницаЗапретаРедактирования) >= КонецДня(Объект.Дата) Тогда
			ЭтаФорма.ТолькоПросмотр = Истина;
		КонецЕсли; 
		
		
	КонецЕсли;
	
КонецПроцедуры

Процедура СделатьВсеНедоступнымиКромеСтатуса()

	Для каждого Эл1 Из Элементы Цикл
		Если Эл1.Имя = "Статус" ИЛИ Эл1.Имя = "НомерИДата"
		ИЛИ Эл1.Имя = "ФормаКоманднаяПанель" ИЛИ ТипЗнч(Эл1) = Тип("КнопкаФормы") Тогда
			Продолжить;
		КонецЕсли;
		Попытка
			Эл1.Доступность = Ложь;
		Исключение
		КонецПопытки;
		
	КонецЦикла;

КонецПроцедуры


&НаКлиенте
Процедура УтверждающийНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СписокПользователей = Новый СписокЗначений;

	УтверждающийНачалоВыбораСервер(СписокПользователей);
		
	Отбор = Новый Структура("Ссылка", СписокПользователей);
	ПараметрыОткрытия = Новый Структура("Отбор", Отбор);
	
	ОткрытьФорму("Справочник.Пользователи.ФормаВыбора", ПараметрыОткрытия, Элемент);
	
КонецПроцедуры

&НаСервере
Процедура УтверждающийНачалоВыбораСервер(СписокПользователей)
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПраваПользователейНаРедактированиеГрафиков.Пользователь
	|ИЗ
	|	РегистрСведений.ПраваПользователейНаРедактированиеГрафиков КАК ПраваПользователейНаРедактированиеГрафиков");
	
	МассивПользователей = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Пользователь");
	СписокПользователей.ЗагрузитьЗначения(МассивПользователей);

КонецПроцедуры	

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	//+++АК sole 2018.09.25 ИП-00019785
	//Если Объект.Проведен Тогда
	//	Режим = РежимДиалогаВопрос.ДаНет;
	//	Текст = "ru = ""Отправить письмо утверждающему?"";";
	//	Ответ = Вопрос(НСтр(Текст), Режим, 0);
	//	Если Ответ = КодВозвратаДиалога.Да Тогда
	//		ОтправитьПисьмоСервер();
	//	КонецЕсли;
	//КонецЕсли;
	//---АК sole 2018.09.25 ИП-00019785
	
	//+++АК sole 2018.10.02 ИП-00019785.02
	Если ЭтаФорма.Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусСогласования.НаСогласовании") Тогда
		СделатьВсеНедоступнымиКромеСтатуса();	
	КонецЕсли;
	//---АК sole 2018.10.02 ИП-00019785.02
	
КонецПроцедуры

&НаСервере
Процедура ОтправитьПисьмоСервер()
	
	СписокКому = Новый СписокЗначений;
	
	Запрос = Новый Запрос;
	Запрос.Текст =                                                                                   
	"ВЫБРАТЬ                                                   
	|	КонтактнаяИнформация.Представление
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Объект = &Объект
	|	И КонтактнаяИнформация.Тип = &Тип
	|	И КонтактнаяИнформация.Вид = Значение(Справочник.ВидыКонтактнойИнформации.EmailФизЛица)";
	
	Запрос.УстановитьПараметр("Объект", Объект.Утверждающий.ФизЛицо);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = Результат.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		
	Иначе
		Сообщить("Не заполнен адрес электронной почты у утверждающего!!");
		Возврат;
	КонецЕсли;
	
	СпАдресов=Новый СписокЗначений;
	МассивАдресов=Справочники.Контрагенты.РазложитьСтрокуВМассивПодстрок(ВыборкаДетальныеЗаписи.Представление,";");	
	Для каждого Эл Из МассивАдресов Цикл
		Если ЗначениеЗаполнено(Эл) Тогда
			СписокКому.Добавить(СокрЛП(Эл));
		КонецЕсли; 
	КонецЦикла; 
	
	//СписокКому.Добавить(ВыборкаДетальныеЗаписи.Представление);
	//СписокКому.Добавить("retail.e@vkusvill.ru");
	//СписокКому.Добавить("pozm@automacon.ru");
	
	УчетнаяЗапись = ОбщиеПроцедуры.ПолучитьУчетнуюЗаписьДляРассылки();
	
	Почта = Новый ИнтернетПочта;
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
	Письмо = Новый ИнтернетПочтовоеСообщение;
	
	Почта.Подключиться(Профиль);
	Письмо.Тема = ""+Объект.Ссылка+" - ждёт Вашего утверждения";
	Письмо.ИмяОтправителя 	= "" + УчетнаяЗапись + "";
	Письмо.ИмяОтправителя  	= "" + СокрЛП(УчетнаяЗапись) + "";
	Письмо.Отправитель     	= "" + СокрЛП(УчетнаяЗапись) + "";
	Для Каждого ПолучательЭлемент Из СписокКому Цикл
		Получатель = Письмо.Получатели.Добавить();
		Получатель.Адрес = ПолучательЭлемент.Значение;
	КонецЦикла;	
	
	ТекстСообщения = Письмо.Тексты.Добавить();
	ТекстСообщения.Текст     = ""+Объект.Ссылка+" - ждёт Вашего утверждения";
	ТекстСообщения.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
	
	//Письмо.Вложения.Добавить(ИмяФайла);
	
	//	Если НЕ ОбщегоНазначения.ЭтоКопияБазы() Тогда
	попытка
		Почта.Послать(Письмо);
	исключение
		Сообщить(ОписаниеОшибки());
	КонецПопытки;	
	//	КонецЕсли;	
	Почта.Отключиться();
	
КонецПроцедуры


&НаКлиенте
Процедура СоставФизЛицоПриИзменении(Элемент)
	
	ФЛ1 = Элементы.Состав.ТекущиеДанные.ФизЛицо;
	Если ФизЛицоВГрафике(ФЛ1) Тогда
		Элементы.Состав.ТекущиеДанные.ФизЛицо = Неопределено;
		Сообщить(НСтр("ru = 'Выбранный сотрудник присутствует в графиках'"));
	КонецЕсли;
	
КонецПроцедуры

Функция ФизЛицоВГрафике(ФизЛицо)

	Запрос1 = Новый Запрос;
	Запрос1.Текст = 
	"ВЫБРАТЬ
	|	ТабельРаботыВнештатныхСотрудников.Группа КАК ГруппаИлиТТ
	|ИЗ
	|	РегистрСведений.ТабельРаботыВнештатныхСотрудников КАК ТабельРаботыВнештатныхСотрудников
	|ГДЕ
	|	ТабельРаботыВнештатныхСотрудников.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТабельРаботыВнештатныхСотрудников.Сотрудник = &ФизЛицо
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТабельРаботыГрузчиков.Группа
	|ИЗ
	|	РегистрСведений.ТабельРаботыГрузчиков КАК ТабельРаботыГрузчиков
	|ГДЕ
	|	ТабельРаботыГрузчиков.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТабельРаботыГрузчиков.Сотрудник = &ФизЛицо
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТабельРаботыКассиров.Группа
	|ИЗ
	|	РегистрСведений.ТабельРаботыКассиров КАК ТабельРаботыКассиров
	|ГДЕ
	|	ТабельРаботыКассиров.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТабельРаботыКассиров.Сотрудник = &ФизЛицо
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТабельРаботыПродавцов.Группа
	|ИЗ
	|	РегистрСведений.ТабельРаботыПродавцов КАК ТабельРаботыПродавцов
	|ГДЕ
	|	ТабельРаботыПродавцов.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТабельРаботыПродавцов.Сотрудник = &ФизЛицо
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТабельРаботыПромоутеров.Группа
	|ИЗ
	|	РегистрСведений.ТабельРаботыПромоутеров КАК ТабельРаботыПромоутеров
	|ГДЕ
	|	ТабельРаботыПромоутеров.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ТабельРаботыПромоутеров.Сотрудник = &ФизЛицо";
	
	Запрос1.УстановитьПараметр("ДатаНач", НачалоМесяца(Объект.МесяцИГодНачисления));
	Запрос1.УстановитьПараметр("ДатаКон", КонецМесяца(Объект.МесяцИГодНачисления));
	Запрос1.УстановитьПараметр("ФизЛицо", ФизЛицо);
	
	Рез1 = Запрос1.Выполнить();
	Если Рез1.Пустой() Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;

КонецФункции // ()

//+++АК sole 2018.09.26 ИП-00019785.01
&НаКлиенте
Процедура ВыгрузитьВЗУП(Команда)

	Если ЭтаФорма.Модифицированность Тогда
		Сообщить("Перед выгрузкой изменений, документ необходимо сохранить!");
		Возврат;
	КонецЕсли;
	
	ВыгрузитьВЗУП_НаСервере();
	
КонецПроцедуры

//+++АК sole 2018.09.26 ИП-00019785.01
&НаСервере
Процедура ВыгрузитьВЗУП_НаСервере()
		
	Документы.НачислениеВознагражденийПоДоговорамГПХ.ВыгрузитьВЗУП(Объект.Ссылка);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьНаСогласование(Команда)
	
	Если Объект.Статус <> ПредопределенноеЗначение("Перечисление.СтатусСогласования.НаСогласовании") Тогда
		Объект.Статус = ПредопределенноеЗначение("Перечисление.СтатусСогласования.НаСогласовании");
		ЭтаФорма.Записать();
	КонецЕсли;
	
	Если ЭтаФорма.Модифицированность Тогда
		Сообщить("Перед отправкой письма на согласование документ необходимо сохранить!");
		Возврат;
	КонецЕсли;

	ОтправитьНаСогласование_НаСервере();
КонецПроцедуры

&НаСервере
Процедура ОтправитьНаСогласование_НаСервере()
	ОбъектДокумента = РеквизитФормыВЗначение("Объект");
	ОбъектДокумента.ОтправитьНаСогласование();
КонецПроцедуры

//+++АК kats 2018.10.31 ИП-00019785.03
&НаСервере
Процедура ОбновитьДанныеКолонкиСуммаСУчетомНДФЛ()

	Для каждого Стр Из Объект.Состав Цикл
	
		Стр.СуммаСУчетомНДФЛ = Документы.НачислениеВознагражденийПоДоговорамГПХ.РассчитатьСуммуСУчетомНДФЛ(Стр.Сумма);
	
	КонецЦикла;
	
КонецПроцедуры
//---АК kats

&НаКлиенте
Процедура СоставСуммаПриИзменении(Элемент)
	
	//+++АК kats 2018.10.31 ИП-00019785.03
	ТекущиеДанные = Элементы.Состав.ТекущиеДанные;
	ТекущиеДанные.СуммаСУчетомНДФЛ = Документы.НачислениеВознагражденийПоДоговорамГПХ.РассчитатьСуммуСУчетомНДФЛ(ТекущиеДанные.Сумма);
	//---АК kats
	
КонецПроцедуры


&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	//+++АК kats 2018.10.31 ИП-00019785.03
	ОбновитьДанныеКолонкиСуммаСУчетомНДФЛ();
	//---АК kats 
	
КонецПроцедуры


&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	//+++АК kats 2018.10.31 ИП-00019785.03
	ОбновитьДанныеКолонкиСуммаСУчетомНДФЛ();
	//---АК kats
	
КонецПроцедуры

