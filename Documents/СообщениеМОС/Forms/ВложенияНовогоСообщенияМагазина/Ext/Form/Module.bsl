
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ТЗВложений.Загрузить(ДанныеФормыВЗначение(Параметры.ТЗВложений, Тип("ТаблицаЗначений")));
	НомерСообщения = Параметры.НомерСообщения;
		
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьВложения(Команда)
	
	Закрыть(ТЗВложений);
	
КонецПроцедуры

&НаКлиенте
Процедура ТЗВложенийИмяФайлаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл...";
	Диалог.ПроверятьСуществованиеФайла = Истина;
	Диалог.МножественныйВыбор = Ложь;
	

	Если Не Диалог.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	СтрФайла = Новый Структура;
	СтрФайла.Вставить("ПолноеИмяФайла", Диалог.ПолноеИмяФайла);
	СтрФайла.Вставить("Каталог", Диалог.Каталог);
	СтрФайла.Вставить("ИмяФайла", СтрЗаменить(Диалог.ПолноеИмяФайла, Диалог.Каталог, ""));
	
	
	
	ЗаполнитьПолноеИмяФайлаПриемника(СтрФайла);
	
	КопироватьФайл(СтрФайла.ПолноеИмяФайла, СтрФайла.ПолноеИмяФайла2);
	
	//------------------
	Элементы.ТЗВложений.ТекущиеДанные.ПолноеИмяФайла = СтрФайла.ПолноеИмяФайла2;
	Элементы.ТЗВложений.ТекущиеДанные.Каталог = СтрФайла.Каталог2;
	Элементы.ТЗВложений.ТекущиеДанные.ИмяФайла = СтрФайла.ИмяФайла;
	
	
КонецПроцедуры


Процедура ЗаполнитьПолноеИмяФайлаПриемника(СтрФайла)

	ИмяПодр = "";
	
	ПолныйКаталог2 =  СокрЛП(Константы.КаталогХраненияФайлов.Получить()) + "NewMessAtt\" + НомерСообщения;
	МСРез2 = НайтиФайлы(ПолныйКаталог2);
	Если МСРез2.Количество() = 0 Тогда
		СоздатьКаталог(ПолныйКаталог2);
	КонецЕсли;
	
	ПолноеИмяФайла = ПолныйКаталог2 + "\" + СтрФайла.ИмяФайла;
	СтрФайла.Вставить("ПолноеИмяФайла2", ПолноеИмяФайла);
	СтрФайла.Вставить("Каталог2", ПолныйКаталог2);
	
КонецПроцедуры
