
&НаКлиенте
Процедура ДобавитьВСписок(Команда)
	
	ТекСтрока = Элементы.ТелефонныйСправочник.ТекущаяСтрока;
	Если ТекСтрока <> Неопределено Тогда
		ДобавитьВСписокНаСервере(ТекСтрока);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УдалитьИзСписка(Команда)
	
	ТекСтрока = Элементы.ПрямыеПолучатели.ТекущаяСтрока;
	Если ТекСтрока <> Неопределено Тогда
		УдалитьИзСпискаНаСервере(ТекСтрока);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("Пересылка") И Параметры.Пересылка Тогда
		РежимПересылки = Истина;
		Элементы.ФормаПрименить.Заголовок = "Переслать";
	КонецЕсли;
	
	КопироватьДанныеФормы(Параметры.ПрямыеПолучатели, ПрямыеПолучатели);
	
	ТекстЗапросаТС = Обработки.ТелефонныйСправочник.ПолучитьЗапросПоТелефонам();
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаТС;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если ТипЗнч(Выборка.Объект) = Тип("СправочникСсылка.ФизическиеЛица") Тогда
			Если ЗначениеЗаполнено(Выборка.EMail) Тогда
				СтрокаТЗ1 = ТелефонныйСправочник.Добавить();
				СтрокаТЗ1.Получатель = Выборка.Объект;
				СтрокаТЗ1.АдресЭП = Выборка.EMail;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	ТелефонныйСправочник.Сортировать("Получатель");
	
	ТелефонныйСправочник2.Загрузить(ТелефонныйСправочник.Выгрузить());
	
КонецПроцедуры

Процедура ДобавитьВСписокНаСервере(ИДСтроки)

	СтрокаТЗ1 = ТелефонныйСправочник.НайтиПоИдентификатору(ИДСтроки);
	Если СтрокаТЗ1 <> Неопределено Тогда
		Отбор1 = Новый Структура("Получатель", СтрокаТЗ1.Получатель);
		Строки1 = ПрямыеПолучатели.НайтиСтроки(Отбор1);
		Если Строки1.Количество() = 0 Тогда
			СтрокаТЧ1 = ПрямыеПолучатели.Добавить();
			СтрокаТЧ1.Получатель = СтрокаТЗ1.Получатель;
			СтрокаТЧ1.АдресЭП = СтрокаТЗ1.АдресЭП;
		Иначе
			Сообщить("Этот получатель уже выбран");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура УдалитьИзСпискаНаСервере(ИДСтроки)

	Строка1 = ПрямыеПолучатели.НайтиПоИдентификатору(ИДСтроки);
	Если Строка1 <> Неопределено Тогда
		ПрямыеПолучатели.Удалить(Строка1);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ТелефонныйСправочникВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ДобавитьВСписокНаСервере(ВыбраннаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ПрямыеПолучателиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	УдалитьИзСпискаНаСервере(ВыбраннаяСтрока)
	
КонецПроцедуры

&НаКлиенте
Процедура Применить(Команда)
	
	ОповеститьОВыборе(ПрямыеПолучатели);
	//Закрыть();
КонецПроцедуры


&НаКлиенте
Процедура ПоискПоФИОАвтоПодбор(Элемент, Текст, ДанныеВыбора, Ожидание, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Текст) Тогда
		ВосстановитьТелефонныйСправочник();
	Иначе
		ТелефонныйСправочник.Очистить();
		ДлинаСтрокиПоиска = СтрДлина(Текст);
		Для каждого СтрокаТС2 Из ТелефонныйСправочник2 Цикл
			Если Лев(ВРег(Строка(СтрокаТС2.Получатель)), ДлинаСтрокиПоиска) = ВРег(СокрЛП(Текст)) Тогда
				СтрокаТС1 = ТелефонныйСправочник.Добавить();
				ЗаполнитьЗначенияСвойств(СтрокаТС1, СтрокаТС2);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры


Процедура ВосстановитьТелефонныйСправочник()

	ТелефонныйСправочник.Загрузить(ТелефонныйСправочник2.Выгрузить());

КонецПроцедуры


&НаКлиенте
Процедура ПоискПоФИОПриИзменении(Элемент)
	
	//ВосстановитьТелефонныйСправочник();
	
КонецПроцедуры


&НаКлиенте
Процедура ДобавитьПроизвольныйАдрес(Команда)
	
	Адрес1 = "";
	Если ВвестиСтроку(Адрес1, "Введите адрес E-mail", 100) Тогда
		Если Найти(Адрес1, "@") = 0 Тогда
			Предупреждение("Введённый адрес некорректен");
			Возврат;
		КонецЕсли;
		СО1 = Новый Структура("АдресЭП", Адрес1);
		МС1 = ПрямыеПолучатели.НайтиСтроки(СО1);
		Если МС1.Количество() > 0 Тогда
			Предупреждение("Такой адрес уже введён");
			Возврат;
		КонецЕсли;
		Строка1 = ПрямыеПолучатели.Добавить();
		Строка1.АдресЭП = Адрес1;
		
	КонецЕсли;
	
КонецПроцедуры

