
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Движения.Финансовый.Записывать = Истина;
	Движения.Финансовый.Очистить();
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РезервНаОбесцениваниеТовараНачислениеРезерва.Ссылка.Дата КАК Период,
		|	РезервНаОбесцениваниеТовараНачислениеРезерва.Ссылка.Организация,
		|	РезервНаОбесцениваниеТовараНачислениеРезерва.Номенклатура,
		|	РезервНаОбесцениваниеТовараНачислениеРезерва.Сумма КАК СуммаМСФО,
		|	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.РезервНаСписаниеОбесцененияТоваров) КАК СчетКт,
		|	НастройкаПроведения.Счет КАК СчетДт,
		|	НастройкаПроведения.СтатьяДоходовРасходов,
		|	НастройкаПроведения.ТорговаяТочка,
		|	НастройкаПроведения.ЦФО
		|ИЗ
		|	(ВЫБРАТЬ
		|		НастройкаОтраженияОперацийВУчетеСрезПоследних.ЦФО КАК ЦФО,
		|		НастройкаОтраженияОперацийВУчетеСрезПоследних.СтатьяДоходовРасходов КАК СтатьяДоходовРасходов,
		|		НастройкаОтраженияОперацийВУчетеСрезПоследних.Счет КАК Счет,
		|		НастройкаОтраженияОперацийВУчетеСрезПоследних.СтруктурнаяЕдиница КАК ТорговаяТочка
		|	ИЗ
		|		РегистрСведений.НастройкаОтраженияОперацийВУчете.СрезПоследних(&ДатаОкончания, ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВУчете.Резервы_ОбесценениеТовара)) КАК НастройкаОтраженияОперацийВУчетеСрезПоследних) КАК НастройкаПроведения
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РезервНаОбесцениваниеТовара.НачислениеРезерва КАК РезервНаОбесцениваниеТовараНачислениеРезерва
		|		ПО (ИСТИНА)
		|ГДЕ
		|	РезервНаОбесцениваниеТовараНачислениеРезерва.Ссылка = &Ссылка
		|	И РезервНаОбесцениваниеТовараНачислениеРезерва.Сумма <> 0";

	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ДатаОкончания", Дата);


	ВыборкаНачислениеРезерва = Запрос.Выполнить().Выбрать();

	Пока ВыборкаНачислениеРезерва.Следующий() Цикл
		
		НоваяПроводка = Движения.Финансовый.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяПроводка,ВыборкаНачислениеРезерва);
		НоваяПроводка.СубконтоКт.Материалы = ВыборкаНачислениеРезерва.Номенклатура;
		
		Если НЕ ЗначениеЗаполнено(ВыборкаНачислениеРезерва.СчетДт) Тогда
			Сообщить("Не установлена настройка проведения");
			Отказ = Истина;
			Возврат;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.ЦФО) Тогда
			НоваяПроводка.СубконтоДт.ЦФО = ВыборкаНачислениеРезерва.ЦФО
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.ТорговаяТочка) Тогда
			НоваяПроводка.СубконтоДт.ТорговыеТочки = ВыборкаНачислениеРезерва.ТорговаяТочка;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.СтатьяДоходовРасходов) Тогда
			НоваяПроводка.СубконтоДт.СтатьиДоходовРасходов = ВыборкаНачислениеРезерва.СтатьяДоходовРасходов
		КонецЕсли;

		
		
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РезервНаОбесцениваниеТовараСписаниеРезерва.Ссылка.Дата КАК Период,
		|	РезервНаОбесцениваниеТовараСписаниеРезерва.Ссылка.Организация,
		|	РезервНаОбесцениваниеТовараСписаниеРезерва.Номенклатура,
		|	РезервНаОбесцениваниеТовараСписаниеРезерва.Сумма КАК СуммаМСФО,
		|	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.РезервНаСписаниеОбесцененияТоваров) КАК СчетДт,
		|	НастройкиПроведения.Счет КАК СчетКт,
		|	НастройкиПроведения.ЦФО,
		|	НастройкиПроведения.СтатьяДоходовРасходов,
		|	НастройкиПроведения.ТорговаяТочка
		|ИЗ
		|	Документ.РезервНаОбесцениваниеТовара.СписаниеРезерва КАК РезервНаОбесцениваниеТовараСписаниеРезерва
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			НастройкаОтраженияОперацийВУчетеСрезПоследних.ЦФО КАК ЦФО,
		|			НастройкаОтраженияОперацийВУчетеСрезПоследних.СтатьяДоходовРасходов КАК СтатьяДоходовРасходов,
		|			НастройкаОтраженияОперацийВУчетеСрезПоследних.Счет КАК Счет,
		|			НастройкаОтраженияОперацийВУчетеСрезПоследних.СтруктурнаяЕдиница КАК ТорговаяТочка
		|		ИЗ
		|			РегистрСведений.НастройкаОтраженияОперацийВУчете.СрезПоследних(&ДатаОкончания, ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийВУчете.Резервы_ОбесценениеТовара)) КАК НастройкаОтраженияОперацийВУчетеСрезПоследних) КАК НастройкиПроведения
		|		ПО (ИСТИНА)
		|ГДЕ
		|	РезервНаОбесцениваниеТовараСписаниеРезерва.Ссылка = &Ссылка
		|	И РезервНаОбесцениваниеТовараСписаниеРезерва.Сумма <> 0";

	Запрос.УстановитьПараметр("Ссылка", Ссылка);
    Запрос.УстановитьПараметр("ДатаОкончания", Дата);
	
	ВыборкаНачислениеРезерва = Запрос.Выполнить().Выбрать();

	Пока ВыборкаНачислениеРезерва.Следующий() Цикл
		
		НоваяПроводка = Движения.Финансовый.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяПроводка,ВыборкаНачислениеРезерва);
		НоваяПроводка.СубконтоДт.Материалы = ВыборкаНачислениеРезерва.Номенклатура;
		
		Если НЕ ЗначениеЗаполнено(ВыборкаНачислениеРезерва.СчетКт) Тогда
			Сообщить("Не установлена настройка проведения");
			Отказ = Истина;
			Возврат;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.ЦФО) Тогда
			НоваяПроводка.СубконтоКт.ЦФО = ВыборкаНачислениеРезерва.ЦФО
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.ТорговаяТочка) Тогда
			НоваяПроводка.СубконтоКт.ТорговыеТочки = ВыборкаНачислениеРезерва.ТорговаяТочка;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ВыборкаНачислениеРезерва.СтатьяДоходовРасходов) Тогда
			НоваяПроводка.СубконтоКт.СтатьиДоходовРасходов = ВыборкаНачислениеРезерва.СтатьяДоходовРасходов
		КонецЕсли;

		
		
	КонецЦикла;

	
КонецПроцедуры
