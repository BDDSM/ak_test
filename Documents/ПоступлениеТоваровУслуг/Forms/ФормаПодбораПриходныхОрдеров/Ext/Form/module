
Процедура ОсновныеДействияФормыОК(Кнопка)
	
	Список.Очистить();
	Для Каждого СтрокаТаблицы Из ТаблицаПриходныхОрдеров Цикл
		Если СтрокаТаблицы.Использование Тогда
			Список.Добавить(СтрокаТаблицы);//.Ордер);
		КонецЕсли;
	КонецЦикла;
	
	ЭтаФорма.Закрыть(КодВозвратаДиалога.ОК);
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОтмена(Кнопка)
	
	ЭтаФорма.Закрыть(КодВозвратаДиалога.Отмена);	
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Поставщик"		, Поставщик);
	Запрос.УстановитьПараметр("НомерНакладной"	, НомерНакладной);
	Запрос.УстановитьПараметр("ДатаНакладной"	, ДатаНакладной);
	Запрос.УстановитьПараметр("ПоступлениеТУ"	, ПоступлениеТУ);
	Запрос.УстановитьПараметр("ДатаГодНазад"	, ДобавитьМесяц(ТекущаяДата(), -12));
	//++ AK BARA  #16581
	Запрос.УстановитьПараметр("ВидОперации"		,П_ВидОперацииПСО);
	//Запрос.УстановитьПараметр("ВидОперации"		,?(ВидОперации = Перечисления.ВидыОперацийПоступлениеТоваровУслуг.Оборудование,
	//												Перечисления.ВидыОперацийПриходСкладскойУчет.ПоступлениеОборудованияОтПоставщика,
	//												Перечисления.ВидыОперацийПриходСкладскойУчет.ОтПоставщика));
	//--- AK BARA  #16581

	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ПриходныйОрдерСклад.НомерДокументаПоставщика = &НомерНакладной
	|				И ПриходныйОрдерСклад.НомерДокументаПоставщика <> """"
	|				И (ПриходныйОрдерСклад.ДатаДокументаПоставщика = &ДатаНакладной
	|					И ПриходныйОрдерСклад.ДатаДокументаПоставщика <> ДАТАВРЕМЯ(1, 1, 1))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Использование,
	|	ПриходныйОрдерСклад.Ссылка КАК Ордер,
	|	ПриходныйОрдерСклад.НомерДокументаПоставщика КАК НомерНакладной,
	|	ПриходныйОрдерСклад.ДатаДокументаПоставщика КАК ДатаНакладной
	|ПОМЕСТИТЬ ВремТаб
	|ИЗ
	|	Документ.ПриходныйОрдерСклад КАК ПриходныйОрдерСклад
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг.ПриходныеОрдера КАК ПоступлениеТоваровУслугПриходныеОрдера
	|		ПО ПриходныйОрдерСклад.Ссылка = ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер
	|ГДЕ
	|	ПриходныйОрдерСклад.Проведен
	|	И ПриходныйОрдерСклад.ВидОперации = &ВидОперации
	|	И ПриходныйОрдерСклад.Поставщик = &Поставщик
	|	И ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер ЕСТЬ NULL
	|	И ПриходныйОрдерСклад.Проведен
	|	И ПриходныйОрдерСклад.Дата >= &ДатаГодНазад
	|	И ПриходныйОрдерСклад.Отменен = Ложь
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.НомерДокументаПоставщика = &НомерНакладной
	|				И ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.НомерДокументаПоставщика <> """"
	|				И (ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.ДатаДокументаПоставщика = &ДатаНакладной
	|					И ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.ДатаДокументаПоставщика <> ДАТАВРЕМЯ(1, 1, 1))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер,
	|	ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.НомерДокументаПоставщика,
	|	ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.ДатаДокументаПоставщика
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.ПриходныеОрдера КАК ПоступлениеТоваровУслугПриходныеОрдера
	|ГДЕ
	|	ПоступлениеТоваровУслугПриходныеОрдера.Ссылка = &ПоступлениеТУ
	//+++АК KIRN 2018.03.19 ИП-00018069
	|	И ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.Проведен = Истина
	|	И ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер.Отменен = Ложь
	//---АК KIRN 
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВремТаб.Использование,
	|	ВремТаб.Ордер,
	|	ВремТаб.НомерНакладной,
	|	ВремТаб.ДатаНакладной
	|ИЗ
	|	ВремТаб КАК ВремТаб
	|
	|СГРУППИРОВАТЬ ПО
	|	ВремТаб.Использование,
	|	ВремТаб.Ордер,
	|	ВремТаб.НомерНакладной,
	|	ВремТаб.ДатаНакладной
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВремТаб.Ордер.Дата";
	
	ТаблицаПриходныхОрдеров = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры

Процедура ПриходныеОрдераПриИзмененииФлажка(Элемент, Колонка)
	
	Использование = Элемент.ТекущиеДанные.Использование;
	
	// Очистим использование у всех строк
	//ТаблицаПриходныхОрдеров.ЗаполнитьЗначения(Ложь, "Использование");	 //AK BARA #16581
	
	СтруктураПоиска = Новый Структура("НомерНакладной, ДатаНакладной", Элемент.ТекущиеДанные.НомерНакладной, Элемент.ТекущиеДанные.ДатаНакладной);
	МассивСтрок = ТаблицаПриходныхОрдеров.НайтиСтроки(СтруктураПоиска);
	Для Каждого СтрокаМассива Из МассивСтрок Цикл
		СтрокаМассива.Использование = Использование;
	КонецЦикла;
	
КонецПроцедуры
