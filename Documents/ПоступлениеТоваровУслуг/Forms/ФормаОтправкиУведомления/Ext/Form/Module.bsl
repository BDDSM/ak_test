
Функция ПолучитьПочтуПолучателя(Получатель)
	
	Если ТипЗнч(Получатель) = Тип("СправочникСсылка.ФизическиеЛица") Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ФизЛицо", Получатель);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	КонтактнаяИнформация.Представление
		|ИЗ
		|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		|ГДЕ
		|	КонтактнаяИнформация.Объект = &ФизЛицо
		|	И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
		|	И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.EmailФизЛица)";

		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Возврат Выборка.Представление;
		КонецЕсли;
			
		Возврат "";
		
	ИначеЕсли ТипЗнч(Получатель) = Тип("СправочникСсылка.СтруктурныеЕдиницы") Тогда
		
		Возврат Получатель.АдресЭлектроннойПочты;
		
	КонецЕсли;	
	
КонецФункции	

&НаКлиенте
Процедура ПолучателиСотрудникПриИзменении(Элемент)
	
	Элементы.Получатели.ТекущиеДанные.Почта = ПолучитьПочтуПолучателя(Элементы.Получатели.ТекущиеДанные.Получатель);
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//+++ AK suvv 15.05.2018 ИП-00018461
	Если Параметры.Организация.ИНН = "7734410589" Тогда  
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	РолиПользователейСоставРоли.Сотрудник
		|ПОМЕСТИТЬ ВТ_Сотрудники
		|ИЗ
		|	Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
		|ГДЕ
		|	РолиПользователейСоставРоли.Ссылка.Код = ""00335""
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Сотрудники.Сотрудник КАК ФизЛицо,
		|	ЕСТЬNULL(ПОДСТРОКА(КонтактнаяИнформация.Представление, 0, 200), """") КАК Email
		|ИЗ
		|	ВТ_Сотрудники КАК ВТ_Сотрудники
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		|		ПО ВТ_Сотрудники.Сотрудник = КонтактнаяИнформация.Объект
		|ГДЕ
		|	КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)";
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл 
			Если Выборка.Email <> "" Тогда 
				СтрокаДоб = Получатели.Добавить();
				СтрокаДоб.Получатель = Выборка.ФизЛицо;
				СтрокаДоб.Почта = Выборка.Email;
			КонецЕсли;
		КонецЦикла;	
		//+++АК POZM 2018.08.16 ИП-00019134.02  Добавить в получателей Скворцова и Хормунову
		СтрокаДоб = Получатели.Добавить();
		СтрокаДоб.Почта = "sp@vkusvill.ru";
		СтрокаДоб.Получатель = "Скворцов Павел";
		
		СтрокаДоб = Получатели.Добавить();
		СтрокаДоб.Почта = "hnp@vkusvill.ru";
		СтрокаДоб.Получатель = "Хармунова Нина";
		//---АК POZM 
	Иначе
	//--- AK suvv
				
		//+++АК Susk (Суслин К.В.) 2018.07.03 ИП-00019134
		//уходим от непосредственного прописывания адресов в код. 
		
		//СтрокаДоб = Получатели.Добавить();
		//СтрокаДоб.Почта = "sp@vkusvill.ru";
		
		ДополнитьПолучателейПоКонтактнойИнформации(Параметры.Организация);
		//---АК Susk (Суслин К.В.) 
		
	//+++ AK suvv 15.05.2018 ИП-00018461	
	КонецЕсли;
	//--- AK suvv
	Если ЗначениеЗаполнено(Параметры.Контрагент) Тогда	
		Если ЗначениеЗаполнено(Параметры.Контрагент.ОсновнойБухгалтерПокупателя) Тогда
			СтрокаДоб = Получатели.Добавить();
			СтрокаДоб.Получатель 	= Параметры.Контрагент.ОсновнойБухгалтерПокупателя.ФизЛицо;
			СтрокаДоб.Почта 		= ПолучитьПочтуПолучателя(СтрокаДоб.Получатель);
		КонецЕсли;
		Если ЗначениеЗаполнено(Параметры.Контрагент.ОсновнойМенеджерПокупателя)
			И НЕ Параметры.Контрагент.ОсновнойБухгалтерПокупателя = Параметры.Контрагент.ОсновнойМенеджерПокупателя Тогда
			СтрокаДоб = Получатели.Добавить();
			СтрокаДоб.Получатель 	= Параметры.Контрагент.ОсновнойМенеджерПокупателя.ФизЛицо;
			СтрокаДоб.Почта 		= ПолучитьПочтуПолучателя(СтрокаДоб.Получатель);
		КонецЕсли;
		//+++AK BATG 2018.12.11 ИП-00020679.000.00000002 Поместить в получатели Ответственного оператора контрагента при условии, 
		// что он равен текущему пользователю
		ОтветственныйОператор = Параметры.Контрагент.ОтветственныйОператор;
		Если ЗначениеЗаполнено(ОтветственныйОператор) И ПараметрыСеанса.ТекущийПользователь = ОтветственныйОператор Тогда
			ПочтаОтветственногоОператора = ПолучитьПочтуПолучателя(ОтветственныйОператор.ФизЛицо);
			Если ЗначениеЗаполнено(ПочтаОтветственногоОператора) Тогда
				// не будем повторно добавлять
				Отбор = Новый Структура("Почта", ПочтаОтветственногоОператора);
				Найденные = Получатели.НайтиСтроки(Отбор);
				Если Найденные.Количество() = 0 Тогда
					СтрокаДоб = Получатели.Добавить();
					СтрокаДоб.Получатель 	= ОтветственныйОператор.ФизЛицо;
					СтрокаДоб.Почта 		= ПочтаОтветственногоОператора;
				КонецЕсли; 
			КонецЕсли;
		КонецЕсли; 
		//---AK BATG 
	КонецЕсли;

	ТемаПисьма 	= Параметры.ТемаПисьма;
	ТекстПисьма = Параметры.ТекстПисьма;
	
	//СтрокаДоб = Получатели.Добавить();
	//СтрокаДоб.Почта = "buh17@vkusvill.ru";
	
	ПочтаОтветственного = ПолучитьПочтуПолучателя(ПараметрыСеанса.ТекущийПользователь.ФизЛицо);
	ТекстПисьма = ТекстПисьма + Символы.ПС + Символы.ПС + "Ответственный: " + ПараметрыСеанса.ТекущийПользователь + Символы.ПС +
					?(ЗначениеЗаполнено(ПочтаОтветственного), Символы.ПС + ПочтаОтветственного, "");
	
КонецПроцедуры

Процедура ОтправитьНаСервере()
	
	УчетнаяЗапись = ОбщиеПроцедуры.ПолучитьУчетнуюЗаписьДляРассылки();
	
	Почта = Новый ИнтернетПочта;
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
	Письмо = Новый ИнтернетПочтовоеСообщение;
	Почта.Подключиться(Профиль);
	Письмо.Тема = ТемаПисьма;
	Письмо.ИмяОтправителя = ""+УчетнаяЗапись+"";
	Письмо.ИмяОтправителя  = ""+СокрЛП(УчетнаяЗапись)+"";
	Письмо.Отправитель     = ""+СокрЛП(УчетнаяЗапись)+"";
	Для Каждого СтрокаПолучатель Из Получатели Цикл
		Если ЗначениеЗаполнено(СтрокаПолучатель.Почта) Тогда
			Получатель = Письмо.Получатели.Добавить();
			Получатель.Адрес           = СтрокаПолучатель.Почта;
			Получатель.ОтображаемоеИмя = СокрЛП(СтрокаПолучатель.Получатель);
		КонецЕсли;	
	КонецЦикла;
	
	ТекстСообщения = Письмо.Тексты.Добавить();
	ТекстСообщения.Текст     = ТекстПисьма;
	ТекстСообщения.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
	
	Почта.Послать(Письмо);
	Почта.Отключиться();
	
КонецПроцедуры	

&НаКлиенте
Процедура Отправить(Команда)
	
	ОтправитьНаСервере();
	Сообщить("Сообщение отправлено");
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.07.03 ИП-00019134 
&НаСервере
Процедура ДополнитьПолучателейПоКонтактнойИнформации(Организация)
	
	//найду сперва все адреса для уведомлений из пту
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	КонтактнаяИнформация.Представление КАК Почта
	|ИЗ
	|	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	|ГДЕ
	|	КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
	|	И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЭлАдресУведомленийПТУ)
	|	И КонтактнаяИнформация.Объект = &Объект";
	
	Запрос.УстановитьПараметр("Объект", Организация);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		//Распарсиваю адреса по разделителю
		МассивПочты = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок(Выборка.Почта, ";");
		
		//Формирую массив адресов, без пробелов и только заполненные адреса.
		ПолучателиМассив = Новый Массив;
		
		Для Каждого ЭлПочты Из МассивПочты Цикл
			Если ЗначениеЗаполнено(ЭлПочты) Тогда
				ПолучателиМассив.Добавить(СокрЛП(ЭлПочты));
			КонецЕсли;
		КонецЦикла;
		
		// Подберу к этим адресам пользователей для красоты, чтобы в форме видно было кто есть кто.
		//Производительность проверял, не влияет.
		ЗапросПолучатели = Новый Запрос;
		ЗапросПолучатели.Текст = "ВЫБРАТЬ
		                         |	МАКСИМУМ(КонтактнаяИнформация.Объект) КАК Пользователь,
		                         |	ВЫРАЗИТЬ(КонтактнаяИнформация.Представление КАК СТРОКА(200)) КАК Почта
		                         |ИЗ
		                         |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
		                         |ГДЕ
		                         |	КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
		                         |	И ВЫРАЗИТЬ(КонтактнаяИнформация.Представление КАК СТРОКА(200)) В (&Адреса)
		                         |
		                         |СГРУППИРОВАТЬ ПО
		                         |	ВЫРАЗИТЬ(КонтактнаяИнформация.Представление КАК СТРОКА(200))";
		
		ЗапросПолучатели.УстановитьПараметр("Адреса", ПолучателиМассив);		
		ТаблицаПользовательПочта = ЗапросПолучатели.Выполнить().Выгрузить();
		
		//Добиваю получателей.
		Для Каждого ЭлПочты Из ПолучателиМассив Цикл		
			СтрокаДоб = Получатели.Добавить();
			СтрокаДоб.Почта = ЭлПочты;
			
			НайдСтрПолучатель = ТаблицаПользовательПочта.Найти(ЭлПочты, "Почта");
			
			Если НЕ НайдСтрПолучатель = Неопределено Тогда
				СтрокаДоб.Получатель = НайдСтрПолучатель.Пользователь;
			КонецЕсли;			
		КонецЦикла;
		
	КонецЕсли;	
		
КонецПроцедуры