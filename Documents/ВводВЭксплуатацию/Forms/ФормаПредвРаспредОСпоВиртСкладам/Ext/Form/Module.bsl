
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Для Каждого Стр Из Этаформа.Параметры.ТЗРаспределение Цикл
		НовСтр = ТаблицаРаспределения.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр, Стр);
		НовСтр.Выбран = Истина;
	КонецЦикла;
	
	Ввод = ЭтаФорма.Параметры.Ввод;
	
КонецПроцедуры

&НаКлиенте
Процедура Ок(Команда)
	
	ОКСервер();
	
	ЭтаФорма.Закрыть(Истина);	
	
КонецПроцедуры

&НаСервере
Процедура ОКСервер()
	
	МассивТочек = Новый Массив;
	
	Для Каждого Стр Из ТаблицаРаспределения Цикл
		Если Стр.Выбран Тогда
			Если МассивТочек.Найти(Стр.Местоположение) = Неопределено Тогда
				МассивТочек.Добавить(Стр.Местоположение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ОборудованиеТТСкладОС = Новый ТаблицаЗначений;
	ОборудованиеТТСкладОС.Колонки.Добавить("ТТ");
	ОборудованиеТТСкладОС.Колонки.Добавить("Склад");
	ОборудованиеТТСкладОС.Колонки.Добавить("ОсновноеСредство");
	
	Для Каждого Стр Из ТаблицаРаспределения Цикл
		Если Стр.Выбран И НЕ Стр.БудетУдалено И ЗначениеЗаполнено(Стр.Местоположение) Тогда
			НовСтр = ОборудованиеТТСкладОС.Добавить();
			НовСтр.ТТ = Стр.Местоположение;
			НовСтр.ОсновноеСредство = Стр.ОсновноеСредство;
			
			НайдСтрСклад = Ввод.Оборудование.Найти(Стр.ОсновноеСредство, "ОсновноеСредство");
			
			НовСтр.Склад = НайдСтрСклад.Местоположение;
		КонецЕсли;
	КонецЦикла;
	
	ОборудованиеТТСклад = ОборудованиеТТСкладОС.Скопировать(, "Склад, ТТ");
	ОборудованиеТТСклад.Свернуть("Склад, ТТ");
	
	Для Каждого СтрПереместить Из ОборудованиеТТСклад Цикл
		
		Док = Документы.РасходныйОрдерСклад.СоздатьДокумент();
		Док.Дата = КонецМесяца(Ввод.Дата);
		Док.Получатель = СтрПереместить.ТТ;
		Док.Склад =  СтрПереместить.Склад;
		Док.ВидОперации = Перечисления.ВидыОперацийРасходСкладскойУчет.ПередачаОборудованияВТорговуюТочку;
		Док.Статус = Перечисления.СтатусыРасходныхОрдеров.ВСборке;
	
		СтрОборудованиеПоТочкам = ОборудованиеТТСкладОС.НайтиСтроки(Новый структура("ТТ, Склад", СтрПереместить.ТТ, СтрПереместить.Склад));
	
		Для Каждого СтрОборудование Из СтрОборудованиеПоТочкам Цикл
	
			НовСтрОб = Док.Оборудование.Добавить();
			НовСтрОБ.Номенклатура = СтрОборудование.ОсновноеСредство.Номенклатура;
			НовСтрОб.Оборудование = СтрОборудование.ОсновноеСредство;		
		
		КонецЦикла;
	
		Если Док.Оборудование.Количество() <> 0 Тогда
			
			Док.НеМенятьДатуПриПроведении = Истина;
		
			Попытка
				Док.Записать(РежимЗаписиДокумента.Запись, РежимПроведенияДокумента.Неоперативный);
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке("Не удалось записать расходный ордер распределения оборудования виртуального склада поставщика!" + Символы.ПС + ОписаниеОшибки());
				Продолжить;
			КонецПопытки;
		
			ОбщегоНазначения.СообщитьОбОшибке("Записан расходный ордер распределения оборудования виртуального склада: " + Строка(Док.Ссылка), , , СтатусСообщения.Информация);
		
			Попытка
				Док.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
			Исключение
				ОбщегоНазначения.СообщитьОбОшибке("Не удалось провести расходный ордер распределения оборудования виртуального склада поставщика!" + Символы.ПС + ОписаниеОшибки());				
			КонецПопытки;
		
			ОбщегоНазначения.СообщитьОбОшибке("Проведен расходный ордер распределения оборудования виртуального склада: " + Строка(Док.Ссылка), , , СтатусСообщения.Информация);
		
		КонецЕсли;
	
	КонецЦикла;	

	МассивСтрДляУд = Новый Массив;

	//ДЛя Каждого ОбДляУд Из МассивОбДляУд Цикл
	//	НайдСтроки = Объект.Оборудование.НайтиСтроки(Новый Структура("ОсновноеСредство", ОбДляУд));
	//
	//	Для Каждого НСтр Из НайдСтроки Цикл
	//		МассивСтрДляУд.Добавить(НСтр);
	//	КонецЦикла;
	//КонецЦИкла;

	//Для Каждого СтрДляУд Из МассивСтрДляУд Цикл
	//	ОБъект.Оборудование.Удалить(СтрДляУд);
	//КонецЦикла;
	
	ВводОб = Ввод.ПолучитьОбъект();
	
	Для Каждого Стр Из ТаблицаРаспределения Цикл
		Если Стр.Выбран И Стр.БудетУдалено Тогда
			
			НайдСтр = ВводОб.Оборудование.Найти(Стр.ОсновноеСредство, "ОсновноеСредство");
			
			МассивСтрДляУд.Добавить(НайдСтр);
			
		КонецЕсли;
	КонецЦикла;
		
	Для Каждого Стр Из МассивСтрДляУд Цикл
		ВводОб.Оборудование.Удалить(Стр);
	КонецЦикла;
	
	Если МассивСтрДляУд.Количество() Тогда
		ВводОб.Записать(РежимЗаписиДокумента.Проведение);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура Отмена(Команда)
	
	ЭтаФорма.Закрыть(Неопределено);
	
КонецПроцедуры

&НаКлиенте
Процедура Нет(Команда)
	
	ЭтаФорма.Закрыть(Ложь);	
	
КонецПроцедуры
