
Функция ПолучитьРеквизитыНоменклатуры(Номенклатура)
	
	СтруктураВозврат = Новый Структура("СтавкаНДС, Цена", Перечисления.СтавкиНДС.НДС18, 0);
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	НоменклатураСпр.Ссылка,
	               |	НоменклатураСпр.СтавкаНДС,
	               |	ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК Цена
	               |ИЗ
	               |	Справочник.Номенклатура КАК НоменклатураСпр
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	               |				&Дата,
	               |				ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка)
	               |					И ТипЦен = ЗНАЧЕНИЕ(Справочник.ТипыЦен.ОсновнойТипЦенПродаж)) КАК ЦеныНоменклатурыСрезПоследних
	               |		ПО НоменклатураСпр.Ссылка = ЦеныНоменклатурыСрезПоследних.Номенклатура
	               |ГДЕ
	               |	НоменклатураСпр.Ссылка = &Ссылка";
				   
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("Ссылка", Номенклатура);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		СтруктураВозврат.СтавкаНДС = Выборка.СтавкаНДС;
		СтруктураВозврат.Цена = Выборка.Цена;
	КонецЕсли;	
	
	Возврат СтруктураВозврат;
	
КонецФункции	

&НаКлиенте
Процедура РасчитатьСуммуТабЧасти()
	
	Элементы.Товары.ТекущиеДанные.Сумма = Элементы.Товары.ТекущиеДанные.Цена * Элементы.Товары.ТекущиеДанные.Количество;
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуНДСТабЧасти()

	СтавкаНДС = УчетНДС.ПолучитьСтавкуНДС(Элементы.Товары.ТекущиеДанные.СтавкаНДС);
	СуммаБезНДС = 100 * Элементы.Товары.ТекущиеДанные.Сумма / (100 + СтавкаНДС);
	Элементы.Товары.ТекущиеДанные.СуммаНДС = Элементы.Товары.ТекущиеДанные.Сумма - СуммаБезНДС;
														   
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	СтрДанные = ПолучитьРеквизитыНоменклатуры(Элементы.Товары.ТекущиеДанные.Номенклатура);
	Элементы.Товары.ТекущиеДанные.СтавкаНДС = СтрДанные.СтавкаНДС;
	Элементы.Товары.ТекущиеДанные.Цена = СтрДанные.Цена;
	РасчитатьСуммуТабЧасти();
	РассчитатьСуммуНДСТабЧасти();
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	РасчитатьСуммуТабЧасти();
	РассчитатьСуммуНДСТабЧасти();
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	РасчитатьСуммуТабЧасти();
	РассчитатьСуммуНДСТабЧасти();
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаПриИзменении(Элемент)
	
	Элементы.Товары.ТекущиеДанные.Цена = ?(Элементы.Товары.ТекущиеДанные.Количество = 0, 0, Элементы.Товары.ТекущиеДанные.Сумма / Элементы.Товары.ТекущиеДанные.Количество);
	РассчитатьСуммуНДСТабЧасти();
	
КонецПроцедуры

Процедура ЗаполнитьНаСервере()
	
	СтрДанные = Документы.ОтчетОРозничныхПродажах.ПолучитьПродажиПоОрганизации(Объект.Организация, Объект.Дата);
	Объект.Товары.Загрузить(СтрДанные.ТабТовары);
	Объект.СуммыПоСтруктурнымЕдиницам.Загрузить(СтрДанные.ТабПоСтруктурнымЕдиницам);
	
КонецПроцедуры	

&НаКлиенте
Процедура Заполнить(Команда)
	
	ЗаполнитьНаСервере();
	
КонецПроцедуры

Функция СформироватьТабличныйДокумент()
	
	Возврат Документы.ОтчетОРозничныхПродажах.ПечатьОРП(Объект.Ссылка);
	
КонецФункции

&НаКлиенте
Процедура Печать(Команда)
	
	ТабДок = СформироватьТабличныйДокумент();
	ТабДок.Показать();
	
КонецПроцедуры

//+++АК sils 08.06.2018 ИП-00018876
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ОперацияАпдекс = APDEX_ОценкаПроизводительностиКлиентСервер.ПолучитьОперацию("Открытие документа Отчет о розничных продажах");
	APDEX_ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(ОперацияАпдекс);
КонецПроцедуры

//+++АК sils 08.06.2018 ИП-00018876
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	APDEX_ОценкаПроизводительностиКлиентСервер.ЗакончитьЗамерВремени(ОперацияАпдекс, ?(Параметры.Ключ.Пустая(), "Новый документ", "" + Объект.Ссылка));
КонецПроцедуры
