
Процедура ОбработкаПроведения(Отказ, Режим)
	//УстановитьПривилегированныйРежим(Истина);
	Движения.ИсторияОбещания.Записывать = Истина;
	Движения.ИсторияОбещания.Прочитать();
	Движение = Движения.ИсторияОбещания.Добавить();
	Движение.Период = ТекущаяДата();
	Движение.Обещание = Ссылка;
	Движение.Оценка = Оценка;

КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	//Если Не РольДоступна("ПолныеПрава") Тогда
	Если ТипЗнч(Заказчик)<>Тип("СправочникСсылка.КорневыеЗаказчикиОбещаний") Тогда
	     ПроверяемыеРеквизиты.Добавить("ОбещаниеИсточник");
	КонецЕсли;
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если Не ЭтоНовый() Тогда
		Док=Ссылка;
	    ОбещаниеИсточникСсылка=ОбещаниеИсточник;
		ТекстСообщения="";
		Сч=0;
		Пока ЗначениеЗаполнено(ОбещаниеИсточникСсылка) Цикл
			Сч=Сч+1;
			ТекстСообщения=ТекстСообщения+"
			|Документ "+ОбещаниеИсточникСсылка+" использован в качестве источника в "+Док;
			Если ОбещаниеИсточникСсылка=Ссылка Тогда
				ТекстСообщения=	ТекстСообщения+"
                |Обнаружена закольцованность обещаний!";
			    Сообщить(ТекстСообщения);
				Отказ=Истина;
				Прервать;
			КонецЕсли; 
			Док=ОбещаниеИсточникСсылка;
		    ОбещаниеИсточникСсылка=ОбещаниеИсточникСсылка.ОбещаниеИсточник;
			Если Сч=500 Тогда
				Прервать;
			КонецЕсли; 
		КонецЦикла; 
	КонецЕсли; 
КонецПроцедуры
