
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//// Маршрутный лист
	//НовСтр = КомплектПечатныхФорм.Добавить();
	//НовСтр.Имя 				= "МаршрутныйЛист";
	//НовСтр.Представление 	= "Маршрутный лист";
	//НовСтр.Экземпляров 		= 1;
	//НовСтр.Печатать 		= Истина;
	
	// Расходный ордер
	НовСтр = КомплектПечатныхФорм.Добавить();
	НовСтр.Имя 				= "РасходныйОрдер";
	НовСтр.Представление 	= "Расходный ордер";
	НовСтр.Экземпляров 		= 1;
	НовСтр.Печатать 		= Истина;
	
	// Транспортная накладная
	НовСтр = КомплектПечатныхФорм.Добавить();
	НовСтр.Имя 				= "ТранспортнаяНакладная";
	НовСтр.Представление 	= "Транспортная накладная";
	НовСтр.Экземпляров 		= 1;
	НовСтр.Печатать 		= Истина;
	
	// ТТН
	НовСтр = КомплектПечатныхФорм.Добавить();
	НовСтр.Имя 				= "ТТН";
	НовСтр.Представление 	= "ТТН (форма 1-Т)";
	НовСтр.Экземпляров 		= 1;
	НовСтр.Печатать 		= Истина;
	
	Для Каждого СтрокаМассива Из Параметры.МаршрутныеЛисты Цикл
		НовСтр = ЭтаФорма.МаршрутныеЛисты.Добавить();
		НовСтр.МаршрутныйЛист = СтрокаМассива;
	КонецЦикла;   	
	
КонецПроцедуры


&НаКлиенте
Процедура СнятьФлажки(Команда)
	
	Для Каждого ТекСтрока Из ЭтаФорма.КомплектПечатныхФорм Цикл
		ТекСтрока.Печатать = Ложь;
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура УстановитьФлажки(Команда)
	
	Для Каждого ТекСтрока Из ЭтаФорма.КомплектПечатныхФорм Цикл
		ТекСтрока.Печатать = Истина;
	КонецЦикла;	
	
КонецПроцедуры


Функция СформироватьПечатныеФормыСервер()
	
	УстановитьПривилегированныйРежим(Истина);
	
	//
	КоллекцияПечатныхФорм = Новый ТаблицаЗначений;
	КоллекцияПечатныхФорм.Колонки.Добавить("ИмяМакета");
	КоллекцияПечатныхФорм.Колонки.Добавить("ИмяВРЕГ");
	КоллекцияПечатныхФорм.Колонки.Добавить("СинонимМакета");
	КоллекцияПечатныхФорм.Колонки.Добавить("ТабличныйДокумент");
	КоллекцияПечатныхФорм.Колонки.Добавить("Экземпляров");
	КоллекцияПечатныхФорм.Колонки.Добавить("Картинка");
	КоллекцияПечатныхФорм.Колонки.Добавить("ТекстHTML");
	
	ДокиМЛ 			= Документы.МаршрутныйЛист;
	ОбработкиТТН 	= Обработки.АК_ПечатьТТН;
	
	//
	Для Каждого ТекСтрока Из ЭтаФорма.КомплектПечатныхФорм Цикл
		
		Если НЕ ТекСтрока.Печатать Тогда
			Продолжить;
		КонецЕсли;
		
		//
		Если ТекСтрока.Имя = "РасходныйОрдер" Тогда
			
			ТабличныйДокумент = Новый ТабличныйДокумент;
			ТабличныйДокумент.АвтоМасштаб 			= Истина;
			ТабличныйДокумент.КоличествоЭкземпляров = ТекСтрока.Экземпляров;
			
			ЕстьТабДокументНаПечать = Ложь;
			ВыводитьРазделительСтраниц = Ложь;
			Для Каждого СтрокаМ Из ЭтаФорма.МаршрутныеЛисты Цикл
				
				ТабДок = ДокиМЛ.ПечатьРасходныйОрдер_Товары(СтрокаМ.МаршрутныйЛист);
				Если НЕ ТабДок = Неопределено Тогда
					Если ВыводитьРазделительСтраниц Тогда
						ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
					КонецЕсли;
					
					ТабличныйДокумент.Вывести(ТабДок);
					
					ВыводитьРазделительСтраниц = Истина;
					ЕстьТабДокументНаПечать = Истина;
				КонецЕсли;
				
				ТабДок = ДокиМЛ.ПечатьРасходныйОрдер_Оборудование(СтрокаМ.МаршрутныйЛист);
				Если НЕ ТабДок = Неопределено Тогда
					Если ВыводитьРазделительСтраниц Тогда
						ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
					КонецЕсли;
					
					ТабличныйДокумент.Вывести(ТабДок);
					
					ВыводитьРазделительСтраниц = Истина;
					ЕстьТабДокументНаПечать = Истина;
				КонецЕсли;
				
			КонецЦикла;
			
			Если ЕстьТабДокументНаПечать Тогда
				НовСтр = КоллекцияПечатныхФорм.Добавить();
				НовСтр.ИмяМакета 		= ТекСтрока.Имя;
				НовСтр.ИмяВРЕГ 			= ВРег(ТекСтрока.Имя);
				НовСтр.СинонимМакета 	= "Расходные ордера";
				НовСтр.ТабличныйДокумент= ТабличныйДокумент;
				НовСтр.Экземпляров 		= ТекСтрока.Экземпляров;
			КонецЕсли;
			
		//
		ИначеЕсли ТекСтрока.Имя = "ТранспортнаяНакладная" Тогда
			
			ТабличныйДокумент = Новый ТабличныйДокумент;
			ТабличныйДокумент.АвтоМасштаб 			= Истина;
			ТабличныйДокумент.КоличествоЭкземпляров = ТекСтрока.Экземпляров;
			
			ТабДок = ОбработкиТТН.ПечатьТранспортнойНакладной(ЭтаФорма.МаршрутныеЛисты.Выгрузить().ВыгрузитьКолонку("МаршрутныйЛист"));
			Если НЕ ТабДок = Неопределено Тогда
				
				ТабличныйДокумент.Вывести(ТабДок);
				
				НовСтр = КоллекцияПечатныхФорм.Добавить();
				НовСтр.ИмяМакета 		= ТекСтрока.Имя;
				НовСтр.ИмяВРЕГ 			= ВРег(ТекСтрока.Имя);
				НовСтр.СинонимМакета 	= "Транспортные накладные";
				НовСтр.ТабличныйДокумент= ТабличныйДокумент;
				НовСтр.Экземпляров 		= ТекСтрока.Экземпляров;
			КонецЕсли;
			
		//	
		ИначеЕсли ТекСтрока.Имя = "ТТН" Тогда
			
			ТабличныйДокумент = Новый ТабличныйДокумент;
			ТабличныйДокумент.АвтоМасштаб 			= Истина;
			ТабличныйДокумент.КоличествоЭкземпляров = ТекСтрока.Экземпляров;
			
			ТабДок = ОбработкиТТН.ПечатьТ1(ЭтаФорма.МаршрутныеЛисты.Выгрузить().ВыгрузитьКолонку("МаршрутныйЛист"));
			Если НЕ ТабДок = Неопределено Тогда
				
				ТабличныйДокумент.Вывести(ТабДок);
				
				НовСтр = КоллекцияПечатныхФорм.Добавить();
				НовСтр.ИмяМакета 		= ТекСтрока.Имя;
				НовСтр.ИмяВРЕГ 			= ВРег(ТекСтрока.Имя);
				НовСтр.СинонимМакета 	= "ТТН (форма 1-Т)";
				НовСтр.ТабличныйДокумент= ТабличныйДокумент;
				НовСтр.Экземпляров 		= ТекСтрока.Экземпляров;
			КонецЕсли;
			
		КонецЕсли;    		
		
	КонецЦикла;	
	
	Возврат КоллекцияПечатныхФорм;
	
КонецФункции

Функция СформироватьПечатныеФормыПоПорядкуСервер()
	
	//
	ДокиМЛ 			= Документы.МаршрутныйЛист;
	ОбработкиТТН 	= Обработки.АК_ПечатьТТН;
	
	СписокПечатныхФорм = Новый СписокЗначений;
	
	Для Каждого СтрокаМ Из ЭтаФорма.МаршрутныеЛисты Цикл
		
		ТекМЛ = СтрокаМ.МаршрутныйЛист;
		
		Для Каждого ТекСтрока Из КомплектПечатныхФорм Цикл
			
			Если НЕ ТекСтрока.Печатать Тогда
				Продолжить;
			КонецЕсли;
		
			Если ТекСтрока.Имя = "РасходныйОрдер" Тогда
				
				ТабДок = ДокиМЛ.ПечатьРасходныйОрдер_Товары(ТекМЛ);
				Если НЕ ТабДок = Неопределено Тогда
					ТабДок.АвтоМасштаб 				= Истина;
					ТабДок.КоличествоЭкземпляров 	= ТекСтрока.Экземпляров;
					
					СписокПечатныхФорм.Добавить(ТабДок, "Расходный ордер");
				КонецЕсли;
				
				ТабДок = ДокиМЛ.ПечатьРасходныйОрдер_Оборудование(ТекМЛ);
				Если НЕ ТабДок = Неопределено Тогда
					ТабДок.АвтоМасштаб 				= Истина;
					ТабДок.КоличествоЭкземпляров 	= ТекСтрока.Экземпляров;
					
					СписокПечатныхФорм.Добавить(ТабДок, "Расходный ордер");
				КонецЕсли;
				
			ИначеЕсли ТекСтрока.Имя = "ТранспортнаяНакладная" Тогда
				
				ТабДок = ОбработкиТТН.ПечатьТранспортнойНакладной(ТекМЛ);
				Если НЕ ТабДок = Неопределено Тогда
					ТабДок.АвтоМасштаб 				= Истина;
					ТабДок.КоличествоЭкземпляров 	= ТекСтрока.Экземпляров;
					
					СписокПечатныхФорм.Добавить(ТабДок, "Транспортная накладная");
				КонецЕсли;
				
			ИначеЕсли ТекСтрока.Имя = "ТТН" Тогда
				
				МассивМЛ = Новый Массив;
				МассивМЛ.Добавить(ТекМЛ);
				
				ТабДок = ОбработкиТТН.ПечатьТ1(МассивМЛ);
				Если НЕ ТабДок = Неопределено Тогда
					ТабДок.АвтоМасштаб 				= Истина;
					ТабДок.КоличествоЭкземпляров 	= ТекСтрока.Экземпляров;
					
					СписокПечатныхФорм.Добавить(ТабДок, "ТТН (форма 1-Т)");
				КонецЕсли;
				
			КонецЕсли;
				
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат СписокПечатныхФорм;
	
КонецФункции

Функция ПолучитьПараметрыОткрытияФормыПечати()
	
	Возврат Новый Структура("ПечатьИзМаршрутногоЛиста, АдресВоВременномХранилище, АдресВоВременномХранилищеСпискаПоПорядку, АдресТаблицыСертификатов",
							Истина,
							ПоместитьВоВременноеХранилище(СформироватьПечатныеФормыСервер()),
							ПоместитьВоВременноеХранилище(СформироватьПечатныеФормыПоПорядкуСервер()),
							ПоместитьВоВременноеХранилище(ТаблицаОтправленныхСертификатов.Выгрузить()));	
	
КонецФункции

&НаКлиенте
Процедура СформироватьПечатныеФормы(Команда)
	
	ЭтаФорма.Закрыть(Истина);
	
	// Получим ключ уникальности открываемой формы
	КлючУникальности = Строка(Новый УникальныйИдентификатор);
	
	ПараметрыОткрытия = ПолучитьПараметрыОткрытияФормыПечати();
	
	ОткрытьФорму("ОбщаяФорма.ПечатьДокументовУправляемая", ПараметрыОткрытия,, КлючУникальности);
	
КонецПроцедуры
