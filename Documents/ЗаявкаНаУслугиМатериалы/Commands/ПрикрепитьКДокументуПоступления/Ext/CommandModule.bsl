

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	//Вставить содержимое обработчика.
	
	//ОткрытьФорму("Документ.ЗаявкаНаУслугиМатериалы.ФормаСписка", ПараметрыФормы, ПараметрыВыполненияКоманды.Источник, ПараметрыВыполненияКоманды.Уникальность, ПараметрыВыполненияКоманды.Окно);
	СписокВыбора = Новый СписокЗначений;
	СписокВыбора.Добавить(1,"Поступление товаров услуг");
	СписокВыбора.Добавить(2,"Поступление доп.расходов");
	СписокВыбора.Добавить(3,"Рейс");
	СписокВыбора.Добавить(4,"Доставка на ТТ");
	СписокВыбора.Добавить(5,"Общие транспортные расходы");
	СписокВыбора.Добавить(6,"Открепить поступление от заявки");
	ВыбВид = СписокВыбора.ВыбратьЭлемент("Какой вид документа выбрать?");
	Если ВыбВид = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	Заявка = ПараметрКоманды;
	
	Отбор = Новый Структура("Контрагент",Заявка.Контрагент);
	ПараметрыФормы=Новый Структура;
	ПараметрыФормы.Вставить("Отбор",Отбор);
	ПараметрыФормы.Вставить("МножественныйВыбор",Истина);
	
	Если ВыбВид.Значение = 1 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.ПоступлениеТоваровУслуг.ФормаВыбора",ПараметрыФормы);
	ИначеЕсли ВыбВид.Значение = 2 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.ПоступлениеДопРасходов.ФормаВыбора",ПараметрыФормы);
	ИначеЕсли ВыбВид.Значение = 3 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.МаршрутныйЛист.ФормаВыбора",ПараметрыФормы);
	ИначеЕсли ВыбВид.Значение = 4 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.ДоставкаНаТТ.ФормаВыбора",ПараметрыФормы);
	ИначеЕсли ВыбВид.Значение = 5 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.ОбщиеТранспортныеРасходы.ФормаВыбора",ПараметрыФормы);
	ИначеЕсли ВыбВид.Значение = 6 Тогда
		ВыбДок = ОткрытьФормуМодально("Документ.ЗаявкаНаУслугиМатериалы.Форма.ФормаОтвязыванияЗаявки");	
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ВыбДок) Тогда
		Если ТипЗнч(ВыбДок) = Тип("Массив") Тогда
			ОстатокНеПрикрепленного=-1;
			Для Каждого Док Из ВыбДок Цикл
				ПрикрепитьКДокументуЗаявку(Заявка,Док,ОстатокНеПрикрепленного);
			КонецЦикла;	
		Иначе	
			ПрикрепитьКДокументуЗаявку(Заявка,ВыбДок);
		КонецЕсли;	
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Процедура ПрикрепитьКДокументуЗаявку(Заявка,ВыбДок,ОстатокНеПрикрепленного=-1)
	БезКонтроля = УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(ПланыВидовХарактеристик.ПраваПользователей.ПрикреплениеЗаявкиКДокументамВЗакрытомПериоде, Ложь);
	Если ОстатокНеПрикрепленного=-1 Тогда
		ОстатокНеПрикрепленного = Заявка.ПолучитьОбъект().ВсеДокументыВНаличии();
	КонецЕсли;	
	
	Если ТипЗнч(ВыбДок) = Тип("ДокументСсылка.ПоступлениеДопРасходов") Тогда
		Док=ВыбДок.ПолучитьОбъект();
		Если Док.Контрагент<>Заявка.Контрагент тогда
			Сообщить("Не выполнено! Контрагент документа не равен контрагенту заявки.");
			Возврат;
		КонецЕсли;	
		Если ОстатокНеПрикрепленного<Док.Сумма Тогда
			Если Не БезКонтроля Тогда
				Сообщить("Не выполнено, превышена сумма заявки! Остаток не прикрепленных поступлений "+ОстатокНеПрикрепленного);
				
				Возврат;
			КонецЕсли;	
		КонецЕсли;	
		Если Не ЗначениеЗаполнено(Док.ЗаявкаНаРсходованиеСредств) ИЛИ БезКонтроля Тогда
			Док.ЗаявкаНаРсходованиеСредств = Заявка;
			
			Если БезКонтроля Тогда
				Док.ОбменДанными.Загрузка = Истина;
			КонецЕсли;	
			Док.Записать(РежимЗаписиДокумента.Запись);
			
			ОстатокНеПрикрепленного = ОстатокНеПрикрепленного - Док.Сумма;
			
			//+++АК SaMi 13.07.2017 
			Если Док.Проведен Тогда	
				Док.Движения.Финансовый.Прочитать();				
				БухгалтерскийУчетРасчетовСКонтрагентами.СформироватьДвиженияПоРасчетамСКонтрагентами(Док);		
				Док.Движения.РасчетыСКонтрагентами.Записать();				
			КонецЕсли;
			//---АК SaMi  13.07.2017 
			
		Иначе
			Сообщить("Для документа уже указан документ-основание "+Док.ЗаявкаНаРсходованиеСредств);
		КонецЕсли;		
	Иначе
		Док=ВыбДок.ПолучитьОбъект();
		Если ТипЗнч(ВыбДок) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") ИЛИ ТипЗнч(ВыбДок) = Тип("ДокументСсылка.ДоставкаНаТТ") Тогда
			Если Док.Контрагент<>Заявка.Контрагент тогда
				Сообщить("Не выполнено! Контрагент документа не равен контрагенту заявки.");
				Возврат;
			КонецЕсли;
			Если ОстатокНеПрикрепленного<Док.СуммаДокумента Тогда
				Если Не БезКонтроля Тогда
					Сообщить("Не выполнено, превышена сумма заявки! Остаток не прикрепленных поступлений "+ОстатокНеПрикрепленного);
					
					Возврат;
				КонецЕсли;	
				
			КонецЕсли;	
			ОстатокНеПрикрепленного = ОстатокНеПрикрепленного - Док.СуммаДокумента;
		ИначеЕсли ТипЗнч(ВыбДок) = Тип("ДокументСсылка.МаршрутныйЛист") ИЛИ ТипЗнч(ВыбДок) = Тип("ДокументСсылка.ОбщиеТранспортныеРасходы") Тогда
			Если Док.Перевозчик<>Заявка.Контрагент тогда
				Сообщить("Не выполнено! Контрагент документа не равен контрагенту заявки.");
				Возврат;
			КонецЕсли;
			Если ОстатокНеПрикрепленного<Док.Сумма Тогда
				Если Не БезКонтроля Тогда
					Сообщить("Не выполнено, превышена сумма заявки! Остаток не прикрепленных поступлений "+ОстатокНеПрикрепленного);
					
					Возврат;
				КонецЕсли;	
			КонецЕсли;	
			ОстатокНеПрикрепленного = ОстатокНеПрикрепленного - Док.Сумма;
		КонецЕсли;	
		
		//+++АК LAGP 2017.11.22 ИП-00017306
		//Если Не ЗначениеЗаполнено(Док.Заявка) ИЛИ БезКонтроля Тогда
		Если Не ЗначениеЗаполнено(Док.ДокументОснование) ИЛИ Не ЗначениеЗаполнено(Док.Заявка) ИЛИ БезКонтроля Тогда
			
			Если Не ЗначениеЗаполнено(Док.ДокументОснование) Тогда
				Док.ДокументОснование = Заявка;
			КонецЕсли;	
				
			Если Не ЗначениеЗаполнено(Док.Заявка) Тогда
				Док.Заявка = Заявка;
			КонецЕсли;	
			//Док.Заявка = Заявка;
			//---АК LAGP	
			
			Если БезКонтроля Тогда
				Док.ОбменДанными.Загрузка = Истина;
			КонецЕсли;	
			Док.Записать(РежимЗаписиДокумента.Запись);
			
			//+++АК SaMi 13.07.2017 
			Если Док.Проведен Тогда	
				Док.Движения.Финансовый.Прочитать();				
				
				Если ТипЗнч(ВыбДок) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда	
					Док.ВыполнитьДвиженияПоРасчетамСКонтрагентами();
				Иначе
					БухгалтерскийУчетРасчетовСКонтрагентами.СформироватьДвиженияПоРасчетамСКонтрагентами(Док);		
				КонецЕсли;
				
				Док.Движения.РасчетыСКонтрагентами.Записать();				
			КонецЕсли;
			//---АК SaMi  13.07.2017 
			
		Иначе
			Сообщить("Для документа уже указан документ-заявка "+Док.Заявка);
		КонецЕсли;	
		
	КонецЕсли;	
КонецПроцедуры	