
Процедура СинхронизироватьДатуДокументаСМаршрутами(Отказ)
	
	МаксДата = Неопределено;
	Для Каждого СтрокаТЧ Из ЭтотОбъект.Показания Цикл
		Если МаксДата = Неопределено Тогда
			МаксДата = СтрокаТЧ.Дата;
			Продолжить;
		КонецЕсли;
		Если СтрокаТЧ.Дата > МаксДата Тогда
			МаксДата = СтрокаТЧ.Дата;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ МаксДата = Неопределено Тогда
		Если НЕ НачалоДня(ЭтотОбъект.Дата) = МаксДата Тогда
			Сообщить("Дата документа не совпадает с максимальной датой в маршрутах!");
			Отказ = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьДублиДат(Отказ)
	
	ВремТаблица = ЭтотОбъект.Показания.Выгрузить(, "НомерСтроки, Дата");
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВремТаблица"			, ВремТаблица);
	Запрос.УстановитьПараметр("ТекДокумент"			, ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("ФизЛицо"				, ЭтотОбъект.ФизЛицо);   
	Запрос.УстановитьПараметр("ТранспортноеСредство", ЭтотОбъект.ТранспортноеСредство);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВремТаблица.НомерСтроки КАК НомерСтроки,
	|	ВремТаблица.Дата КАК Дата
	|ПОМЕСТИТЬ ВТПоказания
	|ИЗ
	|	&ВремТаблица КАК ВремТаблица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПутевойЛистПоказания.НомерСтроки КАК НомерСтроки,
	|	ПутевойЛистПоказания1.Ссылка,
	|	ПутевойЛистПоказания1.НомерСтроки КАК НомерСтроки1,
	|	ПутевойЛистПоказания1.Ссылка.Номер КАК Номер,
	|	ПутевойЛистПоказания1.Ссылка.Дата КАК Дата1
	|ИЗ
	|	ВТПоказания КАК ПутевойЛистПоказания
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПутевойЛист.Показания КАК ПутевойЛистПоказания1
	|		ПО (ПутевойЛистПоказания1.Ссылка.ФизЛицо = &ФизЛицо)
	|			И (ПутевойЛистПоказания1.Ссылка.ТранспортноеСредство = &ТранспортноеСредство)
	|			И (ПутевойЛистПоказания1.Дата = ПутевойЛистПоказания.Дата)
	|			И (НЕ ПутевойЛистПоказания1.Ссылка = &ТекДокумент)
	|ГДЕ
	|	НЕ ПутевойЛистПоказания1.Ссылка ЕСТЬ NULL ";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "В строке №" + Выборка.НомерСтроки + " введена неверная дата, так как она уже введена в путевом листе №" +
							Выборка.Номер + " от " + Формат(Выборка.Дата1, "ДФ=dd.MM.yy");
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	//
	ДатаЗапретаРедактирования = Константы.ДатаГраницаРедактированияПЛ.Получить();
	Если ДатаЗапретаРедактирования >= НачалоДня(ЭтотОбъект.Дата) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Период редактирования закрыт!(" + Формат(ДатаЗапретаРедактирования, "ДФ=dd.MM.yyyy") + ")";
		Сообщение.Сообщить();
		Отказ = Истина;	
		Возврат;
	КонецЕсли;
	
	//
	СинхронизироватьДатуДокументаСМаршрутами(Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	//
	ПроверитьДублиДат(Отказ);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	//Для каждого ТекСтрока Из ЭтотОбъект.Показания Цикл
	//
	//	Запрос = Новый Запрос;
	//	Запрос.УстановитьПараметр("Ссылка"				, ЭтотОбъект.Ссылка);
	//	Запрос.УстановитьПараметр("Дата"				, ТекСтрока.Дата);
	//	Запрос.УстановитьПараметр("ФизЛицо"				, ЭтотОбъект.ФизЛицо);   
	//	Запрос.УстановитьПараметр("ТранспортноеСредство", ЭтотОбъект.ТранспортноеСредство);
	//	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	ПутевойЛистПоказания1.Ссылка,
	//	|	ПутевойЛистПоказания1.НомерСтроки КАК НомерСтроки1,
	//	|	ПутевойЛистПоказания1.Ссылка.Номер,
	//	|	ПутевойЛистПоказания1.Ссылка.Дата КАК Дата1
	//	|ИЗ
	//	|	Документ.ПутевойЛист.Показания КАК ПутевойЛистПоказания1
	//	|ГДЕ
	//	|	ПутевойЛистПоказания1.Дата = &Дата
	//	|	И ПутевойЛистПоказания1.Ссылка.ФизЛицо = &ФизЛицо
	//	|	И ПутевойЛистПоказания1.Ссылка.ТранспортноеСредство = &ТранспортноеСредство
	//	|	И ПутевойЛистПоказания1.Ссылка <> &Ссылка";
	//	
	//	Результат = Запрос.Выполнить();
	//	
	//	ВыборкаДетальныеЗаписи = Результат.Выбрать();
	//	
	//	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	//		
	//		Сообщение = Новый СообщениеПользователю;
	//		Сообщение.Текст = "В строке №" + ТекСтрока.НомерСтроки + " введена неверная дата, так как она уже введена в путевом листе №" +
	//							ВыборкаДетальныеЗаписи.Номер + " от " + Формат(ВыборкаДетальныеЗаписи.Дата1, "ДФ=dd.MM.yy");
	//		Сообщение.Сообщить();
	//		Отказ = Истина;
	//		
	//	КонецЦикла;
	//	
	//КонецЦикла;

	ЭтотОбъект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
КонецПроцедуры
