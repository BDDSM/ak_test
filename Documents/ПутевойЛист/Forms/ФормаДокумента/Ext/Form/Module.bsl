
&НаКлиенте
Процедура ПоказанияПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		Элемент.ТекущиеДанные.Дата   = ТекущаяДата(); 
		Элемент.ТекущиеДанные.Начало = НачалоЧаса(ТекущаяДата());
		Элемент.ТекущиеДанные.Конец  = ТекущаяДата();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОбработатьВыбор()
	
	Объект.ТранспортноеСредство = Справочники.ТранспортныеСредства.ПустаяСсылка(); 
	Объект.ПоказаниеСпидометра	= 0;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Владелец", Объект.ФизЛицо);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТранспортныеСредства.Ссылка КАК ТранспортноеСредство,
	|	ТранспортныеСредства.ПоказаниеСпидометра КАК ПоказаниеСпидометра
	|ИЗ
	|	Справочник.ТранспортныеСредства КАК ТранспортныеСредства
	|ГДЕ
	|	ТранспортныеСредства.Владелец = &Владелец
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ФизическиеЛица.ОсновноеТранспортноеСредство,
	|	ФизическиеЛица.ОсновноеТранспортноеСредство.ПоказаниеСпидометра
	|ИЗ
	|	Справочник.ФизическиеЛица КАК ФизическиеЛица
	|ГДЕ
	|	ФизическиеЛица.Ссылка = &Владелец";

	Выборка = Запрос.Выполнить().Выбрать();

	Пока Выборка.Следующий() Цикл
		Если ЗначениеЗаполнено(Выборка.ТранспортноеСредство) Тогда 
			Объект.ТранспортноеСредство = Выборка.ТранспортноеСредство;
			Объект.ПоказаниеСпидометра  = Выборка.ПоказаниеСпидометра;
		КонецЕсли; 
	КонецЦикла;
	
КонецПроцедуры	

&НаКлиенте
Процедура ПоказанияПриИзменении(Элемент)
	
	ОбработатьНормуЧасов();
	ОбновитьСуммуСписания();
	 
КонецПроцедуры

&НаСервере
Процедура ОбработатьНормуЧасов()
	
	Объект.НормаРасходаТоплива = Объект.Показания.Итог("КилометражМаршрута") / 100 * Объект.ТранспортноеСредство.НормаРасходаТоплива;
	
КонецПроцедуры	

 &НаСервере
Процедура ОбработатьВыборФизЛицо()
	
	Объект.ФизЛицо = Справочники.ФизическиеЛица.ПустаяСсылка(); 
		 
    //
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", Объект.ТранспортноеСредство);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТранспортныеСредства.Владелец
	|ИЗ
	|	Справочник.ТранспортныеСредства КАК ТранспортныеСредства
	|ГДЕ
	|	ТранспортныеСредства.Ссылка = &Ссылка";

	Результат = Запрос.Выполнить();

	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Владелец) Тогда 
			Объект.ФизЛицо = ВыборкаДетальныеЗаписи.Владелец;
		КонецЕсли; 
	КонецЦикла;
	
	Объект.ПоказаниеСпидометра  = Объект.ТранспортноеСредство.ПоказаниеСпидометра;

КонецПроцедуры	

&НаКлиенте
Процедура ОбновитьСуммуСписания()

	КоличествоГСМ 		= Объект.ПредоставленныеЧеки.Итог("КоличествоГСМ");	
	СуммаЧекаПоГСМ 		= Объект.ПредоставленныеЧеки.Итог("СуммаЧекаПоГСМ");	
	КилометражМаршрута 	= Объект.Показания.Итог("КилометражМаршрута");
	Объект.СуммаСписанияПоГСМВАО = ?(КоличествоГСМ = 0, 0, ((СуммаЧекаПоГСМ / КоличествоГСМ) * Объект.НормаРасходаТоплива));

КонецПроцедуры

Процедура УстановитьВидимость()
	
	ДатаЗапретаРедактирования = Константы.ДатаГраницаРедактированияПЛ.Получить();
	
	Если ДатаЗапретаРедактирования >= НачалоДня(Объект.Дата) Тогда
		
        ЭтаФорма.ТолькоПросмотр = Истина;
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Период редактирования закрыт!(" + Формат(ДатаЗапретаРедактирования, "ДФ=dd.MM.yyyy") + ")";
		Сообщение.Сообщить();
		
	КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	УстановитьВидимость();
	
	//+++АК sils 08.06.2018 ИП-00018876
	APDEX_ОценкаПроизводительностиКлиентСервер.ЗакончитьЗамерВремени(ОперацияАпдекс, ?(Параметры.Ключ.Пустая(), "Новый документ", "" + Объект.Ссылка));
	//---АК
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
КонецПроцедуры


&НаКлиенте
Процедура ПредоставленныеЧекиПриИзменении(Элемент)
	
	ОбновитьСуммуСписания();
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	УстановитьВидимость();
	
КонецПроцедуры

&НаКлиенте
Процедура ФизЛицоПриИзменении(Элемент)
	
	ОбработатьВыбор();
	 
КонецПроцедуры

&НаКлиенте
Процедура ТранспортноеСредствоПриИзменении(Элемент)
	
	ОбработатьВыборФизЛицо(); 
	ОбновитьСуммуСписания();
	 
КонецПроцедуры

//+++АК sils 08.06.2018 ИП-00018876
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ОперацияАпдекс = APDEX_ОценкаПроизводительностиКлиентСервер.ПолучитьОперацию("Открытие документа Путевой лист");
	APDEX_ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(ОперацияАпдекс);
КонецПроцедуры
