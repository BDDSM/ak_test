
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Наличка.Загрузить(ЗначениеИзСтрокиВнутр(Параметры.ТаблицаНаличнойОплаты));
	ЭтоИзбенка = Параметры.ЭтоИзбенка;
	Элементы.Наличка.ТолькоПросмотр = ЭтоИзбенка;
	Элементы.ФормаПринять.Доступность = НЕ ЭтоИзбенка;
	ДатаЛиста = Параметры.ДатаЛиста;
	
	ПеречитатьРабочиеМеста();
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТерминалПоКассе(Касса)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаЛиста", КонецДня(ДатаЛиста));
	Запрос.УстановитьПараметр("Касса", Касса);
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПривязкиОборудованияКРабочимМестамСрезПоследних.Терминал
	               |ИЗ
	               |	РегистрСведений.ПривязкиОборудованияКРабочимМестам.СрезПоследних(&ДатаЛиста, Касса = &Касса) КАК ПривязкиОборудованияКРабочимМестамСрезПоследних";
				   
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Терминал;
	Иначе
		Возврат Справочники.Терминалы.ПустаяСсылка();
	КонецЕсли;	
	
КонецФункции	

&НаКлиенте
Процедура Принять(Команда)
	
	МассивСтроки = Новый Массив();
	Для Каждого СтрокаТаб Из Наличка Цикл
		МассивСтроки.Добавить(Новый Структура("ОсновноеСредство, ККМ, Сумма, СуммаВозврата, РабочееМестоВСкл", СтрокаТаб.ОсновноеСредство, ПолучитьТерминалПоКассе(СтрокаТаб.ОсновноеСредство), СтрокаТаб.Сумма, СтрокаТаб.СуммаВозврата, СтрокаТаб.РабочееМестоВСкл));
	КонецЦикла;	
	
	Закрыть(МассивСтроки);
	
КонецПроцедуры

&НаКлиенте
Процедура НаличкаПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	//Если НоваяСтрока Тогда
	//	Элементы.Наличка.ТекущиеДанные.ККМ = ПредопределенноеЗначение("Справочник.Терминалы.ПустаяСсылка");
	//КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Процедура ПеречитатьРабочиеМеста()
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаЛиста", КонецДня(ДатаЛиста));
	Запрос.УстановитьПараметр("Кассы", Наличка.Выгрузить().ВыгрузитьКолонку("ОсновноеСредство"));
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПривязкиОборудованияКРабочимМестамСрезПоследних.РабочееМесто,
	               |	ПривязкиОборудованияКРабочимМестамСрезПоследних.Касса
	               |ИЗ
	               |	РегистрСведений.ПривязкиОборудованияКРабочимМестам.СрезПоследних(&ДатаЛиста, ) КАК ПривязкиОборудованияКРабочимМестамСрезПоследних
	               |ГДЕ
	               |	ПривязкиОборудованияКРабочимМестамСрезПоследних.Касса В(&Кассы)";
				   
	ТабРабМеста = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаТаб Из Наличка Цикл
		СтрокаРМ = ТабРабМеста.Найти(СтрокаТаб.ОсновноеСредство, "Касса");
		СтрокаТаб.РабочееМесто = ?(СтрокаРМ = Неопределено, Справочники.РабочиеМеста.ПустаяСсылка(), СтрокаРМ.РабочееМесто);
	КонецЦикла;	
	
КонецПроцедуры	

&НаКлиенте
Процедура НаличкаККМПриИзменении(Элемент)
	
	ПеречитатьРабочиеМеста();
	
КонецПроцедуры
