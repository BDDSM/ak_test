
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Отказ = НЕ УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(ПланыВидовХарактеристик.ПраваПользователей.РезервПоДепозитамАренды, Ложь);
	
	Если Отказ Тогда
		Сообщить("Нет прав на использование документа!");
	КонецЕсли;	
	
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДоговорКонтрагентаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ИмяТЧ = СтрЗаменить(Элемент.Имя, "ДоговорКонтрагента","");
	
	ФормаВыбора = ПолучитьФорму("Справочник.ДоговорыКонтрагентов.ФормаВыбора",, Элемент);
	
	ФормаВыбора.Отбор.Владелец.Установить(Элементы[ИмяТЧ].ТекущиеДанные.Контрагент);
	ФормаВыбора.Отбор.Организация.Установить(Объект.Организация);
	ФормаВыбора.РежимВыбора = Истина;
	
	ФормаВыбора.Открыть();
	
КонецПроцедуры

&НаКлиенте
Процедура ДокументНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)


	СтандартнаяОбработка = Ложь;
	
	ИмяТЧ = СтрЗаменить(Элемент.Имя, "Документ","");	
	
	ФормаВыбора = ПолучитьФорму("ЖурналДокументов.УчетДоговоровАренды.ФормаСписка",, Элемент);
	
	ФормаВыбора.Отбор.Валюта.ВидСравнения = ВидСравнения.НеРавно;
	ФормаВыбора.Отбор.Валюта.Использование = Истина;
	
	ФормаВыбора.Отбор.ДоговорКонтрагента.Установить(Элементы[ИмяТЧ].ТекущиеДанные.ДоговорКонтрагента);
	
	ФормаВыбора.РежимВыбора = Истина;
	
	ФормаВыбора.ОткрытьМодально();
	
КонецПроцедуры

&НаКлиенте
Процедура ДокументПриИзменении(Элемент)
	
	ИмяТЧ = СтрЗаменить(Элемент.Имя, "ДоговорКонтрагента","");
	ИмяТЧ = СтрЗаменить(ИмяТЧ, "Документ","");	
	ИмяТЧ = СтрЗаменить(ИмяТЧ, "Контрагент","");
	
	Элементы[ИмяТЧ].ТекущиеДанные.Сумма = ПолучитьСуммуДепозита(Элементы[ИмяТЧ].ТекущиеДанные.Документ);

КонецПроцедуры

&НаСервере
Функция ПолучитьСуммуДепозита(Документ)
	
	Если НЕ ЗначениеЗаполнено(Документ) Тогда
		Возврат 0;
	ИначеЕсли Документ.ВалютаДепозита = Константы.ВалютаРегламентированногоУчета.Получить() Тогда
		Возврат Документ.СуммаЗалогаНаличные + Документ.СуммаЗалогаБезналичные;
	Иначе
		Запрос = Новый Запрос("ВЫБРАТЬ
		                      |	ФинансовыйОстатки.СуммаОстаток
		                      |ИЗ
		                      |	РегистрБухгалтерии.Финансовый.Остатки(
		                      |			,
		                      |			Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ОбеспечительныйВзнос),
		                      |			,
		                      |			Субконто1 = &Организация
		                      |				И Субконто2 = &Контрагент
		                      |				И Субконто3 = &ТТ) КАК ФинансовыйОстатки");
		
		Запрос.УстановитьПараметр("Организация", Документ.Организация);
		Запрос.УстановитьПараметр("Контрагент", Документ.Контрагент);
		Запрос.УстановитьПараметр("ТТ", Документ.ОбъектАренды.СтруктурнаяЕдиница);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			Возврат Выборка.СуммаОстаток;
		КонецЕсли; 
	КонецЕсли; 
	
	Возврат 0;
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ТолькоПросмотр = Объект.Проведен;

КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	//ТолькоПросмотр = Объект.Проведен;
	
КонецПроцедуры






