
&НаСервере
Процедура ОбновитьHTML(ТипФотографии, ФотографииHTML)
	
	ТаблицаКартинок.Очистить();
	
	// 
	КаталогФотографий = СокрЛП(Константы.МП_КаталогХраненияФайловЗадачМП.Получить());

	Если Прав(КаталогФотографий, 1) <> "\" Тогда
		КаталогФотографий = КаталогФотографий + "\";
	КонецЕсли;

    СтрокиПараметра = Объект.Фотографии.НайтиСтроки(Новый Структура("ТипФотографии",  ТипФотографии));
	
	Для Каждого СтрокаПараметра ИЗ СтрокиПараметра Цикл
	
		Файл = Новый Файл(КаталогФотографий+СтрокаПараметра.ОтносительноеИмяФайла);
		
		Если ПустаяСтрока(СтрокаПараметра.ОтносительноеИмяФайла) Тогда
			Продолжить;
		КонецЕсли;

		Попытка 
			Если  НЕ Файл.Существует() Тогда
				Продолжить;
			КонецЕсли;

		Исключение
						
		КонецПопытки; 

		Если НЕ Файл.Существует() Тогда 
		Иначе
			НоваяСтрока = ТаблицаКартинок.Добавить();
			НоваяСтрока.ИмяФайла = КаталогФотографий+СтрокаПараметра.ОтносительноеИмяФайла;
		КонецЕсли;	
	КонецЦикла;
	
	//
	ФотографииHTML = ПолучитьHTMLПоТаблицеКартинок();

КонецПроцедуры

&НаСервере
Функция ПолучитьHTMLПоТаблицеКартинок()

	КартинокВСтроке = 4;

	ПолныйТекстHTML = "
		|<html><body>
		|<table name = ""PictView"">";

	Для НомерСтроки = 1 По ОбщегоНазначения.ЦелМаксимальное(ТаблицаКартинок.Количество()/КартинокВСтроке) Цикл
		ПолныйТекстHTML = ПолныйТекстHTML + "
			|<tr>";
		Для НомерКолонки = 1 По КартинокВСтроке Цикл
			ИндексСтрокиКартики = (НомерСтроки-1) * КартинокВСтроке + НомерКолонки - 1;
			Если ИндексСтрокиКартики = ТаблицаКартинок.Количество() Тогда
				Прервать;
			КонецЕсли; 
			ИмяФайла = ТаблицаКартинок[ИндексСтрокиКартики].ИмяФайла;
			ПолныйТекстHTML = ПолныйТекстHTML+ "
			|<td><table id=""" + ИндексСтрокиКартики + "_T" + """ border=""2"" cellpadding=""0"" bordercolor=#ffffff cellspacing=""0""><tr><td><img name=""picture"" width = 125 height=125 style = ""cursor: pointer"" id = """  + ИндексСтрокиКартики  + """ src = ""file:///" + СтрЗаменить(ИмяФайла, "\", "/") + """></td></tr></table></td>";
		КонецЦикла;	
		ПолныйТекстHTML = ПолныйТекстHTML + "
			|</tr>";
	КонецЦикла;	

	ПолныйТекстHTML = ПолныйТекстHTML + "</body></html>";

	Возврат ПолныйТекстHTML;

КонецФункции

&НаКлиенте
Процедура HTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;

	Попытка 
		
		Если ДанныеСобытия.Element.name = "picture" Тогда
			ИндексСтроки = Число(ДанныеСобытия.Element.id);

			Картинка = Новый Картинка(ТаблицаКартинок[ИндексСтроки].ИмяФайла);
			АдресКартинки = ПоместитьВоВременноеХранилище(Картинка, УникальныйИдентификатор);
			ПараметрыФормы = Новый Структура("КартинкаСсылка", АдресКартинки); 
			
			ОткрытьФорму("ОбщаяФорма.Фото", ПараметрыФормы);
		КонецЕсли;

	Исключение
	КонецПопытки; 
	
КонецПроцедуры

&НаКлиенте
Процедура КомментарииПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура КомментарииПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	
	Отказ = Истина;
	
	ФормаКомментария = ПолучитьФорму("Документ.МП_ОтчетПоНовомуТовару.Форма.ФормаКомментария");
	ФормаКомментария.ЭтоНовый = Истина;
	
	Если ФормаКомментария.ОткрытьМодально() = КодВозвратаДиалога.ОК И НЕ ПустаяСтрока(ФормаКомментария.Комментарий) Тогда
		НоваяСтрока = Объект.Комментарии.Вставить(0);
		
		НоваяСтрока.Комментарий = ФормаКомментария.Комментарий;
		НоваяСтрока.Пользователь = ТекущийПользователь;
		НоваяСтрока.Дата = ТекущаяДата();
	КонецЕсли; 
	
	Попытка 
		ЕстьИзмененияДляМП = Истина;		
		Записать();
	Исключение
	КонецПопытки; 
	
КонецПроцедуры

&НаКлиенте
Процедура КомментарииВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ФормаКомментария = ПолучитьФорму("Документ.МП_ОтчетПоНовомуТовару.Форма.ФормаКомментария");
	ФормаКомментария.Комментарий = Элементы.Комментарии.ТекущиеДанные.Комментарий;
	
	ФормаКомментария.ОткрытьМодально();

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ОбновитьHTML(ПредопределенноеЗначение("Перечисление.ТипыФотографийНовогоТовара.Товар"), ФотографииТовараHTML);
	ОбновитьHTML(ПредопределенноеЗначение("Перечисление.ТипыФотографийНовогоТовара.Производство"), ФотографииПроизводстваHTML);
	ОбновитьHTML(ПредопределенноеЗначение("Перечисление.ТипыФотографийНовогоТовара.Этикетка"), ЭтикеткиHTML);
	
	Если Объект.ЕстьИзменения Тогда
		Объект.ЕстьИзменения = Ложь;
		Записать();
	КонецЕсли;

КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ТекущийПользователь = ПараметрыСеанса.ТекущийПользователь.ФизЛицо;
	
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	Если ЕстьИзмененияДляМП Тогда
		ТекущийОбъект.ДополнительныеСвойства.Вставить("ЕстьИзмененияДляМП");
	КонецЕсли; 
	
КонецПроцедуры


