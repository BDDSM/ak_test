
Перем ТекДата;


Функция ПолучитьТаблицуИзмененийВДвижениях()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Регистратор"	, ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Товары"		, ЭтотОбъект.Товары.Выгрузить());
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаданияНаИнвентаризацию.Номенклатура,
	|	ЗаданияНаИнвентаризацию.Характеристика,
	|	ЗаданияНаИнвентаризацию.ДатаПроизводства,
	|	СУММА(ЗаданияНаИнвентаризацию.Количество * ВЫБОР
	|			КОГДА ЗаданияНаИнвентаризацию.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ) КАК Количество
	|ПОМЕСТИТЬ ВТ_Движения
	|ИЗ
	|	РегистрНакопления.ЗаданияНаИнвентаризацию КАК ЗаданияНаИнвентаризацию
	|ГДЕ
	|	ЗаданияНаИнвентаризацию.Регистратор = &Регистратор
	|	И ЗаданияНаИнвентаризацию.Активность = ИСТИНА
	|	И ЗаданияНаИнвентаризацию.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗаданияНаИнвентаризацию.Номенклатура,
	|	ЗаданияНаИнвентаризацию.Характеристика,
	|	ЗаданияНаИнвентаризацию.ДатаПроизводства
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТЧТовары.Номенклатура,
	|	ТЧТовары.Характеристика,
	|	ТЧТовары.ДатаПроизводства,
	|	ТЧТовары.Количество КАК Количество
	|ПОМЕСТИТЬ ВТ_ТабТовары
	|ИЗ
	|	&Товары КАК ТЧТовары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ВТ_Движения.Номенклатура, ВЗ_Товары.Номенклатура) КАК Номенклатура,
	|	ЕСТЬNULL(ВТ_Движения.Характеристика, ВЗ_Товары.Характеристика) КАК Характеристика,
	|	ЕСТЬNULL(ВТ_Движения.ДатаПроизводства, ВЗ_Товары.ДатаПроизводства) КАК ДатаПроизводства,
	|	ЕСТЬNULL(ВЗ_Товары.Количество, 0) - ЕСТЬNULL(ВТ_Движения.Количество, 0) КАК Количество
	|ИЗ
	|	ВТ_Движения КАК ВТ_Движения
	|		ПОЛНОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ВТ_ТабТовары.Номенклатура КАК Номенклатура,
	|			ВТ_ТабТовары.Характеристика КАК Характеристика,
	|			ВТ_ТабТовары.ДатаПроизводства КАК ДатаПроизводства,
	|			СУММА(ВТ_ТабТовары.Количество) КАК Количество
	|		ИЗ
	|			ВТ_ТабТовары КАК ВТ_ТабТовары
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ВТ_ТабТовары.Номенклатура,
	|			ВТ_ТабТовары.Характеристика,
	|			ВТ_ТабТовары.ДатаПроизводства) КАК ВЗ_Товары
	|		ПО ВТ_Движения.Номенклатура = ВЗ_Товары.Номенклатура
	|			И ВТ_Движения.Характеристика = ВЗ_Товары.Характеристика
	|			И ВТ_Движения.ДатаПроизводства = ВЗ_Товары.ДатаПроизводства
	|ГДЕ
	|	ЕСТЬNULL(ВЗ_Товары.Количество, 0) - ЕСТЬNULL(ВТ_Движения.Количество, 0) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТ_Движения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТ_ТабТовары";
				   
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции


Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;	
	
	Если РежимЗаписи = РежимЗаписиДокумента.Проведение Тогда
		
		ТекДата = ТекущаяДата(); //можно брать эту, т.к. код выполняется на сервере и дата будет серверная
		ТабИзмененийВДвижениях = ПолучитьТаблицуИзмененийВДвижениях();
		Если ТабИзмененийВДвижениях.Количество() > 0 Тогда
			СтрокаТаб = ЭтотОбъект.ИзмененияДвижений.Добавить();
			СтрокаТаб.ДатаИзменения = ТекДата;
			СтрокаТаб.Пользователь 	= ПараметрыСеанса.ТекущийПользователь;
		КонецЕсли;
					
	ИначеЕсли РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения Тогда
		
		ЭтотОбъект.ИзмененияДвижений.Очистить();
		
	КонецЕсли;
	
	////
	//Если ЗначениеЗаполнено(СтруктурнаяЕдиница) Тогда
	//	Запрос = Новый Запрос("ВЫБРАТЬ
	//						  |	МобильноеПриложение.Ссылка 
	//						  |ИЗ
	//						  |	ПланОбмена.МобильноеПриложение КАК МобильноеПриложение
	//						  |ГДЕ
	//						  |	МобильноеПриложение.Магазин = &Магазин");
	//	
	//	Запрос.УстановитьПараметр("Магазин", СтруктурнаяЕдиница);
	//	
	//	Выборка = Запрос.Выполнить().Выбрать();
	//	Пока Выборка.Следующий() Цикл
	//		Если Выборка.Ссылка <> ПланыОбмена.МобильноеПриложение.ЭтотУзел() Тогда
	//			ОбменДанными.Получатели.Добавить(Выборка.Ссылка);
	//		КонецЕсли;
	//	КонецЦикла;  
	//КонецЕсли;
	//
	//Если НЕ ЭтоНовый() Тогда
	//	Запрос = Новый Запрос("ВЫБРАТЬ
	//	|	ЗаданиеНаИнвентаризацию.СтруктурнаяЕдиница
	//	|ИЗ
	//	|	Документ.ЗаданиеНаИнвентаризацию КАК ЗаданиеНаИнвентаризацию
	//	|ГДЕ
	//	|	ЗаданиеНаИнвентаризацию.Ссылка = &Ссылка");
	//	
	//	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	//	
	//	Выборка = Запрос.Выполнить().Выбрать();
	//	
	//	Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.СтруктурнаяЕдиница) Тогда
	//		Запрос = Новый Запрос("ВЫБРАТЬ
	//							  |	МобильноеПриложение.Ссылка 
	//							  |ИЗ
	//							  |	ПланОбмена.МобильноеПриложение КАК МобильноеПриложение
	//							  |ГДЕ
	//							  |	МобильноеПриложение.Магазин = &Магазин");
	//		
	//		Запрос.УстановитьПараметр("Магазин", Выборка.СтруктурнаяЕдиница);
	//		
	//		Выборка = Запрос.Выполнить().Выбрать();
	//		Пока Выборка.Следующий() Цикл
	//			Если Выборка.Ссылка <> ПланыОбмена.МобильноеПриложение.ЭтотУзел() Тогда
	//				ОбменДанными.Получатели.Добавить(Выборка.Ссылка);
	//			КонецЕсли;
	//		КонецЦикла;  
	//	КонецЕсли; 
	//КонецЕсли; 
	//
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	УстановитьПривилегированныйРежим(Истина);
	мДвижения = ЭтотОбъект.Движения.ЗаданияНаИнвентаризацию;
	мДвижения.Записывать = Истина;
	мДвижения.Очистить();
	
	ТекПользователь = ПараметрыСеанса.ТекущийПользователь;
	Для Каждого СтрокаТЧ Из ЭтотОбъект.Товары Цикл
		Движение = мДвижения.ДобавитьПриход();
		Движение.Период 			= ТекДата;
		Движение.Задание			= ЭтотОбъект.Ссылка;
		Движение.Номенклатура 		= СтрокаТЧ.Номенклатура;
		Движение.Характеристика 	= СтрокаТЧ.Характеристика;
		Движение.ДатаПроизводства 	= СтрокаТЧ.ДатаПроизводства;
		Движение.Количество 		= СтрокаТЧ.Количество;
		Движение.АвторИзменений		= ТекПользователь;
	КонецЦикла;
	
	Если ЭтотОбъект.Закрыто Тогда //Надо остатки по заданию в регистре закрыть
		мДвижения.Записать();
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ТекущийДокумент", ЭтотОбъект.Ссылка);
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаданияНаИнвентаризациюОстатки.Задание,
		|	ЗаданияНаИнвентаризациюОстатки.Номенклатура,
		|	ЗаданияНаИнвентаризациюОстатки.Характеристика,
		|	ЗаданияНаИнвентаризациюОстатки.ДатаПроизводства,
		|	ЗаданияНаИнвентаризациюОстатки.КоличествоОстаток КАК Количество
		|ИЗ
		|	РегистрНакопления.ЗаданияНаИнвентаризацию.Остатки(, Задание = &ТекущийДокумент) КАК ЗаданияНаИнвентаризациюОстатки";
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			Движение = мДвижения.ДобавитьРасход();
			Движение.Период 		= ТекДата;
			ЗаполнитьЗначенияСвойств(Движение, Выборка);
			Движение.АвторИзменений	= ТекПользователь;
		КонецЦикла;	
	КонецЕсли;
	
	мДвижения = ЭтотОбъект.Движения.Инвентаризация;
	мДвижения.Записывать = Истина;
	мДвижения.Очистить();
	Если ЭтотОбъект.Закрыто Тогда //Надо остатки по заданию в регистре закрыть
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	ЗаданиеНаИнвентаризациюТовары.Номенклатура,
			|	ЗаданиеНаИнвентаризациюТовары.Характеристика,
			|	ЗаданиеНаИнвентаризациюТовары.ДатаПроизводства,
			|	СУММА(ЗаданиеНаИнвентаризациюТовары.Количество) КАК Количество,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.Дата,
			|	ВЫБОР
			|		КОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Камера = ЗНАЧЕНИЕ(Справочник.Камеры.ПустаяСсылка)
			|			ТОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Склад
			|		ИНАЧЕ ЗаданиеНаИнвентаризациюТовары.Ссылка.Камера
			|	КОНЕЦ КАК Склад,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация КАК ДокументИнвентаризации,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.СтруктурнаяЕдиница,
			|	НАЧАЛОПЕРИОДА(ВЫБОР
			|			КОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация = ЗНАЧЕНИЕ(Документ.ИнвентаризацияСклад.ПустаяСсылка)
			|				ТОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Дата
			|			ИНАЧЕ ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация.Дата
			|		КОНЕЦ, ДЕНЬ) КАК ДатаИнвентаризации
			|ИЗ
			|	Документ.ЗаданиеНаИнвентаризацию.Товары КАК ЗаданиеНаИнвентаризациюТовары
			|ГДЕ
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка = &Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗаданиеНаИнвентаризациюТовары.Номенклатура,
			|	ЗаданиеНаИнвентаризациюТовары.Характеристика,
			|	ЗаданиеНаИнвентаризациюТовары.ЕдиницаИзмерения,
			|	ЗаданиеНаИнвентаризациюТовары.ДатаПроизводства,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.Дата,
			|	ВЫБОР
			|		КОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Камера = ЗНАЧЕНИЕ(Справочник.Камеры.ПустаяСсылка)
			|			ТОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Склад
			|		ИНАЧЕ ЗаданиеНаИнвентаризациюТовары.Ссылка.Камера
			|	КОНЕЦ,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация,
			|	ЗаданиеНаИнвентаризациюТовары.Ссылка.СтруктурнаяЕдиница,
			|	НАЧАЛОПЕРИОДА(ВЫБОР
			|			КОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация = ЗНАЧЕНИЕ(Документ.ИнвентаризацияСклад.ПустаяСсылка)
			|				ТОГДА ЗаданиеНаИнвентаризациюТовары.Ссылка.Дата
			|			ИНАЧЕ ЗаданиеНаИнвентаризациюТовары.Ссылка.Инвентаризация.Дата
			|		КОНЕЦ, ДЕНЬ)";

		Запрос.УстановитьПараметр("Ссылка", Ссылка);

		Результат = Запрос.Выполнить();

		ВыборкаДетальныеЗаписи = Результат.Выбрать();
		мДвижения = ЭтотОбъект.Движения.Инвентаризация;
		мДвижения.Записывать = Истина;
		мДвижения.Очистить();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Движение = мДвижения.Добавить();
			Движение.Период 		= Дата;
			ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

