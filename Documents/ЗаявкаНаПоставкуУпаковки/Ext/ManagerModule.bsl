Функция ПолучитьСЗПриходныхОрдеровСклад(Ссылка) Экспорт

	СЗРез = Новый СписокЗначений;
	Запрос1 = Новый Запрос;
	Запрос1.Текст = 
	"ВЫБРАТЬ
	|	ПриходныйОрдерСклад.Ссылка,
	|	ПриходныйОрдерСклад.Номер,
	|	ПриходныйОрдерСклад.Дата
	|ИЗ
	|	Документ.ПриходныйОрдерСклад КАК ПриходныйОрдерСклад
	|ГДЕ
	|	ПриходныйОрдерСклад.Проведен = ИСТИНА
	|	И ПриходныйОрдерСклад.Основание = &Основание";
	
	Запрос1.УстановитьПараметр("Основание", Ссылка);
	
	Рез1 = Запрос1.Выполнить();
	Выб1 = Рез1.Выбрать();
	
	Пока Выб1.Следующий() Цикл
		СЗРез.Добавить(Выб1.Ссылка, "№" + СокрЛП(Выб1.Номер) + " от " + Формат(Выб1.Дата, "ДЛФ=Д"));
	КонецЦикла;
	
	Возврат СЗРез;

КонецФункции // ()

Функция ПечатьВыполненнойЗаявки(Ссылка) Экспорт
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.ОриентацияСтраницы		= ОриентацияСтраницы.Портрет;
	ТабДок.РазмерКолонтитулаСнизу	= 0;
	ТабДок.РазмерКолонтитулаСверху 	= 0;
	ТабДок.ПолеСверху 	= 5;
	ТабДок.ПолеСнизу 	= 5;
	ТабДок.ПолеСлева 	= 5;
	ТабДок.ПолеСправа 	= 5;
	ТабДок.АвтоМасштаб	= Истина;
	
	Макет = Документы.ЗаявкаНаПоставкуУпаковки.ПолучитьМакет("Заявка");
	
	Запрос = Новый Запрос;
	Запрос.Параметры.Вставить("Ссылка", Ссылка);
	Запрос.Параметры.Вставить("ДатаСреза", КонецДня(Ссылка.Дата));
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗаявкаНаПоставкуУпаковки.Номер,
	               |	ЗаявкаНаПоставкуУпаковки.Дата,
	               |	ЗаявкаНаПоставкуУпаковки.Склад,
	               |	ЗаявкаНаПоставкуУпаковки.Комментарий,
	               |	ЗаявкаНаПоставкуУпаковки.Поставщик КАК Получатель,
	               |	ЗаявкаНаПоставкуУпаковки.Автор,
	               |	ЗаявкаНаПоставкуУпаковки.ОжидаемаяДатаПоставки
	               |ИЗ
	               |	Документ.ЗаявкаНаПоставкуУпаковки КАК ЗаявкаНаПоставкуУпаковки
	               |ГДЕ
	               |	ЗаявкаНаПоставкуУпаковки.Ссылка = &Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЗаявкаНаПоставкуУпаковкиТовары.Номенклатура.Наименование КАК Наименование,
	               |	ЗаявкаНаПоставкуУпаковкиТовары.ЕдиницаИзмерения,
	               |	ЗаявкаНаПоставкуУпаковкиТовары.Количество,
	               |	ЗаявкаНаПоставкуУпаковкиТовары.ЗаявкаНаПечатьЭтикетки.Номер КАК ЗаявкаНаПроизводство,
	               |	ЗаявкаНаПоставкуУпаковкиТовары.Склад,
	               |	ЗаявкаНаПоставкуУпаковкиТовары.Получатель
	               |ИЗ
	               |	Документ.ЗаявкаНаПоставкуУпаковки.Товары КАК ЗаявкаНаПоставкуУпаковкиТовары
	               |ГДЕ
	               |	ЗаявкаНаПоставкуУпаковкиТовары.Ссылка = &Ссылка";
	
	Результаты = Запрос.ВыполнитьПакет();
	Выборка 		= Результаты[0].Выбрать();
	ТабЭтикетки 	= Результаты[1].Выгрузить();
	
	ОбластьЗаголовок 		= Макет.ПолучитьОбласть("Заголовок");
	ОбластьСклад	 		= Макет.ПолучитьОбласть("Склад");
	ОбластьПолучатель 		= Макет.ПолучитьОбласть("Получатель");
	ОбластьШапкаТаблицы 	= Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьСтрока 			= Макет.ПолучитьОбласть("Строка");
	ОбластьПодвал 			= Макет.ПолучитьОбласть("Подвал");
	ОбластьВремяПечати 		= Макет.ПолучитьОбласть("ВремяПечати");
	ОбластьИтог         	= Макет.ПолучитьОбласть("Итог");
	
	ТабДок.Очистить();
	
	ВставлятьРазделительСтраниц = Ложь;
	Пока Выборка.Следующий() Цикл
		
		Если ВставлятьРазделительСтраниц Тогда
			ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;
		ОбластьЗаголовок.Параметры.Заполнить(Выборка);
		ОбластьЗаголовок.Параметры.Дата = Формат(Выборка.Дата, "ДЛФ=DD");
		ТекДоговор = ПолучитьДоговорКонтрагента(Ссылка.Поставщик);
		ОбластьЗаголовок.Параметры.ОрганизацияНаименование = ?(ЗначениеЗаполнено(ТекДоговор),ТекДоговор.Организация,Справочники.Организации.ПустаяСсылка());
		 			
		ТабДок.Вывести(ОбластьЗаголовок);
		
		ОбластьСклад.Параметры.Заполнить(Выборка);
		
		ТабДок.Вывести(ОбластьСклад, Выборка.Уровень());
		
		ОбластьПолучатель.Параметры.Заполнить(Выборка);
		ТабДок.Вывести(ОбластьПолучатель, Выборка.Уровень());
		
		Если ЗначениеЗаполнено(Выборка.Комментарий) Тогда
			ОбластьКоммент          = Макет.ПолучитьОбласть("Комментарий");
			ОбластьКоммент.Параметры.Комментарий = СокрЛП(Выборка.Комментарий);
			ТабДок.Вывести(ОбластьКоммент);
		КонецЕсли;	
		
		ТабДок.Вывести(ОбластьШапкаТаблицы);
						
		// Строка
		КолвоКор 	= 0;
		КолвоЕд 	= 0;
		КолвоУРЗ 	= 0;
		КолвоТТ 	= 0;
		Для Каждого ВыборкаНоменклатура Из ТабЭтикетки Цикл
			ОбластьСтрока.Параметры.Заполнить(ВыборкаНоменклатура);
			КолвоЕд = КолвоЕд + ВыборкаНоменклатура.Количество;
			ТабДок.Вывести(ОбластьСтрока);
		КонецЦикла;
		
		// Подвал
		//ОбластьИтог.Параметры.ИтогКор 	= КолвоКор;
		//ОбластьИтог.Параметры.ИтогУРЗ 	= КолвоУРЗ;
		ОбластьИтог.Параметры.ИтогЕд 	= КолвоЕд;
		//ОбластьИтог.Параметры.ИтогТТ 	= КолвоТТ;
		ТабДок.Вывести(ОбластьИтог);
		
		ОбластьВремяПечати.Параметры.ВремяПечати = "[" + ТекущаяДата() + "] " + "Автор: " + Выборка.Автор;
		
		ТабДок.Вывести(ОбластьПодвал);
		
		ВставлятьРазделительСтраниц = Истина;
		ТабДок.Вывести(ОбластьВремяПечати);
		
	КонецЦикла;
	
	Возврат ТабДок;
		
КонецФункции	
 
Функция ПолучитьДоговорКонтрагента(мКонтрагент)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Контрагент", мКонтрагент);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(ДоговорыКонтрагентов.Ссылка) КАК Количество
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Владелец = &Контрагент
	|	И НЕ ДоговорыКонтрагентов.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДоговорыКонтрагентов.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
	|ГДЕ
	|	ДоговорыКонтрагентов.Владелец = &Контрагент
	|	И НЕ ДоговорыКонтрагентов.ПометкаУдаления";
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	Выборка1 = РезультатыЗапроса[0].Выбрать();
	Если Выборка1.Следующий() Тогда
		Если Выборка1.Количество > 0 Тогда
			Если Выборка1.Количество > 1
				И НЕ мКонтрагент.ОсновнойДоговорКонтрагента.пустая() Тогда
				Возврат мКонтрагент.ОсновнойДоговорКонтрагента
			КонецЕсли;
			
			Выборка2 = РезультатыЗапроса[1].Выбрать();
			Выборка2.Следующий();
			Возврат Выборка2.Ссылка;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	
КонецФункции

