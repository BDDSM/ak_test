
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	//СоздатьЗаякуНаСервере(); такое создание теперь в приходнике
КонецПроцедуры

Процедура СоздатьЗаякуНаСервере()
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗаявкаНаСклад.Ссылка
	               |ИЗ
	               |	Документ.ЗаявкаНаСклад КАК ЗаявкаНаСклад
	               |ГДЕ
	               |	ЗаявкаНаСклад.Основание = &Основание";
				   
	Запрос.УстановитьПараметр("Основание", Ссылка);
	
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаявкаНаПоставкуУпаковкиТовары.Номенклатура,
		|	ЗаявкаНаПоставкуУпаковкиТовары.Количество,
		|	ЗаявкаНаПоставкуУпаковкиТовары.ЕдиницаИзмерения,
		|	ЗаявкаНаПоставкуУпаковкиТовары.Характеристика,
		|	ЗаявкаНаПоставкуУпаковкиТовары.Получатель КАК Получатель,
		|	ЗаявкаНаПоставкуУпаковкиТовары.Склад КАК Склад,
		|	ЗаявкаНаПоставкуУпаковкиТовары.НомерСтроки КАК НомерСтрокиУпаковка,
		|	ЗаявкаНаПоставкуУпаковкиТовары.Ссылка.Автор
		|ИЗ
		|	Документ.ЗаявкаНаПоставкуУпаковки.Товары КАК ЗаявкаНаПоставкуУпаковкиТовары
		|ГДЕ
		|	ЗаявкаНаПоставкуУпаковкиТовары.Ссылка = &Ссылка
		|ИТОГИ ПО
		|	Получатель,
		|	Склад";
		
		Запрос.УстановитьПараметр("Ссылка", Ссылка);
		
		Результат = Запрос.Выполнить();
		
		ВыборкаПолучатель = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаПолучатель.Следующий() Цикл
			
			ВыборкаСклад = ВыборкаПолучатель.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			
			Пока ВыборкаСклад.Следующий() Цикл
				
				ВыборкаДетальныеЗаписи = ВыборкаСклад.Выбрать();
				
				ДокументОбъект = Документы.ЗаявкаНаСклад.СоздатьДокумент();
				ДокументОбъект.Дата = ТекущаяДата();
				ДокументОбъект.Подразделение = ВыборкаСклад.Склад.Владелец;
				ДокументОбъект.Склад = ВыборкаСклад.Склад;
				ДокументОбъект.ВидОперации = Перечисления.ВидыОперацийЗаявкиНаСклад.ОтгрузкаВПереработку;
				ДокументОбъект.Получатель = ВыборкаСклад.Получатель;
				
				ДокументОбъект.ДатаОтгрузки = ОжидаемаяДатаПоставки;
				
				ДокументОбъект.Основание =  Ссылка;
				
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
					НовСтр = ДокументОбъект.Товары.Добавить();
					ЗаполнитьЗначенияСвойств(НовСтр, ВыборкаДетальныеЗаписи);    				
				КонецЦикла;
				
				Попытка
					
					ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
					
				Исключение
					
					Попытка
						
						ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
						
					Исключение
						
						Сообщение = Новый СообщениеПользователю;
						Сообщение.Текст = ОписаниеОшибки();
						Сообщение.Сообщить();
						
					КонецПопытки;
					
					
				КонецПопытки;
				
			КонецЦикла;
		КонецЦикла;
	КонецЕсли;	
		
КонецПроцедуры // СоздатьЗаякуНаСервере()

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если Не ЭтоНовый() Тогда
		
		Попытка
		
			ПользователиПолныеПрава.УдалитьЗаявкиНаСклад(Ссылка);
		
		Исключение
			
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = ОписаниеОшибки();
			Сообщение.Сообщить();
		
		КонецПопытки;
		
	КонецЕсли;	
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПриходныйОрдерСклад") Тогда
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеЗаполнения,,"Дата, Номер, Комментарий");
		Дата = ТекущаяДата();
		ОжидаемаяДатаПоставки = ТекущаяДата();
		ДокументОснование = ДанныеЗаполнения;
		Для Каждого Стр Из ДанныеЗаполнения.Товары Цикл
			Если Стр.Количество > 0 Тогда
				НоваяСтрока = Товары.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока,Стр);
				НоваяСтрока.ЗаявкаНаПечатьЭтикетки = Стр.ЗаявкаНаПроизводствоПерсональнойУпаковки;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура ОтправитьПолучено() Экспорт
	
	ТаблицаВложений = Новый ТаблицаЗначений;
	ТаблицаВложений.Колонки.Добавить("Файл", Новый ОписаниеТипов("Строка"));
	ТаблицаВложений.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("Строка"));
	ТабДок = Документы.ЗаявкаНаПоставкуУпаковки.ПечатьВыполненнойЗаявки(Ссылка);
	мИмяФайла = КаталогВременныхФайлов() + Номер + ".PDF";
	Попытка
		ТабДок.Записать(мИмяФайла, ТипФайлаТабличногоДокумента.PDF); 
		ИмяФайла = мИмяФайла;
		НовоеВложение = ТаблицаВложений.Добавить();
		НовоеВложение.Файл = мИмяФайла;
		НовоеВложение.Номенклатура = ОбщегоНазначения.ПолучитьНомерНаПечать(Номер);
	Исключение
		
	КонецПопытки;
	
	АдресОтправителя = Товары[0].ЗаявкаНаПечатьЭтикетки.АдресОтправителя;
	
	Если ЗначениеЗаполнено(Ссылка) и ЗначениеЗаполнено(АдресОтправителя) Тогда
		ТемаГотово="Заявка на получение упаковки №"+Номер+".";
		ТекстГотово = "Этикетки по произведены. Оформлена заявка на получение №"+Номер+". ";
		Для каждого СтрокаТЧ из Товары Цикл
			ТекстГотово = ТекстГотово+Символы.ПС+СтрокаТЧ.Номенклатура.Наименование+" "+строка(СтрокаТЧ.Количество)+"шт. ";
		КонецЦикла;
		ОтправитьПисьмо(ТемаГотово,ТекстГотово,ТаблицаВложений,АдресОтправителя);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтправитьПисьмо(Тема,ТекстПисьма,Вложения=Неопределено,АдресОтправителя)
	УчетнаяЗапись = Справочники.УчетныеЗаписиЭлектроннойПочты.ЗаявкиНаЭтикетки;
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
	Почта = Новый ИнтернетПочта;
	
	Сообщ = Новый СообщениеПользователю();
	Попытка
		Почта.Подключиться(Профиль);
	Исключение
		// Ошибка при подключении к серверу или при приеме сообщения обмена
		Сообщ.Текст = " - Ошибка при подключении или приеме" + ОписаниеОшибки();
		Сообщ.Сообщить();
		Возврат;
	КонецПопытки;
	
	Письмо = Новый ИнтернетПочтовоеСообщение;
	Письмо.Тема = Тема;
	Письмо.Отправитель = УчетнаяЗапись.Логин;
	Письмо.ИмяОтправителя = УчетнаяЗапись.Логин;
	Получатель = Письмо.Получатели.Добавить();
	Получатель.Адрес = АдресОтправителя;
	ТекстПиьсма = Письмо.Тексты.Добавить();
	ТекстПиьсма.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
	ТекстПиьсма.Текст = ТекстПисьма;
	Если не Вложения = Неопределено Тогда
		Для Каждого Вложение из Вложения Цикл
			Если ЗначениеЗаполнено(Вложение.Файл) Тогда
				Письмо.Вложения.Добавить(Вложение.Файл,Вложение.Номенклатура);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
    Почта.Послать(Письмо);
	Почта.Отключиться();
КонецПроцедуры


