
Функция ПолучитьСотрудникаПоФизЛицу(ТекОрганизация, ТекФизлицо)
	
	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация"	, ТекОрганизация);
	Запрос.УстановитьПараметр("Физлицо"		, ТекФизлицо);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СотрудникиОрганизаций.Ссылка
	|ИЗ
	|	Справочник.СотрудникиОрганизаций КАК СотрудникиОрганизаций
	|ГДЕ
	|	СотрудникиОрганизаций.Физлицо = &Физлицо
	|	И СотрудникиОрганизаций.Организация = &Организация";
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
	
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Физлицо", ТекФизлицо);
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СотрудникиОрганизаций.Ссылка
		|ИЗ
		|	Справочник.СотрудникиОрганизаций КАК СотрудникиОрганизаций
		|ГДЕ
		|	СотрудникиОрганизаций.Физлицо = &Физлицо";
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Возврат Справочники.СотрудникиОрганизаций.ПустаяСсылка();	
		КонецЕсли;
		
	КонецЕсли;
	
	//
	Выборка = Результат.Выбрать();
	Выборка.Следующий();	
	
	Возврат Выборка.Ссылка;
	
КонецФункции


Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ЗначениеЗаполнено(ДанныеЗаполнения) Тогда
		
		ЭтотОбъект.Организация 					= ДанныеЗаполнения.Организация;
		
		Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.АвансовыйОтчет") Тогда
			
			ЭтотОбъект.СотрудникиОрганизации 	= ПолучитьСотрудникаПоФизЛицу(ЭтотОбъект.Организация, ДанныеЗаполнения.Физлицо);
			
		ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаявкаНаРасходованиеСредств") Тогда
			
			ЭтотОбъект.СотрудникиОрганизации 	= ПолучитьСотрудникаПоФизЛицу(ЭтотОбъект.Организация, ДанныеЗаполнения.Контрагент);
			
		КонецЕсли;
		
		ЭтотОбъект.ТабельныйНомер 				= ЭтотОбъект.СотрудникиОрганизации.Код;
		ЭтотОбъект.ПодразделениеОрганизации 	= ЭтотОбъект.СотрудникиОрганизации.ПодразделениеОрганизации;
		ЭтотОбъект.Должность 					= ЭтотОбъект.СотрудникиОрганизации.Физлицо.Должность;
		
		Если НЕ ЭтотОбъект.СотрудникиОрганизации.Организация = ЭтотОбъект.Организация Тогда
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Внимание! Данный сотрудник  является работником другой организации!";
			Сообщение.Сообщить();
		КонецЕсли;
		
		ЭтотОбъект.ДокументОснование 			= ДанныеЗаполнения;
	Иначе
		
		ЭтотОбъект.Организация = Справочники.Организации.НайтиПоКоду("000000006");
		
	КонецЕсли;	

КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.МестоНазначения) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Заполните место назначения!";
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.ЦельКомандировки) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Заполните цель командировки!";
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.НачалоКомандировки)
			ИЛИ НЕ ЗначениеЗаполнено(ЭтотОбъект.КонецКомандировки) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Заполните период!";
		Сообщение.Сообщить();
		Отказ = Истина;
	КонецЕсли;
	
//+++АК KOPA 2018.04.09 ИП-00018322
	Если ЭтотОбъект.АК_Статус = Перечисления.АК_СтаусыПриказаНаКомандировку.Создан и ЗначениеЗаполнено(ЭтотОбъект.ФизЛицо) Тогда
		ТелеграмТехБот.ЗарегистрироватьОбъектНаОтправкуВТелеграмТехБот(ЭтотОбъект.Ссылка, Отказ);
	Иначе 
		ТелеграмТехБот.СнятьРегистрациюОбъектаНаОтправкуВТелеграмТехБот(ЭтотОбъект.Ссылка, Отказ);
	КонецЕсли;
//---АК KOPA
КонецПроцедуры

//+++АК KOPA 2018.04.10 ИП-00018322
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Если РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения Тогда
		ТелеграмТехБот.СнятьРегистрациюОбъектаНаОтправкуВТелеграмТехБот(ЭтотОбъект.Ссылка, Отказ);	
	КонецЕсли;
КонецПроцедуры//---АК KOPA


