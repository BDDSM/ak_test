&НаКлиенте
Процедура УстановитьВидимостьДоступность()
	
	// Материалы
	ЭтоМатериалы = (Объект.ВидСписания = ПредопределенноеЗначение("Перечисление.ВидыСписанияТребованиеНакладная.СписаниеМатериалов"));
	
	Если ЭтоМатериалы Тогда
		
		Элементы.Контрагент.Видимость	= НЕ ЭтоМатериалы;
		Элементы.ГруппаПериод.Видимость	= ЭтоМатериалы;
		Элементы.ТоварыЗаполнитьПоОстаткамМатериалов.Видимость = ЭтоМатериалы;

		
		
	Иначе	
		//Видимость контрагента и периода
		КонтрагентВидимость				= (Объект.ВидСписания = ПредопределенноеЗначение("Перечисление.ВидыСписанияТребованиеНакладная.РаспределениеНаПоступившийТовар"));
		Элементы.Контрагент.Видимость	= КонтрагентВидимость;
		Элементы.ГруппаПериод.Видимость	= КонтрагентВидимость;
		
		//Видимость счета списания
		ВидимостьСчета 						= (Объект.ВидСписания = ПредопределенноеЗначение("Перечисление.ВидыСписанияТребованиеНакладная.НаУказанныйСчет"));
		Элементы.ТоварыСчетЗатрат.Видимость	= ВидимостьСчета;
		Элементы.ТоварыСубконто1.Видимость	= ВидимостьСчета;
		Элементы.ТоварыСубконто2.Видимость	= ВидимостьСчета;
		Элементы.ТоварыСубконто3.Видимость	= ВидимостьСчета;
		
	КонецЕсли;
	
	Элементы.ТоварыСтавкаНДС.Видимость = НЕ ЭтоМатериалы; 
	Элементы.ТоварыСуммаНДС.Видимость = НЕ ЭтоМатериалы;	
	Элементы.Склад.Видимость = НЕ ЭтоМатериалы;
	
	//+++susk
	//ИП-00016544
	
	Элементы.ТоварыЦена.Видимость = ЭтоМатериалы;
	Элементы.ТоварыСумма.Видимость = ЭтоМатериалы;	
	
	//Элементы.ТоварыЦена.Видимость = НЕ ЭтоМатериалы;
	//Элементы.ТоварыСумма.Видимость = НЕ ЭтоМатериалы;		
	//---susk
	
	Элементы.ТоварыСубконтоУчет1.Видимость = НЕ ЭтоМатериалы;
    Элементы.ТоварыСубконтоУчет2.Видимость = НЕ ЭтоМатериалы;
    Элементы.ТоварыСубконтоУчет3.Видимость = НЕ ЭтоМатериалы;

КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьТекущегоПользователяСервер()
	
	Возврат ПараметрыСеанса.ТекущийПользователь;
	
КонецФункции	

&НаСервереБезКонтекста
Функция ДатьВладельцаСклада(Склад)
	
	Возврат Склад.Владелец;
	
КонецФункции

&НаСервереБезКонтекста
Функция ДатьСтавкуНДССервер(Номенклатура)
	
	Возврат Номенклатура.СтавкаНДС;
	
КонецФункции

&НаСервереБезКонтекста
Функция ДатьЦенуПоставкиСервер(Номенклатура, Дата)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Дата"		, Дата);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЦеныПоставщиковСрезПоследних.Номенклатура,
	|	ЦеныПоставщиковСрезПоследних.Цена
	|ИЗ
	|	РегистрСведений.ЦеныПоставщиков.СрезПоследних(&Дата, Номенклатура = &Номенклатура) КАК ЦеныПоставщиковСрезПоследних
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЦеныПоставщиковСрезПоследних.Период УБЫВ";
							
	Выборка = Запрос.Выполнить().Выбрать();
	
	Возврат ?(Выборка.Следующий(), Выборка.Цена, 0);
	
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//+++АК sils 08.06.2018 ИП-00018466
	ОперацияАпдекс = APDEX_ОценкаПроизводительностиКлиентСервер.ПолучитьОперацию("Открытие документа Требование-накладная");
	APDEX_ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(ОперацияАпдекс);
	//---АК
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		НастройкаПравДоступа.ОпределитьДоступностьВозможностьИзмененияДокументаПоДатеЗапрета(Объект.Ссылка.ПолучитьОбъект(), ЭтаФорма);
	Иначе
		Объект.ВидСписания		= ПредопределенноеЗначение("Перечисление.ВидыСписанияТребованиеНакладная.СписаниеМатериалов");
		Объект.ДатаНачала		= НачалоМесяца(ТекущаяДата());
		Объект.ДатаОкончания	= КонецМесяца(ТекущаяДата());
	КонецЕсли;
	
		
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	УстановитьВидимостьДоступность();
	
	//Проставим ответственного в новом документе
	Если Объект.Ссылка.Пустая() Тогда
		Объект.Ответственный = ПолучитьТекущегоПользователяСервер();
	КонецЕсли;
	
	//+++АК sils 08.06.2018 ИП-00018466
	APDEX_ОценкаПроизводительностиКлиентСервер.ЗакончитьЗамерВремени(ОперацияАпдекс, ?(Параметры.Ключ.Пустая(), "Новый документ", "" + Объект.Ссылка));
	//---АК
КонецПроцедуры


&НаКлиенте
Процедура ВидсписанияПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры

&НаКлиенте
Процедура НастройкаПериода(Команда)

	Период = Новый СтандартныйПериод;
	Диалог = Новый ДиалогРедактированияСтандартногоПериода();
	
	Если Диалог.Редактировать() Тогда 
	    Объект.ДатаНачала		= Диалог.Период.ДатаНачала;
	    Объект.ДатаОкончания	= Диалог.Период.ДатаОкончания;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураПриИзменении(Элемент)
	
	ТекущиеДанные	= Элементы.Товары.ТекущиеДанные;
	мДата			= ?(ЗначениеЗаполнено(Объект.Ссылка), Объект.Дата, ТекущаяДата());
	
	//Эти вещи пока не требуются, определяются в ходе формирования проводок (упаковка/не упаковка)
	//----------------------------
	//Счет недоступен для правки, зашиваем программно
	ТекущиеДанные.СчетЗатрат = ПланыСчетов.Финансовый.НайтиПоКоду("44.1");
	
	////Субконто
	//СтруктураНастроек		= ОбщегоНазначенияСервер.ПолучитьНастройкиОтраженияОперацийВУчете(Перечисления.ВидыОперацийВУчете.СписаниеОтходовОтПереработки, мДата);
	//ТекущиеДанные.Субконто1	= Объект.Склад;
	//ТекущиеДанные.Субконто2	= СтруктураНастроек.СтатьяДоходовРасходов;
	//ТекущиеДанные.Субконто3	= ОбщиеПроцедуры.ПолучитьЦФОПоСтруктурнойЕдинице(ДатьВладельцаСклада(Объект.Склад), мДата);
	//----------------------------
	
	//Цена поставки
	ТекущиеДанные.Цена = ДатьЦенуПоставкиСервер(ТекущиеДанные.Номенклатура, мДата);
	
	//НДС
	ТекущиеДанные.СтавкаНДС	= ДатьСтавкуНДССервер(ТекущиеДанные.Номенклатура);
	
	//Пересчет данных в строке
	РассчитатьСуммыВСтроке(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыНоменклатураНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	СтрокаТабличнойЧасти = Элементы.Товары.ТекущиеДанные;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Склад",	Объект.Склад);
	ПараметрыФормы.Вставить("Дата",		?(ЗначениеЗаполнено(Объект.Ссылка), Объект.Дата, ТекущаяДата()));
	
	ПараметрыФормы.Вставить("Режим", "С остатками по складу");
		
	Результат = ОткрытьФормуМодально("Справочник.Номенклатура.Форма.ФормаВыбораУправляемая", ПараметрыФормы);
	
	Если Результат = Неопределено Тогда
		Возврат;
	Иначе
		СтрокаТабличнойЧасти.Номенклатура = Результат;
		ТоварыНоменклатураПриИзменении(Элемент);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	РассчитатьСуммыВСтроке(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	РассчитатьСуммыВСтроке(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммыВСтроке(ТекущиеДанные)

	ТекущиеДанные.Сумма = ТекущиеДанные.Цена * ТекущиеДанные.Количество;
	РассчитатьСуммуНДСТабЧасти(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуНДСТабЧасти(СтрокаТабличнойЧасти)
	
	УчитыватьНДС		= Истина;
	СуммаВключаетНДС	= Истина;
	
	СтрокаТабличнойЧасти.СуммаНДС = УчетНДС.РассчитатьСуммуНДС(СтрокаТабличнойЧасти.Сумма,
													   УчитыватьНДС, СуммаВключаетНДС,
													   УчетНДС.ПолучитьСтавкуНДС(СтрокаТабличнойЧасти.СтавкаНДС));
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСтавкаНДСПриИзменении(Элемент)

	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	РассчитатьСуммуНДСТабЧасти(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоОстаткамМатериалов(Команда)
	
	//++AK susk
	// временно
	Ответ = Вопрос("Вы выбираете старый механизм заполнения. Продолжить?", РежимДиалогаВопрос.ДаНет);
	
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	//---AK susk
	
	ЗаполнитьПоОстаткамМатериаловНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоОстаткамМатериаловНаСервере(СчетУчета = Неопределено)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетЗатрат КАК СчетУчета,
	               |	Таблица.Номенклатура КАК СубконтоУчет1,
	               |	Таблица.Субконто2 КАК СубконтоУчет2,
	               |	Таблица.Субконто3 КАК СубконтоУчет3,
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ3,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения) КАК СчетЗатрат,
	               |	Таблица.ТорговаяТочка КАК Субконто1,
	               |	Таблица.Ссылка.СтатьяЗатрат КАК Субконто2,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.СтруктурнаяЕдиница ЕСТЬ NULL 
	               |				ИЛИ Таблица.Ссылка.СтруктурнаяЕдиница = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.СтруктурнаяЕдиница
	               |	КОНЕЦ КАК Субконто3,
	               |	СУММА(Таблица.Количество) КАК Количество,
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ) КАК Сумма
	               |ПОМЕСТИТЬ втРезультат
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Услуги КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО Таблица.ТорговаяТочка = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетЗатрат В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоНУ3,
	               |	Таблица.Субконто3,
	               |	Таблица.Субконто2,
	               |	Таблица.СчетЗатрат,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.ТорговаяТочка,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.СтруктурнаяЕдиница ЕСТЬ NULL 
	               |				ИЛИ Таблица.Ссылка.СтруктурнаяЕдиница = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.СтруктурнаяЕдиница
	               |	КОНЕЦ,
	               |	Таблица.Номенклатура
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	НЕОПРЕДЕЛЕНО,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	СУММА(Таблица.Количество),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ)
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Товары КАК Таблица
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.СчетУчета,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	Таблица.Номенклатура
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	НЕОПРЕДЕЛЕНО,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	СУММА(Таблица.Количество),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ)
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Товары КАК Таблица
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	Таблица.Субконто2,
	               |	Таблица.Субконто3,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	ВЫБОР
	               |		КОГДА Таблица.ТорговаяТочка ЕСТЬ NULL 
	               |				ИЛИ Таблица.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.Пустаяссылка)
	               |			ТОГДА Таблица.Ссылка.ЦФО
	               |		ИНАЧЕ Таблица.ТорговаяТочка
	               |	КОНЕЦ,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.ЦФО ЕСТЬ NULL 
	               |				ИЛИ Таблица.Ссылка.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.ЦФО
	               |	КОНЕЦ,
	               |	СУММА(Таблица.Количество),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ)
	               |ИЗ
	               |	Документ.АвансовыйОтчет.Товары КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО Таблица.ТорговаяТочка = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.Субконто3,
	               |	Таблица.Субконто2,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.СчетУчетаБУ,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.ЦФО ЕСТЬ NULL 
	               |				ИЛИ Таблица.Ссылка.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.ЦФО
	               |	КОНЕЦ,
	               |	ВЫБОР
	               |		КОГДА Таблица.ТорговаяТочка ЕСТЬ NULL 
	               |				ИЛИ Таблица.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.Пустаяссылка)
	               |			ТОГДА Таблица.Ссылка.ЦФО
	               |		ИНАЧЕ Таблица.ТорговаяТочка
	               |	КОНЕЦ,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СтатьиДоходовРасходов.Ссылка
	               |ПОМЕСТИТЬ втСтатьи442
	               |ИЗ
	               |	Справочник.СтатьиДоходовРасходов КАК СтатьиДоходовРасходов
	               |ГДЕ
	               |	СтатьиДоходовРасходов.Ссылка В(&Статьи442)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.СубконтоУчет1,
	               |	Таблица.СубконтоУчет2,
	               |	Таблица.СубконтоУчет3,
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ3,
	               |	Таблица.Субконто1,
	               |	Таблица.Субконто2,
	               |	Таблица.Субконто3,
	               |	ВЫБОР
	               |		КОГДА Таблица.Количество > 0
	               |			ТОГДА Таблица.Сумма / Таблица.Количество
	               |		ИНАЧЕ 0
	               |	КОНЕЦ КАК Цена,
	               |	Таблица.Количество,
	               |	Таблица.Сумма,
	               |	ВЫБОР
	               |		КОГДА Статьи442.Ссылка ЕСТЬ NULL 
	               |			ТОГДА Таблица.СчетЗатрат
	               |		ИНАЧЕ ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыОбщиеДляРаспределения)
	               |	КОНЕЦ КАК СчетЗатрат
	               |ИЗ
	               |	втРезультат КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			втСтатьи442.Ссылка КАК Ссылка
	               |		ИЗ
	               |			втСтатьи442 КАК втСтатьи442) КАК Статьи442
	               |		ПО Таблица.Субконто2 = Статьи442.Ссылка
	               |ГДЕ
	               |	(Таблица.СчетУчета = &СчетУчета
	               |			ИЛИ &СчетУчетаНеЗаполнен)";

				   
				   
	Если Не ЗначениеЗаполнено(СчетУчета) Тогда
		Запрос.УстановитьПараметр("СчетУчетаНеЗаполнен", Истина);	
		Запрос.УстановитьПараметр("СчетУчета", ПланыСчетов.Финансовый.ПустаяСсылка());
	Иначе 
		Запрос.УстановитьПараметр("СчетУчетаНеЗаполнен", Ложь);	
		Запрос.УстановитьПараметр("СчетУчета", СчетУчета);
	КонецЕсли;	
	
	Запрос.УстановитьПараметр("Статьи442", АК_ОсновныеСредства.МассивСтатейДРДляОтнесенияНаРасходыОфис());
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("ДатаНачала", Объект.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));
   	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	//Запрос.УстановитьПараметр("Счет445", ПланыСчетов.Финансовый.НайтиПоКоду("44.5"));

	Результат = Запрос.Выполнить().Выгрузить();

	Объект.Товары.Загрузить(Результат);	
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоСчетуПрочиеМатериалы(Команда)
	
	//++AK susk
	// временно
	Ответ = Вопрос("Вы выбираете старый механизм заполнения. Продолжить?", РежимДиалогаВопрос.ДаНет);
	
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	//---AK susk
	
	ЗаполнитьПоОстаткамМатериаловНаСервере(ПредопределенноеЗначение("ПланСчетов.Финансовый.ПрочиеМатериалы"));
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоСчетуГСМ(Команда)
	//++AK susk
	// временно
	Ответ = Вопрос("Вы выбираете старый механизм заполнения. Продолжить?", РежимДиалогаВопрос.ДаНет);
	
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	//---AK susk
	
	ЗаполнитьПоОстаткамМатериаловНаСервере(ПредопределенноеЗначение("ПланСчетов.Финансовый.ГСМ"));
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаКлиенте
Процедура ЗаполнитьПоОстаткамМатериаловНовые(Команда)
	
	ЗаполнитьПоОстаткамМатериаловНовыеНаСервере();
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаКлиенте
Процедура ЗаполнитьПоСчетуГСМНовые(Команда)
	ЗаполнитьПоОстаткамМатериаловНовыеНаСервере(ПредопределенноеЗначение("ПланСчетов.Финансовый.ГСМ"));
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаКлиенте
Процедура ЗаполнитьПоСчетуПрочиеМатериалыНОвые(Команда)
	ЗаполнитьПоОстаткамМатериаловНовыеНаСервере(ПредопределенноеЗначение("ПланСчетов.Финансовый.ПрочиеМатериалы"));
	РаспределитьПоНормам();
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаСервере
Процедура ЗаполнитьПоОстаткамМатериаловНовыеНаСервере(СчетУчета = Неопределено)
	
	Запрос = Новый Запрос;		
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПоступлениеДопРасходовТовары.Ссылка КАК Ссылка,
	               |	ПоступлениеДопРасходовТовары.НомерСтроки КАК НомерСтроки,
	               |	ПоступлениеДопРасходовТовары.Номенклатура КАК Номенклатура,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка КАК ТорговаяТочка,
	               |	МАКСИМУМ(ПоступлениеДопРасходовТовары.СчетУчета) КАК СчетБУ,
	               |	ПоступлениеДопРасходовТовары.Ссылка.СтатьяДДС КАК СтатьяДДС,
	               |	СУММА(ПоступлениеДопРасходовТовары.Количество) КАК Количество,
	               |	ПоступлениеДопРасходовТовары.Партия.СтруктурнаяЕдиница КАК ЦФО,
	               |	ПоступлениеДопРасходовТовары.Ссылка.ВариантРасчетаНДС КАК ВариантРасчетаНДС
	               |ПОМЕСТИТЬ ДопРасходыДокументы
	               |ИЗ
	               |	Документ.ПоступлениеДопРасходов.Товары КАК ПоступлениеДопРасходовТовары
	               |ГДЕ
	               |	ПоступлениеДопРасходовТовары.Ссылка.Проведен
	               |	И ПоступлениеДопРасходовТовары.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |	И ПоступлениеДопРасходовТовары.СчетЗатрат В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И ПоступлениеДопРасходовТовары.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И ПоступлениеДопРасходовТовары.Ссылка.Организация = &Организация
	               |	И ПоступлениеДопРасходовТовары.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ПоступлениеДопРасходовТовары.Ссылка,
	               |	ПоступлениеДопРасходовТовары.Номенклатура,
	               |	ПоступлениеДопРасходовТовары.НомерСтроки,
	               |	ПоступлениеДопРасходовТовары.Ссылка.СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.Партия.СтруктурнаяЕдиница,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.Ссылка.ВариантРасчетаНДС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПоступлениеДопРасходовТовары.Ссылка КАК Ссылка,
	               |	ПоступлениеДопРасходовТовары.Номенклатура КАК Номенклатура,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка КАК ТорговаяТочка,
	               |	МАКСИМУМ(ПоступлениеДопРасходовТовары.СчетБУ) КАК СчетБУ,
	               |	ПоступлениеДопРасходовТовары.Ссылка.СтатьяДДС КАК СтатьяДДС,
	               |	СУММА(ПоступлениеДопРасходовТовары.Количество) КАК Количество,
	               |	ПоступлениеДопРасходовТовары.ЦФО КАК ЦФО,
	               |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС КАК ВариантРасчетаНДС
	               |ПОМЕСТИТЬ ДопРасходыДокументыСвернуто
	               |ИЗ
	               |	ДопРасходыДокументы КАК ПоступлениеДопРасходовТовары
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ПоступлениеДопРасходовТовары.Ссылка,
	               |	ПоступлениеДопРасходовТовары.Номенклатура,
	               |	ПоступлениеДопРасходовТовары.СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.ЦФО,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС,
	               |	ПоступлениеДопРасходовТовары.Ссылка.СтатьяДДС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ДопРасходыДокументы.Ссылка
	               |ПОМЕСТИТЬ НеУдалосьСоединитьДопРасходы
	               |ИЗ
	               |	ДопРасходыДокументы КАК ДопРасходыДокументы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Финансовый.ДвиженияССубконто(
	               |				&ДатаНачала,
	               |				&ДатаОкончания,
	               |				Регистратор ССЫЛКА Документ.ПоступлениеДопРасходов
	               |					И СчетДт В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |					И Организация = &Организация
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда),
	               |				,
	               |				) КАК ФинансовыйДвиженияССубконто
	               |		ПО (ФинансовыйДвиженияССубконто.Регистратор = ДопРасходыДокументы.Ссылка)
	               |			И (ФинансовыйДвиженияССубконто.СубконтоДт1 = ДопРасходыДокументы.Номенклатура)
	               |			И (ВЫБОР
	               |				КОГДА ДопРасходыДокументы.ВариантРасчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.БезНДС)
	               |					ТОГДА ДопРасходыДокументы.НомерСтроки + (ДопРасходыДокументы.НомерСтроки - 1) = ФинансовыйДвиженияССубконто.НомерСтроки
	               |				ИНАЧЕ ФинансовыйДвиженияССубконто.НомерСтроки = ДопРасходыДокументы.НомерСтроки
	               |			КОНЕЦ)
	               |ГДЕ
	               |	ФинансовыйДвиженияССубконто.Регистратор ЕСТЬ NULL
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ДопРасходыДокументы.Ссылка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПоступлениеДопРасходовТовары.Ссылка КАК Ссылка,
	               |	ПоступлениеДопРасходовТовары.Номенклатура КАК Номенклатура,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка КАК ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.СчетБУ,
	               |	ПоступлениеДопРасходовТовары.СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.Количество КАК Количество,
	               |	ПоступлениеДопРасходовТовары.ЦФО КАК ЦФО,
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   //|	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС КАК ВариантРасчетаНДС
				   |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС КАК ВариантРасчетаНДС,
	               |	МАКСИМУМ(СоответствияСтатейСчетов.Период) КАК МаксПериод
				   //---АК SUVV
				   |ПОМЕСТИТЬ ДопРасходыДокументыБезСоединенияПоСтроке
	               |ИЗ
	               |	ДопРасходыДокументыСвернуто КАК ПоступлениеДопРасходовТовары
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
	               |		ПО ПоступлениеДопРасходовТовары.Ссылка.Дата >= СоответствияСтатейСчетов.Период
	               |			И ПоступлениеДопРасходовТовары.СтатьяДДС >= СоответствияСтатейСчетов.СтатьяДДС
				   //---АК SUVV
				   |ГДЕ
	               |	ПоступлениеДопРасходовТовары.Ссылка В
	               |			(ВЫБРАТЬ
	               |				НеУдалосьСоединитьДопРасходы.Ссылка
	               |			ИЗ
	               |				НеУдалосьСоединитьДопРасходы)
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |
	               |СГРУППИРОВАТЬ ПО
	               |	ПоступлениеДопРасходовТовары.СчетБУ,
	               |	ПоступлениеДопРасходовТовары.СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.ЦФО,
	               |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.Номенклатура,
	               |	ПоступлениеДопРасходовТовары.Ссылка,
	               |	ПоступлениеДопРасходовТовары.Количество
				   //---АК SUVV
				   |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ПоступлениеДопРасходовТовары.Ссылка КАК Ссылка,
	               |	ПоступлениеДопРасходовТовары.НомерСтроки КАК НомерСтроки,
	               |	ПоступлениеДопРасходовТовары.Номенклатура КАК Номенклатура,
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка КАК ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.СчетБУ,
	               |	ПоступлениеДопРасходовТовары.СтатьяДДС КАК СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.Количество КАК Количество,
	               |	ПоступлениеДопРасходовТовары.ЦФО,
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   //|	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС КАК ВариантРасчетаНДС
				   |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС КАК ВариантРасчетаНДС,
	               |	МАКСИМУМ(СоответствияСтатейСчетов.Период) КАК МаксПериод
				   //---АК SUVV
				   |ПОМЕСТИТЬ ДопРасходыДокументыССоединениемПоСтроке
	               |ИЗ
	               |	ДопРасходыДокументы КАК ПоступлениеДопРасходовТовары
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
	               |		ПО ПоступлениеДопРасходовТовары.Ссылка.Дата >= СоответствияСтатейСчетов.Период
	               |			И ПоступлениеДопРасходовТовары.СтатьяДДС = СоответствияСтатейСчетов.СтатьяДДС
				   //---АК SUVV
				   |ГДЕ
	               |	НЕ ПоступлениеДопРасходовТовары.Ссылка В
	               |				(ВЫБРАТЬ
	               |					НеУдалосьСоединитьДопРасходы.Ссылка
	               |				ИЗ
	               |					НеУдалосьСоединитьДопРасходы)
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |
	               |СГРУППИРОВАТЬ ПО
	               |	ПоступлениеДопРасходовТовары.ТорговаяТочка,
	               |	ПоступлениеДопРасходовТовары.СтатьяДДС,
	               |	ПоступлениеДопРасходовТовары.СчетБУ,
	               |	ПоступлениеДопРасходовТовары.ЦФО,
	               |	ПоступлениеДопРасходовТовары.ВариантРасчетаНДС,
	               |	ПоступлениеДопРасходовТовары.Номенклатура,
	               |	ПоступлениеДопРасходовТовары.Ссылка,
	               |	ПоступлениеДопРасходовТовары.НомерСтроки,
	               |	ПоступлениеДопРасходовТовары.Количество
				   //---АК SUVV
				   |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетЗатрат КАК СчетУчета,
	               |	Таблица.Номенклатура КАК СубконтоУчет1,
	               |	Таблица.Субконто2 КАК СубконтоУчет2,
	               |	Таблица.Субконто3 КАК СубконтоУчет3,
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ3,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения) КАК СчетЗатрат,
	               |	Таблица.ТорговаяТочка КАК Субконто1,
	               |	Таблица.Ссылка.СтатьяЗатрат КАК Субконто2,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.СтруктурнаяЕдиница ЕСТЬ NULL
	               |				ИЛИ Таблица.Ссылка.СтруктурнаяЕдиница = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.СтруктурнаяЕдиница
	               |	КОНЕЦ КАК Субконто3,
	               |	СУММА(Таблица.Количество) КАК Количество,
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ) КАК Сумма,
	               |	Таблица.Ссылка,
	               |	ИСТИНА КАК УчитыватьКоличество
	               |ПОМЕСТИТЬ втРезультат
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Услуги КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО Таблица.ТорговаяТочка = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетЗатрат В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетЗатрат <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоНУ3,
	               |	Таблица.Субконто3,
	               |	Таблица.Субконто2,
	               |	Таблица.СчетЗатрат,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.ТорговаяТочка,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.СтруктурнаяЕдиница ЕСТЬ NULL
	               |				ИЛИ Таблица.Ссылка.СтруктурнаяЕдиница = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.СтруктурнаяЕдиница
	               |	КОНЕЦ,
	               |	Таблица.Ссылка,
	               |	Таблица.Номенклатура
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	НЕОПРЕДЕЛЕНО,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	СУММА(Таблица.Количество),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ),
	               |	Таблица.Ссылка,
	               |	ИСТИНА
	               |ИЗ
	               |	Документ.ПоступлениеТоваровУслуг.Товары КАК Таблица
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
				   //+++АК Susk (Суслин К.В.) 2018.09.10 ИП-00019621
				   |	И НЕ Таблица.Номенклатура.ХозТовар
				   //-
				    
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.СчетУчета,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	Таблица.Ссылка.СтруктурнаяЕдиница,
	               |	Таблица.Ссылка,
	               |	Таблица.Номенклатура
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	Таблица.Субконто2,
	               |	Таблица.Субконто3,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	ВЫБОР
	               |		КОГДА Таблица.ТорговаяТочка ЕСТЬ NULL
	               |				ИЛИ Таблица.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.Пустаяссылка)
	               |			ТОГДА Таблица.Ссылка.ЦФО
	               |		ИНАЧЕ Таблица.ТорговаяТочка
	               |	КОНЕЦ,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.ЦФО ЕСТЬ NULL
	               |				ИЛИ Таблица.Ссылка.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.ЦФО
	               |	КОНЕЦ,
	               |	СУММА(Таблица.Количество),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ),
	               |	Таблица.Ссылка,
	               |	ИСТИНА
	               |ИЗ
	               |	Документ.АвансовыйОтчет.Товары КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО Таблица.ТорговаяТочка = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен = ИСТИНА
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.Субконто3,
	               |	Таблица.Субконто2,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.Ссылка.СтатьяЗатрат,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.СчетУчетаБУ,
	               |	ВЫБОР
	               |		КОГДА Таблица.Ссылка.ЦФО ЕСТЬ NULL
	               |				ИЛИ Таблица.Ссылка.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ Таблица.Ссылка.ЦФО
	               |	КОНЕЦ,
	               |	ВЫБОР
	               |		КОГДА Таблица.ТорговаяТочка ЕСТЬ NULL
	               |				ИЛИ Таблица.ТорговаяТочка = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.Пустаяссылка)
	               |			ТОГДА Таблица.Ссылка.ЦФО
	               |		ИНАЧЕ Таблица.ТорговаяТочка
	               |	КОНЕЦ,
	               |	Таблица.Ссылка,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчетаБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ФинансовыйДвиженияССубконто.СубконтоДт1,
	               |	ФинансовыйДвиженияССубконто.СчетДт,
	               |	ФинансовыйДвиженияССубконто.СубконтоДт1,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ДопРасходыДокументы.СчетБУ,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ДопРасходыДокументы.СчетБУ,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	ДопРасходыДокументы.ТорговаяТочка,
	               |	ЕСТЬNULL(СоответствияСтатейСчетов.СтатьяДР, ДопРасходыДокументы.СтатьяДДС.ОсновнаяСтатьяДоходовРасходов),
	               |	ВЫБОР
	               |		КОГДА ДопРасходыДокументы.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ ДопРасходыДокументы.ЦФО
	               |	КОНЕЦ,
	               |	ДопРасходыДокументы.Количество,
	               |	ФинансовыйДвиженияССубконто.Сумма,
	               |	ФинансовыйДвиженияССубконто.Регистратор,
	               |	ЛОЖЬ
	               |ИЗ
	               |	ДопРасходыДокументыБезСоединенияПоСтроке КАК ДопРасходыДокументы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Финансовый.ДвиженияССубконто(
	               |				&ДатаНачала,
	               |				&ДатаОкончания,
	               |				Регистратор ССЫЛКА Документ.ПоступлениеДопРасходов
	               |					И СчетДт В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |					И Организация = &Организация
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда),
	               |				,
	               |				) КАК ФинансовыйДвиженияССубконто
	               |		ПО (ФинансовыйДвиженияССубконто.Регистратор = ДопРасходыДокументы.Ссылка)
	               |			И (ФинансовыйДвиженияССубконто.СубконтоДт1 = ДопРасходыДокументы.Номенклатура)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО ДопРасходыДокументы.ЦФО = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
	               |		ПО ДопРасходыДокументы.СтатьяДДС = СоответствияСтатейСчетов.СтатьяДДС
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |        И ДопРасходыДокументы.МаксПериод = СоответствияСтатейСчетов.Период
				   //---АК SUVV
				   |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ФинансовыйДвиженияССубконто.СубконтоДт1,
	               |	ФинансовыйДвиженияССубконто.СчетДт,
	               |	ФинансовыйДвиженияССубконто.СубконтоДт1,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ДопРасходыДокументы.СчетБУ,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ДопРасходыДокументы.СчетБУ,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	ДопРасходыДокументы.ТорговаяТочка,
	               |	ЕСТЬNULL(СоответствияСтатейСчетов.СтатьяДР, ДопРасходыДокументы.СтатьяДДС.ОсновнаяСтатьяДоходовРасходов),
	               |	ВЫБОР
	               |		КОГДА ДопРасходыДокументы.ЦФО = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ ДопРасходыДокументы.ЦФО
	               |	КОНЕЦ,
	               |	ДопРасходыДокументы.Количество,
	               |	ФинансовыйДвиженияССубконто.Сумма,
	               |	ФинансовыйДвиженияССубконто.Регистратор,
	               |	ЛОЖЬ
	               |ИЗ
	               |	ДопРасходыДокументыССоединениемПоСтроке КАК ДопРасходыДокументы
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Финансовый.ДвиженияССубконто(
	               |				&ДатаНачала,
	               |				&ДатаОкончания,
	               |				Регистратор ССЫЛКА Документ.ПоступлениеДопРасходов
	               |					И СчетДт В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |					И Организация = &Организация
	               |					И СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда),
	               |				,
	               |				) КАК ФинансовыйДвиженияССубконто
	               |		ПО (ФинансовыйДвиженияССубконто.Регистратор = ДопРасходыДокументы.Ссылка)
	               |			И (ФинансовыйДвиженияССубконто.СубконтоДт1 = ДопРасходыДокументы.Номенклатура)
	               |			И (ВЫБОР
	               |				КОГДА ДопРасходыДокументы.ВариантРасчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.БезНДС)
	               |					ТОГДА ДопРасходыДокументы.НомерСтроки + (ДопРасходыДокументы.НомерСтроки - 1) = ФинансовыйДвиженияССубконто.НомерСтроки
	               |				ИНАЧЕ ФинансовыйДвиженияССубконто.НомерСтроки = ДопРасходыДокументы.НомерСтроки
	               |			КОНЕЦ)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО ДопРасходыДокументы.ЦФО = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
	               |		ПО ДопРасходыДокументы.СтатьяДДС = СоответствияСтатейСчетов.СтатьяДДС
				   //+++АК SUVV 2018.02.28 ИП-00017941
				   |        И ДопРасходыДокументы.МаксПериод = СоответствияСтатейСчетов.Период
				   //---АК SUVV
				   |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	КорректировкаПоступленияУслуги.Номенклатура,
	               |	КорректировкаПоступленияУслуги.СчетЗатрат,
	               |	КорректировкаПоступленияУслуги.Номенклатура,
	               |	КорректировкаПоступленияУслуги.Субконто2,
	               |	КорректировкаПоступленияУслуги.Субконто3,
	               |	КорректировкаПоступленияУслуги.СчетЗатратБУ,
	               |	КорректировкаПоступленияУслуги.СубконтоБУ1,
	               |	КорректировкаПоступленияУслуги.СубконтоБУ2,
	               |	КорректировкаПоступленияУслуги.СубконтоБУ3,
	               |	КорректировкаПоступленияУслуги.СчетЗатратНУ,
	               |	КорректировкаПоступленияУслуги.СубконтоНУ1,
	               |	КорректировкаПоступленияУслуги.СубконтоНУ2,
	               |	КорректировкаПоступленияУслуги.СубконтоНУ3,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	КорректировкаПоступленияУслуги.ТорговаяТочка,
	               |	КорректировкаПоступленияУслуги.Ссылка.ДокументПоступления.СтатьяЗатрат,
	               |	ВЫБОР
	               |		КОГДА КорректировкаПоступленияУслуги.Ссылка.ДокументПоступления.СтруктурнаяЕдиница ЕСТЬ NULL
	               |				ИЛИ КорректировкаПоступленияУслуги.Ссылка.ДокументПоступления.СтруктурнаяЕдиница = ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяССылка)
	               |			ТОГДА ЦФОСтруктурныхЕдиницСрезПоследних.ЦФО
	               |		ИНАЧЕ КорректировкаПоступленияУслуги.Ссылка.ДокументПоступления.СтруктурнаяЕдиница
	               |	КОНЕЦ,
	               |	ВЫБОР
	               |		КОГДА КорректировкаПоступленияУслуги.Количество - КорректировкаПоступленияУслуги.КоличествоДоИзменения = 0
	               |			ТОГДА 1
	               |		ИНАЧЕ КорректировкаПоступленияУслуги.Количество - КорректировкаПоступленияУслуги.КоличествоДоИзменения
	               |	КОНЕЦ,
	               |	ВЫБОР
	               |		КОГДА КорректировкаПоступленияУслуги.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |			ТОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаНДС
	               |		ИНАЧЕ КорректировкаПоступленияУслуги.Сумма
	               |	КОНЕЦ - ВЫБОР
	               |		КОГДА КорректировкаПоступленияУслуги.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |			ТОГДА КорректировкаПоступленияУслуги.СуммаДоИзменения - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения
	               |		ИНАЧЕ КорректировкаПоступленияУслуги.СуммаДоИзменения
	               |	КОНЕЦ,
	               |	КорректировкаПоступленияУслуги.Ссылка,
	               |	ВЫБОР
	               |		КОГДА КорректировкаПоступленияУслуги.Количество - КорректировкаПоступленияУслуги.КоличествоДоИзменения = 0
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ
	               |ИЗ
	               |	Документ.КорректировкаПоступления.Услуги КАК КорректировкаПоступленияУслуги
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&ДатаОкончания, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	               |		ПО КорректировкаПоступленияУслуги.ТорговаяТочка = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	               |ГДЕ
	               |	КорректировкаПоступленияУслуги.Ссылка.Проведен
	               |	И КорректировкаПоступленияУслуги.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	               |	И КорректировкаПоступленияУслуги.СчетЗатрат В ИЕРАРХИИ (ЗНАЧЕНИЕ(плансчетов.финансовый.материалы))
	               |	И КорректировкаПоступленияУслуги.СчетЗатрат <> ЗНАЧЕНИЕ(плансчетов.финансовый.инвентарь)
	               |	И КорректировкаПоступленияУслуги.Ссылка.Организация = &Организация
	               |	И КорректировкаПоступленияУслуги.СчетЗатрат <> ЗНАЧЕНИЕ(плансчетов.финансовый.спецодежда)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	НЕОПРЕДЕЛЕНО,
	               |	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
	               |	НЕОПРЕДЕЛЕНО,
	               |	Таблица.Ссылка.ДокументПоступления.СтатьяЗатрат,
	               |	Таблица.Ссылка.ДокументПоступления.СтруктурнаяЕдиница,
	               |	СУММА(Таблица.Количество - Таблица.КоличествоДоИзменения),
	               |	СУММА(ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.Сумма - Таблица.СуммаНДС
	               |			ИНАЧЕ Таблица.Сумма
	               |		КОНЕЦ - ВЫБОР
	               |			КОГДА Таблица.Ссылка.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДСвТомЧисле)
	               |				ТОГДА Таблица.СуммаДоИзменения - Таблица.СуммаНДСДоИзменения
	               |			ИНАЧЕ Таблица.СуммаДоИзменения
	               |		КОНЕЦ),
	               |	Таблица.Ссылка,
	               |	ВЫБОР
	               |		КОГДА СУММА(Таблица.Количество - Таблица.КоличествоДоИзменения) = 0
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ
	               |ИЗ
	               |	Документ.КорректировкаПоступления.Товары КАК Таблица
	               |ГДЕ
	               |	Таблица.Ссылка.Проведен
	               |	И Таблица.Ссылка.Дата >= &ДатаНачала
	               |	И Таблица.Ссылка.Дата <= &ДатаОкончания
	               |	И Таблица.СчетУчета В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
	               |	И Таблица.Ссылка.Организация = &Организация
	               |	И Таблица.СчетУчета <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Таблица.СчетУчета,
	               |	Таблица.Номенклатура,
	               |	Таблица.Ссылка.ДокументПоступления,
	               |	Таблица.Ссылка,
	               |	Таблица.Ссылка.ДокументПоступления.СтатьяЗатрат,
				   |	Таблица.Ссылка.ДокументПоступления.СтруктурнаяЕдиница,
				   |	Таблица.Номенклатура
				   
				   //+++АК Susk (Суслин К.В.) 2018.09.10 ИП-00019621				    
				   //|ОБЪЕДИНИТЬ ВСЕ
				   //
				   //|ВЫБРАТЬ
				   //|	ОперацияПроводки.СубконтоДт1,
				   //|	ОперацияПроводки.СчетДт,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения),
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	НЕОПРЕДЕЛЕНО,
				   //|	ОперацияПроводки.КоличествоДт,
				   //|	ОперацияПроводки.Сумма,
				   //|	ОперацияПроводки.Ссылка,
				   //|	ИСТИНА
				   //|ИЗ
				   //|	Документ.Операция.Проводки КАК ОперацияПроводки
				   //|ГДЕ
				   //|	НЕ ОперацияПроводки.Ссылка.ПометкаУдаления
				   //|	И ОперацияПроводки.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
				   //|	И ОперацияПроводки.СчетДт В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Материалы))
				   //|	И ОперацияПроводки.СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Инвентарь)
				   //|	И ОперацияПроводки.СчетДт <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.Спецодежда)
				   //|	И ОперацияПроводки.Ссылка.Организация = &Организация
				   //---АК Susk (Суслин К.В.) 
				   |;
				   |
				   |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ДопРасходыДокументы
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ДопРасходыДокументыСвернуто
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ НеУдалосьСоединитьДопРасходы
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ДопРасходыДокументыБезСоединенияПоСтроке
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ДопРасходыДокументыССоединениемПоСтроке
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СтатьиДоходовРасходовСписокСчетовУчета.Ссылка
	               |ПОМЕСТИТЬ втСтатьи442
	               |ИЗ
	               |	Справочник.СтатьиДоходовРасходов.СписокСчетовУчета КАК СтатьиДоходовРасходовСписокСчетовУчета
	               |ГДЕ
	               |	СтатьиДоходовРасходовСписокСчетовУчета.СчетУчета = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыОбщиеДляРаспределения)
	               |	И СтатьиДоходовРасходовСписокСчетовУчета.ОсновнойСчет
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	втРезультат.Номенклатура,
	               |	втРезультат.СчетУчета,
	               |	втРезультат.СубконтоУчет1,
	               |	втРезультат.СубконтоУчет2,
	               |	втРезультат.СубконтоУчет3,
	               |	втРезультат.СчетЗатратБУ,
	               |	втРезультат.СубконтоБУ1,
	               |	втРезультат.СубконтоБУ2,
	               |	втРезультат.СубконтоБУ3,
	               |	втРезультат.СчетЗатратНУ,
	               |	втРезультат.СубконтоНУ1,
	               |	втРезультат.СубконтоНУ2,
	               |	втРезультат.СубконтоНУ3,
	               |	втРезультат.СчетЗатрат,
	               |	втРезультат.Субконто1,
	               |	втРезультат.Субконто2,
	               |	втРезультат.Субконто3,
	               |	СУММА(втРезультат.Количество) КАК Количество,
	               |	СУММА(втРезультат.Сумма) КАК Сумма,
	               |	втРезультат.Ссылка,
	               |	втРезультат.УчитыватьКоличество
	               |ПОМЕСТИТЬ втРезультатСвернуто
	               |ИЗ
	               |	втРезультат КАК втРезультат
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	втРезультат.Номенклатура,
	               |	втРезультат.СчетУчета,
	               |	втРезультат.СубконтоУчет1,
	               |	втРезультат.СубконтоУчет2,
	               |	втРезультат.СубконтоУчет3,
	               |	втРезультат.СчетЗатратБУ,
	               |	втРезультат.СубконтоБУ1,
	               |	втРезультат.СубконтоБУ2,
	               |	втРезультат.СубконтоБУ3,
	               |	втРезультат.СчетЗатратНУ,
	               |	втРезультат.СубконтоНУ1,
	               |	втРезультат.СубконтоНУ2,
	               |	втРезультат.СубконтоНУ3,
	               |	втРезультат.СчетЗатрат,
	               |	втРезультат.Субконто1,
	               |	втРезультат.Субконто2,
	               |	втРезультат.Субконто3,
	               |	втРезультат.Ссылка,
	               |	втРезультат.УчитыватьКоличество
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Таблица.Ссылка КАК Документ,
	               |	Таблица.Номенклатура,
	               |	Таблица.СчетУчета,
	               |	Таблица.СубконтоУчет1,
	               |	Таблица.СубконтоУчет2,
	               |	Таблица.СубконтоУчет3,
	               |	Таблица.СчетЗатратБУ,
	               |	Таблица.СубконтоБУ1,
	               |	Таблица.СубконтоБУ2,
	               |	Таблица.СубконтоБУ3,
	               |	Таблица.СчетЗатратНУ,
	               |	Таблица.СубконтоНУ1,
	               |	Таблица.СубконтоНУ2,
	               |	Таблица.СубконтоНУ3,
	               |	Таблица.Субконто1,
	               |	Таблица.Субконто2,
	               |	Таблица.Субконто3,
	               |	ВЫБОР
	               |		КОГДА Таблица.Количество - ЕСТЬNULL(ТребованиеНакладнаяТовары.Количество, 0) <> 0
	               |			ТОГДА (Таблица.Сумма - ЕСТЬNULL(ТребованиеНакладнаяТовары.Сумма, 0)) / (Таблица.Количество - ЕСТЬNULL(ТребованиеНакладнаяТовары.Количество, 0))
	               |		ИНАЧЕ 0
	               |	КОНЕЦ КАК Цена,
	               |	Таблица.Количество КАК Количество,
	               |	ЕСТЬNULL(ТребованиеНакладнаяТовары.Количество, 0) КАК КоличествоТН,
	               |	Таблица.Сумма - ЕСТЬNULL(ТребованиеНакладнаяТовары.Сумма, 0) КАК Сумма,
	               |	ВЫБОР
	               |		КОГДА Статьи442.Ссылка ЕСТЬ NULL
	               |			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыТочекДляРаспределения)
	               |		ИНАЧЕ ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ЗатратыОбщиеДляРаспределения)
	               |	КОНЕЦ КАК СчетЗатрат,
	               |	Таблица.УчитыватьКоличество
	               |ПОМЕСТИТЬ Сводная
	               |ИЗ
	               |	втРезультатСвернуто КАК Таблица
	               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			втСтатьи442.Ссылка КАК Ссылка
	               |		ИЗ
	               |			втСтатьи442 КАК втСтатьи442) КАК Статьи442
	               |		ПО Таблица.Субконто2 = Статьи442.Ссылка
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ТребованиеНакладная.Товары КАК ТребованиеНакладнаяТовары
	               |		ПО Таблица.Номенклатура = ТребованиеНакладнаяТовары.Номенклатура
	               |			И (ЛОЖЬ)
	               |			И Таблица.Ссылка = ТребованиеНакладнаяТовары.Документ
	               |			И Таблица.СубконтоУчет2 = ТребованиеНакладнаяТовары.СубконтоУчет2
	               |			И Таблица.Субконто1 = ТребованиеНакладнаяТовары.Субконто1
	               |			И (ТребованиеНакладнаяТовары.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания)
	               |			И (ТребованиеНакладнаяТовары.Ссылка.Проведен)
	               |			И (ТребованиеНакладнаяТовары.Ссылка <> &Ссылка)
	               |ГДЕ
	               |	(Таблица.СчетУчета = &СчетУчета
	               |			ИЛИ &СчетУчетаНеЗаполнен)
	               |	И (Таблица.Количество - ЕСТЬNULL(ТребованиеНакладнаяТовары.Количество, 0) <> 0
	               |			ИЛИ Таблица.Сумма - ЕСТЬNULL(ТребованиеНакладнаяТовары.Сумма, 0) <> 0)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ втРезультат
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ втСтатьи442
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ втРезультатСвернуто
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СоответствиеСтатейДРСтатьямБУ.Статья,
	               |	МАКСИМУМ(СоответствиеСтатейДРСтатьямБУ.СтатьяБУ) КАК СтатьяБУ,
	               |	СоответствиеСтатейДРСтатьямБУ.Счет,
	               |	СоответствиеСтатейДРСтатьямБУ.КорСчет
	               |ПОМЕСТИТЬ СтатьиЗатратБУ
	               |ИЗ
	               |	РегистрСведений.СоответствиеСтатейДРСтатьямБУ КАК СоответствиеСтатейДРСтатьямБУ
	               |ГДЕ
	               |	СоответствиеСтатейДРСтатьямБУ.Счет В
	               |			(ВЫБРАТЬ
	               |				ТЗ.СчетЗатрат
	               |			ИЗ
	               |				Сводная КАК ТЗ)
	               |	И СоответствиеСтатейДРСтатьямБУ.Статья В
	               |			(ВЫБРАТЬ
	               |				ТЗ.Субконто2
	               |			ИЗ
	               |				Сводная КАК ТЗ)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СоответствиеСтатейДРСтатьямБУ.Статья,
	               |	СоответствиеСтатейДРСтатьямБУ.Счет,
	               |	СоответствиеСтатейДРСтатьямБУ.КорСчет
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СтатьиЗатратБУ.Статья,
	               |	МАКСИМУМ(СтатьиЗатратБУ.СтатьяБУ) КАК СтатьяБУ,
	               |	СтатьиЗатратБУ.Счет,
	               |	СтатьиЗатратБУ.КорСчет
	               |ПОМЕСТИТЬ СтатьиЗатратБУПустойКорСчет
	               |ИЗ
	               |	СтатьиЗатратБУ КАК СтатьиЗатратБУ
	               |ГДЕ
	               |	СтатьиЗатратБУ.КорСчет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ПустаяСсылка)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СтатьиЗатратБУ.Статья,
	               |	СтатьиЗатратБУ.Счет,
	               |	СтатьиЗатратБУ.КорСчет
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СтатьиЗатратБУ.Статья,
	               |	МАКСИМУМ(СтатьиЗатратБУ.СтатьяБУ) КАК СтатьяБУ,
	               |	СтатьиЗатратБУ.Счет,
	               |	СтатьиЗатратБУ.КорСчет
	               |ПОМЕСТИТЬ СтатьиЗатратБУЗаполненКорСчет
	               |ИЗ
	               |	СтатьиЗатратБУ КАК СтатьиЗатратБУ
	               |ГДЕ
	               |	СтатьиЗатратБУ.КорСчет <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ПустаяСсылка)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СтатьиЗатратБУ.Статья,
	               |	СтатьиЗатратБУ.Счет,
	               |	СтатьиЗатратБУ.КорСчет
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ СтатьиЗатратБУ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Сводная.Документ,
	               |	Сводная.Номенклатура,
	               |	Сводная.СчетУчета,
	               |	Сводная.СубконтоУчет1,
	               |	Сводная.СубконтоУчет2,
	               |	Сводная.СубконтоУчет3,
	               |	Сводная.СчетЗатратБУ,
	               |	Сводная.СубконтоБУ1,
	               |	Сводная.СубконтоБУ2,
	               |	Сводная.СубконтоБУ3,
	               |	Сводная.СчетЗатратНУ,
	               |	Сводная.СубконтоНУ1,
	               |	Сводная.СубконтоНУ2,
	               |	Сводная.СубконтоНУ3,
	               |	Сводная.Субконто1,
	               |	Сводная.Субконто2,
	               |	Сводная.Субконто3,
	               |	Сводная.Цена,
	               |	Сводная.Количество,
	               |	Сводная.КоличествоТН,
	               |	Сводная.Сумма,
	               |	Сводная.СчетЗатрат,
	               |	&СчетЗатратБУ КАК СчетБУ,
	               |	ЕСТЬNULL(СтатьиЗатратБУЗаполненКорСчет.СтатьяБУ, СтатьиЗатратБУПустойКорСчет.СтатьяБУ) КАК СтатьяЗатрат,
	               |	Сводная.УчитыватьКоличество
	               |ИЗ
	               |	Сводная КАК Сводная
	               |		ЛЕВОЕ СОЕДИНЕНИЕ СтатьиЗатратБУПустойКорСчет КАК СтатьиЗатратБУПустойКорСчет
	               |		ПО Сводная.СчетЗатрат = СтатьиЗатратБУПустойКорСчет.Счет
	               |			И Сводная.Субконто2 = СтатьиЗатратБУПустойКорСчет.Статья
	               |		ЛЕВОЕ СОЕДИНЕНИЕ СтатьиЗатратБУЗаполненКорСчет КАК СтатьиЗатратБУЗаполненКорСчет
	               |		ПО Сводная.СчетЗатрат = СтатьиЗатратБУЗаполненКорСчет.Счет
	               |			И Сводная.Субконто2 = СтатьиЗатратБУЗаполненКорСчет.Статья
	               |			И Сводная.СчетУчета = СтатьиЗатратБУЗаполненКорСчет.КорСчет";
				   
	Если Не ЗначениеЗаполнено(СчетУчета) Тогда
		Запрос.УстановитьПараметр("СчетУчетаНеЗаполнен", Истина);	
		Запрос.УстановитьПараметр("СчетУчета", ПланыСчетов.Финансовый.ПустаяСсылка());
	Иначе 
		Запрос.УстановитьПараметр("СчетУчетаНеЗаполнен", Ложь);	
		Запрос.УстановитьПараметр("СчетУчета", СчетУчета);
	КонецЕсли;	
	
	Запрос.УстановитьПараметр("Статьи442", АК_ОсновныеСредства.МассивСтатейДРДляОтнесенияНаРасходыОфис());
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("ДатаНачала", Объект.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));
   	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	
	Запрос.УстановитьПараметр("НачалоПериодаДок", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("КонецПериодаДок", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	
	//+++АК Susk (Суслин К.В.) 2018.02.14 ИП-00017786  
	Запрос.УстановитьПараметр("СчетЗатратБУ", ПланыСчетов.Хозрасчетный.ИздержкиОбращения); //44.01
	//---АК Susk (Суслин К.В.) 	 

	Результат = Запрос.Выполнить().Выгрузить();
	
	Объект.Товары.Загрузить(Результат);	
	
	Объект.НовоеПроведение = Истина;
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаКлиенте
Процедура ВыгрузитьВБП(Команда)
	
	Если Параметры.Ключ.Пустая() Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Сначала нужно записать документ");
		Возврат;
	КонецЕсли;	
	
	Если ЭтаФорма.Модифицированность Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Документ был изменен. Сначала нужно записать документ");
		Возврат;
	КонецЕсли;
	
	Если Объект.Дата < Дата(2017, 1, 1) Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Дата документа меньше 1 января 2017 года. Выгружен не будет!");
		Возврат;
	КонецЕсли;
	
	Если Объект.ВидСписания <> ПредопределенноеЗначение("Перечисление.ВидыСписанияТребованиеНакладная.СписаниеМатериалов") Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Вид списания не равен Списанию материалов. Документ выгружен не будет!");
		Возврат;
	КонецЕсли;
	
	ВыгрузитьВБПСервер();
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.01.17 б/н старые задачи 
&НаСервере
Процедура ВыгрузитьВБПСервер()
	
	ОбменСБП2_0.ВыгрузитьДокументВБП("ТребованиеНакладная", "ТребованиеНакладная", Объект.Ссылка); 
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.02.15 ИП-00017786 
&НаКлиенте
Процедура ИзменитьВыделенныеСтроки(Команда)
	
	ВыбраннаяСтрока = Элементы.Товары.ТекущиеДанные;
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПараметрыОткрытия = Новый Структура;
	ПараметрыОткрытия.Вставить("СчетЗатрат", ВыбраннаяСтрока.СчетЗатрат); 
	
	Результат = ОткрытьФормуМодально("Документ.ТребованиеНакладная.Форма.ФормаЗаполненияТЧ",ПараметрыОткрытия);	
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого Стр Из Элементы.Товары.ВыделенныеСтроки Цикл
		Для Сч = 1 По 3 Цикл
			Если ЗначениеЗаполнено(Результат["Субконто" + Сч]) Тогда
				СтрокаТовары = Объект.Товары.НайтиПоИдентификатору(Стр);
				СтрокаТовары["Субконто" + Сч] = Результат["Субконто" + Сч];
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
КонецПроцедуры

//+++АК Susk (Суслин К.В.) 2018.08.14 ИП-00019522
&НаСервере
Процедура РаспределитьТоварыПоНормам(РезультатЗаполнения)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
				   |	РезультатЗаполнения.НомерСтроки,
				   |	РезультатЗаполнения.Номенклатура,
	               |	РезультатЗаполнения.Количество,
				   |	РезультатЗаполнения.Цена,
	               |	РезультатЗаполнения.Сумма,
	               |	РезультатЗаполнения.СчетЗатрат,
	               |	РезультатЗаполнения.Субконто1,
	               |	РезультатЗаполнения.Субконто2,
	               |	РезультатЗаполнения.Субконто3,
	               |	РезультатЗаполнения.СчетУчета,
	               |	РезультатЗаполнения.СчетБУ,
	               |	РезультатЗаполнения.СтатьяЗатрат,
	               |	РезультатЗаполнения.СчетЗатратБУ,
	               |	РезультатЗаполнения.СубконтоБУ1,
	               |	РезультатЗаполнения.СубконтоБУ2,
	               |	РезультатЗаполнения.СубконтоБУ3,
	               |	РезультатЗаполнения.СчетЗатратНУ,
	               |	РезультатЗаполнения.СубконтоНУ1,
	               |	РезультатЗаполнения.СубконтоНУ2,
	               |	РезультатЗаполнения.СубконтоНУ3
	               |ПОМЕСТИТЬ ТЗ_Временная
	               |ИЗ
	               |	&РезультатЗаполнения КАК РезультатЗаполнения
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
				   |	ТЗ_Временная.НомерСтроки,
				   |	ТЗ_Временная.Номенклатура КАК Номенклатура,
	               |	ТЗ_Временная.Количество КАК Количество,
				   |	ТЗ_Временная.Цена КАК Цена,
	               |	ТЗ_Временная.Сумма КАК Сумма,
	               |	ТЗ_Временная.СчетЗатрат,
	               |	ТЗ_Временная.Субконто1,
	               |	ТЗ_Временная.Субконто2,
	               |	ТЗ_Временная.Субконто3,
	               |	ТЗ_Временная.СчетУчета,
	               |	ТЗ_Временная.СчетБУ,
	               |	ТЗ_Временная.СтатьяЗатрат,
	               |	ТЗ_Временная.СчетЗатратБУ,
	               |	ТЗ_Временная.СубконтоБУ1,
	               |	ТЗ_Временная.СубконтоБУ2,
	               |	ТЗ_Временная.СубконтоБУ3,
	               |	ТЗ_Временная.СчетЗатратНУ,
	               |	ТЗ_Временная.СубконтоНУ1,
	               |	ТЗ_Временная.СубконтоНУ2,
	               |	ТЗ_Временная.СубконтоНУ3,
	               |	ЕСТЬNULL(НормативыРасходныхМатериаловНаНовыеТТСрезПоследних.Количество, 0) КАК КоличествоИзРегистра,
				   |	ЕСТЬNULL(НормативыРасходныхМатериаловНаНовыеТТСрезПоследних.СтатьяДР, 0) КАК СтатьяДР
	               |ИЗ
	               |	ТЗ_Временная КАК ТЗ_Временная
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НормативыРасходныхМатериаловНаНовыеТТ.СрезПоследних(&Период, ) КАК НормативыРасходныхМатериаловНаНовыеТТСрезПоследних
	               |		ПО ТЗ_Временная.Номенклатура = НормативыРасходныхМатериаловНаНовыеТТСрезПоследних.Номенклатура
	               |ГДЕ
	               |	ТЗ_Временная.Субконто1 В(&ТочкиДляРаспределенияЗатрат)
	               |ИТОГИ
	               |	СРЕДНЕЕ(КоличествоИзРегистра)
	               |ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЛистУчета.ТорговаяТочка,
	               |	МИНИМУМ(ЛистУчета.Дата) КАК Дата
	               |ПОМЕСТИТЬ МинимальныеДатыОткрытияТочек
	               |ИЗ
	               |	Документ.ЛистУчета КАК ЛистУчета
	               |ГДЕ
	               |	ЛистУчета.Проведен
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ЛистУчета.ТорговаяТочка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	МинимальныеДатыОткрытияТочек.ТорговаяТочка,
	               |	МинимальныеДатыОткрытияТочек.Дата КАК Дата
	               |ИЗ
	               |	МинимальныеДатыОткрытияТочек КАК МинимальныеДатыОткрытияТочек
	               |ГДЕ
	               |	МинимальныеДатыОткрытияТочек.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Дата
	               |АВТОУПОРЯДОЧИВАНИЕ";
	
	Запрос.УстановитьПараметр("РезультатЗаполнения", РезультатЗаполнения);
	Запрос.УстановитьПараметр("Период", КонецДня(Объект.Дата));
	Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("КонецПериода", КонецДня(Объект.Дата));
	Запрос.УстановитьПараметр("ТочкиДляРаспределенияЗатрат", Объект.ТочкиДляРаспределенияЗатратНаНовыеТТ.Выгрузить(,"СтруктурнаяЕдиница").ВыгрузитьКолонку("СтруктурнаяЕдиница")); 
	
	МассивСтрДляУд = Новый Массив;
	
	Результат = Запрос.ВыполнитьПакет();
	
	Выборка = Результат[1].Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	НовыеТочки = Результат[3].Выбрать();
	ТзДополнить = РезультатЗаполнения.Скопировать();
	ТзДополнить.Очистить();
	ТзДополнить.Колонки.Добавить("НомерСтрокиИсходной", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));	
	
	СоответствиеОстатковНоменклатуры = Новый Соответствие;
	
	Пока НовыеТочки.Следующий() Цикл
		
		//Для Каждой точки распределяю всю номенклатуру по нормам.
		Пока Выборка.Следующий() Цикл
			
			НормаРаспределения = Выборка.КоличествоИзРегистра;
			
			Если НормаРаспределения = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ВыборкаНом = Выборка.Выбрать();
			
			Пока ВыборкаНом.Следующий() Цикл
				
				Если НормаРаспределения = 0 Тогда
					Прервать;
				КонецЕсли;
				
				КоличествоДляРаспределения = СоответствиеОстатковНоменклатуры.Получить(ВыборкаНом.НомерСтроки);
				
				Если КоличествоДляРаспределения = Неопределено Тогда
					КоличествоДляРаспределения = ВыборкаНом.Количество;
				КонецЕсли;	
				
				Если КоличествоДляРаспределения = 0 Тогда
					Продолжить;
				КонецЕсли;
				
				НовСтр = ТзДополнить.Добавить();
				ЗаполнитьЗначенияСвойств(НовСтр, ВыборкаНом);
				НовСтр.НомерСтрокиИсходной = ВыборкаНом.НомерСтроки;
				НовСтр.Количество = Мин(КоличествоДляРаспределения, НормаРаспределения);
				НовСтр.Сумма = НовСтр.Количество * НовСтр.Цена;
				НовСтр.Субконто1 = НовыеТочки.ТорговаяТочка;
				НовСтр.Субконто2 = ВыборкаНом.СтатьяДР;
				КоличествоДляРаспределения = КоличествоДляРаспределения - НовСтр.Количество;
				НормаРаспределения = НормаРаспределения - НовСтр.Количество;
				СоответствиеОстатковНоменклатуры.Вставить(ВыборкаНом.НомерСтроки, КоличествоДляРаспределения);
				
			КонецЦикла;			
			
		КонецЦикла;
		
		Выборка.Сбросить();
			
	КонецЦикла;	
	
	МассивСтрДляУд = Новый Массив;
	
	ПолученноеРаспределение = ТзДополнить.Скопировать(, "Номенклатура, НомерСтрокиИсходной, Количество, Цена, Сумма");
	ПолученноеРаспределение.Свернуть("Номенклатура,НомерСтрокиИсходной, Цена", "Количество, Сумма");	
		
	Для Каждого ЭлСоответствия Из СоответствиеОстатковНоменклатуры Цикл
		СтрРЗ = РезультатЗаполнения[ЭлСоответствия.Ключ - 1];
		СтрРз.Количество = ЭлСоответствия.Значение;
			
		СуммаБыла = СтрРз.Сумма;			
		СтрРз.Сумма = СтрРз.Количество * СтрРз.Цена;
			
		НайдСтр = ПолученноеРаспределение.Найти(СтрРз.НомерСтроки, "НомерСтрокиИсходной");
		НайдСтрДляДополнения = ТзДополнить.Найти(СтрРз.НомерСтроки, "НомерСтрокиИсходной");
		
		Если Не НайдСтр = Неопределено Тогда
			ПогрешностьОкругления = СуммаБыла - (СтрРз.Сумма + НайдСтр.Сумма);
			НайдСтрДляДополнения.Сумма = НайдСтрДляДополнения.Сумма + ПогрешностьОкругления;
		КонецЕсли;
		
		Если ЭлСоответствия.Значение = 0 Тогда
			МассивСтрДляУд.Добавить(РезультатЗаполнения[ЭлСоответствия.Ключ-1]);
		КонецЕсли;
		
	КонецЦИкла;
	
	Для Каждого Стр Из МассивСтрДляУд Цикл
		РезультатЗаполнения.Удалить(Стр);
	КонецЦикла;
	
	Для Каждого Стр Из ТзДополнить Цикл		
		ЗаполнитьЗначенияСвойств(РезультатЗаполнения.Добавить(), Стр);
	КонецЦикла;		
	
КонецПроцедуры

&НаСервере
Процедура РаспределитьПоНормам()
	
	РезультатЗаполнения = Объект.Товары.Выгрузить();
	РаспределитьТоварыПоНормам(РезультатЗаполнения);	
	Объект.Товары.Загрузить(РезультатЗаполнения);		
	
КонецПроцедуры
