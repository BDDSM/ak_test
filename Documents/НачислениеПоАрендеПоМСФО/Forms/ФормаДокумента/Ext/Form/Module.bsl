
&НаКлиенте
Процедура ЗаполнитьВсе(Команда)
	Если Объект.Проведен Тогда
		Сообщить("Нельзя заполнить проведенный документ. Отмените проведение документа!");
		Возврат;
	КонецЕсли;
	ЗаполнитьИзмененияНачисленийСервер();
	ЗаполнитьНачислениеАмортизацииСервер();
	ЗаполнитьЗакрытыеТорговыеТочкиИДоговораНаСервере();
	ЗаполнитьОбеспечительныеВзносыНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьИзмененияНачислений(Команда)
	Если Объект.Проведен Тогда
		Сообщить("Нельзя заполнить проведенный документ. Отмените проведение документа!");
		Возврат;
	КонецЕсли;
	ЗаполнитьИзмененияНачисленийСервер();
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьНачислениеАмортизации(Команда)
	Если Объект.Проведен Тогда
		Сообщить("Нельзя заполнить проведенный документ. Отмените проведение документа!");
		Возврат;
	КонецЕсли;
	ЗаполнитьНачислениеАмортизацииСервер();
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьЗакрытыеТорговыеТочкиИДоговора(Команда)
	Если Объект.Проведен Тогда
		Сообщить("Нельзя заполнить проведенный документ. Отмените проведение документа!");
		Возврат;
	КонецЕсли;
	ЗаполнитьЗакрытыеТорговыеТочкиИДоговораНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьИзмененияНачисленийСервер() Экспорт
	Если не ЗначениеЗаполнено(Объект.Организация) Тогда
		Возврат;
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	Запрос.УстановитьПараметр("Дата1", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Дата2", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("АрендаТорговыхТочек", Справочники.Номенклатура.НайтиПоКоду("000000288"));
	Запрос.УстановитьПараметр("Дата3", ?(НачалоМесяца(Объект.Дата) = '20180101', '20180101000001', НачалоМесяца(Объект.Дата)));
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	СУММА(ВложенныйЗапрос.НоваяСтавка) КАК НоваяСтавка,
	               |	НАЧАЛОПЕРИОДА(ВложенныйЗапрос.ДатаНачала, МЕСЯЦ) КАК ДатаНачала
	               |ПОМЕСТИТЬ ВсеНовыеДанные
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент КАК Контрагент,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница КАК ТорговаяТочка,
	               |		СУММА(ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ) КАК НоваяСтавка,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата КАК ДатаНачала
	               |	ИЗ
	               |		Документ.ЗаключениеДоговораАренды.ПостояннаяЧастьАренднойПлаты КАК ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Услуга = &АрендаТорговыхТочек
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		СУММА(ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата
	               |	ИЗ
	               |		Документ.ЗаключениеДоговораАренды.ПеременнаяЧастьАренднойПлаты КАК ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000001""
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		СУММА(ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата
	               |	ИЗ
	               |		Документ.ДополнительноеСоглашение.ПостояннаяЧастьАренднойПлаты КАК ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Услуга = &АрендаТорговыхТочек
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ЗаключениеДоговораАренды.ПустаяСсылка)
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДокументОснование.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		СУММА(ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата
	               |	ИЗ
	               |		Документ.ДополнительноеСоглашение.ПеременнаяЧастьАренднойПлаты КАК ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000001""
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ЗаключениеДоговораАренды.ПустаяСсылка)
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДокументОснование.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница) КАК ВложенныйЗапрос
	               |ГДЕ
	               |	ВложенныйЗапрос.НоваяСтавка <> 0
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	НАЧАЛОПЕРИОДА(ВложенныйЗапрос.ДатаНачала, МЕСЯЦ)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ИнформацияПоДоговоруАрендыОстатки.Контрагент,
	               |	ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка,
	               |	ИнформацияПоДоговоруАрендыОстатки.ДДПОстаток
	               |ПОМЕСТИТЬ ОстатокДДП
	               |ИЗ
	               |	РегистрНакопления.ИнформацияПоДоговоруАренды.Остатки(&Дата1, Организация = &Организация) КАК ИнформацияПоДоговоруАрендыОстатки
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ИнформацияПоДоговоруАренды.Контрагент,
	               |	ИнформацияПоДоговоруАренды.ТорговаяТочка,
	               |	ИнформацияПоДоговоруАренды.Ставка,
	               |	ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений
	               |ПОМЕСТИТЬ ДопДанные
	               |ИЗ
	               |	РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			ИнформацияПоДоговоруАренды.Контрагент КАК Контрагент,
	               |			ИнформацияПоДоговоруАренды.ТорговаяТочка КАК ТорговаяТочка,
	               |			МАКСИМУМ(ИнформацияПоДоговоруАренды.Период) КАК Период
	               |		ИЗ
	               |			РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |		ГДЕ
	               |			ИнформацияПоДоговоруАренды.Организация = &Организация
	               |			И ИнформацияПоДоговоруАренды.Период <= &Дата1
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			ИнформацияПоДоговоруАренды.Контрагент,
	               |			ИнформацияПоДоговоруАренды.ТорговаяТочка) КАК ВложенныйЗапрос
	               |		ПО ИнформацияПоДоговоруАренды.Контрагент = ВложенныйЗапрос.Контрагент
	               |			И ИнформацияПоДоговоруАренды.ТорговаяТочка = ВложенныйЗапрос.ТорговаяТочка
	               |			И ИнформацияПоДоговоруАренды.Период = ВложенныйЗапрос.Период
	               |ГДЕ
	               |	ИнформацияПоДоговоруАренды.Организация = &Организация
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ИнформацияПоДоговоруАренды.Контрагент,
	               |	ИнформацияПоДоговоруАренды.ТорговаяТочка,
	               |	ИнформацияПоДоговоруАренды.Ставка,
	               |	ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗРЕШЕННЫЕ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ОбъектАренды,
	               |	МАКСИМУМ(НАЧАЛОПЕРИОДА(ВложенныйЗапрос.ДатаНачалаАренды, МЕСЯЦ)) КАК ДатаНачалаАренды
	               |ПОМЕСТИТЬ ДатаНачВзаим
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		УслугиПоДоговорамАренды.Договор.Владелец КАК Контрагент,
	               |		УслугиПоДоговорамАренды.Договор.ОбъектАренды КАК ОбъектАренды,
	               |		МИНИМУМ(УслугиПоДоговорамАренды.Период) КАК ДатаНачалаАренды
	               |	ИЗ
	               |		РегистрСведений.УслугиПоДоговорамАренды КАК УслугиПоДоговорамАренды
	               |	ГДЕ
	               |		УслугиПоДоговорамАренды.Услуга = &АрендаТорговыхТочек
	               |		И УслугиПоДоговорамАренды.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоровСПоставщиком.Аренда)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		УслугиПоДоговорамАренды.Договор.Владелец,
	               |		УслугиПоДоговорамАренды.Договор.ОбъектАренды) КАК ВложенныйЗапрос
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ОбъектАренды
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВсеНовыеДанные.Контрагент,
	               |	ВсеНовыеДанные.ТорговаяТочка,
	               |	ЕСТЬNULL(ДопДанные.Ставка, 0) КАК СтараяСтавка,
	               |	ЕСТЬNULL(ОстатокДДП.ДДПОстаток, 0) КАК ОстатокДДП,
	               |	ВсеНовыеДанные.НоваяСтавка,
	               |	ЕСТЬNULL(ДопДанные.ДатаНачалаВзаимоотношений, ЕСТЬNULL(ДатаНачВзаим.ДатаНачалаАренды, НАЧАЛОПЕРИОДА(ВсеНовыеДанные.ДатаНачала, МЕСЯЦ))) КАК ДатаНачалаВзаимоотношений,
	               |	ВсеНовыеДанные.ДатаНачала
	               |ПОМЕСТИТЬ ДанныеБезСтавкиДисконта
	               |ИЗ
	               |	ВсеНовыеДанные КАК ВсеНовыеДанные
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ОстатокДДП КАК ОстатокДДП
	               |		ПО ВсеНовыеДанные.Контрагент = ОстатокДДП.Контрагент
	               |			И ВсеНовыеДанные.ТорговаяТочка = ОстатокДДП.ТорговаяТочка
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ДопДанные КАК ДопДанные
	               |		ПО ВсеНовыеДанные.Контрагент = ДопДанные.Контрагент
	               |			И ВсеНовыеДанные.ТорговаяТочка = ДопДанные.ТорговаяТочка
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ДатаНачВзаим КАК ДатаНачВзаим
	               |		ПО ВсеНовыеДанные.Контрагент = ДатаНачВзаим.Контрагент
	               |			И ВсеНовыеДанные.ТорговаяТочка = ДатаНачВзаим.ОбъектАренды
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент,
	               |	СУММА(ВложенныйЗапрос.СуммаМСФООстаток) КАК СуммаМСФООстаток,
	               |	СУММА(ВложенныйЗапрос.СуммаАмортизации) КАК СуммаАмортизации
	               |ПОМЕСТИТЬ Остатки03
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ФинансовыйОстатки.Субконто1 КАК ТорговаяТочка,
	               |		ФинансовыйОстатки.Субконто2 КАК Контрагент,
	               |		ФинансовыйОстатки.СуммаМСФООстаток КАК СуммаМСФООстаток,
	               |		0 КАК СуммаАмортизации
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата3, Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда), , Организация = &Организация) КАК ФинансовыйОстатки
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ФинансовыйОстатки.Субконто1,
	               |		ФинансовыйОстатки.Субконто2,
	               |		0,
	               |		-ФинансовыйОстатки.СуммаМСФООстаток
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата3, Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АмортизацияРасходыПоАренде), , Организация = &Организация) КАК ФинансовыйОстатки) КАК ВложенныйЗапрос
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.СтараяСтавка,
	               |	ВложенныйЗапрос.ОстатокДДП,
	               |	ВложенныйЗапрос.НоваяСтавка,
	               |	ВложенныйЗапрос.ДатаНачалаВзаимоотношений,
	               |	ВложенныйЗапрос.ДатаНачала,
	               |	СтавкиДисконтированияПоДоговорам.Ставка КАК ПроцентДисконта,
	               |	ЕСТЬNULL(Остатки03.СуммаМСФООстаток, 0) КАК АктивПоАренде,
	               |	ЕСТЬNULL(Остатки03.СуммаАмортизации, 0) КАК АмортизацияНаНачалоМесяца
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ДанныеБезСтавкиДисконта.Контрагент КАК Контрагент,
	               |		ДанныеБезСтавкиДисконта.ТорговаяТочка КАК ТорговаяТочка,
	               |		ДанныеБезСтавкиДисконта.СтараяСтавка КАК СтараяСтавка,
	               |		ДанныеБезСтавкиДисконта.ОстатокДДП КАК ОстатокДДП,
	               |		ДанныеБезСтавкиДисконта.НоваяСтавка КАК НоваяСтавка,
	               |		ДанныеБезСтавкиДисконта.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений,
	               |		ДанныеБезСтавкиДисконта.ДатаНачала КАК ДатаНачала,
	               |		МАКСИМУМ(СтавкиДисконтированияПоДоговорам.Период) КАК Период
	               |	ИЗ
	               |		ДанныеБезСтавкиДисконта КАК ДанныеБезСтавкиДисконта
	               |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиДисконтированияПоДоговорам КАК СтавкиДисконтированияПоДоговорам
	               |			ПО ДанныеБезСтавкиДисконта.ДатаНачалаВзаимоотношений >= СтавкиДисконтированияПоДоговорам.Период
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДанныеБезСтавкиДисконта.Контрагент,
	               |		ДанныеБезСтавкиДисконта.ТорговаяТочка,
	               |		ДанныеБезСтавкиДисконта.ДатаНачалаВзаимоотношений,
	               |		ДанныеБезСтавкиДисконта.ДатаНачала,
	               |		ДанныеБезСтавкиДисконта.СтараяСтавка,
	               |		ДанныеБезСтавкиДисконта.ОстатокДДП,
	               |		ДанныеБезСтавкиДисконта.НоваяСтавка) КАК ВложенныйЗапрос
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиДисконтированияПоДоговорам КАК СтавкиДисконтированияПоДоговорам
	               |		ПО ВложенныйЗапрос.Период = СтавкиДисконтированияПоДоговорам.Период
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Остатки03 КАК Остатки03
	               |		ПО ВложенныйЗапрос.Контрагент = Остатки03.Контрагент
	               |			И ВложенныйЗапрос.ТорговаяТочка = Остатки03.ТорговаяТочка
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВложенныйЗапрос.Контрагент.Наименование,
	               |	ВложенныйЗапрос.ТорговаяТочка.Наименование";
	РезультатЗапроса = Запрос.Выполнить();
	
	Объект.ИзмененияНачислений.Очистить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НовСтр = Объект.ИзмененияНачислений.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр, Выборка);
		
		Дата1 = НачалоМесяца(НовСтр.ДатаНачалаВзаимоотношений);
		Дата2 = НачалоМесяца(Объект.Дата);
		НовСтр.ОставшеесяКолМесяцев = 60 - ((Год(Дата2) - Год(Дата1))* 12 + Месяц(Дата2) - Месяц(Дата1));
		
		Если НовСтр.СтараяСтавка = НовСтр.НоваяСтавка Тогда
			НовСтр.НовыйДДП = НовСтр.ОстатокДДП;
		Иначе
			НовСтр.НовыйДДП = РасчетДДП(НовСтр.НоваяСтавка, НовСтр.ПроцентДисконта, НовСтр.ОставшеесяКолМесяцев);
			НовСтр.АктивПоАренде = НовСтр.АктивПоАренде + НовСтр.НовыйДДП - НовСтр.ОстатокДДП;
		КонецЕсли;
		
		НовСтр.Амортизация = Окр(НовСтр.АктивПоАренде / 60, 2, 1); 
		Если НовСтр.Амортизация > НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца Тогда
			НовСтр.Амортизация = НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца;
		КонецЕсли;
		НовСтр.ЕжемПроцент = ?(Выборка.ПроцентДисконта = 0, 0, Окр((НовСтр.НовыйДДП - НовСтр.НоваяСтавка) * (Выборка.ПроцентДисконта / 1200), 2, 1)); 
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНачислениеАмортизацииСервер() Экспорт
	Если не ЗначениеЗаполнено(Объект.Организация) Тогда
		Возврат;
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("Дата1", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Дата2", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("АрендаТорговыхТочек", Справочники.Номенклатура.НайтиПоКоду("000000288"));
	Запрос.Текст = "ВЫБРАТЬ
	               |	ИнформацияПоДоговоруАрендыОстатки.Контрагент,
	               |	ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка,
	               |	ИнформацияПоДоговоруАрендыОстатки.ДДПОстаток,
	               |	ВложенныйЗапрос.Ставка,
	               |	ВложенныйЗапрос.ДатаНачалаВзаимоотношений
	               |ПОМЕСТИТЬ Данные
	               |ИЗ
	               |	РегистрНакопления.ИнформацияПоДоговоруАренды.Остатки(&Дата, Организация = &Организация) КАК ИнформацияПоДоговоруАрендыОстатки
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			ИнформацияПоДоговоруАренды.Контрагент КАК Контрагент,
	               |			ИнформацияПоДоговоруАренды.ТорговаяТочка КАК ТорговаяТочка,
	               |			ИнформацияПоДоговоруАренды.Ставка КАК Ставка,
	               |			ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений
	               |		ИЗ
	               |			РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |					ИнформацияПоДоговоруАренды.Контрагент КАК Контрагент,
	               |					ИнформацияПоДоговоруАренды.ТорговаяТочка КАК ТорговаяТочка,
	               |					МАКСИМУМ(ИнформацияПоДоговоруАренды.Период) КАК Период
	               |				ИЗ
	               |					РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |				ГДЕ
	               |					ИнформацияПоДоговоруАренды.Организация = &Организация
	               |					И ИнформацияПоДоговоруАренды.Период < &Дата
	               |				
	               |				СГРУППИРОВАТЬ ПО
	               |					ИнформацияПоДоговоруАренды.Контрагент,
	               |					ИнформацияПоДоговоруАренды.ТорговаяТочка) КАК ВложенныйЗапрос
	               |				ПО ИнформацияПоДоговоруАренды.Контрагент = ВложенныйЗапрос.Контрагент
	               |					И ИнформацияПоДоговоруАренды.ТорговаяТочка = ВложенныйЗапрос.ТорговаяТочка
	               |					И ИнформацияПоДоговоруАренды.Период = ВложенныйЗапрос.Период
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			ИнформацияПоДоговоруАренды.ТорговаяТочка,
	               |			ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений,
	               |			ИнформацияПоДоговоруАренды.Контрагент,
	               |			ИнформацияПоДоговоруАренды.Ставка) КАК ВложенныйЗапрос
	               |		ПО ИнформацияПоДоговоруАрендыОстатки.Контрагент = ВложенныйЗапрос.Контрагент
	               |			И ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка = ВложенныйЗапрос.ТорговаяТочка
	               |ГДЕ
	               |	(ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка.ДатаЗакрытия >= &Дата1
	               |			ИЛИ ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка.ДатаЗакрытия = ДАТАВРЕМЯ(1, 1, 1))
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент,
	               |	СУММА(ВложенныйЗапрос.СуммаМСФООстаток) КАК СуммаМСФООстаток,
	               |	СУММА(ВложенныйЗапрос.СуммаАмортизации) КАК СуммаАмортизации
	               |ПОМЕСТИТЬ Остатки03
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ФинансовыйОстатки.Счет КАК Счет,
	               |		ФинансовыйОстатки.Субконто1 КАК ТорговаяТочка,
	               |		ФинансовыйОстатки.Субконто2 КАК Контрагент,
	               |		ФинансовыйОстатки.СуммаМСФООстаток КАК СуммаМСФООстаток,
	               |		0 КАК СуммаАмортизации
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата, Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАренде)), , Организация = &Организация) КАК ФинансовыйОстатки
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ВЫБОР
	               |			КОГДА ФинансовыйОстатки.Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АмортизацияРасходыПоАренде)
	               |				ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда)
	               |			ИНАЧЕ ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеРемонтныеРаботы)
	               |		КОНЕЦ,
	               |		ФинансовыйОстатки.Субконто1,
	               |		ФинансовыйОстатки.Субконто2,
	               |		0,
	               |		-ФинансовыйОстатки.СуммаМСФООстаток
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата, Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АмортизацияАктиваПоАренде)), , Организация = &Организация) КАК ФинансовыйОстатки) КАК ВложенныйЗапрос
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЕСТЬNULL(Данные.Контрагент, Остатки03.Контрагент) КАК Контрагент,
	               |	ЕСТЬNULL(Данные.ТорговаяТочка, Остатки03.ТорговаяТочка) КАК ТорговаяТочка,
	               |	Данные.ДатаНачалаВзаимоотношений,
	               |	Данные.Ставка,
	               |	Остатки03.Счет,
	               |	Данные.ДДПОстаток,
	               |	Остатки03.СуммаМСФООстаток КАК АктивПоАренде,
	               |	Остатки03.СуммаАмортизации
	               |ПОМЕСТИТЬ Итог
	               |ИЗ
	               |	Данные КАК Данные
	               |		ПОЛНОЕ СОЕДИНЕНИЕ Остатки03 КАК Остатки03
	               |		ПО Данные.Контрагент = Остатки03.Контрагент
	               |			И Данные.ТорговаяТочка = Остатки03.ТорговаяТочка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка
	               |ПОМЕСТИТЬ ВсеНовыеДанные
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент КАК Контрагент,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница КАК ТорговаяТочка,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка КАК Документ,
	               |		СУММА(ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ) КАК НоваяСтавка,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата КАК ДатаНачала,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора КАК ДатаОкончания
	               |	ИЗ
	               |		Документ.ЗаключениеДоговораАренды.ПостояннаяЧастьАренднойПлаты КАК ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Услуга = &АрендаТорговыхТочек
	               |		И ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора,
	               |		ЗаключениеДоговораАрендыПостояннаяЧастьАренднойПлаты.Ссылка
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка,
	               |		СУММА(ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора
	               |	ИЗ
	               |		Документ.ЗаключениеДоговораАренды.ПеременнаяЧастьАренднойПлаты КАК ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000001""
	               |		И ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора,
	               |		ЗаключениеДоговораАрендыПеременнаяЧастьАренднойПлаты.Ссылка
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка,
	               |		СУММА(ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора
	               |	ИЗ
	               |		Документ.ДополнительноеСоглашение.ПостояннаяЧастьАренднойПлаты КАК ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Услуга = &АрендаТорговыхТочек
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ЗаключениеДоговораАренды.ПустаяСсылка)
	               |		И ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДокументОснование.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора,
	               |		ДополнительноеСоглашениеПостояннаяЧастьАренднойПлаты.Ссылка
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка,
	               |		СУММА(ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ставка / ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления <> ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка)
	               |					ТОГДА ВЫБОР
	               |							КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВалютаСпособаНачисления.Код = ""643""
	               |								ТОГДА 1
	               |							ИНАЧЕ ВЫБОР
	               |									КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Фиксированный)
	               |										ТОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Курс
	               |									КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.СпособРасчета = ЗНАЧЕНИЕ(Перечисление.СпособыРасчетаКурсаВалюты.Расчетный)
	               |										ТОГДА ВЫБОР
	               |												КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница = 0
	               |													ТОГДА 1
	               |												ИНАЧЕ ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ВерхняяГраница
	               |											КОНЕЦ
	               |									ИНАЧЕ 1
	               |								КОНЕЦ
	               |						КОНЕЦ
	               |				ИНАЧЕ 1
	               |			КОНЕЦ * ВЫБОР
	               |				КОГДА ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000005""
	               |					ТОГДА 30
	               |				ИНАЧЕ 1
	               |			КОНЕЦ),
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора
	               |	ИЗ
	               |		Документ.ДополнительноеСоглашение.ПеременнаяЧастьАренднойПлаты КАК ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты
	               |	ГДЕ
	               |		НЕ ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ПометкаУдаления
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата >= &Дата1
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата <= &Дата2
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.СпособНачисления.Код = ""000000001""
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ЗаключениеДоговораАренды.ПустаяСсылка)
	               |		И ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДокументОснование.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Контрагент,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.Дата,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ОбъектАренды.СтруктурнаяЕдиница,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка.ДатаОкончанияДоговора,
	               |		ДополнительноеСоглашениеПеременнаяЧастьАренднойПлаты.Ссылка) КАК ВложенныйЗапрос
	               |ГДЕ
	               |	ВложенныйЗапрос.НоваяСтавка <> 0
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.ДатаНачалаВзаимоотношений,
	               |	ВложенныйЗапрос.Ставка,
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ДДПОстаток,
	               |	ВложенныйЗапрос.АктивПоАренде,
	               |	ВложенныйЗапрос.СуммаАмортизации КАК АмортизацияНаНачалоМесяца,
	               |	ЕСТЬNULL(СтавкиДисконтированияПоДоговорам.Ставка, 0) КАК СтавкаДисконтирования
	               |ПОМЕСТИТЬ ДанныеСДисконтом
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		Итог.Контрагент КАК Контрагент,
	               |		Итог.ТорговаяТочка КАК ТорговаяТочка,
	               |		Итог.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений,
	               |		Итог.Ставка КАК Ставка,
	               |		Итог.Счет КАК Счет,
	               |		Итог.ДДПОстаток КАК ДДПОстаток,
	               |		Итог.АктивПоАренде КАК АктивПоАренде,
	               |		МАКСИМУМ(ЕСТЬNULL(СтавкиДисконтированияПоДоговорам.Период, ДАТАВРЕМЯ(1, 1, 1))) КАК Период,
	               |		Итог.СуммаАмортизации КАК СуммаАмортизации
	               |	ИЗ
	               |		Итог КАК Итог
	               |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиДисконтированияПоДоговорам КАК СтавкиДисконтированияПоДоговорам
	               |			ПО Итог.ДатаНачалаВзаимоотношений >= СтавкиДисконтированияПоДоговорам.Период
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		Итог.Контрагент,
	               |		Итог.ТорговаяТочка,
	               |		Итог.ДатаНачалаВзаимоотношений,
	               |		Итог.Ставка,
	               |		Итог.Счет,
	               |		Итог.ДДПОстаток,
	               |		Итог.АктивПоАренде,
	               |		Итог.СуммаАмортизации) КАК ВложенныйЗапрос
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиДисконтированияПоДоговорам КАК СтавкиДисконтированияПоДоговорам
	               |		ПО ВложенныйЗапрос.Период = СтавкиДисконтированияПоДоговорам.Период
	               |			И (ВложенныйЗапрос.Период <> ДАТАВРЕМЯ(1, 1, 1))
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.ДатаНачалаВзаимоотношений,
	               |	ВложенныйЗапрос.Ставка,
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ДДПОстаток,
	               |	ВложенныйЗапрос.АктивПоАренде,
	               |	ВложенныйЗапрос.АмортизацияНаНачалоМесяца,
	               |	ВложенныйЗапрос.СтавкаДисконтирования
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ДанныеСДисконтом.Контрагент КАК Контрагент,
	               |		ДанныеСДисконтом.ТорговаяТочка КАК ТорговаяТочка,
	               |		ДанныеСДисконтом.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений,
	               |		ДанныеСДисконтом.Ставка КАК Ставка,
	               |		ДанныеСДисконтом.Счет КАК Счет,
	               |		ДанныеСДисконтом.ДДПОстаток КАК ДДПОстаток,
	               |		ДанныеСДисконтом.АктивПоАренде КАК АктивПоАренде,
	               |		ДанныеСДисконтом.АмортизацияНаНачалоМесяца КАК АмортизацияНаНачалоМесяца,
	               |		ДанныеСДисконтом.СтавкаДисконтирования КАК СтавкаДисконтирования,
	               |		ВЫБОР
	               |			КОГДА ВсеНовыеДанные.ТорговаяТочка ЕСТЬ NULL
	               |				ТОГДА 0
	               |			ИНАЧЕ 1
	               |		КОНЕЦ КАК НеНадо
	               |	ИЗ
	               |		ДанныеСДисконтом КАК ДанныеСДисконтом
	               |			ПОЛНОЕ СОЕДИНЕНИЕ ВсеНовыеДанные КАК ВсеНовыеДанные
	               |			ПО ДанныеСДисконтом.Контрагент = ВсеНовыеДанные.Контрагент
	               |				И ДанныеСДисконтом.ТорговаяТочка = ВсеНовыеДанные.ТорговаяТочка) КАК ВложенныйЗапрос
	               |ГДЕ
	               |	ВложенныйЗапрос.НеНадо = 0
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВложенныйЗапрос.Счет.Наименование,
	               |	ВложенныйЗапрос.Контрагент.Наименование,
	               |	ВложенныйЗапрос.ТорговаяТочка.Наименование";
	РезультатЗапроса = Запрос.Выполнить();
	
	Объект.НачислениеАмортизации.Очистить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.Счет = ПланыСчетов.Финансовый.АктивПоАрендеРемонтныеРаботы Тогда
			Продолжить;
		КонецЕсли;
		НовСтр = Объект.НачислениеАмортизации.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр, Выборка);
		НовСтр.Амортизация = Окр(НовСтр.АктивПоАренде / 60, 2, 1); 
		Если НовСтр.Амортизация > НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца Тогда
			НовСтр.Амортизация = НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца;
		КонецЕсли;
		НовСтр.ЕжемПроцент = ?(Выборка.СтавкаДисконтирования = 0, 0, Окр((НовСтр.ДДПОстаток - НовСтр.Ставка) * (Выборка.СтавкаДисконтирования / 1200), 2, 1)); 
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьЗакрытыеТорговыеТочкиИДоговораНаСервере()
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("Дата1", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Дата2", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("АрендаТорговыхТочек", Справочники.Номенклатура.НайтиПоКоду("000000288"));
	Запрос.УстановитьПараметр("Дата3", КонецМесяца(Объект.Дата)+1);
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент,
	               |	СУММА(ВложенныйЗапрос.СуммаМСФООстаток) КАК СуммаАктива,
	               |	СУММА(ВложенныйЗапрос.СуммаАмортизации) КАК СуммаАмортизации,
	               |	ВложенныйЗапрос.ТорговаяТочка.ДатаЗакрытия КАК ДатаЗакрытияТТ,
	               |	СУММА(ВложенныйЗапрос.ОбязательствоПоАренде) КАК ОбязательствоПоАренде
	               |ПОМЕСТИТЬ Остатки
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ФинансовыйОстатки.Счет КАК Счет,
	               |		ФинансовыйОстатки.Субконто1 КАК ТорговаяТочка,
	               |		ФинансовыйОстатки.Субконто2 КАК Контрагент,
	               |		ФинансовыйОстатки.СуммаМСФООстаток КАК СуммаМСФООстаток,
	               |		0 КАК СуммаАмортизации,
	               |		0 КАК ОбязательствоПоАренде
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата3, Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАренде)), , Организация = &Организация) КАК ФинансовыйОстатки
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ВЫБОР
	               |			КОГДА ФинансовыйОстатки.Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АмортизацияРасходыПоАренде)
	               |				ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда)
	               |			ИНАЧЕ ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеРемонтныеРаботы)
	               |		КОНЕЦ,
	               |		ФинансовыйОстатки.Субконто1,
	               |		ФинансовыйОстатки.Субконто2,
	               |		0,
	               |		-ФинансовыйОстатки.СуммаМСФООстаток,
	               |		0
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата3, Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АмортизацияАктиваПоАренде)), , Организация = &Организация) КАК ФинансовыйОстатки
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда),
	               |		ФинансовыйОстатки.Субконто3,
	               |		ФинансовыйОстатки.Субконто2,
	               |		0,
	               |		0,
	               |		ФинансовыйОстатки.СуммаМСФООстаток
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(&Дата3, Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.РасчетыОбязательстваПоАренде), , Организация = &Организация) КАК ФинансовыйОстатки) КАК ВложенныйЗапрос
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка.ДатаЗакрытия
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	СУММА(ВложенныйЗапрос.КолДействующих) КАК КолДействующих,
	               |	СУММА(ВложенныйЗапрос.КолРасторгнутых) КАК КолРасторгнутых,
	               |	СУММА(ВложенныйЗапрос.КолКолДействующих1) КАК КолКолДействующих1,
	               |	СУММА(ВложенныйЗапрос.КолРасторгнутых1) КАК КолРасторгнутых1
	               |ПОМЕСТИТЬ РасторгнДоговора
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор.Владелец КАК Контрагент,
	               |		СтатусыДоговоровАрендыСрезПоследних.ОбъектАренды.СтруктурнаяЕдиница КАК ТорговаяТочка,
	               |		ВЫБОР
	               |			КОГДА СтатусыДоговоровАрендыСрезПоследних.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыДоговоровКонтрагентов.Действует)
	               |				ТОГДА 1
	               |			ИНАЧЕ 0
	               |		КОНЕЦ КАК КолДействующих,
	               |		ВЫБОР
	               |			КОГДА СтатусыДоговоровАрендыСрезПоследних.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыДоговоровКонтрагентов.Расторгнут)
	               |					И СтатусыДоговоровАрендыСрезПоследних.ДатаОкончанияАренды >= &Дата1
	               |					И СтатусыДоговоровАрендыСрезПоследних.ДатаОкончанияАренды <= &Дата2
	               |				ТОГДА 1
	               |			ИНАЧЕ 0
	               |		КОНЕЦ КАК КолРасторгнутых,
	               |		0 КАК КолКолДействующих1,
	               |		0 КАК КолРасторгнутых1
	               |	ИЗ
	               |		РегистрСведений.СтатусыДоговоровАренды.СрезПоследних(&Дата3, Договор.Организация = &Организация) КАК СтатусыДоговоровАрендыСрезПоследних
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор.Владелец,
	               |		СтатусыДоговоровАрендыСрезПоследних.ОбъектАренды.СтруктурнаяЕдиница,
	               |		0,
	               |		0,
	               |		ВЫБОР
	               |			КОГДА СтатусыДоговоровАрендыСрезПоследних.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыДоговоровКонтрагентов.Действует)
	               |				ТОГДА 1
	               |			ИНАЧЕ 0
	               |		КОНЕЦ,
	               |		ВЫБОР
	               |			КОГДА СтатусыДоговоровАрендыСрезПоследних.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыДоговоровКонтрагентов.Расторгнут)
	               |				ТОГДА 1
	               |			ИНАЧЕ 0
	               |		КОНЕЦ
	               |	ИЗ
	               |		РегистрСведений.СтатусыДоговоровАренды.СрезПоследних(&Дата3, Договор.Организация = &Организация) КАК СтатусыДоговоровАрендыСрезПоследних
	               |	ГДЕ
	               |		СтатусыДоговоровАрендыСрезПоследних.ДатаНачалаАренды >= НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&Дата1, МЕСЯЦ, 1), МЕСЯЦ)
	               |		И СтатусыДоговоровАрендыСрезПоследних.ДатаНачалаАренды <= КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&Дата1, МЕСЯЦ, 1), МЕСЯЦ)) КАК ВложенныйЗапрос
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ТорговаяТочка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Остатки.Счет,
	               |	Остатки.ТорговаяТочка,
	               |	Остатки.Контрагент,
	               |	Остатки.СуммаАктива,
	               |	Остатки.СуммаАмортизации,
	               |	Остатки.ДатаЗакрытияТТ,
	               |	Остатки.ОбязательствоПоАренде,
	               |	ЕСТЬNULL(РасторгнДоговора.КолДействующих, 0) КАК КолДействующих,
	               |	ЕСТЬNULL(РасторгнДоговора.КолРасторгнутых, 0) КАК КолРасторгнутых,
	               |	ЕСТЬNULL(РасторгнДоговора.КолКолДействующих1, 0) КАК КолКолДействующих1,
	               |	ЕСТЬNULL(РасторгнДоговора.КолРасторгнутых1, 0) КАК КолРасторгнутых1
	               |ПОМЕСТИТЬ ПолныеДанные
	               |ИЗ
	               |	Остатки КАК Остатки
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РасторгнДоговора КАК РасторгнДоговора
	               |		ПО Остатки.ТорговаяТочка = РасторгнДоговора.ТорговаяТочка
	               |			И Остатки.Контрагент = РасторгнДоговора.Контрагент
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Счет,
	               |	ВложенныйЗапрос.ТорговаяТочка,
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.СуммаАктива,
	               |	ВложенныйЗапрос.СуммаАмортизации,
	               |	ВложенныйЗапрос.ДатаЗакрытияТТ,
	               |	ВложенныйЗапрос.ОбязательствоПоАренде,
	               |	ВложенныйЗапрос.Ставка,
	               |	ВложенныйЗапрос.ДатаНачалаВзаимоотношений,
	               |	ВложенныйЗапрос.Закрыть,
	               |	ВложенныйЗапрос.ДДПОстаток
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ПолныеДанные.Счет КАК Счет,
	               |		ПолныеДанные.ТорговаяТочка КАК ТорговаяТочка,
	               |		ПолныеДанные.Контрагент КАК Контрагент,
	               |		ПолныеДанные.СуммаАктива КАК СуммаАктива,
	               |		ПолныеДанные.СуммаАмортизации КАК СуммаАмортизации,
	               |		ПолныеДанные.ДатаЗакрытияТТ КАК ДатаЗакрытияТТ,
	               |		ПолныеДанные.ОбязательствоПоАренде КАК ОбязательствоПоАренде,
	               |		ВложенныйЗапрос.Ставка КАК Ставка,
	               |		ВложенныйЗапрос.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений,
	               |		ВЫБОР
	               |			КОГДА ПолныеДанные.ТорговаяТочка.ДатаЗакрытия >= &Дата1
	               |					И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия <= &Дата2
	               |					И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия <> ДАТАВРЕМЯ(1, 1, 1)
	               |					И ПолныеДанные.КолДействующих = 0
	               |					И ПолныеДанные.КолРасторгнутых <> 0
	               |					И ПолныеДанные.КолКолДействующих1 = 0
	               |				ТОГДА ИСТИНА
	               |			ИНАЧЕ ЛОЖЬ
	               |		КОНЕЦ КАК Закрыть,
	               |		ИнформацияПоДоговоруАрендыОстатки.ДДПОстаток КАК ДДПОстаток
	               |	ИЗ
	               |		ПолныеДанные КАК ПолныеДанные
	               |			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |				ИнформацияПоДоговоруАренды.Контрагент КАК Контрагент,
	               |				ИнформацияПоДоговоруАренды.ТорговаяТочка КАК ТорговаяТочка,
	               |				ИнформацияПоДоговоруАренды.Ставка КАК Ставка,
	               |				ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений КАК ДатаНачалаВзаимоотношений
	               |			ИЗ
	               |				РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |					ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |						ИнформацияПоДоговоруАренды.Контрагент КАК Контрагент,
	               |						ИнформацияПоДоговоруАренды.ТорговаяТочка КАК ТорговаяТочка,
	               |						МАКСИМУМ(ИнформацияПоДоговоруАренды.Период) КАК Период
	               |					ИЗ
	               |						РегистрНакопления.ИнформацияПоДоговоруАренды КАК ИнформацияПоДоговоруАренды
	               |					ГДЕ
	               |						ИнформацияПоДоговоруАренды.Период < &Дата3
	               |						И ИнформацияПоДоговоруАренды.Организация = &Организация
	               |					
	               |					СГРУППИРОВАТЬ ПО
	               |						ИнформацияПоДоговоруАренды.Контрагент,
	               |						ИнформацияПоДоговоруАренды.ТорговаяТочка) КАК ВложенныйЗапрос
	               |					ПО ИнформацияПоДоговоруАренды.Контрагент = ВложенныйЗапрос.Контрагент
	               |						И ИнформацияПоДоговоруАренды.ТорговаяТочка = ВложенныйЗапрос.ТорговаяТочка
	               |						И ИнформацияПоДоговоруАренды.Период = ВложенныйЗапрос.Период
	               |			ГДЕ
	               |				ИнформацияПоДоговоруАренды.Организация = &Организация
	               |			
	               |			СГРУППИРОВАТЬ ПО
	               |				ИнформацияПоДоговоруАренды.ТорговаяТочка,
	               |				ИнформацияПоДоговоруАренды.Контрагент,
	               |				ИнформацияПоДоговоруАренды.ДатаНачалаВзаимоотношений,
	               |				ИнформацияПоДоговоруАренды.Ставка) КАК ВложенныйЗапрос
	               |			ПО ПолныеДанные.ТорговаяТочка = ВложенныйЗапрос.ТорговаяТочка
	               |				И ПолныеДанные.Контрагент = ВложенныйЗапрос.Контрагент
	               |			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ИнформацияПоДоговоруАренды.Остатки(&Дата3, Организация = &Организация) КАК ИнформацияПоДоговоруАрендыОстатки
	               |			ПО ПолныеДанные.ТорговаяТочка = ИнформацияПоДоговоруАрендыОстатки.ТорговаяТочка
	               |				И ПолныеДанные.Контрагент = ИнформацияПоДоговоруАрендыОстатки.Контрагент
	               |	ГДЕ
	               |		ПолныеДанные.Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда)
	               |		И (ПолныеДанные.КолДействующих = 0
	               |					И ПолныеДанные.КолРасторгнутых <> 0
	               |					И ПолныеДанные.КолКолДействующих1 = 0
	               |				ИЛИ ПолныеДанные.ТорговаяТочка.ДатаЗакрытия >= &Дата1
	               |					И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия <= &Дата2)
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		ПолныеДанные.Счет,
	               |		ПолныеДанные.ТорговаяТочка,
	               |		ПолныеДанные.Контрагент,
	               |		ПолныеДанные.СуммаАктива,
	               |		ПолныеДанные.СуммаАмортизации,
	               |		ПолныеДанные.ДатаЗакрытияТТ,
	               |		ПолныеДанные.ОбязательствоПоАренде,
	               |		NULL,
	               |		NULL,
	               |		ИСТИНА,
	               |		0
	               |	ИЗ
	               |		ПолныеДанные КАК ПолныеДанные
	               |	ГДЕ
	               |		ПолныеДанные.Счет <> ЗНАЧЕНИЕ(ПланСчетов.Финансовый.АктивПоАрендеАренда)
	               |		И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия >= &Дата1
	               |		И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия <= &Дата2
	               |		И ПолныеДанные.ТорговаяТочка.ДатаЗакрытия <> ДАТАВРЕМЯ(1, 1, 1)) КАК ВложенныйЗапрос
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ВложенныйЗапрос.Счет.Наименование,
	               |	ВложенныйЗапрос.Контрагент.Наименование,
	               |	ВложенныйЗапрос.ТорговаяТочка.Наименование";
	РезультатЗапроса = Запрос.Выполнить();
	
	Объект.ЗакрытыеТорговыеТочкиИДоговора.Очистить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НовСтр = Объект.ЗакрытыеТорговыеТочкиИДоговора.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр, Выборка);
		//НовСтр.Амортизация = Окр(НовСтр.АктивПоАренде / 60, 2, 1); 
		//Если НовСтр.Амортизация > НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца Тогда
		//	НовСтр.Амортизация = НовСтр.АктивПоАренде - НовСтр.АмортизацияНаНачалоМесяца;
		//КонецЕсли;
		//НовСтр.ЕжемПроцент = ?(Выборка.СтавкаДисконтирования = 0, 0, Окр((НовСтр.ДДПОстаток - НовСтр.Ставка) * (Выборка.СтавкаДисконтирования / 1200), 2, 1)); 
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция РасчетДДП(Ставка, СтавкаДисконта, КолМесяцев) Экспорт
	ДДП = 0;
	Для й = 1 по КолМесяцев Цикл
		ДДП = ДДП + Ставка / pow((1 + СтавкаДисконта / 1200), й - 1);
	КонецЦикла;
	
	Возврат ДДП;
КонецФункции

&НаСервере
Процедура ЗаполнитьОбеспечительныеВзносыНаСервере()
	Если не ЗначениеЗаполнено(Объект.Организация) Тогда
		Возврат;
	КонецЕсли;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
	Запрос.УстановитьПараметр("Дата", Объект.Дата);
	Запрос.УстановитьПараметр("Дата1", НачалоМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("Дата3", ?(НачалоМесяца(Объект.Дата) = '20180101', '20180101000001', НачалоМесяца(Объект.Дата)));
	Запрос.УстановитьПараметр("Дата2", КонецМесяца(Объект.Дата));
	Запрос.УстановитьПараметр("АрендаТорговыхТочек", Справочники.Номенклатура.НайтиПоКоду("000000288"));
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ДоговорКонтрагента,
	               |	ВложенныйЗапрос.Сумма
	               |ПОМЕСТИТЬ НачальныйОстатокДепозита
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ДепозитыПоДоговорамАрендыСрезПоследних.Контрагент КАК Контрагент,
	               |		ДепозитыПоДоговорамАрендыСрезПоследних.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |		СУММА(ДепозитыПоДоговорамАрендыСрезПоследних.СуммаЗалогаМСФО / ВЫБОР
	               |				КОГДА ДепозитыПоДоговорамАрендыСрезПоследних.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |					ТОГДА 1.18
	               |				КОГДА ДепозитыПоДоговорамАрендыСрезПоследних.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |					ТОГДА 1.2
	               |				ИНАЧЕ 1
	               |			КОНЕЦ) КАК Сумма
	               |	ИЗ
	               |		РегистрСведений.ДепозитыПоДоговорамАренды.СрезПоследних(
	               |				&Дата1,
	               |				Услуга = &АрендаТорговыхТочек
	               |					И ДоговорКонтрагента.Организация = &Организация) КАК ДепозитыПоДоговорамАрендыСрезПоследних
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		ДепозитыПоДоговорамАрендыСрезПоследних.Контрагент,
	               |		ДепозитыПоДоговорамАрендыСрезПоследних.ДоговорКонтрагента) КАК ВложенныйЗапрос
	               |ГДЕ
	               |	ВложенныйЗапрос.Сумма <> 0
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ДоговорКонтрагента,
	               |	СУММА(ВложенныйЗапрос.Сумма) КАК Сумма,
	               |	ВложенныйЗапрос.Регистратор,
	               |	ВложенныйЗапрос.Период
	               |ПОМЕСТИТЬ СуммыДепозита
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ДепозитыПоДоговорамАренды.Контрагент КАК Контрагент,
	               |		ДепозитыПоДоговорамАренды.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |		ДепозитыПоДоговорамАренды.СуммаЗалогаМСФО / ВЫБОР
	               |			КОГДА ДепозитыПоДоговорамАренды.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |				ТОГДА 1.18
	               |			КОГДА ДепозитыПоДоговорамАренды.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |				ТОГДА 1.2
	               |			ИНАЧЕ 1
	               |		КОНЕЦ КАК Сумма,
	               |		ДепозитыПоДоговорамАренды.Регистратор КАК Регистратор,
	               |		ДепозитыПоДоговорамАренды.Период КАК Период
	               |	ИЗ
	               |		РегистрСведений.ДепозитыПоДоговорамАренды КАК ДепозитыПоДоговорамАренды
	               |	ГДЕ
	               |		ДепозитыПоДоговорамАренды.ДоговорКонтрагента.Организация = &Организация
	               |		И ДепозитыПоДоговорамАренды.Период >= &Дата1
	               |		И ДепозитыПоДоговорамАренды.Период <= &Дата2
	               |		И ДепозитыПоДоговорамАренды.Услуга = &АрендаТорговыхТочек
	               |		И (ДепозитыПоДоговорамАренды.Регистратор ССЫЛКА Документ.ЗаключениеДоговораАренды
	               |					И ДепозитыПоДоговорамАренды.Регистратор.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |				ИЛИ ДепозитыПоДоговорамАренды.Регистратор ССЫЛКА Документ.ДополнительноеСоглашение
	               |					И ДепозитыПоДоговорамАренды.Регистратор.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ЗаключениеДоговораАренды.ПустаяСсылка)
	               |					И ДепозитыПоДоговорамАренды.Регистратор.ДокументОснование ССЫЛКА Документ.ЗаключениеДоговораАренды
	               |					И ДепозитыПоДоговорамАренды.Регистратор.ДокументОснование.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем))
	               |		И ДепозитыПоДоговорамАренды.Услуга = &АрендаТорговыхТочек) КАК ВложенныйЗапрос
	               |ГДЕ
	               |	ВложенныйЗапрос.Сумма <> 0
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ДоговорКонтрагента,
	               |	ВложенныйЗапрос.Регистратор,
	               |	ВложенныйЗапрос.Период
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммыДепозита.Контрагент КАК Контрагент,
	               |	СуммыДепозита.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |	СуммыДепозита.Регистратор КАК Регистратор,
	               |	СуммыДепозита.Сумма - ЕСТЬNULL(НачальныйОстатокДепозита.Сумма, 0) КАК Сумма
	               |ПОМЕСТИТЬ СуммаРазницы
	               |ИЗ
	               |	СуммыДепозита КАК СуммыДепозита
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			СуммыДепозита.Контрагент КАК Контрагент,
	               |			СуммыДепозита.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |			МАКСИМУМ(СуммыДепозита.Регистратор) КАК Регистратор
	               |		ИЗ
	               |			СуммыДепозита КАК СуммыДепозита
	               |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |					СуммыДепозита.Контрагент КАК Контрагент,
	               |					СуммыДепозита.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |					МАКСИМУМ(СуммыДепозита.Период) КАК Период
	               |				ИЗ
	               |					СуммыДепозита КАК СуммыДепозита
	               |				
	               |				СГРУППИРОВАТЬ ПО
	               |					СуммыДепозита.Контрагент,
	               |					СуммыДепозита.ДоговорКонтрагента) КАК ВложенныйЗапрос
	               |				ПО СуммыДепозита.Контрагент = ВложенныйЗапрос.Контрагент
	               |					И СуммыДепозита.ДоговорКонтрагента = ВложенныйЗапрос.ДоговорКонтрагента
	               |					И СуммыДепозита.Период = ВложенныйЗапрос.Период
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			СуммыДепозита.Контрагент,
	               |			СуммыДепозита.ДоговорКонтрагента) КАК ВложенныйЗапрос
	               |		ПО СуммыДепозита.Контрагент = ВложенныйЗапрос.Контрагент
	               |			И СуммыДепозита.ДоговорКонтрагента = ВложенныйЗапрос.ДоговорКонтрагента
	               |			И СуммыДепозита.Регистратор = ВложенныйЗапрос.Регистратор
	               |		ЛЕВОЕ СОЕДИНЕНИЕ НачальныйОстатокДепозита КАК НачальныйОстатокДепозита
	               |		ПО СуммыДепозита.Контрагент = НачальныйОстатокДепозита.Контрагент
	               |			И СуммыДепозита.ДоговорКонтрагента = НачальныйОстатокДепозита.ДоговорКонтрагента
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.Договор,
	               |	ВложенныйЗапрос.СтруктурнаяЕдиница,
	               |	ВложенныйЗапрос.Документ,
	               |	ВложенныйЗапрос.Статус,
	               |	ВложенныйЗапрос.ЗаключениеДоговора,
	               |	ВложенныйЗапрос.Период
	               |ПОМЕСТИТЬ Расторжение
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор.Владелец КАК Контрагент,
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор КАК Договор,
	               |		СтатусыДоговоровАрендыСрезПоследних.ОбъектАренды.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	               |		СтатусыДоговоровАрендыСрезПоследних.Документ КАК Документ,
	               |		СтатусыДоговоровАрендыСрезПоследних.Статус КАК Статус,
	               |		СтатусыДоговоровАрендыСрезПоследних.ЗаключениеДоговора КАК ЗаключениеДоговора,
	               |		СтатусыДоговоровАрендыСрезПоследних.Период КАК Период
	               |	ИЗ
	               |		РегистрСведений.СтатусыДоговоровАренды.СрезПоследних(&Дата2, Договор.Организация = &Организация) КАК СтатусыДоговоровАрендыСрезПоследних
	               |	ГДЕ
	               |		СтатусыДоговоровАрендыСрезПоследних.ДатаОкончанияАренды >= &Дата1
	               |		И СтатусыДоговоровАрендыСрезПоследних.ДатаОкончанияАренды <= &Дата2
	               |		И СтатусыДоговоровАрендыСрезПоследних.Договор.Организация = &Организация
	               |		И СтатусыДоговоровАрендыСрезПоследних.Договор.ТипДоговора = ЗНАЧЕНИЕ(Перечисление.ТипыДоговоровСПоставщиком.Аренда)
	               |		И СтатусыДоговоровАрендыСрезПоследних.ЗаключениеДоговора ССЫЛКА Документ.ЗаключениеДоговораАренды
	               |		И СтатусыДоговоровАрендыСрезПоследних.ЗаключениеДоговора.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДоговоровАренды.САрендодателем)
	               |	
	               |	СГРУППИРОВАТЬ ПО
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор.Владелец,
	               |		СтатусыДоговоровАрендыСрезПоследних.ОбъектАренды.СтруктурнаяЕдиница,
	               |		СтатусыДоговоровАрендыСрезПоследних.Документ,
	               |		СтатусыДоговоровАрендыСрезПоследних.Статус,
	               |		СтатусыДоговоровАрендыСрезПоследних.ЗаключениеДоговора,
	               |		СтатусыДоговоровАрендыСрезПоследних.Договор,
	               |		СтатусыДоговоровАрендыСрезПоследних.Период) КАК ВложенныйЗапрос
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ДоговорКонтрагента,
	               |	ДепозитыПоДоговорамАренды.ДоговорКонтрагента.ОбъектАренды.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	               |	ДепозитыПоДоговорамАренды.Регистратор,
	               |	СУММА(ДепозитыПоДоговорамАренды.СуммаЗалогаМСФО / ВЫБОР
	               |			КОГДА ДепозитыПоДоговорамАренды.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	               |				ТОГДА 1.18
	               |			КОГДА ДепозитыПоДоговорамАренды.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	               |				ТОГДА 1.2
	               |			ИНАЧЕ 1
	               |		КОНЕЦ) КАК Сумма,
	               |	ВложенныйЗапрос.Документ
	               |ПОМЕСТИТЬ СуммаРасторжения
	               |ИЗ
	               |	РегистрСведений.ДепозитыПоДоговорамАренды КАК ДепозитыПоДоговорамАренды
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			ДепозитыПоДоговорамАренды.Контрагент КАК Контрагент,
	               |			ДепозитыПоДоговорамАренды.ДоговорКонтрагента КАК ДоговорКонтрагента,
	               |			МАКСИМУМ(ДепозитыПоДоговорамАренды.Период) КАК Период,
	               |			ВложенныйЗапрос.Документ КАК Документ
	               |		ИЗ
	               |			РегистрСведений.ДепозитыПоДоговорамАренды КАК ДепозитыПоДоговорамАренды
	               |				ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |					Расторжение.Контрагент КАК Контрагент,
	               |					Расторжение.Договор КАК Договор,
	               |					Расторжение.Документ КАК Документ
	               |				ИЗ
	               |					Расторжение КАК Расторжение
	               |				
	               |				СГРУППИРОВАТЬ ПО
	               |					Расторжение.Контрагент,
	               |					Расторжение.Договор,
	               |					Расторжение.Документ) КАК ВложенныйЗапрос
	               |				ПО ДепозитыПоДоговорамАренды.Контрагент = ВложенныйЗапрос.Контрагент
	               |					И ДепозитыПоДоговорамАренды.ДоговорКонтрагента = ВложенныйЗапрос.Договор
	               |		ГДЕ
	               |			ДепозитыПоДоговорамАренды.ДоговорКонтрагента.Организация = &Организация
	               |			И ДепозитыПоДоговорамАренды.Услуга = &АрендаТорговыхТочек
	               |			И ДепозитыПоДоговорамАренды.Период <= &Дата2
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			ДепозитыПоДоговорамАренды.Контрагент,
	               |			ДепозитыПоДоговорамАренды.ДоговорКонтрагента,
	               |			ВложенныйЗапрос.Документ) КАК ВложенныйЗапрос
	               |		ПО ДепозитыПоДоговорамАренды.Контрагент = ВложенныйЗапрос.Контрагент
	               |			И ДепозитыПоДоговорамАренды.ДоговорКонтрагента = ВложенныйЗапрос.ДоговорКонтрагента
	               |			И ДепозитыПоДоговорамАренды.Период = ВложенныйЗапрос.Период
	               |ГДЕ
	               |	ДепозитыПоДоговорамАренды.ДоговорКонтрагента.Организация = &Организация
	               |	И ДепозитыПоДоговорамАренды.Услуга = &АрендаТорговыхТочек
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.ДоговорКонтрагента,
	               |	ДепозитыПоДоговорамАренды.Регистратор,
	               |	ДепозитыПоДоговорамАренды.ДоговорКонтрагента.ОбъектАренды.СтруктурнаяЕдиница,
	               |	ВложенныйЗапрос.Документ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВложенныйЗапрос.Контрагент,
	               |	ВложенныйЗапрос.СтруктурнаяЕдиница,
	               |	ВложенныйЗапрос.НачОст,
	               |	ВложенныйЗапрос.Документ,
	               |	ВложенныйЗапрос.СуммаПриход,
	               |	ВложенныйЗапрос.СуммаРасход,
	               |	ВложенныйЗапрос.Провести
	               |ПОМЕСТИТЬ Данные
	               |ИЗ
	               |	(ВЫБРАТЬ
	               |		ФинансовыйОстатки.Субконто2 КАК Контрагент,
	               |		ФинансовыйОстатки.Субконто3 КАК СтруктурнаяЕдиница,
	               |		-ФинансовыйОстатки.СуммаМСФООстаток КАК НачОст,
	               |		NULL КАК Документ,
	               |		0 КАК СуммаПриход,
	               |		0 КАК СуммаРасход,
	               |		ЛОЖЬ КАК Провести
	               |	ИЗ
	               |		РегистрБухгалтерии.Финансовый.Остатки(
	               |				&Дата3,
	               |				Счет = ЗНАЧЕНИЕ(ПланСчетов.Финансовый.ОбеспечительныйВзнос),
	               |				,
	               |				Организация = &Организация
	               |					И Субконто1 = &Организация) КАК ФинансовыйОстатки
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		СуммаРазницы.Контрагент,
	               |		СуммаРазницы.ДоговорКонтрагента.ОбъектАренды.СтруктурнаяЕдиница,
	               |		0,
	               |		СуммаРазницы.Регистратор,
	               |		СуммаРазницы.Сумма,
	               |		0,
	               |		ИСТИНА
	               |	ИЗ
	               |		СуммаРазницы КАК СуммаРазницы
	               |	
	               |	ОБЪЕДИНИТЬ ВСЕ
	               |	
	               |	ВЫБРАТЬ
	               |		СуммаРасторжения.Контрагент,
	               |		СуммаРасторжения.СтруктурнаяЕдиница,
	               |		0,
	               |		СуммаРасторжения.Документ,
	               |		0,
	               |		СуммаРасторжения.Сумма,
	               |		ИСТИНА
	               |	ИЗ
	               |		СуммаРасторжения КАК СуммаРасторжения) КАК ВложенныйЗапрос
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Данные.Контрагент,
	               |	Данные.СтруктурнаяЕдиница КАК ТорговаяТочка,
	               |	Данные.НачОст КАК НачальныйОстаток,
	               |	Данные.Документ КАК Документ,
	               |	Данные.СуммаПриход,
	               |	Данные.СуммаРасход,
	               |	Данные.Провести
	               |ИЗ
	               |	Данные КАК Данные
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	               |			Данные.Контрагент КАК Контрагент,
	               |			Данные.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	               |			СУММА(Данные.НачОст) КАК НачОст,
	               |			СУММА(Данные.СуммаПриход) КАК СуммаПриход,
	               |			СУММА(Данные.СуммаРасход) КАК СуммаРасход
	               |		ИЗ
	               |			Данные КАК Данные
	               |		
	               |		СГРУППИРОВАТЬ ПО
	               |			Данные.Контрагент,
	               |			Данные.СтруктурнаяЕдиница) КАК ВложенныйЗапрос
	               |		ПО Данные.Контрагент = ВложенныйЗапрос.Контрагент
	               |			И Данные.СтруктурнаяЕдиница = ВложенныйЗапрос.СтруктурнаяЕдиница
	               |ГДЕ
	               |	(ВложенныйЗапрос.СуммаПриход <> 0
	               |			ИЛИ ВложенныйЗапрос.СуммаРасход <> 0)
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Данные.Контрагент.Наименование,
	               |	Данные.СтруктурнаяЕдиница.Наименование,
	               |	Документ";
	РезультатЗапроса = Запрос.Выполнить();
	
	Объект.ОбеспечительныеВзносы.Очистить();
	Объект.ОбеспечительныеВзносы.Загрузить(РезультатЗапроса.Выгрузить());
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьОбеспечительныеВзносы(Команда)
	ЗаполнитьОбеспечительныеВзносыНаСервере();
КонецПроцедуры

















