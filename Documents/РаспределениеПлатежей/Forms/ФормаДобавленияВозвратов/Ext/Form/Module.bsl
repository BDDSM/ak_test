&НаКлиенте
Процедура ПеренестиВДокумент(Команда)
	
	ТаблицаВозвратовИсточник = ПеренестиРезультатНаСервере();
	ЭтаФорма.Закрыть(ТаблицаВозвратовИсточник);
	
КонецПроцедуры

&НаСервере
Функция ПеренестиРезультатНаСервере()
	
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("Обрабатывать", Истина);
	НайденныеСтроки = ТаблицаВозвратов.Выгрузить(ПараметрыОтбора);
	
	Возврат НайденныеСтроки;
		
КонецФункции	

&НаСервере
Процедура ПриОткрытииНаСервере(СтруктураИсточника)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РасчетыСКонтрагентамиОстатки.Сделка КАК ВозвратТоваровОтПокупателя,
		|	-РасчетыСКонтрагентамиОстатки.СуммаОстаток КАК СуммаОстаткаПоРегистру
		|ИЗ
		|	РегистрНакопления.РасчетыСКонтрагентами.Остатки(
		|			&ДатаОстатка,
		|			Сделка ССЫЛКА Документ.ВозвратТоваровОтПокупателя
		|				И Контрагент = &Контрагент
		|				И Организация = &Организация
		|				И Сделка.ДоговорКонтрагента = &ДоговорКонтрагента) КАК РасчетыСКонтрагентамиОстатки
		|
		|УПОРЯДОЧИТЬ ПО
		|	РасчетыСКонтрагентамиОстатки.Сделка.Дата";
	                                     
	Запрос.УстановитьПараметр("ДатаОстатка", СтруктураИсточника.Дата);
	Запрос.УстановитьПараметр("ДоговорКонтрагента", СтруктураИсточника.ДоговорКонтрагента);
	Запрос.УстановитьПараметр("Контрагент", СтруктураИсточника.Контрагент);
	Запрос.УстановитьПараметр("Организация", СтруктураИсточника.Организация);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Сообщить("Нет возвратов с остатками!");
	КонецЕсли;	
		
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ДобавленнаяСтрока = ТаблицаВозвратов.Добавить();
		ЗаполнитьЗначенияСвойств(ДобавленнаяСтрока, ВыборкаДетальныеЗаписи); 
	КонецЦикла;
		
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	СтруктураИсточника = Новый Структура;
	СтруктураИсточника.Вставить("Дата", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭтаФорма.ВладелецФормы.Объект.ПлатежныйДокумент, "Дата"));
	СтруктураИсточника.Вставить("ДоговорКонтрагента", ЭтаФорма.ВладелецФормы.Объект.ДоговорКонтрагента);
	СтруктураИсточника.Вставить("Контрагент", ЭтаФорма.ВладелецФормы.Объект.Контрагент);
	СтруктураИсточника.Вставить("Организация", ЭтаФорма.ВладелецФормы.Объект.Организация);
	
	ПриОткрытииНаСервере(СтруктураИсточника);
	
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаВозвратовОбрабатыватьПриИзменении(Элемент)
	
	ТаблицаОтобранных = ПеренестиРезультатНаСервере();
	
	Элементы.ИтогоВозвратов.Заголовок = "Итого возвратов: " + ТаблицаОтобранных.Итог("СуммаОстаткаПоРегистру");	
	
КонецПроцедуры

&НаСервере
Функция ИтогоВозвратовНаСервере()
	
	Возврат 0;
	
КонецФункции