//+++АК LAGP 2018.06.26 ИП-00018465.04 Создание объекта. 
//Документ предназначен для "гашения" регистра накопления "Расчёты с контрагентами" по измерению "Сделка" со значениями документов ВозвратОтПокупателя, ПоступлениеВБанк, РеализацияТоваровИУслуг. 

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПоступлениеВБанк") Тогда
		ДоговорКонтрагента = ДанныеЗаполнения.ДоговорКонтрагента;
		Контрагент = ДанныеЗаполнения.Контрагент;
		ПлатежныйДокумент = ДанныеЗаполнения.Ссылка;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)
	
	ОстатокПоПлатежномуДокументу = Документы.РаспределениеПлатежей.ПолучитьОстатокПлатёжногоДокумента(ПлатежныйДокумент, Новый Граница(ПлатежныйДокумент.МоментВремени(), ВидГраницы.Исключая), Ссылка); //+++АК LAGP 2018.07.06 ИП-00019118.02 Проверяются остатки не включая движения документа
	СуммаТабличнойЧасти = 0;
	Для каждого СтрокаТаблицыСделок Из ТаблицаРаспределяемыхДокументов Цикл
		ОстатокПоСделке = Документы.РаспределениеПлатежей.ПолучитьОстатокПлатёжногоДокумента(СтрокаТаблицыСделок.Сделка, Новый Граница(ПлатежныйДокумент.МоментВремени(), ВидГраницы.Исключая), Ссылка); //+++АК LAGP 2018.07.06 ИП-00019118.02 Проверяются остатки не включая движения документа
		ОстатокПоСделке = ?(ОстатокПоСделке < 0, -ОстатокПоСделке, ОстатокПоСделке); //В табличной части только положительные значения распределяемых сумм.
		СуммаТабличнойЧасти = СуммаТабличнойЧасти + ?(СтрокаТаблицыСделок.ВидДокумента = "Возврат товаров от покупателя", -СтрокаТаблицыСделок.СуммаРаспределяемая, СтрокаТаблицыСделок.СуммаРаспределяемая);
		Если СтрокаТаблицыСделок.СуммаРаспределяемая > ОстатокПоСделке Тогда
			Сообщить("Остаток по сделке " + СтрокаТаблицыСделок.Сделка + " (" + ОстатокПоСделке + ") меньше разносимой суммы " + СтрокаТаблицыСделок.СуммаРаспределяемая + "!");
			//Отказ = Истина;		
		КонецЕсли;	
	КонецЦикла;	
	
	Если СуммаТабличнойЧасти > ОстатокПоПлатежномуДокументу Тогда
		Сообщить("Суммы остатка платёжного документа (" + ОстатокПоПлатежномуДокументу + ") недостаточно для распределения по сделкам (" + СуммаТабличнойЧасти + ").");
		//Отказ = Истина; 		
	КонецЕсли;
	
	//Проводки создаются в общем модуле "БухгалтерскийУчетРасчетовСКонтрагентами"
	
КонецПроцедуры
