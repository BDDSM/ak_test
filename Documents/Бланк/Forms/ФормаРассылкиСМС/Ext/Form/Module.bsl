
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ТекстЗапроса="ВЫБРАТЬ
	             |	ОбращенияПокупателей.ФИО_Покупателя КАК ФИО,
	             |	ОбращенияПокупателей.Телефон,
	             |	ОбращенияПокупателей.GUID_Загрузки КАК Бланк,
	             |	ИСТИНА КАК Пометка,
	             |	ОбращенияПокупателей.Номенклатура КАК Товар
	             |ИЗ
	             |	РегистрСведений.ОбращенияПокупателей КАК ОбращенияПокупателей
	             |ГДЕ
	             |	ОбращенияПокупателей.GUID_Загрузки В(&Бланки)
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ОбращенияПокупателей.ФИО_Покупателя,
	             |	ОбращенияПокупателей.Телефон,
	             |	ОбращенияПокупателей.GUID_Загрузки,
	             |	ОбращенияПокупателей.Номенклатура
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Бланк,
	             |	ФИО";
	Запрос=Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Бланки",Параметры.СписокБланков);
	ТО=Запрос.Выполнить().Выгрузить();
	ЗначениеВРеквизитФормы(ТО,"ТаблицаОтправки");
	ЗаполнитьСписокСообщенийСервер();
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьСМС(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "ru = ""Отправить сообщения?""";
	Ответ = Вопрос(НСтр(Текст), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
	    Возврат;
	КонецЕсли;
    
	Предупреждение(КнОтправитьНаСервере());	
КонецПроцедуры

&НаСервере
Функция КнОтправитьНаСервере()
	
	ТО=РеквизитФормыВЗначение("ТаблицаОтправки");
	//АК БЕЛН 10.05.2016++
	ТО.Свернуть("ФИО,Товар,Телефон,Бланк,Пометка");
	ТаблицаОбработаныхПозиций.Очистить();	
	//АК БЕЛН 10.05.2016--
	СтрокиДляОтправки=ТО.НайтиСтроки(Новый Структура("Пометка",Истина));
	
	СтрокаВозврата = "";	
	
	ТекстЗапроса = "insert into [SMSGate].[dbo].[Incoming]
		|      ([Date]
		|      ,[nomer]
		|      ,[text]
		|      ,[Time]
		|      ,[source])
		|select convert(datetime,CONVERT(date,getdate())) , 
		|/**BPar1**/'~~~~~'/**FPar**/ ,
		|/**BPar2**/'^^^^^'/**FPar**/ ,
		|CONVERT(time(7),getdate())  , 10 ;";
		
	СтрокаПодключения = ВнешниеДанные.ПолучитьСтрокуПодключенияMSSQL("srv-sql01", "SMSGate");
		
	Для Каждого СтрокаДляОтправки Из СтрокиДляОтправки Цикл
		Если СтрДлина(Формат(СтрокаДляОтправки.Телефон,"ЧГ=0")) <> 10 Тогда
			// Сообщить о пропуске строки
			Продолжить;
		КонецЕсли;	
		Если ТаблицаОбработаныхПозиций.НайтиСтроки(Новый Структура("ФИО,Товар,Телефон",СтрокаДляОтправки.ФИО,СтрокаДляОтправки.Товар,СтрокаДляОтправки.Телефон)).Количество()=0 Тогда
			СообщениеSMS=ШаблонОтправки.ТекстСообщения;
			СообщениеSMS=СтрЗаменить(СообщениеSMS,"[Товар]",СтрокаДляОтправки.Товар);
			СообщениеSMS=СтрЗаменить(СообщениеSMS,"[ФИО]",СокрЛП(СтрокаДляОтправки.ФИО));
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "~~~~~",Формат(СтрокаДляОтправки.Телефон,"ЧГ=0"));
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "^^^^^",СообщениеSMS);
			
			
			База_ВыполнитьЗапросНеЗаполняяТЗ(ТекстЗапроса, , СтрокаПодключения);
			СтрокаВозврата = "Сообщения отправлены.";
			НовСтр=ТаблицаОбработаныхПозиций.Добавить();
			ЗаполнитьЗначенияСвойств(НовСтр,СтрокаДляОтправки);
		КонецЕсли; 
		ДОК=СтрокаДляОтправки.Бланк.ПолучитьОбъект();
		НС=Док.ОтправленныеСМС.Добавить();
		НС.Сообщение=СообщениеSMS;
		Док.Записать(РежимЗаписиДокумента.Запись);
	КонецЦикла;	
	
	Возврат СтрокаВозврата;
	
КонецФункции

&НаСервере
Процедура База_ВыполнитьЗапросНеЗаполняяТЗ(ТекстЗапроса, допПараметры = Неопределено, СтрокаПодключения = "")  
	
	RecordSet = База_ВыполнитьЗапрос(ТекстЗапроса, допПараметры, СтрокаПодключения);
	Попытка
		RecordSet.Close();
	Исключение
	КонецПопытки;	
		
КонецПроцедуры

&НаСервере
Функция База_ВыполнитьЗапрос(ТекстЗапроса, допПараметры = Неопределено, СтрокаПодключения = "")  
	Попытка
		Command = Новый COMОбъект("ADODB.Command");
		
		Если ТипЗнч(допПараметры) = Тип("Структура") тогда
			ЗаполнитьЗначенияСвойств(Command, допПараметры);
		КонецЕсли;			
		CurrentConnection = База_Подключение(СтрокаПодключения);
		Command.ActiveConnection = CurrentConnection;
		Command.CommandTimeout = 0;
		Command.CommandText = ТекстЗапроса;
		RecordSet = Новый COMОбъект("ADODB.RecordSet");
		RecordSet = Command.Execute(); //Выполнение и получение набора данных
		Возврат RecordSet;
	Исключение	
		ВызватьИсключение ОписаниеОшибки();
	КонецПопытки;	
КонецФункции

&НаСервере
Функция База_Подключение(СтрокаПодключения) экспорт	
	
	Попытка
		CurrentConnection = Новый COMОбъект("ADODB.Connection");
		Catalog = Новый COMОбъект("ADOX.Catalog");			
		
		Catalog.ActiveConnection = СтрокаПодключения;
		CurrentConnection.Open(СтрокаПодключения);
		Возврат CurrentConnection;	
		
	Исключение
		ОписаниеОшибки = ОписаниеОшибки();		
		#Если НаКлиенте тогда
		Сообщить(ОписаниеОшибки);			
		#КонецЕсли		
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

&НаКлиенте
Процедура ШаблонОтправкиПриИзменении(Элемент)
	ЗаполнитьСписокСообщенийСервер();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСписокСообщенийСервер()
	ПереченьСообщений.Очистить();
	НомерСтроки=1;
	Для каждого СтрокаДляОтправки Из ТаблицаОтправки Цикл
		НС=ПереченьСообщений.Добавить();
		СообщениеSMS=ШаблонОтправки.ТекстСообщения;
		СообщениеSMS=СтрЗаменить(СообщениеSMS,"[Товар]",СтрокаДляОтправки.Товар);
		СообщениеSMS=СтрЗаменить(СообщениеSMS,"[ФИО]",СтрокаДляОтправки.ФИО);
		НС.НомерСтроки=НомерСтроки;
		НС.НомерТелефона=СтрокаДляОтправки.Телефон;
		НС.ТекстСообщения=СообщениеSMS;
		НомерСтроки=НомерСтроки+1;
	КонецЦикла;	
КонецПроцедуры	

&НаКлиенте
Процедура ТаблицаОтправкиПриИзменении(Элемент)
	ЗаполнитьСписокСообщенийСервер();
КонецПроцедуры



