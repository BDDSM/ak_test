
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)

	 // переход со старой структуры хранения данных
	Если ЭтотОбъект.ВидТранспортныхРасходов.Пустая() Тогда		
		Если ЭтотОбъект.СписыватьРасходыНа44Счет Тогда
			ЭтотОбъект.ВидТранспортныхРасходов = Перечисления.ВидыОбщихТранспортныхРасходов.Прочие;
		Иначе
			ЭтотОбъект.ВидТранспортныхРасходов = Перечисления.ВидыОбщихТранспортныхРасходов.ДоставкаНаСклад;
		КонецЕсли;
	КонецЕсли;
	
	// лишние данные - очистить
	Если (НЕ ЭтотОбъект.ВидТранспортныхРасходов = Перечисления.ВидыОбщихТранспортныхРасходов.ДоставкаНаСклад)
			И ЭтотОбъект.Поставщики.Количество() > 0 Тогда
		ЭтотОбъект.Поставщики.Очистить();
	ИначеЕсли (НЕ ЭтотОбъект.ВидТранспортныхРасходов = Перечисления.ВидыОбщихТранспортныхРасходов.ДополнительныеУслуги)
			И ЭтотОбъект.ТорговыеТочки.Количество() > 0 Тогда
		ЭтотОбъект.ТорговыеТочки.Очистить();
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	//+++АК POZM 2018.05.31 ИП-00018739
	Если ЗначениеЗаполнено(ЭтотОбъект.Заявка)
			И ТипЗнч(ЭтотОбъект.Заявка) = Тип("ДокументСсылка.ЗаявкаНаУслугиМатериалы") Тогда
		ПолныеПрава.ЗарегистрироватьОтложенныйРасчетНаличияПоступленийПоЗаявке(ЭтотОбъект.Заявка);
	КонецЕсли;
	Если ЗначениеЗаполнено(Ссылка.Заявка) И ТипЗнч(Ссылка.Заявка)=Тип("ДокументСсылка.ЗаявкаНаУслугиМатериалы") И Ссылка.Заявка<>Заявка Тогда	
		ПолныеПрава.ЗарегистрироватьОтложенныйРасчетНаличияПоступленийПоЗаявке(Ссылка.Заявка);
	КонецЕсли;
	#Область АК_ОтключенныйКод 
	//Если ЗначениеЗаполнено(ЭтотОбъект.ДокументОснование)
	//		И ТипЗнч(ЭтотОбъект.ДокументОснование) = Тип("ДокументСсылка.ЗаявкаНаУслугиМатериалы") Тогда
	//		
	//	ЗаявкаОбъект = ЭтотОбъект.ДокументОснование.ПолучитьОбъект();
	//	ВсеДокументыВНаличииЗаявка = ЗаявкаОбъект.ВсеДокументыВНаличии;
	//	СуммаОстатка = ЗаявкаОбъект.ВсеДокументыВНаличии(ЭтотОбъект.Ссылка);
	//	
	//	Если (СуммаОстатка - ЭтотОбъект.Сумма - ?(ЭтотОбъект.ВариантРасчетаНДС = Перечисления.ВариантыРасчетаНДС.НДСсверху, ЭтотОбъект.СуммаНДС, 0)) < 0 Тогда
	//		//Отказ = истина;
	//		Сообщить("Сумма поступлений по заявке документа превышает сумму заявки!");
	//		//Возврат;
	//	ИначеЕсли СуммаОстатка=(ЭтотОбъект.Сумма + ?(ЭтотОбъект.ВариантРасчетаНДС = Перечисления.ВариантыРасчетаНДС.НДСсверху, ЭтотОбъект.СуммаНДС, 0)) Тогда
	//		ЗаявкаОбъект.ВсеДокументыВНаличии = Истина;	
	//	КонецЕсли;	
	//	

	//	Если ЗаявкаОбъект.ВсеДокументыВНаличии <> ВсеДокументыВНаличииЗаявка Тогда
	//		ЗаявкаОбъект.Записать(РежимЗаписиДокумента.Запись);
	//	КонецЕсли;
	//	
	//КонецЕсли;
	//Если ЗначениеЗаполнено(Ссылка.ДокументОснование) И ТипЗнч(Ссылка.ДокументОснование)=Тип("ДокументСсылка.ЗаявкаНаУслугиМатериалы") И Ссылка.ДокументОснование<>ДокументОснование Тогда
	//	ЗаявкаОбъект = Ссылка.ДокументОснование.ПолучитьОбъект();
	//	ВсеДокументыВНаличииЗаявка = ЗаявкаОбъект.ВсеДокументыВНаличии;
	//	СуммаОстатка = ЗаявкаОбъект.ВсеДокументыВНаличии(ЭтотОбъект.Ссылка);
	//	#Если Клиент Тогда
	//	Если (СуммаОстатка-ЭтотОбъект.СуммаДокумента)<0 Тогда
	//		//Отказ = истина;
	//		//Сообщить("Сумма поступлений по заявке документа превышает сумму заявки!");
	//		//Возврат;
	//	КонецЕсли;	
	//	#КонецЕсли
	//	Если ЗаявкаОбъект.ВсеДокументыВНаличии<>ВсеДокументыВНаличииЗаявка Тогда
	//		ЗаявкаОбъект.Записать(РежимЗаписиДокумента.Запись);
	//	КонецЕсли;	
	//КонецЕсли;
#КонецОбласти 
//---АК POZM 
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Перем мДвиженияБух, ТаблицаКПроведению, СтруктураНастроек;
	
	мДвиженияБух = Движения.Финансовый;
	мДвиженияБух.Записывать = Истина;
	мДвиженияБух.Очистить();
	
	Движения.ЗатратыНаДоставкуПоПоставщикам.Записывать = Истина;
	Движения.ЗатратыНаДоставкуПоПоставщикам.Очистить();
	
	//+++АК SHEP 2018.04.18 ИП-00018423
	// после 01.04.2018 проводки в документе "Поступление товаров и услуг" (по транспортным услугам) кроме вида «Доставка на склад».
	Если Дата >= Дата(2018, 4, 1) И ЭтотОбъект.ВидТранспортныхРасходов <> ПредопределенноеЗначение("Перечисление.ВидыОбщихТранспортныхРасходов.ДоставкаНаСклад") Тогда
		Возврат;
	КонецЕсли;
	
	// перенёс формирование движений в модуль менеджера
	Документы.ОбщиеТранспортныеРасходы.ДвиженияВыполнить(ЭтотОбъект, мДвиженияБух, Отказ);
	//---АК SHEP 2018.04.18
	
	АК_УчетМСФО.ЗаполнитьОрганизацию(Движения.Финансовый, ЭтотОбъект.Организация);
	
	//// Если товар не облагается НДС
	//Если ЭтотОбъект.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
	//	
	//	СтруктураНастроек =
	//		ОбщегоНазначенияСервер.ПолучитьНастройкиОтраженияОперацийВУчете(Перечисления.ВидыОперацийВУчете.ОтражениеНДСПоТоварамБезНДС, ЭтотОбъект.Дата);
	//	
	//	Если ЗначениеЗаполнено(СтруктураНастроек.Счет) Тогда
	//		
	//		ПроводкаНДС = мДвиженияБух.Добавить();
	//		ПроводкаНДС.Период = ЭтотОбъект.Дата;
	//		
	//		ПроводкаНДС.СчетДт = ПланыСчетов.Финансовый.НалогиУН;  // Дт68.2
	//		ПроводкаНДС.СубконтоДт.Организации = ЭтотОбъект.Организация;
	//		ПроводкаНДС.СубконтоДт.ВидыНалогов = Справочники.ВидыНалогов.НайтиПоКоду("000000001");
	//		
	//		ПроводкаНДС.СчетКт = СтруктураНастроек.Счет;
	//		ПроводкаНДС.СубконтоКт.ТорговыеТочки  		= СтруктураНастроек.СтруктурнаяЕдиница;
	//		ПроводкаНДС.СубконтоКт.СтатьиДоходовРасходов= СтруктураНастроек.СтатьяДоходовРасходов;
	//		ПроводкаНДС.СубконтоКт.ЦФО 					= СтруктураНастроек.ЦФО;
	//		
	//		ПроводкаНДС.Организация = ЭтотОбъект.Организация;
	//		ПроводкаНДС.Сумма 		=
	//				(ЭтотОбъект.СуммыРасходов.Итог("Сумма") * ОбщегоНазначенияСервер.ПолучитьСтавкуНДСПриОтгрузкеБезНДС(ЭтотОбъект.Дата)) / 100;
	//		
	//		ПроводкаНДС.Содержание	= "НДС";
	//		
	//	КонецЕсли;
	//	
	//КонецЕсли;
	
	//+++АК POZM 2018.05.31 ИП-00018739 
	////+++АК pozm 20.04.2017
	//ВыполнитьДвиженияПоАвансамАкцептантов();
	////---АК pozm 20.04.2017
	//---АК POZM 

КонецПроцедуры
//+++АК POZM 2018.05.31 ИП-00018739 
#Область АК_ОтключенныйКод 

//Процедура ВыполнитьДвиженияПоАвансамАкцептантов()
//	Запись = РегистрыСведений.ОтложенныеДвиженияДокументов.СоздатьМенеджерЗаписи();
//	Запись.Документ = ЭтотОбъект.Ссылка;
//	Запись.ДатаДокумента = ЭтотОбъект.Дата;
//	Запись.Записать();
//КонецПроцедуры	
#КонецОбласти 
//---АК POZM 
Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ЗаявкаНаУслугиМатериалы") Тогда
		
		ЭтотОбъект.Организация 			= ДанныеЗаполнения.Организация;
		ЭтотОбъект.Перевозчик			= ДанныеЗаполнения.Контрагент;
		ЭтотОбъект.ДокументОснование 	= ДанныеЗаполнения.Ссылка;
		//+++ АК pozm ИП-00016503
		ЭтотОбъект.Заявка			 	= ДанныеЗаполнения.Ссылка;
		//--- АК pozm ИП-00016503
		
		//ЭтотОбъект.СтатьяДоходовРасходов = ДанныеЗаполнения.
		ЭтотОбъект.Сумма				= ДанныеЗаполнения.Услуги.Итог("Сумма");
				
		ЭтотОбъект.СуммаНДС				= ДанныеЗаполнения.Услуги.Итог("СуммаНДС");
		ЭтотОбъект.Автор				= ДанныеЗаполнения.Ответственный;
		
		Если ДанныеЗаполнения.Услуги.Количество()>0 Тогда
			ЭтотОбъект.СтавкаНДС 		= ДанныеЗаполнения.Услуги[0].СтавкаНДС;
		КонецЕсли;
		
		ЭтотОбъект.ВариантРасчетаНДС 	= ДанныеЗаполнения.ВариантРасчетаНДС;
		
	КонецЕсли;

КонецПроцедуры
