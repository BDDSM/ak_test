Перем мВалютаРегламентированногоУчета Экспорт;

Процедура ЗагрузитьДанныеНажатие(Элемент)
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогВыбораФайла.Заголовок = "Открыть файл с данными";
	ДиалогВыбораФайла.Фильтр    = "Файл Excel (*.xls)|*.xls";
	
	Если НЕ ДиалогВыбораФайла.Выбрать() Тогда
		Возврат;
	КонецЕсли;

	xl = Новый COMОбъект("Excel.Application");
	xl_документ = xl.Workbooks.Open(ДиалогВыбораФайла.ПолноеИмяФайла);
	xl_лист  = xl_документ.Sheets(1);
	БИК = "044583994";
	Банк = Справочники.Банки.НайтиПоКоду("044583994").Ссылка;
	
	й=2;
	Пока ЗначениеЗаполнено(СокрЛП(xl_лист.cells(й,1).value)) Цикл	
		ФИО = СокрЛП(xl_лист.cells(й,3).value);
		ФЛ = Справочники.ФизическиеЛица.НайтиПоНаименованию(ФИО).Ссылка;
		Если ФЛ.Пустая() Тогда
			//ПозицияПробела = Найти(ФИО," ");
			//Фамилия = Лев(ФИО,ПозицияПробела-1);
			//ИО = Сред(ФИО,ПозицияПробела+1);
			//ПозицияПробела = Найти(ИО," ");
			//Имя = Лев(ИО,ПозицияПробела-1);
			//ФИ = Фамилия+ " "+Имя;
			//ФЛ = Справочники.ФизическиеЛица.НайтиПоНаименованию(ФИ,Ложь).Ссылка;
			//Если ФЛ.Пустая() Тогда
				й = й + 1;
				Сообщить("Не найден "+ФИО);
				Продолжить;
			//КонецЕсли;			
		КонецЕсли;			
		НомерСчета 	= СокрЛП(xl_лист.cells(й,4).value);
		СКС			= СокрЛП(xl_лист.cells(й,1).value);
		БанковскийСчет = Справочники.БанковскиеСчета.НайтиПоРеквизиту("НомерСчета",НомерСчета,,ФЛ);
		Если БанковскийСчет = справочники.БанковскиеСчета.ПустаяСсылка() Тогда
			БанковскийСчет = справочники.БанковскиеСчета.СоздатьЭлемент();
			БанковскийСчет.ОбменДанными.Загрузка = Истина;
			БанковскийСчет.Наименование = Банк.Наименование+ "(Расчетный)";
			БанковскийСчет.Владелец 	= ФЛ;
			БанковскийСчет.ВидСчета 	= "Расчетный";
			БанковскийСчет.НомерСчета 	= НомерСчета;
			БанковскийСчет.ВалютаДенежныхСредств = мВалютаРегламентированногоУчета;
			БанковскийСчет.Банк = Банк;
			БанковскийСчет.СКС = СКС;
			БанковскийСчет.ТекстНазначения = "Пополнение СКС "+ СКС;
			БанковскийСчет.Записать();
			
			ФизЛицо = ФЛ.ПолучитьОбъект();
			ФизЛицо.ОсновнойБанковскийСчет = БанковскийСчет.Ссылка;
			ФизЛицо.Записать();
			Сообщить("Создали счет "+НомерСчета+" для "+ФЛ);
		Иначе
			
			Если НЕ БанковскийСчет.СКС = СКС Тогда 
				БанковскийСчет = БанковскийСчет.ПолучитьОбъект();
				БанковскийСчет.Наименование = НомерСчета;
				БанковскийСчет.СКС = СКС;
				БанковскийСчет.ТекстНазначения = "Пополнение СКС "+ СКС;
				БанковскийСчет.Записать();
				Сообщить("Обновили значение СКС "+СКС+" для "+ФЛ);
			КонецЕсли;
			
			Если НЕ ФЛ.ОсновнойБанковскийСчет = БанковскийСчет.Ссылка Тогда
				ФизЛицо = ФЛ.ПолучитьОбъект();
				ФизЛицо.ОсновнойБанковскийСчет = БанковскийСчет.Ссылка;
				ФизЛицо.Записать();
				Сообщить("Назначили счет "+НомерСчета+" для "+ФЛ);
			КонецЕсли;
		КонецЕсли;
			
		й = й + 1;
	КонецЦикла;
	xl.quit();
	Сообщить("Всё");
КонецПроцедуры

Процедура КнопкаЗагрузитьИзЗУПНажатие(Элемент)
	ТекстЗапроса="ВЫБРАТЬ
             |	ЛицевыеСчетаРаботниковОрганизации.Организация.ИНН КАК ИНН_Организации,
             |	ЛицевыеСчетаРаботниковОрганизации.Банк.ИНН КАК ИНН_Банка,
             |	ЛицевыеСчетаРаботниковОрганизации.Банк.Наименование КАК Наименование_Банка,
             |	ЛицевыеСчетаРаботниковОрганизации.ФизЛицо.Наименование КАК Наименование_физлица,
             |	ЛицевыеСчетаРаботниковОрганизации.НомерЛицевогоСчета
             |ИЗ
             |	РегистрСведений.ЛицевыеСчетаРаботниковОрганизации КАК ЛицевыеСчетаРаботниковОрганизации
             |ГДЕ
             |	ЛицевыеСчетаРаботниковОрганизации.ФизЛицо.Наименование <> """"
             |	И ЛицевыеСчетаРаботниковОрганизации.Банк.Наименование <> """"";

	СтрокаПодключения = ПолныеПрава.ПолучитьСтрокуПодключения_Зуп();
	v82COMОбъект = Новый COMОбъект(ПолныеПрава.ПолучитьВерсиюКомОбъекта_Зуп() + ".COMConnector");
	Попытка
		v82 = v82COMОбъект.Connect(СтрокаПодключения);
		ПодключениеУстановлено=Истина;
	Исключение
		ПодключениеУстановлено=Ложь;
		Сообщить("Не удалось подключиться к базе Зарплаты");
		Возврат;
	КонецПопытки;
	
	запрос=v82.NewObject("Запрос");  
	запрос.текст = ТекстЗапроса;
	Выборка=Запрос.Выполнить().Выгрузить();
	Для каждого стр из выборка цикл
		ФЛ = Справочники.ФизическиеЛица.НайтиПоНаименованию(Стр.Наименование_физлица);
		Если ФЛ.Пустая() Тогда
			Сообщить("Не найден "+Стр.Наименование_физлица);
			Продолжить;
		КонецЕсли;			
		Банк=Справочники.Банки.НайтиПоНаименованию(Стр.Наименование_Банка);
		Если Банк.Пустая() Тогда
			Сообщить("Не найден "+Стр.Наименование_Банка);
			Продолжить;
		КонецЕсли;			
		НомерСчета=Стр.НомерЛицевогоСчета;
		БанковскийСчет = Справочники.БанковскиеСчета.НайтиПоРеквизиту("НомерСчета",НомерСчета,,ФЛ);
		
		Если БанковскийСчет = справочники.БанковскиеСчета.ПустаяСсылка() Тогда
			БанковскийСчет = справочники.БанковскиеСчета.СоздатьЭлемент();
			БанковскийСчет.Наименование = Банк.Наименование+ "(Расчетный)";
			БанковскийСчет.Владелец 	= ФЛ;
			БанковскийСчет.ВидСчета 	= "Расчетный";
			БанковскийСчет.НомерСчета 	= НомерСчета;
			БанковскийСчет.ВалютаДенежныхСредств = мВалютаРегламентированногоУчета;
			БанковскийСчет.Банк = Банк;
			//БанковскийСчет.СКС = СКС;
			//БанковскийСчет.ТекстНазначения = "Пополнение СКС "+ СКС;
			БанковскийСчет.Записать();
			
			ФизЛицо = ФЛ.ПолучитьОбъект();
			ФизЛицо.ОсновнойБанковскийСчет = БанковскийСчет.Ссылка;
			ФизЛицо.Записать();
			Сообщить("Создали счет "+НомерСчета+" для "+ФЛ);
		Иначе
			
			//Если НЕ БанковскийСчет.СКС = СКС Тогда 
			//	БанковскийСчет = БанковскийСчет.ПолучитьОбъект();
			//	БанковскийСчет.Наименование = НомерСчета;
			//	БанковскийСчет.СКС = СКС;
			//	БанковскийСчет.ТекстНазначения = "Пополнение СКС "+ СКС;
			//	БанковскийСчет.Записать();
			//	Сообщить("Обновили значение СКС "+СКС+" для "+ФЛ);
			//КонецЕсли;
			
			Если НЕ ФЛ.ОсновнойБанковскийСчет = БанковскийСчет Тогда
				ФизЛицо = ФЛ.ПолучитьОбъект();
				ФизЛицо.ОсновнойБанковскийСчет = БанковскийСчет.Ссылка;
				ФизЛицо.Записать();
				Сообщить("Назначили счет "+НомерСчета+" для "+ФЛ);
			КонецЕсли;
		КонецЕсли;

	КонецЦикла;	

КонецПроцедуры

мВалютаРегламентированногоУчета = глЗначениеПеременной("ВалютаРегламентированногоУчета");
