

Процедура getRussianEnterpriseListRequest()
	ФабрикаXD = ОбменССистемойВетис.ПолучитьФабрикуXDTOEnterpiseService();
	
	ListOptions = ФабрикаXD.Создать("http://api.vetrf.ru/schema/cdm/base", "ListOptions");  
	ListOptions.count = 100;  
	
	BusinessEntity = ФабрикаXD.Создать("http://api.vetrf.ru/schema/cdm/cerberus/enterprise", "BusinessEntity"); 
	BusinessEntity.inn = ЭтаФорма.Контрагент.ИНН;
	
	ПроксиEnterprise = ОбменССистемойВетис.ПолучитьПроксиEnterprise(ОбменССистемойВетис.ОсновнаяНастройкаАПИ());	
	
	ЭтотОбъект.ТаблицаКонтрагентов.Очистить();
	Попытка 
		Ответ = ПроксиEnterprise.GetBusinessEntityList(ListOptions, BusinessEntity);
		Если ТипЗнч(Ответ) = Тип("ОбъектXDTO") Тогда
			businessEntity =  ОбменССистемойВетис.ПолучитьСвойствоОбъектаXDTO(Ответ, "businessEntity");
			
			Если ТипЗнч(businessEntity) = Тип("СписокXDTO") Тогда
				Для каждого Стр Из businessEntity Цикл
					НСтр = ЭтотОбъект.ТаблицаКонтрагентов.Добавить();
					ЗаполнитьЗначенияСвойств(Нстр, Стр);
				КонецЦикла;					
			КонецЕсли;	
		КонецЕсли;	
	Исключение		
		
	КонецПопытки;
	
	
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОсновныеДействияФормыВыполнить(Кнопка)
	Запись = РегистрыСведений.МЙ_СоответствиеКонтрагентов.СоздатьМенеджерЗаписи();
	Запись.Контрагент = ЭтаФорма.Контрагент;
	
	Запись.Прочитать();
КонецПроцедуры

Процедура ПоискНажатие(Элемент)
	getRussianEnterpriseListRequest();

КонецПроцедуры

Процедура ТаблицаКонтрагентовПриАктивизацииСтроки(Элемент)
	ТС = Элемент.ТекущиеДанные;
	Если ТС = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	GUID = ТС.GUID;
	
	ПроксиEnterprise = ОбменССистемойВетис.ПолучитьПроксиEnterprise(ОбменССистемойВетис.ОсновнаяНастройкаАПИ());
	
	Попытка
		Ответ = ПроксиEnterprise.GetBusinessEntityByGuid(GUID);
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	
	ТЗГуидПлощадок = Новый ТаблицаЗначений; 	
	ТЗГуидПлощадок.Колонки.Добавить("ГУИД", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(36)));
	
	Если ТипЗнч(Ответ) = Тип("ОбъектXDTO") Тогда
		СписокПлощадок = ОбменССистемойВетис.ПолучитьСвойствоОбъектаXDTO(Ответ, "activityLocation"); 	
		
		Если ТипЗнч(СписокПлощадок) = Тип("СписокXDTO") Тогда
			
			Для каждого ЗначСписка Из СписокПлощадок Цикл
				Нстр = ТЗГуидПлощадок.Добавить();
				Нстр.ГУИД = ЗначСписка.enterprise.guid;
			КонецЦикла;
			
		КонецЕсли;		
	КонецЕсли;
	
	ЭтотОбъект.ТаблицаПлощадок.Очистить();
	
	а = 0;
	Для каждого Стр Из ТЗГуидПлощадок Цикл
		 GUIDПлощадки = Стр.ГУИД;
		 Попытка
			 Ответ = ПроксиEnterprise.GetEnterpriseByGuid(GUIDПлощадки);
		 Исключение
			 Сообщить(ОписаниеОшибки());
			 Возврат;
		 КонецПопытки;
		 
		 Если ТипЗнч(Ответ) = Тип("ОбъектXDTO") Тогда			 
			 НСтр = ЭтотОбъект.ТаблицаПлощадок.Добавить();
			 ЗаполнитьЗначенияСвойств(НСтр, Ответ);			 
			 НСтр.addressView = Ответ.address.addressView;
		 КонецЕсли; 
		 
		 а = а + 1;
		 Состояние("Обработан " + Строка(а));
	КонецЦикла;	
	

			 
		 
	
КонецПроцедуры
