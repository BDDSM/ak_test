
//+++АК SHEP 2018.07.20 ИП-00019267: добавлена обработка

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ЗаполнитьТаблицуПлановСтруктур();
КонецПроцедуры

&НаКлиенте
// Возвращает для управляемых форм полный путь к форме отчёта, внешней обработки или любого объекта метаданных в виде:
// "Отчет.<ИмяОтчёта>.Форма.ИмяФормы"
// "ВнешняяОбработка.<ИмяВнешнейОбработки>.Форма.ИмяФормы"
// "Документ.<ИмяОбъекта>.Форма.ИмяФормы"
//
// Может быть полезна при встраивании внешней обработки/отчёта в конфигурацию или переименовании объекта, т.к. не требуется изменять вызовы форм. 
//
Функция ПолучитьПолноеИмяФормы(ИмяВызвавшейФормы, ИмяФормы = "")
	
    ПозицияТочки = СтрДлина(ИмяВызвавшейФормы);
    Пока Сред(ИмяВызвавшейФормы, ПозицияТочки, 1) <> "." Цикл ПозицияТочки = ПозицияТочки - 1; КонецЦикла;
    Возврат Лев(ИмяВызвавшейФормы, ПозицияТочки - 1) + ?(ПустаяСтрока(ИмяФормы), "", "." + ИмяФормы);
	
КонецФункции

&НаСервере
Процедура ЗаполнитьТаблицуПлановСтруктур()
	
	ТаблицаПлановСтруктур.Очистить();
	
	ТекстЗапросаSQL = "
		|SELECT distinct
		|	'План Идеальной структуры с ' + CONVERT(char(10), [date_start], 104) Наименование,
		|	CAST([date_start] AS datetime) [ДатаСтарта]
        |FROM
		|	[Reports].[dbo].[PlanStructury_GroupTov] as s with(nolock)
		|
        |ORDER BY
		|	[ДатаСтарта] desc
		|";
	
	ADOСоединение = ВнешниеДанные.ПолучитьADOСоединение();
	rs = ADOСоединение.Execute(ТекстЗапросаSQL);
	
	Попытка
		rs.MoveFirst();
		
		Пока НЕ rs.EOF() Цикл
			НоваяСтрокаТЗ = ТаблицаПлановСтруктур.Добавить();
			НоваяСтрокаТЗ.Наименование = Rs.Fields("Наименование").Value;
			НоваяСтрокаТЗ.ДатаСтарта = Rs.Fields("ДатаСтарта").Value;
			rs.MoveNext();
		КонецЦикла;
	Исключение
	КонецПопытки;
	ADOСоединение.Close();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьТаблицуПлановСтруктур(Команда)
	ЗаполнитьТаблицуПлановСтруктур();
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаПлановСтруктурВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.ТаблицаПлановСтруктур.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда Возврат; КонецЕсли;
	
	ОткрытьФорму(ПолучитьПолноеИмяФормы(ЭтаФорма.ИмяФормы, "ФормаСтруктура"), Новый Структура("ДатаСтарта", ТекущиеДанные.ДатаСтарта), ЭтаФорма,,,,,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьНовуюСтруктуру(Команда)
	
	ОткрытьФорму(ПолучитьПолноеИмяФормы(ЭтаФорма.ИмяФормы, "ФормаДобавления"),, ЭтаФорма,,,,,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ОбновитьИдеальныеСтруктуры" Тогда
		ЗаполнитьТаблицуПлановСтруктур();
	КонецЕсли;
	
КонецПроцедуры
