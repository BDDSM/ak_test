
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ТорговаяТочка = Параметры.ТорговаяТочка;
	
	Для Каждого ЭлементСписка Из Параметры.СписокСуммы Цикл
		СтрокаДоб = СуммыПоТТ.Добавить();
		СтрокаДоб.ЛистУчета = ЭлементСписка.ЛистУчета;
		СтрокаДоб.СуммаИнкассации = ЭлементСписка.СуммаИнкассации;
		СтрокаДоб.СуммаПоЛисту = ЭлементСписка.ЛистУчета.СуммаИнкассации;
		СтрокаДоб.ЗаписатьСуммуВЛистУчета = СтрокаДоб.СуммаПоЛисту;
	КонецЦикла;	
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСтроку()
	
	ТекДанные = СуммыПоТТ.НайтиПоИдентификатору(Элементы.СуммыПоТТ.ТекущаяСтрока);
	ТекДанные.СуммаПоЛисту = ТекДанные.ЛистУчета.СуммаИнкассации;
	ТекДанные.ЗаписатьСуммуВЛистУчета = ТекДанные.СуммаПоЛисту;
	
КонецПроцедуры	

&НаКлиенте
Процедура СуммыПоТТЛистУчетаПриИзменении(Элемент)
	
	ЗаполнитьСтроку();
	
КонецПроцедуры

Процедура ЗаписатьИзменения()
	
	Для Каждого СтрокаТаб Из СуммыПоТТ Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТаб.ЛистУчета) Тогда
			Продолжить;
		КонецЕсли;	
		Если СтрокаТаб.СуммаПоЛисту <> СтрокаТаб.ЗаписатьСуммуВЛистУчета Тогда
			ДокОбъект = СтрокаТаб.ЛистУчета.ПолучитьОбъект();
			ДокОбъект.СуммаИнкассации = СтрокаТаб.ЗаписатьСуммуВЛистУчета;
			ДокОбъект.Отклонение = -(ДокОбъект.НачальныйОстаток 
							+ ДокОбъект.СуммаДокумента 
							+ ДокОбъект.КорректировкаZ 
							- ДокОбъект.ОплатаБаллами 
							- ДокОбъект.СуммаЭквайринг 
							- ДокОбъект.КорректировкаБезнал 
							- ДокОбъект.СуммаИнкассации
							- ДокОбъект.КонечныйОстаток);
			ДокОбъект.Записать(РежимЗаписиДокумента.Проведение);
		КонецЕсли;	
	КонецЦикла;	
	
КонецПроцедуры	

&НаКлиенте
Процедура ЗаписатьИзмененияВЛУИЗакрыть(Команда)
	
	ЗаписатьИзменения();
	СтрокиЛистов = Новый Массив();
	Для Каждого СтрокаТаб Из СуммыПоТТ Цикл
		СтрокиЛистов.Добавить(Новый Структура("ЛистУчета, Сумма, ТорговаяТочка", СтрокаТаб.ЛистУчета, СтрокаТаб.СуммаИнкассации, ТорговаяТочка));
	КонецЦикла;	
	Закрыть(Новый Структура("СтрокиЛистов, СуммаИнкассации", СтрокиЛистов, СуммыПоТТ.Итог("СуммаИнкассации")));
	
КонецПроцедуры
