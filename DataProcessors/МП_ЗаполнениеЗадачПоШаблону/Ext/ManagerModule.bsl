
Процедура СформироватьНаСервере(Объект) Экспорт

	УстановитьПривилегированныйРежим(Истина);
	
	Если Объект.Шаблон.Ракурсы.Количество() = 0 Тогда
		Сообщить("У шаблона не заполнена ТЧ Ракурсы!");
		Возврат;
	КонецЕсли;
	
	Для Каждого Элемент Из Объект.СписокМагазинов Цикл
		Если Элемент.Пометка Тогда
			СформироватьЗадачу(Объект, Элемент.Значение);
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры // СформироватьНаСервере()

&НаСервере
Процедура СформироватьЗадачу(Объект, Магазин)

	Задача = Документы.МП_ЗадачаМагазина.СоздатьДокумент();
	Задача.Магазин = Магазин;
	Задача.Дата = Объект.ДатаВыполнения;
	Задача.ДатаСоздания = ТекущаяДата();
	Задача.ДатаВыполнения = Объект.ДатаВыполнения;
	Задача.СтатусЗадачи = Перечисления.СтатусыЗадач.ВРаботе;
	Задача.Шаблон = Объект.Шаблон; 
	
	Задача.Записать();
	Для Каждого СтрокаТЧ Из Объект.Шаблон.Ракурсы Цикл
		
		//СпрОбъект = Справочники.МП_ФотографииКЗадачам.СоздатьЭлемент();
		//Спробъект.Задача = Задача.Ссылка;
		//СпрОбъект.Ракурс = СтрокаТЧ.Ракурс;
		//СпрОбъект.Записать();
		//
		НоваяСтрока = Задача.Ракурсы.Добавить();
		НоваяСтрока.Ракурс = СтрокаТЧ.Ракурс;		
	КонецЦикла;

	Задача.Записать();

	Сообщить("Создана задача " + Задача);
	
КонецПроцедуры // СформироватьЗадачу()

&НаСервере
Процедура ЗаполнитьСписокМагазинов(Объект) Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МобильноеПриложение.Магазин КАК Магазин
	|ИЗ
	|	ПланОбмена.МобильноеПриложение КАК МобильноеПриложение
	|ГДЕ
	|	МобильноеПриложение.Магазин <> ЗНАЧЕНИЕ(Справочник.СтруктурныеЕдиницы.ПустаяСсылка)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Магазин
	|АВТОУПОРЯДОЧИВАНИЕ";
	Выборка = Запрос.Выполнить().Выбрать();
	Объект.СписокМагазинов.Очистить();
	Пока Выборка.Следующий() Цикл
		
		Элемент = Объект.СписокМагазинов.Добавить();
		Элемент.Значение = Выборка.Магазин;
		Элемент.Пометка = Истина;
		
	КонецЦикла;

КонецПроцедуры // ЗаполнитьСписокМагазинов()