
Функция ПолучитьТаблицуЗаявокКОплате(ДатаОбработки) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НаДату", ДатаОбработки);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка,
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.УИН_СтрокиОплат,
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.СуммаОстаток,
	|	ВложенныйЗапрос.СуммаОстаток КАК ОстатокПоЗаявке
	|ПОМЕСТИТЬ Остатки
	|ИЗ
	|	РегистрНакопления.РасчетыПоЗаявкамНаУслугиМатериалы.Остатки КАК РасчетыПоЗаявкамНаУслугиМатериалыОстатки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка КАК Заявка,
	|			СУММА(РасчетыПоЗаявкамНаУслугиМатериалыОстатки.СуммаОстаток) КАК СуммаОстаток
	|		ИЗ
	|			РегистрНакопления.РасчетыПоЗаявкамНаУслугиМатериалы.Остатки КАК РасчетыПоЗаявкамНаУслугиМатериалыОстатки
	|		
	|		СГРУППИРОВАТЬ ПО
	|			РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка) КАК ВложенныйЗапрос
	|		ПО РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка = ВложенныйЗапрос.Заявка
	|ГДЕ
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.СуммаОстаток > 0
	|	И ВложенныйЗапрос.СуммаОстаток > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(РасходИзБанка.СуммаДокумента) КАК Оплачено,
	|	0 КАК Получено,
	|	Остатки.Заявка
	|ПОМЕСТИТЬ ОплаченоПолученоПоЗаявкам
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РасходИзБанка КАК РасходИзБанка
	|		ПО Остатки.Заявка = РасходИзБанка.ЗаявкаНаРасходованиеСредств
	|			И Остатки.УИН_СтрокиОплат = РасходИзБанка.УИН_СтрокиОснования
	//|			И (РасходИзБанка.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	0,
	|	СУММА(ЕСТЬNULL(ОбщиеТранспортныеРасходы.Сумма, 0) + ВЫБОР
	|			КОГДА ОбщиеТранспортныеРасходы.ВариантРасчетаНДС ЕСТЬ NULL
	|				ТОГДА 0
	|			КОГДА ОбщиеТранспортныеРасходы.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДССверху)
	|				ТОГДА ОбщиеТранспортныеРасходы.СуммаНДС
	|			ИНАЧЕ 0
	|		КОНЕЦ),
	|	Остатки.Заявка
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОбщиеТранспортныеРасходы КАК ОбщиеТранспортныеРасходы
	|		ПО Остатки.Заявка = ОбщиеТранспортныеРасходы.Заявка
	|			И (ОбщиеТранспортныеРасходы.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	0,
	|	СУММА(ЕСТЬNULL(ПоступлениеТоваровУслуг.СуммаДокумента, 0)),
	|	Остатки.Заявка
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ПО Остатки.Заявка = ПоступлениеТоваровУслуг.Заявка
	|			И (ПоступлениеТоваровУслуг.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	0,
	|	СУММА(ЕСТЬNULL(ПоступлениеДопРасходов.СуммаДокумента, 0)),
	|	Остатки.Заявка
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеДопРасходов КАК ПоступлениеДопРасходов
	|		ПО Остатки.Заявка = ПоступлениеДопРасходов.ЗаявкаНаРсходованиеСредств
	|			И (ПоступлениеДопРасходов.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	0,
	|	СУММА(ЕСТЬNULL(МаршрутныйЛист.Сумма, 0) + ВЫБОР
	|			КОГДА МаршрутныйЛист.ВариантРасчетаНДС ЕСТЬ NULL
	|				ТОГДА 0
	|			КОГДА МаршрутныйЛист.ВариантРасчетаНДС = ЗНАЧЕНИЕ(Перечисление.ВариантыРасчетаНДС.НДССверху)
	|				ТОГДА МаршрутныйЛист.СуммаНДС
	|			ИНАЧЕ 0
	|		КОНЕЦ),
	|	Остатки.Заявка
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.МаршрутныйЛист КАК МаршрутныйЛист
	|		ПО Остатки.Заявка = МаршрутныйЛист.Заявка
	|			И (МаршрутныйЛист.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	0,
	|	СУММА(ДоставкаНаТТ.СуммаДокумента),
	|	Остатки.Заявка
	|ИЗ
	|	Остатки КАК Остатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ДоставкаНаТТ КАК ДоставкаНаТТ
	|		ПО Остатки.Заявка = ДоставкаНаТТ.Заявка
	|			И (ДоставкаНаТТ.Проведен)
	|ГДЕ
	|	Остатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.Заявка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ОплаченоПолученоПоЗаявкам.Оплачено) КАК Оплачено,
	|	СУММА(ОплаченоПолученоПоЗаявкам.Получено) КАК Получено,
	|	ОплаченоПолученоПоЗаявкам.Заявка
	|ПОМЕСТИТЬ ОплаченоПолученоИтого
	|ИЗ
	|	ОплаченоПолученоПоЗаявкам КАК ОплаченоПолученоПоЗаявкам
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплаченоПолученоПоЗаявкам.Заявка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка,
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.УИН_СтрокиОплат,
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.СуммаОстаток,
	|	ВЫБОР
	|		КОГДА ЗаявкаНаУслугиМатериалыОплата.ДатаПлатежа > &НаДату
	|			ТОГДА ЗаявкаНаУслугиМатериалыОплата.ДатаПлатежа
	|		ИНАЧЕ &НаДату
	|	КОНЕЦ КАК ДатаПлатежа,
	|	ЗаявкаНаУслугиМатериалыОплата.Ссылка.Организация КАК Организация,
	|	ЗаявкаНаУслугиМатериалыОплата.Ссылка.Контрагент КАК Контрагент,
	|	ЗаявкаНаУслугиМатериалыОплата.Ссылка.ДоговорКонтрагента,
	|	ЗаявкаНаУслугиМатериалыОплата.ДатаПлатежа КАК ДатаПлатежаПоДокументу,
	|	ЗаявкаНаУслугиМатериалыОплата.НазначениеПлатежа,
	|	NULL КАК РасходИзБанка,
	|	ЗаявкаНаУслугиМатериалыОплата.Аванс,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы.НеКонтролироватьНаличиеДокументаПоступления, ЛОЖЬ)
	|			ТОГДА ЗаявкаНаУслугиМатериалыОплата.Ссылка.СуммаДокумента
	|		ИНАЧЕ ЕСТЬNULL(ОплаченоПолученоИтого.Получено, 0)
	|	КОНЕЦ КАК Получено,
	|	ЕСТЬNULL(ОплаченоПолученоИтого.Оплачено, 0) КАК Оплачено,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы.НеКонтролироватьНаличиеДокументаПоступления, ЛОЖЬ)
	|			ТОГДА ЗаявкаНаУслугиМатериалыОплата.Ссылка.СуммаДокумента - ЕСТЬNULL(ОплаченоПолученоИтого.Оплачено, 0)
	|		ИНАЧЕ ЕСТЬNULL(ОплаченоПолученоИтого.Получено, 0) - ЕСТЬNULL(ОплаченоПолученоИтого.Оплачено, 0)
	|	КОНЕЦ КАК ПолученоНеОплачено,
	|	ЗаявкаНаУслугиМатериалыОплата.Ссылка.СтатьяДДС,
	|	ЗаявкаНаУслугиМатериалыОплата.Ссылка.ЦФО,
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.ОстатокПоЗаявке,
	|	ЕСТЬNULL(АК_ОчередьРаспознаванияФайлов.РезультатСравнения, ЛОЖЬ) КАК РеквизитыЗаявкиСоответсвуютСкануСчета
	|ИЗ
	|	Остатки КАК РасчетыПоЗаявкамНаУслугиМатериалыОстатки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаявкаНаУслугиМатериалы.Оплата КАК ЗаявкаНаУслугиМатериалыОплата
	|		ПО РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка = ЗаявкаНаУслугиМатериалыОплата.Ссылка
	|			И РасчетыПоЗаявкамНаУслугиМатериалыОстатки.УИН_СтрокиОплат = ЗаявкаНаУслугиМатериалыОплата.УИН_Строки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОплаченоПолученоИтого КАК ОплаченоПолученоИтого
	|		ПО РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка = ОплаченоПолученоИтого.Заявка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы КАК ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы
	|		ПО (РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка.СтатьяДДС = ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы.СтатьяДДС
	|					И ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы.Документ = ЗНАЧЕНИЕ(Документ.ЗаявкаНаУслугиМатериалы.ПустаяСсылка)
	|				ИЛИ РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка = ИсключенияКонтроляПоЗаявкамНаУслугиМатериалы.Документ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АК_ОчередьРаспознаванияФайлов КАК АК_ОчередьРаспознаванияФайлов
	|		ПО РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка.СчетНаОплату = АК_ОчередьРаспознаванияФайлов.Файл
	|			И РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка = АК_ОчередьРаспознаванияФайлов.ОбъектСравнения
	|ГДЕ
	|	РасчетыПоЗаявкамНаУслугиМатериалыОстатки.Заявка ССЫЛКА Документ.ЗаявкаНаУслугиМатериалы
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Контрагент";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции	

Функция ПолучитьТаблицуПоСделкамСПоставщиком(ДатаОбработки) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НаДату", ДатаОбработки);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РасчетыПоСделкамСПоставщикамиОстатки.Сделка КАК Сделка,
	|	РасчетыПоСделкамСПоставщикамиОстатки.СуммаОстаток КАК СуммаОстаток,
	|	РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа КАК ДатаПлатежаПоДокументу,
	|	СделкаСПоставщикомГрафикОплат.Номенклатура КАК Номенклатура,
	|	ЕСТЬNULL(ПредпоступлениеПоКомплектацииТовары.Ссылка.Магазин, СделкаСПоставщикомГрафикОплат.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ВЫБОР
	|		КОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа > &НаДату
	|				ИЛИ СделкаСПоставщикомГрафикОплат.Ссылка.ПроизвольныеПлатежи
	|			ТОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа
	|		ИНАЧЕ &НаДату
	|	КОНЕЦ КАК ДатаПлатежа,
	|	СделкаСПоставщикомГрафикОплат.НомерСтрокиГрафика КАК ЭтапСделки,
	//+++АК POZM 2017.12.13 ИП-00017345 
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.РасчетыЧерезФК
	|			ТОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.ФакторинговаяКомпания
	|		ИНАЧЕ СделкаСПоставщикомГрафикОплат.Ссылка.Контрагент
	|	КОНЕЦ КАК Контрагент,
	//---АК POZM 
	|	СделкаСПоставщикомГрафикОплат.УИН_ПервойСтроки,
	|	СделкаСПоставщикомГрафикОплат.УИН_Строки,
	|	ЦФОСтруктурныхЕдиницСрезПоследних.Организация КАК Организация,
	|	ПредпоступлениеПоКомплектацииТовары.Ссылка.ДатаАкта КАК АктПодписан,
	|	КомплектацияМагазинаПоСделкамСПоставщикомКомплектация.ПлановыйСрокНачалаМонтажа,
	|	ЕСТЬNULL(РасчетыПоСделкамСПоставщикамиОстатки.Комплектация.Ссылка, ПредпоступлениеПоКомплектацииТовары.Ссылка) КАК Комплектация,
	|	РасчетыПоСделкамСПоставщикамиОстатки.УИН_СтрокиКомплектации КАК УИН_СтрокиКомплектации,
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.НомерСтрокиГрафика = 1
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Аванс,
	|	СделкаСПоставщикомГрафикОплат.ДатаГотовности КАК ДатаГотовностиПлан,
	|	NULL КАК ВариантОплаты,
	|	NULL КАК ПроцентОплаты,
	//+++АК POZM 2017.12.13 ИП-00017345 
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.РасчетыЧерезФК
	|			ТОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.ФакторинговаяКомпанияДоговор
	|		ИНАЧЕ СделкаСПоставщикомГрафикОплат.Ссылка.Договор
	|	КОНЕЦ КАК Договор
	//---АК POZM 
	|ИЗ
	|	РегистрНакопления.РасчетыПоСделкамСПоставщиками.Остатки(
	|			КОНЕЦПЕРИОДА(&НаДату, ДЕНЬ),
	|			Комплектация = НЕОПРЕДЕЛЕНО
	|				ИЛИ Комплектация ССЫЛКА Документ.ПредпоступлениеПоКомплектации
	|					И Комплектация.Дата < ДАТАВРЕМЯ(2017, 8, 14)) КАК РасчетыПоСделкамСПоставщикамиОстатки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СделкаСПоставщиком.ГрафикОплат КАК СделкаСПоставщикомГрафикОплат
	|		ПО РасчетыПоСделкамСПоставщикамиОстатки.Сделка = СделкаСПоставщикомГрафикОплат.Ссылка
	|			И РасчетыПоСделкамСПоставщикамиОстатки.УИН_Этапа = СделкаСПоставщикомГрафикОплат.УИН_Строки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КомплектацияМагазинаПоСделкамСПоставщиком.Комплектация КАК КомплектацияМагазинаПоСделкамСПоставщикомКомплектация
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦФОСтруктурныхЕдиниц.СрезПоследних(&НаДату, ) КАК ЦФОСтруктурныхЕдиницСрезПоследних
	|			ПО КомплектацияМагазинаПоСделкамСПоставщикомКомплектация.Ссылка.Магазин = ЦФОСтруктурныхЕдиницСрезПоследних.СтруктурнаяЕдиница
	|		ПО РасчетыПоСделкамСПоставщикамиОстатки.Комплектация = КомплектацияМагазинаПоСделкамСПоставщикомКомплектация.Ссылка
	|			И РасчетыПоСделкамСПоставщикамиОстатки.УИН_СтрокиКомплектации = КомплектацияМагазинаПоСделкамСПоставщикомКомплектация.УИН_Строки
	|			И РасчетыПоСделкамСПоставщикамиОстатки.Сделка = КомплектацияМагазинаПоСделкамСПоставщикомКомплектация.Сделка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПредпоступлениеПоКомплектации.Товары КАК ПредпоступлениеПоКомплектацииТовары
	|			ЛЕВОЕ СОЕДИНЕНИЕ Документ.КомплектацияМагазинаПоСделкамСПоставщиком.Комплектация КАК КомплектацияМагазинаПоСделкамСПоставщикомКомплектация1
	|			ПО (КомплектацияМагазинаПоСделкамСПоставщикомКомплектация1.УИН_Строки = ПредпоступлениеПоКомплектацииТовары.УИН_Строки)
	|				И (КомплектацияМагазинаПоСделкамСПоставщикомКомплектация1.Предпоступление = ПредпоступлениеПоКомплектацииТовары.Ссылка)
	|		ПО РасчетыПоСделкамСПоставщикамиОстатки.Комплектация = ПредпоступлениеПоКомплектацииТовары.Ссылка
	|			И РасчетыПоСделкамСПоставщикамиОстатки.УИН_СтрокиКомплектации = ПредпоступлениеПоКомплектацииТовары.УИН_Строки
	|			И РасчетыПоСделкамСПоставщикамиОстатки.Сделка = ПредпоступлениеПоКомплектацииТовары.Сделка
	|ГДЕ
	|	(РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа <> ДАТАВРЕМЯ(1, 1, 1)
	|			ИЛИ РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа = ДАТАВРЕМЯ(1, 1, 1)
	|				И СделкаСПоставщикомГрафикОплат.Ссылка.ПроизвольныеПлатежи)
	|	И РасчетыПоСделкамСПоставщикамиОстатки.СуммаОстаток > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РасчетыПоСделкамСПоставщикамиОстатки.Сделка,
	|	РасчетыПоСделкамСПоставщикамиОстатки.СуммаОстаток,
	|	РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа,
	|	NULL,
	|	NULL,
	|	ВЫБОР
	|		КОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа > &НаДату
	|			ТОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа
	|		ИНАЧЕ &НаДату
	|	КОНЕЦ,
	|	МАКСИМУМ(СделкаСПоставщикомГрафикОплат.НомерСтрокиГрафика),
	|	ВЫБОР
	|		КОГДА РасчетыПоСделкамСПоставщикамиОстатки.Сделка.Договор.РасчетыЧерезФК
	|			ТОГДА РасчетыПоСделкамСПоставщикамиОстатки.Сделка.Договор.ФакторинговаяКомпания
	|		ИНАЧЕ РасчетыПоСделкамСПоставщикамиОстатки.Сделка.Контрагент
	|	КОНЕЦ,
	|	NULL,
	|	NULL,
	|	РасчетыПоСделкамСПоставщикамиОстатки.Комплектация.Организация,
	|	NULL,
	|	NULL,
	|	РасчетыПоСделкамСПоставщикамиОстатки.Комплектация,
	|	NULL,
	|	ЛОЖЬ,
	|	NULL,
	|	СделкаСПоставщикомЭтапыСделки.ВариантОплаты,
	|	СделкаСПоставщикомЭтапыСделки.ПроцентОплаты,
	//+++АК POZM 2017.12.13 ИП-00017345 
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.РасчетыЧерезФК
	|			ТОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.ФакторинговаяКомпанияДоговор
	|		ИНАЧЕ СделкаСПоставщикомГрафикОплат.Ссылка.Договор
	|	КОНЕЦ
	//---АК POZM 
	|ИЗ
	|	РегистрНакопления.РасчетыПоСделкамСПоставщиками.Остатки(
	|			КОНЕЦПЕРИОДА(&НаДату, ДЕНЬ),
	|			Комплектация ССЫЛКА Документ.ПоступлениеТоваровУслуг
	|				ИЛИ Комплектация ССЫЛКА Документ.ПоступлениеДопРасходов) КАК РасчетыПоСделкамСПоставщикамиОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыПоСделкамСПоставщиками КАК РасчетыПоСделкамСПоставщиками
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СделкаСПоставщиком.ГрафикОплат КАК СделкаСПоставщикомГрафикОплат
	|				ЛЕВОЕ СОЕДИНЕНИЕ Документ.СделкаСПоставщиком.ЭтапыСделки КАК СделкаСПоставщикомЭтапыСделки
	|				ПО СделкаСПоставщикомГрафикОплат.Ссылка = СделкаСПоставщикомЭтапыСделки.Ссылка
	|					И СделкаСПоставщикомГрафикОплат.НомерСтрокиГрафика = СделкаСПоставщикомЭтапыСделки.НомерСтроки
	|			ПО РасчетыПоСделкамСПоставщиками.УИН_Этапа = СделкаСПоставщикомГрафикОплат.УИН_Строки
	|		ПО РасчетыПоСделкамСПоставщикамиОстатки.Сделка = РасчетыПоСделкамСПоставщиками.Сделка
	|			И РасчетыПоСделкамСПоставщикамиОстатки.Комплектация = РасчетыПоСделкамСПоставщиками.Регистратор
	|			И (РасчетыПоСделкамСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|			И РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа = РасчетыПоСделкамСПоставщиками.ДатаПлатежа
	|ГДЕ
	|	РасчетыПоСделкамСПоставщикамиОстатки.СуммаОстаток > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	РасчетыПоСделкамСПоставщикамиОстатки.Сделка,
	|	РасчетыПоСделкамСПоставщикамиОстатки.СуммаОстаток,
	|	РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа,
	|	ВЫБОР
	|		КОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа > &НаДату
	|			ТОГДА РасчетыПоСделкамСПоставщикамиОстатки.ДатаПлатежа
	|		ИНАЧЕ &НаДату
	|	КОНЕЦ,
	|	РасчетыПоСделкамСПоставщикамиОстатки.Комплектация.Организация,
	|	РасчетыПоСделкамСПоставщикамиОстатки.Комплектация,
	|	СделкаСПоставщикомЭтапыСделки.ВариантОплаты,
	|	СделкаСПоставщикомЭтапыСделки.ПроцентОплаты,
	//+++АК POZM 2017.12.13 ИП-00017345 
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.РасчетыЧерезФК
	|			ТОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.ФакторинговаяКомпания
	|		ИНАЧЕ СделкаСПоставщикомГрафикОплат.Ссылка.Контрагент
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.РасчетыЧерезФК
	|			ТОГДА СделкаСПоставщикомГрафикОплат.Ссылка.Договор.ФакторинговаяКомпанияДоговор
	|		ИНАЧЕ СделкаСПоставщикомГрафикОплат.Ссылка.Договор
	|	КОНЕЦ
	//---АК POZM 
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	Контрагент,
	|	СтруктурнаяЕдиница,
	|	Номенклатура,
	|	Сделка";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции	