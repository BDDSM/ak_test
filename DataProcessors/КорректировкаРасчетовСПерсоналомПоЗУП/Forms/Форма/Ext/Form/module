
Процедура КнопкаВыполнитьНажатие(Кнопка)
	ТекстЗапроса="ВЫБРАТЬ
	             |	ФизическиеЛица.Ссылка,
	             |	ФизическиеЛица.Код,
	             |	ФизическиеЛица.Наименование
	             |ИЗ
	             |	Справочник.ФизическиеЛица КАК ФизическиеЛица";
	Запрос=Новый Запрос(ТекстЗапроса);			 
	КэшСотрудников=Запрос.Выполнить().Выгрузить();
	
	ТекстЗапроса="ВЫБРАТЬ
	|ВзаиморасчетыСРаботникамиОрганизацийОстатки.Физлицо,
	|ВзаиморасчетыСРаботникамиОрганизацийОстатки.Организация,
	|ВзаиморасчетыСРаботникамиОрганизацийОстатки.СуммаВзаиморасчетовОстаток КАК СуммаЗУП
	|ИЗ
	|РегистрНакопления.ВзаиморасчетыСРаботникамиОрганизаций.Остатки(&НаДату,Организация.ИНН=&ИНН) КАК ВзаиморасчетыСРаботникамиОрганизацийОстатки";
	СтрокаПодключения = ПолныеПрава.ПолучитьСтрокуПодключения_Зуп();
	v82COMОбъект = Новый COMОбъект(ПолныеПрава.ПолучитьВерсиюКомОбъекта_Зуп() + ".COMConnector");
	
	Попытка
		v82 = v82COMОбъект.Connect(СтрокаПодключения);
		ПодключениеУстановлено=Истина;
	Исключение
		
		ПодключениеУстановлено=Ложь;
		Сообщить("Не удалось подключиться к базе зарплаты");
		Возврат;
		
	КонецПопытки;
	запрос=v82.NewObject("Запрос");  
	запрос.текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("НаДату",КонецДня(Дата)+1);
	Запрос.УстановитьПараметр("ИНН",Организация.ИНН);
	Выборка=Запрос.Выполнить().Выбрать();
	ТЗ=Новый ТаблицаЗначений();
	ТЗ.Колонки.Добавить("ФизЛицо");
	ТЗ.Колонки.Добавить("СуммаУпр");
	ТЗ.Колонки.Добавить("СуммаЗуп");
	Пока выборка.следующий() Цикл
		Нашли=КэшСотрудников.Найти(Выборка.ФизЛицо.Код,"Код");
		Если Нашли=Неопределено Тогда
			Сообщить("Не нашёл сотрудника с кодом "+Выборка.ФизЛицо.Код+"("+Выборка.ФизЛицо.Наименование+")");
			Продолжить;
		КонецЕсли;	
		НС=ТЗ.Добавить();
        НС.ФизЛицо=Нашли.Ссылка;
		НС.СуммаУпр=0;
		НС.СуммаЗУП=Выборка.СуммаЗуп;
	КонецЦикла;	
    ТекстЗапроса="ВЫБРАТЬ
                 |	РасчетыСПерсоналомОстатки.Организация,
                 |	РасчетыСПерсоналомОстатки.ФизЛицо,
                 |	РасчетыСПерсоналомОстатки.СуммаОстаток КАК СуммаУпр,
                 |	0 КАК СуммаЗУП
                 |ИЗ
                 |	РегистрНакопления.РасчетыСПерсоналом.Остатки(&НаДату, Организация = &Организация) КАК РасчетыСПерсоналомОстатки";
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.УстановитьПараметр("НаДату",КонецДня(Дата)+1);
	Запрос.УстановитьПараметр("Организация",Организация);
	Выборка=Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НС=ТЗ.Добавить();
		ЗаполнитьЗначенияСвойств(НС,Выборка);
	КонецЦикла;	
	Док=Документы.КорректировкаЗаписейРегистровНакопления.СоздатьДокумент();
	ДатаДок=КонецДня(Дата);
	Док.Дата=ДатаДок;
	Док.Организация=Организация;
	ТЗ.Свернуть("Физлицо","СуммаУпр,СуммаЗУП");
	Для Каждого Стр Из ТЗ Цикл
		Если Стр.СуммаУпр=Стр.СуммаЗУП Тогда
			Продолжить;
		КонецЕсли;
		НД=Док.Движения.РасчетыСПерсоналом.ДобавитьПриход();
		НД.Период=ДатаДок;
		НД.Организация=Организация;
		НД.Сумма=Стр.СуммаЗУП-Стр.СуммаУпр;
		НД.ФизЛицо=Стр.ФизЛицо;
	КонецЦикла;	
	НС=Док.ТаблицаРегистровНакопления.Добавить();
	НС.Имя="РасчетыСПерсоналом";
	НС.Представление="Расчеты с персоналом";
	Док.ПолучитьФорму().Открыть();
КонецПроцедуры
