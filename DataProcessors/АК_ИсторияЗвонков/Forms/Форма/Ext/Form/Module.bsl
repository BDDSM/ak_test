
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Не ЗначениеЗаполнено(ПериодИстории.ДатаНачала)
		И Не ЗначениеЗаполнено(ПериодИстории.ДатаНачала) Тогда
		ПериодИстории.ДатаНачала = НачалоДня(НачалоДня(ТекущаяДата())-1);
		ПериодИстории.ДатаОкончания = КонецДня(ТекущаяДата());
	КонецЕсли;
	ОбновитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура Позвонить(Команда)
	Если Элементы.ИсторияЗвонков.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	НомерДляЗвонка = Элементы.ИсторияЗвонков.ТекущиеДанные.src;
	Если Элементы.ИсторияЗвонков.ТекущийЭлемент.Имя = "ИсторияЗвонковИсходящийПредставление" Тогда
		НомерДляЗвонка = Элементы.ИсторияЗвонков.ТекущиеДанные.dst;
	КонецЕсли;
	АК_ТелефонияКлиент.Звонить(НомерДляЗвонка);
КонецПроцедуры

&НаСервере
Процедура ОбновитьНаСервере()
	Объект.ИсторияЗвонков.Загрузить(АК_ТелефонияСервер.ПрочитатьЛогAsterisk(ПериодИстории.ДатаНачала,ПериодИстории.ДатаОкончания,,Элементы.ИсторияЗвонковНеотвеченные.Пометка));
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьНаКлиенте()
	ОбновитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура Воспроизвести(Команда)
	Если Элементы.ИсторияЗвонков.ТекущиеДанные = Неопределено
		Или Элементы.ИсторияЗвонков.ТекущиеДанные.recordingfile = "" Тогда
		Возврат;
	КонецЕсли;
	
	ФайлДляВоспроизведения = АК_ТелефонияКлиент.ПолучитьИмяФайлаЗаписиРазговора(Формат(Элементы.ИсторияЗвонков.ТекущиеДанные.calldate,"ДФ=/гггг/ММ/дд/"),Элементы.ИсторияЗвонков.ТекущиеДанные.recordingfile);
	
	Если ЗначениеЗаполнено(ФайлДляВоспроизведения) Тогда
		ЗапуститьПриложение("""C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"" """ + ФайлДляВоспроизведения + """");
	Иначе
		Сообщить("Файл не найден.");
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура Неотвеченные(Команда)
	Элементы.ИсторияЗвонковНеотвеченные.Пометка = Не Элементы.ИсторияЗвонковНеотвеченные.Пометка;
	ОбновитьНаСервере();
	Если Элементы.ИсторияЗвонковНеотвеченные.Пометка Тогда
		ОтборСтрок = Новый ФиксированнаяСтруктура("NotAnswered", Истина);
	КонецЕсли;	
	Элементы.ИсторияЗвонков.ОтборСтрок = ОтборСтрок;
КонецПроцедуры

&НаКлиенте
Процедура ПериодИсторииПриИзменении(Элемент)
	ОбновитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ИсторияЗвонковВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Если Элементы.ИсторияЗвонков.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ОбъектЗвонка = Элементы.ИсторияЗвонков.ТекущиеДанные.ВходящийОбъект;
	Если Элементы.ИсторияЗвонков.ТекущийЭлемент.Имя = "ИсторияЗвонковИсходящийПредставление" Тогда
		ОбъектЗвонка = Элементы.ИсторияЗвонков.ТекущиеДанные.ИсходящийОбъект;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ОбъектЗвонка) Тогда
		Возврат;
	КонецЕсли;
	Если ТипЗнч(ОбъектЗвонка) = Тип("Строка") Тогда
		СтруктураПараметровФормы = Новый Структура;
		СтруктураПараметровФормы.Вставить("CustomerUID",ОбъектЗвонка);
		СтруктураПараметровФормы.Вставить("rowguid","");
		СтруктураПараметровФормы.Вставить("Email","");
		
		ОткрытьФорму("Обработка.ОтчетыПоКартам.Форма.КарточкаКлиента", СтруктураПараметровФормы);
	Иначе
		ОткрытьЗначение(ОбъектЗвонка);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПодключитьОбработчикОжидания("ОбновитьНаКлиенте",120);
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	ОтключитьОбработчикОжидания("ОбновитьНаКлиенте");
КонецПроцедуры
