перем ДоступноДопПравоОграниченноеРедактирование;
перем ДоступноДопПравоУстановкаНовых;

//
//
Процедура ОбновитьТаблицу()
	
	ЭтотОбъект.ТаблицаЛимитов.Очистить();
	
	//
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЛимитыАренднойПлатыСрезПоследних.Период КАК Период,
	|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка КАК ТорговаяТочка,
	|	ЛимитыАренднойПлатыСрезПоследних.МесяцАренды,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостоянная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаСубаренда,
	|	ЛимитыАренднойПлатыСрезПоследних.Ответственный,
	|	ЛимитыАренднойПлатыСрезПоследних.Комментарий
	|ИЗ
	|	РегистрСведений.ЛимитыАренднойПлаты.СрезПоследних(, ) КАК ЛимитыАренднойПлатыСрезПоследних
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период УБЫВ
	|ИТОГИ ПО
	|	ТорговаяТочка";
	
	ВыборкаТТ = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаТТ.Следующий() Цикл
		
		ТекущийМесяцАренды = Неопределено;
		
		Выборка = ВыборкаТТ.Выбрать();
		Пока Выборка.Следующий() Цикл
			Если ТекущийМесяцАренды = Неопределено ИЛИ Выборка.МесяцАренды<ТекущийМесяцАренды Тогда
				НоваяЗапись = ТаблицаЛимитов.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
				ТекущийМесяцАренды = Выборка.МесяцАренды;
			КонецЕсли; 	
		КонецЦикла;  
	КонецЦикла;  
	
	ТаблицаЛимитов.Сортировать("ТорговаяТочка, МесяцАренды");
	
КонецПроцедуры 


Процедура ПриОткрытии()
	
	ОбновитьТаблицу();
	
	//+++ AK suvv 2018.10.01 ИП-00019353
	МассивПраваОграниченноеРедактирование = УправлениеДопПравамиПользователей.ПрочитатьЗначениеПраваПользователя(ПланыВидовХарактеристик.ПраваПользователей.ЛимитыАренднойПлатыОграниченноеРедактирование,Ложь,ПараметрыСеанса.ТекущийПользователь);	
	ДоступноДопПравоОграниченноеРедактирование = МассивПраваОграниченноеРедактирование[0];
	
	МассивПраваУстановкаНовых = УправлениеДопПравамиПользователей.ПрочитатьЗначениеПраваПользователя(ПланыВидовХарактеристик.ПраваПользователей.ЛимитыАренднойПлатыУстановкаНовых,Ложь,ПараметрыСеанса.ТекущийПользователь);	
	ДоступноДопПравоУстановкаНовых = МассивПраваУстановкаНовых[0];
	//--- AK suvv
	
КонецПроцедуры


Процедура КоманднаяПанель1Обновить(Кнопка)
	
	ОбновитьТаблицу();
	
КонецПроцедуры

Процедура КоманднаяПанель1Добавить(Кнопка)
	
	ФормаЗаписи = ПолучитьФорму("ФормаЗаписи");
	//+++ AK suvv 2018.10.01 ИП-00019353
	Если не ДоступноДопПравоУстановкаНовых Тогда 
		УПользователяЕстьОграничения = Истина;
	Иначе
		УПользователяЕстьОграничения = Ложь;
	КонецЕсли;
	ФормаЗаписи.УПользователяЕстьОграничения = УПользователяЕстьОграничения;
	//--- AK suvv

	ФормаЗаписи.ОткрытьМодально();
	
	ОбновитьТаблицу();
	
КонецПроцедуры

Процедура КоманднаяПанель1Скопировать(Кнопка)
	
	ТекДанные = ЭлементыФормы.ТаблицаЛимитов.ТекущиеДанные;
	
	//
	ФормаЗаписи = ПолучитьФорму("ФормаЗаписи");
	ЗаполнитьЗначенияСвойств(ФормаЗаписи, ТекДанные);
	//+++ AK suvv 2018.10.01 ИП-00019353
	Если не ДоступноДопПравоУстановкаНовых Тогда 
		УПользователяЕстьОграничения = Истина;
	Иначе
		УПользователяЕстьОграничения = Ложь;
	КонецЕсли;
	ФормаЗаписи.УПользователяЕстьОграничения = УПользователяЕстьОграничения;
	//--- AK suvv
	ФормаЗаписи.ОткрытьМодально();
	
	//
	ОбновитьТаблицу();

КонецПроцедуры

Процедура ТаблицаЛимитовВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	//+++ AK suvv 2018.10.01 ИП-00019353
	ДоступноРедактированиеВыбраннойСтроки = Ложь;
	
	Если ДоступноДопПравоОграниченноеРедактирование Тогда 
		Если НачалоМесяца(ВыбраннаяСтрока.МесяцАренды) = НачалоМесяца(ТекущаяДата()) или 
			ВыбраннаяСтрока.Ответственный = ПараметрыСеанса.ТекущийПользователь Тогда 
			ДоступноРедактированиеВыбраннойСтроки = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ДоступноДопПравоУстановкаНовых Тогда 
		Если ВыбраннаяСтрока.СуммаАрендаПостоянная = 0 и ВыбраннаяСтрока.СуммаАрендаПеременная = 0 или
			ВыбраннаяСтрока.Ответственный = ПараметрыСеанса.ТекущийПользователь Тогда 
		    ДоступноРедактированиеВыбраннойСтроки = Истина;
		КонецЕсли;	
	КонецЕсли;
	
	Если не ДоступноРедактированиеВыбраннойСтроки Тогда 
		Сообщить("Недостаточно прав для редактирования выбранной строки.");
		Возврат;
	ИначеЕсли не ДоступноДопПравоУстановкаНовых Тогда 
		УПользователяЕстьОграничения = Истина;
	Иначе
		УПользователяЕстьОграничения = Ложь;
	КонецЕсли;
	
	ФормаЗаписи = ПолучитьФорму("ФормаЗаписи");
	ЗаполнитьЗначенияСвойств(ФормаЗаписи, ВыбраннаяСтрока);
	ФормаЗаписи.УПользователяЕстьОграничения = УПользователяЕстьОграничения;
	ФормаЗаписи.МесяцАрендыС                 = ВыбраннаяСтрока.МесяцАренды;
	ФормаЗаписи.ОткрытьМодально();
	
	ОбновитьТаблицу();
	//--- AK suvv
	
КонецПроцедуры
