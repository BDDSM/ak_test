
Процедура МесяцАрендыПриИзменении(Элемент)
	
//	Элемент.Значение = НачалоМесяца(Элемент.Значение);
	
КонецПроцедуры


Процедура ОсновныеДействияФормыОсновныеДействияФормыОК(Кнопка)
	
	Если НЕ ЗначениеЗаполнено(ТорговаяТочка) Тогда
		Сообщить("Не указана торговая точка!");
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(МесяцАрендыС) Тогда
		Сообщить("Не указана дата начала действия!");
		Возврат;
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(МесяцАрендыПо)
			И МесяцАрендыС > МесяцАрендыПо Тогда
		Сообщить("Дата начала действия не может быть больше даты окончания!");
		Возврат;
	КонецЕсли; 
	
	//+++ AK suv 2018.10.01 ИП-00019353
	Если УПользователяЕстьОграничения Тогда 
		Если СуммаАрендаПеременная > 80000 Тогда 
			Сообщить("Сумма переменной части арендной платы не может превышать 80 000 руб.");
			Возврат;
		ИначеЕсли НачалоМесяца(МесяцАрендыС) <> НачалоМесяца(ТекущаяДата()) Тогда 
			Сообщить("В поле ""Действует с"" может быть установлена дата только текущего месяца");
			Возврат;
		КонецЕсли;
	КонецЕсли;
	//--- AK suvv
	
	// Если период содержит нецелое число месяцев - разбиваем на несколько записей, пропорционально количеству дней в месяце
	ТолькоОдинМесяц 		= (НачалоМесяца(МесяцАрендыС) = НачалоМесяца(МесяцАрендыПо));
	НеполныйПервыйМесяц 	= (МесяцАрендыС <> НачалоМесяца(МесяцАрендыС)
								ИЛИ ТолькоОдинМесяц
										И МесяцАрендыПо <> НачалоДня(КонецМесяца(МесяцАрендыПо)));
	НеполныйПоследнийМесяц 	= (ЗначениеЗаполнено(МесяцАрендыПо)
								И НЕ ТолькоОдинМесяц
								И МесяцАрендыПо <> НачалоДня(КонецМесяца(МесяцАрендыПо)));
	
	МассивНовыхЗаписей = Новый Массив;
	
	ДатаНовойЗаписи = Неопределено;
	
	Если НеполныйПервыйМесяц
			ИЛИ НеполныйПоследнийМесяц Тогда
		
		Если НеполныйПервыйМесяц
				И НеполныйПоследнийМесяц Тогда
			ТекстСуммы = "Суммы первого и последнего месяцев";
		ИначеЕсли НеполныйПервыйМесяц Тогда
			ТекстСуммы = "Суммы первого месяца";
		Иначе
			ТекстСуммы = "Суммы последнего месяца";
		КонецЕсли; 
		Если Вопрос("Указано неполное количество месяцев. " + ТекстСуммы + " будут пересчитаны пропорционально количеству дней аренды. Продолжить?", РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
			Возврат;
		КонецЕсли; 
		
		// Если первый месяц неполный - добавляем строку по нему, иначе общую
		Если НеполныйПервыйМесяц Тогда
			
			//
			Если ЗначениеЗаполнено(МесяцАрендыПо) Тогда
				КонецПервогоМесяца = Мин(КонецМесяца(МесяцАрендыС), МесяцАрендыПо);
			Иначе
				КонецПервогоМесяца = КонецМесяца(МесяцАрендыС);
			КонецЕсли; 
			
			ДнейАренды 	= День(КонецПервогоМесяца) - День(МесяцАрендыС) + 1;
			ДнейВМесяце = День(КонецМесяца(МесяцАрендыС)) - День(НачалоМесяца(МесяцАрендыС)) + 1;
			
			//
			ЛимитыДоМесяцаАрендыС = Новый Структура("СуммаАрендаПостоянная, СуммаАрендаПеременная, СуммаСубаренда", 0, 0, 0);
			КомментарийДоМесяцаАрендыСАрендаПостоянная 	= "";
			КомментарийДоМесяцаАрендыСАрендаПеременная 	= "";
			КомментарийДоМесяцаАрендыССубаренда 		= "";
			Если НЕ НачалоМесяца(МесяцАрендыС) = МесяцАрендыС Тогда
				Запрос = Новый Запрос;
				Запрос.УстановитьПараметр("ТорговаяТочка"	, ТорговаяТочка); 
				Запрос.УстановитьПараметр("МесяцАрендыС"	, НачалоМесяца(МесяцАрендыС)); 
				Запрос.Текст =
				"ВЫБРАТЬ ПЕРВЫЕ 1
				|	ВЫБОР
				|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц = 0
				|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостоянная
				|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц
				|	КОНЕЦ КАК СуммаАрендаПостоянная,
				|	ВЫБОР
				|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц = 0
				|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременная
				|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц
				|	КОНЕЦ КАК СуммаАрендаПеременная,
				|	ВЫБОР
				|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц = 0
				|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаСубаренда
				|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц
				|	КОНЕЦ КАК СуммаСубаренда
				|ИЗ
				|	РегистрСведений.ЛимитыАренднойПлаты.СрезПоследних КАК ЛимитыАренднойПлатыСрезПоследних
				|ГДЕ
				|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка = &ТорговаяТочка
				|	И ЛимитыАренднойПлатыСрезПоследних.МесяцАренды <= &МесяцАрендыС
				|
				|УПОРЯДОЧИТЬ ПО
				|	ЛимитыАренднойПлатыСрезПоследних.Период УБЫВ";

			    Выборка = Запрос.Выполнить().Выбрать();
				Если Выборка.Следующий() Тогда
					ЗаполнитьЗначенияСвойств(ЛимитыДоМесяцаАрендыС, Выборка);
					КомментарийДоМесяцаАрендыСАрендаПеременная 	= "" + ЛимитыДоМесяцаАрендыС.СуммаАрендаПеременная 	+ " * " + (ДнейВМесяце - ДнейАренды) + " / " + ДнейВМесяце + " + ";
					ЛимитыДоМесяцаАрендыС.СуммаАрендаПеременная 	= ЛимитыДоМесяцаАрендыС.СуммаАрендаПеременная 	* (ДнейВМесяце - ДнейАренды) / ДнейВМесяце;
					КомментарийДоМесяцаАрендыСАрендаПостоянная 	= "" + ЛимитыДоМесяцаАрендыС.СуммаАрендаПостоянная 	+ " * " + (ДнейВМесяце - ДнейАренды) + " / " + ДнейВМесяце + " + ";
					ЛимитыДоМесяцаАрендыС.СуммаАрендаПостоянная 	= ЛимитыДоМесяцаАрендыС.СуммаАрендаПостоянная 	* (ДнейВМесяце - ДнейАренды) / ДнейВМесяце;
					КомментарийДоМесяцаАрендыССубаренда 		= "" + ЛимитыДоМесяцаАрендыС.СуммаСубаренда 		+ " * " + (ДнейВМесяце - ДнейАренды) + " / " + ДнейВМесяце + " + ";
					ЛимитыДоМесяцаАрендыС.СуммаСубаренда 			= ЛимитыДоМесяцаАрендыС.СуммаСубаренда 			* (ДнейВМесяце - ДнейАренды) / ДнейВМесяце;
				КонецЕсли;			
			КонецЕсли;
			
			// Проверим - был ли уже лимит до начала месяца
			//Запрос = Новый Запрос;
			//Запрос.УстановитьПараметр("ТорговаяТочка"	, ТорговаяТочка); 
			//Запрос.УстановитьПараметр("МесяцАрендыС"	, НачалоМесяца(МесяцАрендыС)); 
			//Запрос.Текст =
			//"ВЫБРАТЬ ПЕРВЫЕ 1
			//|	ВЫБОР
			//|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц = 0
			//|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостоянная
			//|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц
			//|	КОНЕЦ КАК СуммаАрендаПостоянная,
			//|	ВЫБОР
			//|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц = 0
			//|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременная
			//|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц
			//|	КОНЕЦ КАК СуммаАрендаПеременная,
			//|	ВЫБОР
			//|		КОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц = 0
			//|			ТОГДА ЛимитыАренднойПлатыСрезПоследних.СуммаСубаренда
			//|		ИНАЧЕ ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц
			//|	КОНЕЦ КАК СуммаСубаренда
			//|ИЗ
			//|	РегистрСведений.ЛимитыАренднойПлаты.СрезПоследних КАК ЛимитыАренднойПлатыСрезПоследних
			//|ГДЕ
			//|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка = &ТорговаяТочка
			//|	И ЛимитыАренднойПлатыСрезПоследних.МесяцАренды < &МесяцАрендыС
			//|
			//|УПОРЯДОЧИТЬ ПО
			//|	ЛимитыАренднойПлатыСрезПоследних.Период УБЫВ";


			//ЛимитыДоНачалаМесяца = Новый Структура("СуммаАрендаПостоянная, СуммаАрендаПеременная, СуммаСубаренда", 0, 0, 0);

			//
			//Выборка = Запрос.Выполнить().Выбрать();

			//Если Выборка.Следующий() Тогда
			//	ЗаполнитьЗначенияСвойств(ЛимитыДоНачалаМесяца, Выборка);
			//КонецЕсли;			
			
			//
			МЗНоваяПервыйМесяц = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();

			ДатаНовойЗаписи = ТекущаяДата();
			
			МЗНоваяПервыйМесяц.Период 			= ДатаНовойЗаписи;
			МЗНоваяПервыйМесяц.ТорговаяТочка 	= ТорговаяТочка;
			МЗНоваяПервыйМесяц.МесяцАренды 		= НачалоМесяца(МесяцАрендыС);
			
			МЗНоваяПервыйМесяц.СуммаАрендаПеременная 	= ЛимитыДоМесяцаАрендыС.СуммаАрендаПеременная 	+ СуммаАрендаПеременная * ДнейАренды / ДнейВМесяце; //+ (ДнейВМесяце - ДнейАренды) * ЛимитыДоНачалаМесяца.СуммаАрендаПеременная/ ДнейВМесяце;
			МЗНоваяПервыйМесяц.СуммаАрендаПостоянная 	= ЛимитыДоМесяцаАрендыС.СуммаАрендаПостоянная 	+ СуммаАрендаПостоянная * ДнейАренды / ДнейВМесяце; //+ (ДнейВМесяце - ДнейАренды) * ЛимитыДоНачалаМесяца.СуммаАрендаПостоянная/ ДнейВМесяце;
			МЗНоваяПервыйМесяц.СуммаСубаренда 			= ЛимитыДоМесяцаАрендыС.СуммаСубаренда 			+ СуммаСубаренда 		* ДнейАренды / ДнейВМесяце; // + (ДнейВМесяце - ДнейАренды) * ЛимитыДоНачалаМесяца.СуммаСубаренда/ ДнейВМесяце;
			
			МЗНоваяПервыйМесяц.СуммаАрендаПеременнаяПолныйМесяц = СуммаАрендаПеременная; 
			МЗНоваяПервыйМесяц.СуммаАрендаПостояннаяПолныйМесяц = СуммаАрендаПостоянная;
			МЗНоваяПервыйМесяц.СуммаСубарендаПолныйМесяц 		= СуммаСубаренда;
			
			КомментарийНеполныйМесяц =  " ## За неполный месяц - с  " + Формат(МесяцАрендыС, "ДФ=dd.MM.yyyy") + ".";
			Если СуммаАрендаПостоянная > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Постоянная часть: " + КомментарийДоМесяцаАрендыСАрендаПостоянная
											+ СуммаАрендаПостоянная + " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			Если СуммаАрендаПеременная > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Переменная часть: "	+ КомментарийДоМесяцаАрендыСАрендаПеременная
											+ СуммаАрендаПеременная + " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			Если СуммаСубаренда > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Субаренда: " 		+ КомментарийДоМесяцаАрендыССубаренда
											+ СуммаСубаренда 		+ " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			КомментарийНеполныйМесяц =  КомментарийНеполныйМесяц + "##";
			МЗНоваяПервыйМесяц.Комментарий = Комментарий + КомментарийНеполныйМесяц;

			МЗНоваяПервыйМесяц.Ответственный = глЗначениеПеременной("глТекущийПользователь");	

			МассивНовыхЗаписей.Добавить(МЗНоваяПервыйМесяц);
		КонецЕсли;
		
		// Добавляем общую строку
		Если НЕ НеполныйПервыйМесяц
				ИЛИ НЕ ТолькоОдинМесяц Тогда
			МЗНовая = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();

			ДатаНовойЗаписи = ?(ДатаНовойЗаписи = Неопределено, ТекущаяДата(), ДатаНовойЗаписи+1);
			
			МЗНовая.Период = ДатаНовойЗаписи;
			МЗНовая.ТорговаяТочка 	= ТорговаяТочка;
			МЗНовая.МесяцАренды 	= ?(НеполныйПервыйМесяц, ДобавитьМесяц(НачалоМесяца(МесяцАрендыС), 1), НачалоМесяца(МесяцАрендыС));
			
			МЗНовая.СуммаАрендаПеременная 	= СуммаАрендаПеременная;
			МЗНовая.СуммаАрендаПостоянная 	= СуммаАрендаПостоянная;
			МЗНовая.СуммаСубаренда 			= СуммаСубаренда;
			
			МЗНовая.СуммаАрендаПеременнаяПолныйМесяц 	= СуммаАрендаПеременная; 
			МЗНовая.СуммаАрендаПостояннаяПолныйМесяц 	= СуммаАрендаПостоянная;
			МЗНовая.СуммаСубарендаПолныйМесяц 			= СуммаСубаренда;
		
			МЗНовая.Комментарий 	= Комментарий;
			МЗНовая.Ответственный 	= глЗначениеПеременной("глТекущийПользователь");	

			МассивНовыхЗаписей.Добавить(МЗНовая);
		КонецЕсли; 
		
		// Если последний месяц неполный - добавляем отдельную строку по нему
		Если НеполныйПоследнийМесяц Тогда
			
			ДнейАренды 	= (День(МесяцАрендыПо) - День(НачалоМесяца(МесяцАрендыПо)) + 1);
			ДнейВМесяце = (День(КонецМесяца(МесяцАрендыПо)) - День(НачалоМесяца(МесяцАрендыПо)) + 1);
			
			МЗНоваяПоследнийМесяц = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();

			ДатаНовойЗаписи = ?(ДатаНовойЗаписи = Неопределено, ТекущаяДата(), ДатаНовойЗаписи+1);
			
			МЗНоваяПоследнийМесяц.Период 		= ДатаНовойЗаписи;
			МЗНоваяПоследнийМесяц.ТорговаяТочка = ТорговаяТочка;
			МЗНоваяПоследнийМесяц.МесяцАренды 	= НачалоМесяца(МесяцАрендыПо);
			
			МЗНоваяПоследнийМесяц.СуммаАрендаПеременная = СуммаАрендаПеременная * ДнейАренды / ДнейВМесяце;
			МЗНоваяПоследнийМесяц.СуммаАрендаПостоянная = СуммаАрендаПостоянная * ДнейАренды / ДнейВМесяце;
			МЗНоваяПоследнийМесяц.СуммаСубаренда 		= СуммаСубаренда * ДнейАренды / ДнейВМесяце;
			
			МЗНоваяПоследнийМесяц.СуммаАрендаПеременнаяПолныйМесяц 	= СуммаАрендаПеременная; 
			МЗНоваяПоследнийМесяц.СуммаАрендаПостояннаяПолныйМесяц 	= СуммаАрендаПостоянная;
			МЗНоваяПоследнийМесяц.СуммаСубарендаПолныйМесяц 		= СуммаСубаренда;
			
			КомментарийНеполныйМесяц =  " ## За неполный месяц - по " + Формат(МесяцАрендыПо, "ДФ=dd.MM.yyyy") + ".";
			Если СуммаАрендаПостоянная > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Постоянная часть: " + СуммаАрендаПостоянная + " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			Если СуммаАрендаПеременная > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Переменная часть: " + СуммаАрендаПеременная + " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			Если СуммаСубаренда > 0 Тогда
				КомментарийНеполныйМесяц = КомментарийНеполныйМесяц + " Субаренда: " + СуммаСубаренда + " * " + ДнейАренды + " / " + ДнейВМесяце + ". ";
			КонецЕсли; 
			КомментарийНеполныйМесяц =  КомментарийНеполныйМесяц + "##";			
			МЗНоваяПоследнийМесяц.Комментарий 	= Комментарий + КомментарийНеполныйМесяц;
			МЗНоваяПоследнийМесяц.Ответственный = глЗначениеПеременной("глТекущийПользователь");	

			МассивНовыхЗаписей.Добавить(МЗНоваяПоследнийМесяц);
			
		КонецЕсли;

	Иначе
		
		//  Обычная новая запись на период
		МЗНовая = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();

		ДатаНовойЗаписи = ТекущаяДата();
		
		МЗНовая.Период 			= ДатаНовойЗаписи;
		МЗНовая.ТорговаяТочка 	= ТорговаяТочка;
		МЗНовая.МесяцАренды 	= НачалоМесяца(МесяцАрендыС);
		
		МЗНовая.СуммаАрендаПеременная 	= СуммаАрендаПеременная;
		МЗНовая.СуммаАрендаПостоянная 	= СуммаАрендаПостоянная;
		МЗНовая.СуммаСубаренда 			= СуммаСубаренда;
		
		МЗНовая.СуммаАрендаПеременнаяПолныйМесяц 	= СуммаАрендаПеременная; 
		МЗНовая.СуммаАрендаПостояннаяПолныйМесяц 	= СуммаАрендаПостоянная;
		МЗНовая.СуммаСубарендаПолныйМесяц 			= СуммаСубаренда;
		
		МЗНовая.Комментарий 	= Комментарий;
		МЗНовая.Ответственный 	= глЗначениеПеременной("глТекущийПользователь");	

		МассивНовыхЗаписей.Добавить(МЗНовая);
	КонецЕсли; 
	
	// Если не указан период окончания - можно заканчивать
	Если НЕ ЗначениеЗаполнено(МесяцАрендыПо) Тогда
		Для Каждого МЗ Из МассивНовыхЗаписей Цикл
			МЗ.Записать();			
		КонецЦикла;  
		
		Закрыть();
		Возврат;
	КонецЕсли;

	
	// Добавим запись, которая прерывается вводимым периодом
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТорговаяТочка", ТорговаяТочка); 
	Запрос.УстановитьПараметр("МесяцАрендыПо", НачалоМесяца(МесяцАрендыПо)); 
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЛимитыАренднойПлатыСрезПоследних.Период КАК Период,
	|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка,
	|	ЛимитыАренднойПлатыСрезПоследних.МесяцАренды,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостоянная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаСубаренда,
	|	ЛимитыАренднойПлатыСрезПоследних.Ответственный,
	|	ЛимитыАренднойПлатыСрезПоследних.Комментарий,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц
	|ИЗ
	|	РегистрСведений.ЛимитыАренднойПлаты.СрезПоследних КАК ЛимитыАренднойПлатыСрезПоследних
	|ГДЕ
	|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка = &ТорговаяТочка
	|	И ЛимитыАренднойПлатыСрезПоследних.МесяцАренды <= &МесяцАрендыПо
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период УБЫВ";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МЗПрерываемая = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(МЗПрерываемая, Выборка);
		//+++АК sils 09.02.2018 ИП-00017863
		Если не ЗначениеЗаполнено(МЗПрерываемая.Ответственный) Тогда
			МЗПрерываемая.Ответственный = глЗначениеПеременной("глТекущийПользователь");	
		КонецЕсли;
		//---АК
	Иначе
		МЗПрерываемая.ТорговаяТочка = ТорговаяТочка;		
		МЗПрерываемая.Ответственный = глЗначениеПеременной("глТекущийПользователь");	
	КонецЕсли; 

	ДатаНовойЗаписи = ДатаНовойЗаписи + 1;
	
	МЗПрерываемая.Период 		= ДатаНовойЗаписи;
	МЗПрерываемая.МесяцАренды 	= ДобавитьМесяц(НачалоМесяца(МесяцАрендыПо), 1);
	
	//  Добавляем записи, которые действовали после вводимого периода
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТорговаяТочка", ТорговаяТочка); 
	Запрос.УстановитьПараметр("МесяцАрендыПО", НачалоМесяца(МесяцАрендыПо)); 
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЛимитыАренднойПлатыСрезПоследних.Период КАК Период,
	|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка,
	|	ЛимитыАренднойПлатыСрезПоследних.МесяцАренды,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостоянная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременная,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаСубаренда,
	|	ЛимитыАренднойПлатыСрезПоследних.Ответственный,
	|	ЛимитыАренднойПлатыСрезПоследних.Комментарий,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПостояннаяПолныйМесяц,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаАрендаПеременнаяПолныйМесяц,
	|	ЛимитыАренднойПлатыСрезПоследних.СуммаСубарендаПолныйМесяц
	|ИЗ
	|	РегистрСведений.ЛимитыАренднойПлаты.СрезПоследних КАК ЛимитыАренднойПлатыСрезПоследних
	|ГДЕ
	|	ЛимитыАренднойПлатыСрезПоследних.ТорговаяТочка = &ТорговаяТочка
	|	И ЛимитыАренднойПлатыСрезПоследних.МесяцАренды > &МесяцАрендыПО
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	// Записываем после всех чтений
	Для Каждого МЗ Из МассивНовыхЗаписей Цикл
		МЗ.Записать();			
	КонецЦикла;  
	МЗПрерываемая.Записать();	

	Выборка = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока Выборка.Следующий() Цикл
		МЗ = РегистрыСведений.ЛимитыАренднойПлаты.СоздатьМенеджерЗаписи();
		
		ЗаполнитьЗначенияСвойств(МЗ, Выборка);
		ДатаНовойЗаписи = ДатаНовойЗаписи + 1;
		МЗ.Период = ДатаНовойЗаписи;
		//МЗ.Ответственный = глЗначениеПеременной("глТекущийПользователь");	
		//+++АК sils 09.02.2018 ИП-00017863
		Если не ЗначениеЗаполнено(МЗ.Ответственный) Тогда
			МЗ.Ответственный = глЗначениеПеременной("глТекущийПользователь");	
		КонецЕсли;
		//---АК
		
		МЗ.Записать();
	КонецЦикла;  
	
	Закрыть();
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	//+++ AK suvv ИП-00019353 2018.10.01
	Если УПользователяЕстьОграничения Тогда
		ЭлементыФормы.СуммаАрендаПостоянная.Доступность = Ложь;
	КонецЕсли;
	//--- AK suvv
	
КонецПроцедуры
