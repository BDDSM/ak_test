
//+++АК SHEP 2018.11.30 ИП-00020078.03
Функция ПолучитьТаблицуМожетПродать(ДатаНачала, ДатаОкончания, id_TT, id_tov = "") Экспорт
	
	ADOСоединение = ВнешниеДанные.ПолучитьADOСоединение();
	
	//LATV: исправил во ремя дежурства, вместо суммирования всех строк выбираю максимльное значение. Правильно или нет неизвестно
	ТекстЗапросаSQL = "
		|select
		|	tki.id_tov,
		|	tki.id_kontr,
		|	MAX(tki.q_plan_pr) AS q_plan_pr
		|from m2..tt_tov_kontr_init tki (nolock)
		|	INNER JOIN M2..Raspr_zadanie As rz With (NOLOCK)
		|	ON tki.Number_r = rz.Number_r
		|		AND ISNULL(rz.test_raspr, 0) = 0
		|where
		|	date_r1 between " + ВнешниеДанные.ФорматПоля(ДатаНачала, Истина) + " and " + ВнешниеДанные.ФорматПоля(ДатаОкончания, Истина) + "
		|	and id_tt = " + ВнешниеДанные.ФорматПоля(id_TT) + ?(ЗначениеЗаполнено(id_tov), "
		|	and id_tov = " + ВнешниеДанные.ФорматПоля(id_tov), "") + "
		|	
		|GROUP BY
		|	tki.id_tov,
		|	tki.id_kontr";
	
	rs = ADOСоединение.Execute(ТекстЗапросаSQL);
	ТЗнРезультат = ВнешниеДанные.ПреобразоватьРезультатВТаблицуЗначений(rs);
	
	ADOСоединение.Close();
	ADOСоединение = Неопределено;
	
	Если ТЗнРезультат.Количество() = 0 Тогда Возврат ТЗнРезультат; КонецЕсли;
	
	Запрос = Новый Запрос(
		"ВЫБРАТЬ
		|	ТЗнДанныеSQL.id_tov,
		|	ТЗнДанныеSQL.id_kontr,
		|	ТЗнДанныеSQL.q_plan_pr
		|ПОМЕСТИТЬ ТекущиеДанные
		|ИЗ
		|	&ТЗнДанныеSQL КАК ТЗнДанныеSQL
		|ГДЕ
		|	НЕ ТЗнДанныеSQL.id_tov = 0
		|	И НЕ ЕСТЬNULL(ТЗнДанныеSQL.id_kontr, 0) = 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Товар,
		|	СУММА(ТекущиеДанные.q_plan_pr) КАК МожетПродать
		|ИЗ
		|	ТекущиеДанные КАК ТекущиеДанные
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
		|		ПО ТекущиеДанные.id_tov = Номенклатура.id_tov
		|
		|СГРУППИРОВАТЬ ПО
		|	Номенклатура.Ссылка");
	Запрос.УстановитьПараметр("ТЗнДанныеSQL", ТЗнРезультат);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции
