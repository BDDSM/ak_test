
&НаСервере
Процедура ЗаполнитьТЧНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ЗаданиеЛаборатории.Ссылка КАК ДокЗадание,
		|	ЗаданиеЛаборатории.Дата КАК ДатаЗадания,
		|	ЗаданиеЛаборатории.Номенклатура КАК Номенклатура,
		|	ЗаданиеЛаборатории.Поставщик КАК Производитель,
		|	ЗаданиеЛаборатории.Характеристика,
		|	ЗаданиеЛаборатории.Количество,
		|	ЗаданиеЛаборатории.ДатаИзготовления
		|ПОМЕСТИТЬ вт_ЗадЛаб
		|ИЗ
		|	Документ.ЗаданиеЛаборатории КАК ЗаданиеЛаборатории
		|ГДЕ
		|	ЗаданиеЛаборатории.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийДокументаЗаданиеЛаборатории.Основная)
		|	И ЗаданиеЛаборатории.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыЗаданийЛаборатории.ВРаботе)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступностьТоваровНаСкладах.Номенклатура КАК Номенклатура,
		|	ДоступностьТоваровНаСкладах.Склад КАК Склад
		|ПОМЕСТИТЬ вт_Склады
		|ИЗ
		|	вт_ЗадЛаб КАК вт_ЗадЛаб
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоступностьТоваровНаСкладах КАК ДоступностьТоваровНаСкладах
		|		ПО вт_ЗадЛаб.Номенклатура = ДоступностьТоваровНаСкладах.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура,
		|	Склад
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	вт_Склады.Номенклатура КАК Номенклатура,
		|	СУММА(ТоварыНаСкладахОстатки.КоличествоОстаток) КАК Остаток
		|ПОМЕСТИТЬ вт_Остатки
		|ИЗ
		|	вт_Склады КАК вт_Склады
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
		|				&ДатаНач,
		|				Склад В
		|						(ВЫБРАТЬ
		|							вт_Склады.Склад
		|						ИЗ
		|							вт_Склады КАК вт_Склады)
		|					И Номенклатура В
		|						(ВЫБРАТЬ
		|							вт_ЗадЛаб.Номенклатура
		|						ИЗ
		|							вт_ЗадЛаб КАК вт_ЗадЛаб)
		|					И Характеристика В
		|						(ВЫБРАТЬ
		|							вт_ЗадЛаб.Характеристика
		|						ИЗ
		|							вт_ЗадЛаб КАК вт_ЗадЛаб)) КАК ТоварыНаСкладахОстатки
		|		ПО вт_Склады.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|			И вт_Склады.Склад = ТоварыНаСкладахОстатки.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	вт_Склады.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	вт_ЗадЛаб.ДокЗадание КАК ДокЗадание,
		|	вт_ЗадЛаб.ДатаЗадания,
		|	вт_ЗадЛаб.Номенклатура,
		|	вт_ЗадЛаб.Производитель,
		|	вт_ЗадЛаб.Характеристика,
		|	вт_ЗадЛаб.Количество,
		|	вт_ЗадЛаб.ДатаИзготовления,
		|	вт_Остатки.Остаток КАК Остаток
		|ИЗ
		|	вт_ЗадЛаб КАК вт_ЗадЛаб
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Остатки КАК вт_Остатки
		|		ПО вт_ЗадЛаб.Номенклатура = вт_Остатки.Номенклатура
		|
		|УПОРЯДОЧИТЬ ПО
		|	ДокЗадание";
	
	Запрос.УстановитьПараметр("ДатаНач",ТекущаяДата());
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Объект.ЗаданияЛаборатории.Загрузить(РезультатЗапроса.Выгрузить());
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТЧ(Команда)
	ЗаполнитьТЧНаСервере();
КонецПроцедуры

&НаСервере
Процедура ВыполнитьОбработкуТЧНаСервере()
	Для каждого СтрокаТЧ Из Объект.ЗаданияЛаборатории Цикл
		Если СтрокаТЧ.Выполнено = Истина И НЕ СтрокаТЧ.ДокЗадание.Пустая() Тогда
			ДокументОбъект = СтрокаТЧ.ДокЗадание.ПолучитьОбъект();
			ДокументОбъект.Статус = Перечисления.СтатусыЗаданийЛаборатории.ОтправленоВЛабораторию;
			ДокументОбъект.ТекстПисьма = ДокументОбъект.ТекстПисьма + Символы.ПС + СтрокаТЧ.Комментарий;
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
		КонецЕсли;	
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьОбработкуТЧ(Команда)
	ВыполнитьОбработкуТЧНаСервере();
КонецПроцедуры

&НаСервере
Функция ПечатьНаСервере()
	Макет = РеквизитФормыВЗначение("Объект").ПолучитьМакет("Макет");
	//Макет = ВнешняяОбработка.ОтгрузкаВЛабораторию.ПолучитьМакет("Макет");
	ПечатнаяФорма = Новый ТабличныйДокумент;
    Шапка = Макет.ПолучитьОбласть("Шапка");
    ПечатнаяФорма.Вывести(Шапка);
    ТабличнаяЧастьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
    ПечатнаяФорма.Вывести(ТабличнаяЧастьЗаголовок);
    ПечатнаяФорма.ПовторятьПриПечатиСтроки = Макет.Область(3,,4);
 
    ТабличнаяЧастьСтрока = Макет.ПолучитьОбласть("Строка"); 
    // Сгруппируем строки таблицы в сворачивающийся блок.
    //ПечатнаяФорма.НачатьГруппуСтрок("Товар", Истина);
 
	Для каждого СтрокаТЧ Из Объект.ЗаданияЛаборатории Цикл
		//ТабличнаяЧастьСтрока.Параметры.Ном = СтрокаТЧ.НомерСтроки;
		//ТабличнаяЧастьСтрока.Параметры.Документ
		//ТабличнаяЧастьСтрока.Параметры.Номенклатура = СтрокаТЧ.Номенклатура;
		//ТабличнаяЧастьСтрока.Параметры.Количество = СтрокаТЧ.Количество;
		
		ЗаполнитьЗначенияСвойств(ТабличнаяЧастьСтрока.Параметры, СтрокаТЧ);
        ТабличнаяЧастьСтрока.Параметры.РасшифровкаЗадания = СтрокаТЧ.ДокЗадание.Ссылка;
 
        ПечатнаяФорма.Вывести(ТабличнаяЧастьСтрока);
    КонецЦикла;
 
    // Закончим начатую группировку.
    //ПечатнаяФорма.ЗакончитьГруппуСтрок();    
 
    Возврат ПечатнаяФорма;
КонецФункции

&НаКлиенте
Процедура Печать(Команда)
	ПечатнаяФорма = ПечатьНаСервере();
	ПечатнаяФорма.ТолькоПросмотр = Истина;
	ПечатнаяФорма.Показать("Задания лаборатории");
КонецПроцедуры
