
#Область ОбработчикиКомандФормы

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	СтруктураПараметров = Новый Структура("Дата, НомерТочки, ЗаписьTD_Move, ЗаписьTD_ost_detail, Очистка, ПросмотрТаблиц, ТолькоНезаполненные", 
										   Дата, НомерТочки, ЗаписьTD_Move, ЗаписьTD_ost_detail, Очистка, ПросмотрТаблиц, ТолькоНезаполненные);
	
	ОбновитьОперации400ПоМагазинамСтороннейРозницы(СтруктураПараметров);
	
	Если ПросмотрТаблиц Тогда
		
		ЭлементыФормы.ТабличноеПоле1.Значение = СтруктураПараметров.ТаблицаTD_Move;
		ЭлементыФормы.ТабличноеПоле1.СоздатьКолонки();
		
		ЭлементыФормы.ТабличноеПоле2.Значение = СтруктураПараметров.ТаблицаРеализаций;
		ЭлементыФормы.ТабличноеПоле2.СоздатьКолонки();
		
		ЭлементыФормы.ТабличноеПоле3.Значение = СтруктураПараметров.ИтоговаяТаблица;
		ЭлементыФормы.ТабличноеПоле3.СоздатьКолонки();
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОчиститьВсеЗаписПоТТ(Кнопка)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос(НСтр("ru = 'Продолжить выполнение операции?';"
	+ " en = 'Do you want to continue?'"), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос(НСтр("ru = 'Точно удалить все записи по магазинам "+НомерТочки+"?';"
	+ " en = 'Do you want to continue?'"), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	
	ADOСоединение = ВнешниеДанныеКлиентСервер.ПолучитьADOСоединение();
	
	УдалитьВсеЗаписиTD_ost_detail (ADOСоединение,"TD_ost_detail", ВнешниеДанные.ФорматПоля(НомерТочки));
	УдалитьВсеЗаписиTD_ost_detail (ADOСоединение,"TD_ost_detail_History",ВнешниеДанные.ФорматПоля(НомерТочки));
	
	ADOСоединение.Close();
	ADOСоединение = Неопределено;

КонецПроцедуры

Процедура ОсновныеДействияФормыОбновитьВесьПериод(Кнопка)
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос(НСтр("ru = 'Обновить даты производства за последний месяц по "+НомерТочки+"?';"
	+ " en = 'Do you want to continue?'"), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	
	ТекущаяДата = НачалоДня(ТекущаяДата());
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДОБАВИТЬКДАТЕ(&ТекущаяДата, МЕСЯЦ, -1) КАК НачалоПериода";
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	ВыборкаДетальныеЗаписи.Следующий();
	
	ДатаОбработки = ВыборкаДетальныеЗаписи.НачалоПериода;	
	
	Пока ДатаОбработки <= ТекущаяДата Цикл
		
		ОбработкаПрерыванияПользователя();
		
		ОбновитьОперации400ПоМагазинамСтороннейРозницы(Новый Структура("Дата, НомерТочки, ЗаписьTD_Move, ЗаписьTD_ost_detail, Очистка, ПросмотрТаблиц, ТолькоНезаполненные", 
																		ДатаОбработки, НомерТочки, Истина, Ложь, Ложь, Ложь, Истина));
		
		Состояние(ДатаОбработки);
		ДатаОбработки = НачалоДня(ДатаОбработки + 86400);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура КоманднаяПанель1ЗагрузитьТочки(Кнопка)
	
	НомерТочки = ПолучитьТочкиПерекресток();
	
КонецПроцедуры

Процедура КоманднаяПанель1Печать(Кнопка)
	
	ТабДокумент = Новый ТабличныйДокумент();
	
	ЭтотОбъект.СформироватьОтчетОПросроченныхПозицияхМагазиновСтороннейРозницы(НомерТочки, Истина, ТабДокумент);
	
	ТабДокумент.Показать();
	
КонецПроцедуры

Процедура КоманднаяПанель1ОтправитьПисьмо(Кнопка)
	
	ЭтотОбъект.СформироватьОтчетОПросроченныхПозицияхМагазиновСтороннейРозницы(НомерТочки, Ложь, , Ложь);
	
КонецПроцедуры

#КонецОбласти
