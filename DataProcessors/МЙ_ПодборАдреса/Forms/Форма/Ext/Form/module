//////////////////////////////////

//
Процедура СформироватьПредставление()
	
	//
	АдресПредставление = "";
	
	//
	Для Сч = 1 По ТЗ_СтэкВыбранныхОбъектов.Количество() Цикл
		
		 //
		 СтрокаТЗ = ТЗ_СтэкВыбранныхОбъектов[ТЗ_СтэкВыбранныхОбъектов.Количество() - Сч];
		 
		 //
		 АдресПредставление = АдресПредставление  + ?(ПустаяСтрока(АдресПредставление), "", ", ") + СтрокаТЗ.view; 
		
	КонецЦикла;	
	
	//
	ТекущаяСтрока_Улица = ЭлементыФормы.ТЗ_Улицы.ТекущаяСтрока;
	Если НЕ БезУлицы И ТекущаяСтрока_Улица <> Неопределено Тогда
		АдресПредставление = АдресПредставление  + ", " + ТекущаяСтрока_Улица.view;
	КонецЕсли;	
	
	//
	Если ЗначениеЗаполнено(Дом) Тогда
		АдресПредставление = АдресПредставление  + ", " + "дом " + Дом;
	КонецЕсли;	
	
	//
	Если ЗначениеЗаполнено(Корпус) Тогда
		АдресПредставление = АдресПредставление  + ", " + "корп. " + Корпус;
	КонецЕсли;	
	
	//
	Если ЗначениеЗаполнено(Строение) Тогда
		АдресПредставление = АдресПредставление  + ", " + "стр. " + Строение;
	КонецЕсли;	
	
	
КонецПроцедуры	

//
//
Процедура СтроениеПриИзменении(Элемент)
	
	//
	СформироватьПредставление();
	
КонецПроцедуры

//
//
Процедура СтруктурнаяЕдиницаПриИзменении(Элемент)

	//
	//ПервоначальноеЗаполнение();
	
	ТЗ_СтэкВыбранныхОбъектов.Очистить();
	
	//
	Если ЗначениеЗаполнено(СтруктурнаяЕдиница) И ЗначениеЗаполнено(НастройкаAPI) = Истина Тогда
		
		//
		МЗ = РегистрыСведений.МЙ_ПоднадзорныеОбъекты.СоздатьМенеджерЗаписи();
		МЗ.СтруктурнаяЕдиница = СтруктурнаяЕдиница;
		МЗ.Организация = НастройкаAPI.Организация;
		МЗ.Прочитать();
		
		//
		Если ЗначениеЗаполнено(МЗ.РегионGUID) Тогда
		
			//
			НайденнаяСтрока = ТЗ_Регионы.Найти(МЗ.РегионGUID, "GUID");
			Если НайденнаяСтрока <> Неопределено Тогда
				ЗаполнитьРайоныИГорода(НайденнаяСтрока);
				ЗаполнитьУлицы(НайденнаяСтрока);
			КонецЕсли;
			
		КонецЕсли;	
		
		//
		Если ЗначениеЗаполнено(МЗ.РайонGUID) Тогда
			
			//
			ТекущийРайонГород_GUID = МЗ.РайонGUID;
			
			//
			НайденнаяСтрока = ТЗ_РайоныИГорода.Найти(МЗ.РайонGUID, "GUID");
			Если НайденнаяСтрока <> Неопределено Тогда
				ЗаполнитьРайоныИГорода(НайденнаяСтрока);
				ЗаполнитьУлицы(НайденнаяСтрока);
			КонецЕсли;
			
		КонецЕсли;	
		
		//
		Если ЗначениеЗаполнено(МЗ.ГородGUID) Тогда
			
			//
			ТекущийРайонГород_GUID = МЗ.ГородGUID;
			
			//
			НайденнаяСтрока = ТЗ_РайоныИГорода.Найти(МЗ.ГородGUID, "GUID");
			ВремСтруктура = Новый Структура;
			Если НайденнаяСтрока <> Неопределено Тогда
				
				Для каждого Колонка Из ТЗ_РайоныИГорода.Колонки Цикл
					ВремСтруктура.Вставить(Колонка.Имя, НайденнаяСтрока[Колонка.Имя]);
				КонецЦикла;	
				ЗаполнитьРайоныИГорода(НайденнаяСтрока);
				ЗаполнитьУлицы(ВремСтруктура);
			КонецЕсли;
			
		КонецЕсли;	
		
		//
		Если ЗначениеЗаполнено(МЗ.УлицаGUID) Тогда
			
			//
			ТекущаяУлица_GUID = МЗ.УлицаGUID;
			
			//
			НайденнаяСтрока = ТЗ_Улицы.Найти(МЗ.УлицаGUID, "GUID");
			Если НайденнаяСтрока <> Неопределено Тогда
				ЭлементыФормы.ТЗ_Улицы.ТекущаяСтрока = НайденнаяСтрока;
			КонецЕсли;
			
		КонецЕсли;	
		
		//
		Дом = ?(МЗ.Дом = "0", "", МЗ.Дом);
		Корпус = ?(МЗ.Корпус = "0", "", МЗ.Корпус);
		Строение = ?(МЗ.Строение = "0", "", МЗ.Строение);
		
		//
		АдресПредставление = МЗ.АдресПредставление;
		
	КонецЕсли;	
	
КонецПроцедуры

//////////////////////////////////

//
//
Процедура ТЗ_РегионыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	//
	СтандартнаяОбработка = Ложь;
	
	//
	ТекущийРайонГород_GUID = "";
	ТекущаяУлица_GUID = "";
	
	//
	ТЗ_СтэкВыбранныхОбъектов.Очистить();
	ТЗ_РайоныИГорода.Очистить();
	ТЗ_Улицы.Очистить();
	
	//
	ЗаполнитьРайоныИГорода(ВыбраннаяСтрока);
	
	//
	Для Каждого Колонка Из ТЗ_РайоныИГорода.Колонки Цикл
		
		//
		Попытка
			ТЗ_СтэкВыбранныхОбъектов.Колонки.Добавить(Колонка.Имя);
		Исключение
		КонецПопытки;	
		
	КонецЦикла;	
	
КонецПроцедуры

//
//
Процедура ТЗ_РайоныИГородаВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	//
	СтандартнаяОбработка = Ложь;
	
	ГородИзменился = (ВыбраннаяСтрока.guid <> ТекущийРайонГород_GUID);	
	
	Если ГородИзменился Тогда
		//
		ТЗ_Улицы.Очистить();
		
		//
		ТекущаяУлица_GUID = "";
	КонецЕсли; 
	
	
	//
	ЗаполнитьРайоныИГорода(ВыбраннаяСтрока, , ГородИзменился);
	
	
	//
	СформироватьПредставление();
	
КонецПроцедуры

//
//
Процедура ТЗ_РайоныИГородаПриПолученииДанных(Элемент, ОформленияСтрок)
	
	//
	Для Каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		
		//
		ДанныеСтроки = ОформлениеСтроки.ДанныеСтроки;
		
		//
		НайденнаяСтрока = ТЗ_СтэкВыбранныхОбъектов.Найти(ДанныеСтроки.GUID, "GUID");
		Если НайденнаяСтрока <> Неопределено Тогда
			
			//
			ОформлениеСтроки.Ячейки.view.Шрифт = Новый Шрифт(ОформлениеСтроки.Ячейки.view.Шрифт,,,Истина);
			ОформлениеСтроки.Ячейки.view.ЦветФона = WebЦвета.СеребристоСерый;
			
		КонецЕсли;	
		
		//
		Если ДанныеСтроки.GUID = ТекущийРайонГород_GUID Тогда
			
			//
			ОформлениеСтроки.Ячейки.view.Шрифт = Новый Шрифт(ОформлениеСтроки.Ячейки.view.Шрифт,,,Истина);
			ОформлениеСтроки.Ячейки.view.ЦветТекста = WebЦвета.Синий;
			
		КонецЕсли;	
		
	КонецЦикла;	
	
КонецПроцедуры

//
//
Процедура ТЗ_УлицыПриПолученииДанных(Элемент, ОформленияСтрок)
	
	//
	Для Каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		
		//
		ДанныеСтроки = ОформлениеСтроки.ДанныеСтроки;
		
		//
		Если ДанныеСтроки.GUID = ТекущаяУлица_GUID Тогда
			
			//
			ОформлениеСтроки.Ячейки.name.Шрифт = Новый Шрифт(ОформлениеСтроки.Ячейки.name.Шрифт,,,Истина);
			ОформлениеСтроки.Ячейки.name.ЦветТекста = WebЦвета.Синий;
			
		КонецЕсли;	
		
	КонецЦикла;
	
КонецПроцедуры

//
//
Процедура ТЗ_УлицыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	//
	СтандартнаяОбработка = Ложь;
	
	//
	ТекущаяУлица_GUID = ВыбраннаяСтрока.GUID;
	
	//
	СформироватьПредставление();
	 
КонецПроцедуры

//
//
Процедура БезУлицыПриИзменении(Элемент)
	
	СформироватьПредставление();
	
КонецПроцедуры


//////////////////////////////////

//
Процедура ЗаполнитьРайоныИГорода(ВыбраннаяСтрока, ПризнакЭтоВозврат = Ложь, ГородИзменился = Истина)
	
	//
	GUID = ВыбраннаяСтрока.GUID;
	ПризнакЭтоРегион = ВыбраннаяСтрока.ПризнакЭтоРегион;
	ПризнакЭтоРайон = ВыбраннаяСтрока.ПризнакЭтоРайон;
	ПризнакЭтоГород = ВыбраннаяСтрока.ПризнакЭтоГород;
	
	//
	Если НЕ ПризнакЭтоВозврат Тогда
		
		//
		НайденноеЗначение = ТЗ_СтэкВыбранныхОбъектов.Найти(GUID, "GUID");
		Если НайденноеЗначение <> Неопределено Тогда
			
			//
			ТекущийРайонГород_GUID = GUID;
		
			//
			ТЗ_СтэкВыбранныхОбъектов.Удалить(НайденноеЗначение);
			
			//
			Если ТЗ_СтэкВыбранныхОбъектов.Количество() > 0 Тогда
				
				//
				Стэк_СтрокаТЗ = ТЗ_СтэкВыбранныхОбъектов[0];
				ЗаполнитьРайоныИГорода(Стэк_СтрокаТЗ, Истина);
				
				//
				Возврат;
				
			КонецЕсли;	
			
		КонецЕсли;
		
	КонецЕсли;	
	
	//
	Если ПризнакЭтоРегион = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокРайоновИГородовПоРегиону(GUID);
		
	ИначеЕсли ПризнакЭтоРайон = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокРайоновИГородовПоРайону(GUID);
		
	ИначеЕсли ПризнакЭтоГород = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокРайоновИГородовПоГороду(GUID);	
		
	КонецЕсли;	
	
	//
	Если ЛОЖЬ И (ТЗ = Неопределено ИЛИ ТЗ.Количество() = 0) Тогда
		
		//
		ЗаполнитьУлицы(ВыбраннаяСтрока);
		
		//
		Возврат;
		
	Иначе
		
		//
		НайденноеЗначение = ТЗ_СтэкВыбранныхОбъектов.Найти(GUID, "GUID");
		Если НайденноеЗначение = Неопределено Тогда
			
			//
			НоваяСтрока = ТЗ_СтэкВыбранныхОбъектов.Вставить(0);
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыбраннаяСтрока);
			
			//
			ТекущийРайонГород_GUID = GUID;
			
		КонецЕсли;	
		
		//
		Если (ТЗ = Неопределено ИЛИ ТЗ.Количество() = 0) Тогда
			
			//
			ТЗ_РайоныИГорода.Очистить();
			
		Иначе	
			
			//
			ТЗ_РайоныИГорода = ТЗ;
			
		КонецЕсли;	
		
	КонецЕсли;	
	
	//
	СтрокаСтэка = Неопределено;
	Если ТЗ_СтэкВыбранныхОбъектов.Количество() > 0 Тогда
		СтрокаСтэка = ТЗ_СтэкВыбранныхОбъектов[0];
	КонецЕсли;
	
	//
	Если СтрокаСтэка <> Неопределено Тогда
		
		//
		НайденноеЗначение = ТЗ_РайоныИГорода.Найти(СтрокаСтэка.GUID, "GUID");
		Если НайденноеЗначение = Неопределено Тогда
			
			//
			НоваяСтрока = ТЗ_РайоныИГорода.Вставить(0);
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаСтэка); 
			
			//
			НайденноеЗначение = НоваяСтрока;
			
		КонецЕсли;
		
	КонецЕсли;	
	
	//
	ЭлементыФормы.ТЗ_РайоныИГорода.СоздатьКолонки();
	Для Каждого Колонка Из ЭлементыФормы.ТЗ_РайоныИГорода.Колонки Цикл
		Колонка.Видимость = (Колонка.Имя = "view");
		Колонка.ТекстШапки = "Районы/Города";
	КонецЦикла;
	
	//
	НайденноеЗначение = ТЗ_РайоныИГорода.Найти(ТекущийРайонГород_GUID, "GUID");
	Если НайденноеЗначение <> Неопределено Тогда
		
		//
		ЭлементыФормы.ТЗ_РайоныИГорода.ТекущаяСтрока = НайденноеЗначение;
		
		//
		Если ГородИзменился Тогда
			ЗаполнитьУлицы(НайденноеЗначение);			
		КонецЕсли; 
		
	КонецЕсли;
	
КонецПроцедуры	

//
Процедура ЗаполнитьУлицы(Знач ВыбраннаяСтрока)
	
	//
	ТЗ_Улицы.Очистить();
	
	//
	Если ВыбраннаяСтрока.hasStreets <> Истина Тогда
		Возврат;
	КонецЕсли;	
	
	//
	GUID = ВыбраннаяСтрока.GUID;
	ПризнакЭтоРегион = ВыбраннаяСтрока.ПризнакЭтоРегион;
	ПризнакЭтоРайон = ВыбраннаяСтрока.ПризнакЭтоРайон;
	ПризнакЭтоГород = ВыбраннаяСтрока.ПризнакЭтоГород;
	
	//
	Если ПризнакЭтоРегион = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокУлиц(GUID);
		
	ИначеЕсли ПризнакЭтоРайон = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокУлиц(GUID);
		
	ИначеЕсли ПризнакЭтоГород = Истина Тогда
		
		//
		ТЗ = ПолучитьСписокУлиц(GUID);	
		
	КонецЕсли;	
	
	//
	Если ТЗ = Неопределено ИЛИ ТЗ.Количество() = 0 Тогда
		
		
		//
		Возврат;
		
	Иначе
		
		//
		ТЗ_Улицы = ТЗ;
		
	КонецЕсли;	
	
	//
	ЭлементыФормы.ТЗ_Улицы.СоздатьКолонки();
	Для Каждого Колонка Из ЭлементыФормы.ТЗ_Улицы.Колонки Цикл
		Колонка.Видимость = (Колонка.Имя = "name");
		Колонка.ТекстШапки = "Улицы";
	КонецЦикла;
	
КонецПроцедуры	

//////////////////////////////////

//
//
Процедура ПервоначальноеЗаполнение()
	
	//
	ТЗ_СтэкВыбранныхОбъектов.Очистить();
	ТЗ_Регионы.Очистить();
	ТЗ_РайоныИГорода.Очистить();
	ТЗ_Улицы.Очистить();
	
	//
		
	ТЗ_Регионы = ПолучитьСписокРегионов();
	
	//
	ЭлементыФормы.ТЗ_Регионы.СоздатьКолонки();
	Для Каждого Колонка Из ЭлементыФормы.ТЗ_Регионы.Колонки Цикл
		Колонка.Видимость = (Колонка.Имя = "view");
		Колонка.ТекстШапки = "Регионы";
	КонецЦикла;	
	
	//
	Для Каждого Колонка Из ТЗ_Регионы.Колонки Цикл
		
		//
		Попытка
			ТЗ_СтэкВыбранныхОбъектов.Колонки.Добавить(Колонка.Имя);
		Исключение
		КонецПопытки;	
		
	КонецЦикла;
	
КонецПроцедуры 	

Процедура СохранитьАдрес()
	
		//
	МЗ = РегистрыСведений.МЙ_ПоднадзорныеОбъекты.СоздатьМенеджерЗаписи();
	МЗ.СтруктурнаяЕдиница = СтруктурнаяЕдиница;
	МЗ.Организация = НастройкаAPI.Организация;
	
	//
	МЗ.Прочитать();
	
	//
	МЗ.СтруктурнаяЕдиница = СтруктурнаяЕдиница;
	МЗ.Организация = НастройкаAPI.Организация;
	
	//
	Для Каждого СтрокаТЗ Из ТЗ_СтэкВыбранныхОбъектов Цикл
		
		//
		Если СтрокаТЗ.ПризнакЭтоРегион Тогда
			
			//
			МЗ.РегионGUID = СтрокаТЗ.GUID;
			МЗ.РегионUUID = СтрокаТЗ.UUID;
			
		КонецЕсли;	
		
		//
		Если СтрокаТЗ.ПризнакЭтоРайон Тогда
			
			//
			МЗ.РайонGUID = СтрокаТЗ.GUID;
			МЗ.РайонUUID = СтрокаТЗ.UUID;
			
		КонецЕсли;	
		
		//
		Если СтрокаТЗ.ПризнакЭтоГород Тогда
			
			//
			МЗ.ГородGUID = СтрокаТЗ.GUID;
			МЗ.ГородUUID = СтрокаТЗ.UUID;
			
		КонецЕсли;	
		
		//
		Если БезУлицы Тогда
			МЗ.УлицаGUID = "";
			МЗ.УлицаUUID = "";
			
		Иначе
			НайденнаяСтрока = ТЗ_Улицы.Найти(ТекущаяУлица_GUID, "GUID");			
			
			Если  НайденнаяСтрока <> Неопределено Тогда
				МЗ.УлицаGUID = НайденнаяСтрока.GUID;
				МЗ.УлицаUUID = НайденнаяСтрока.UUID;
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЦикла;	
	
	//
	МЗ.Строение = Строение;
	МЗ.Дом = Дом;
	МЗ.Корпус = Корпус;
	
	//
	МЗ.АдресПредставление = АдресПредставление;
	
	//
	МЗ.Записать();

КонецПроцедуры 

//////////////////////////////////

//
//
Процедура ПередОткрытием(Отказ, СтандартнаяОбработка)
	
	//
	ЗаполнитьСписокРегионовПоУмолчанию();
	
	//
	ПервоначальноеЗаполнение();
	
	//
	СтруктурнаяЕдиницаПриИзменении(Неопределено);
	
КонецПроцедуры

//
//
Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	СохранитьАдрес();
	
	//
	Закрыть();
	
КонецПроцедуры

Процедура ОсновныеДействияФормыВыгрузитьВВетис(Кнопка)
	
	СохранитьАдрес();
	
	ВыгрузитьСтруктурнуюЕдиницу(СтруктурнаяЕдиница);
	
	//Закрыть();
	
КонецПроцедуры

Процедура КоманднаяПанельРегионыНастроитьРегионы(Кнопка)
	Форма = ЭтотОбъект.ПолучитьФорму("ФормаВыбораРегионов");
	Форма.ОткрытьМодально();
	
	//
	ПервоначальноеЗаполнение();
	
	//
	СтруктурнаяЕдиницаПриИзменении(Неопределено);

КонецПроцедуры


