//+++АК LAGP 2018.09.13 ИП-00019246 Объект создал Лагерев. Вызов из Справочника "Периодические задания" + возможность ручного формирования.

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("СвойПериод", ЗначениеЗаполнено(ДатаНачалаНаФорме));	
	СтруктураПараметров.Вставить("ДатаНачалаОтчёта", ДатаНачалаНаФорме);
	СтруктураПараметров.Вставить("ДатаОкончанияОтчёта", ?(ЗначениеЗаполнено(ДатаОкончанияНаФорме), ДатаОкончанияНаФорме, ТекущаяДата()));
	СтруктураПараметров.Вставить("ДляТехнологов", ЗначениеЗаполнено(ЭлементыФормы.ТехнологНаФорме.Значение));
	СтруктураПараметров.Вставить("Технолог", ЭлементыФормы.ТехнологНаФорме.Значение);
	СтруктураПараметров.Вставить("РучноеФормирование", Истина);
	
	СформированныйТабДокумент = Обработки.ОтчетПоНедружелюбнойУпаковке.ПолучитьТаблицуДанных(СтруктураПараметров);
	
	ЭлементыФормы.ТабличныйДокумент.Очистить();
	Если ТипЗнч(СформированныйТабДокумент) = Тип("ТабличныйДокумент") Тогда
		ЭлементыФормы.ТабличныйДокумент.Вывести(СформированныйТабДокумент);
	Иначе
		Сообщить("По данному технологу нет данных!");
	КонецЕсли;
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(ДатаНачалаНаФорме, ?(ДатаОкончанияНаФорме='0001-01-01', ДатаОкончанияНаФорме, КонецДня(ДатаОкончанияНаФорме)));
	Если НастройкаПериода.Редактировать() Тогда
		ДатаНачала = НастройкаПериода.ПолучитьДатуНачала();
		ДатаОкончания = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли;
КонецПроцедуры

Процедура ОсновныеДействияФормыМенюРассылкиПисем(Кнопка)
	
	Адреса = "lagp@automacon.ru";
	Подсказка = "Введите e-mail получателей ручной рассылки.";
	ТабДокТело = Новый ТабличныйДокумент;
	
	Если НЕ ЗначениеЗаполнено(ДатаНачалаНаФорме) Тогда
		ТекстДатаНачалаНаФорме = ?(ЗначениеЗаполнено(ЭлементыФормы.ТехнологНаФорме.Значение), НачалоНедели(ТекущаяДата()-14*24*60*60), Формат(ДобавитьМесяц(НачалоМесяца(ТекущаяДата()), -2), "ДФ=dd.MM.yyyy"));
	Иначе
		ТекстДатаНачалаНаФорме = Формат(ДатаНачалаНаФорме, "ДФ=dd.MM.yyyy");
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ДатаОкончанияНаФорме) Тогда
		ТекстДатаОкончанияНаФорме = ?(ЗначениеЗаполнено(ЭлементыФормы.ТехнологНаФорме.Значение), КонецДня(НачалоНедели(ТекущаяДата())-1), Формат(КонецДня(НачалоМесяца(ТекущаяДата())-1), "ДФ=dd.MM.yyyy"));
	Иначе
		ТекстДатаОкончанияНаФорме = Формат(ДатаОкончанияНаФорме, "ДФ=dd.MM.yyyy");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЭлементыФормы.ТехнологНаФорме.Значение) Тогда
		ТекстТехнолог = " (Технолог: " + ЭлементыФормы.ТехнологНаФорме.Значение + ") ";
	Иначе
		ТекстТехнолог = " (общий) ";
	КонецЕсли;	
		
 	Тема = "Отчёт по закупкам в недружелюбной упаковке" + ТекстТехнолог + ТекстДатаНачалаНаФорме + " - " + ТекстДатаОкончанияНаФорме;
	 
	Если ВвестиСтроку(Адреса, Подсказка, 0, Ложь) Тогда	   
		Обработки.ОтчетПоНедружелюбнойУпаковке.ОтправитьПисьмоСВложениемИТелом(Адреса, ЭлементыФормы.ТабличныйДокумент, ТабДокТело, Тема);			
	КонецЕсли;	
	
КонецПроцедуры

Процедура ПриОткрытии()
			
	ADOСоединение = Новый COMОбъект("ADODB.Connection");
	
	парСервер = "10.0.0.40";
	парLogin = Константы.ЛогинSQL.Получить();
	парПароль = Константы.ПарольSQL.Получить();
	ADOСоединение.ConnectionTimeOut = 0;
	ADOСоединение.CommandTimeOut    = 0;
	
	ADOСоединение.ConnectionString  = "SERVER=" + парСервер + "; DRIVER=SQL Server; UID=" + парLogin + "; PWD=" + парПароль + "; OLE DB Services=-2;";
	
	ADOСоединение.Open();
	
	ТекстЗапроса = "
  	|SELECT  
  	|    [FIO]
  	|FROM [Reports].[dbo].[Tovar_Proizv_Tehnolog_tbl] techno
  	|WHERE [_ItsAssistant] = 0 AND techno.FIO <> 'Дербышев Сергей Владимирович' AND techno.FIO <> 'Затинщиков Сергей Александрович,Машкина Олеся Сергеевна' AND techno.FIO <> 'Кузнецова Лариса Владимировна,Широков Максим Алексеевич' AND techno.FIO <> 'Кузьмина Светлана Михайловна' AND techno.FIO <> 'Пурим Марина Марковна,Радченко Мария Леонидовна,Щепин Евгений Владимирович'
  	|GROUP BY [FIO]
  	|ORDER BY [FIO]";
	
	rs = ADOСоединение.Execute(ТекстЗапроса);
		
	Пока rs <> Неопределено И rs.Fields.Count <= 0 Цикл
		rs=rs.NextRecordSet();
	КонецЦикла;
	
	Попытка
		rs.MoveFirst();
		
		Пока НЕ rs.EOF() Цикл
			ЭлементыФормы.ТехнологНаФорме.СписокВыбора.Добавить(Rs.Fields("FIO").Value);
			rs.MoveNext();
		КонецЦикла;
	Исключение
	КонецПопытки;
	ADOСоединение.Close();
	ADOСоединение = Неопределено;
	
КонецПроцедуры
