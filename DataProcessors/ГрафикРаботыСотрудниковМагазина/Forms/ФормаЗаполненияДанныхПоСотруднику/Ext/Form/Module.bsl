
&НаКлиенте
Процедура РаботаИлиОтсутствиеПриИзменении(Элемент)
	
	Если РаботаИлиОтсутствие = 1 Тогда
		Отсутствие = ПредопределенноеЗначение("Перечисление.ВидыОтсутствия.ПустаяСсылка");	
	Иначе
		ТорговаяТочка = ПредопределенноеЗначение("Справочник.СтруктурныеЕдиницы.ПустаяСсылка");
		СвойствоПродавца = 0;
	КонецЕсли;
	
	УстановитьВидимостьЭлементов();
	УстановитьДоступностьЭлементов();
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("Сотрудник")Тогда
		Сотрудник = Параметры.Сотрудник;
	КонецЕсли;
	
	Если Параметры.Свойство("ТорговаяТочка")Тогда
		ТорговаяТочка = Параметры.ТорговаяТочка;
	КонецЕсли;
	
	Если Параметры.Свойство("Отсутствие")Тогда
		Отсутствие = Параметры.Отсутствие;
	КонецЕсли;
	
	Если Параметры.Свойство("СвойствоПродавца")Тогда
		СвойствоПродавца = Параметры.СвойствоПродавца;
	КонецЕсли;
	
	Если Параметры.Свойство("КоличествоЧасов")Тогда
		КоличествоЧасовПочасовика = Параметры.КоличествоЧасов;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Отсутствие)Тогда
		РаботаИлиОтсутствие = 1;
		Элементы.ТорговаяТочка.АктивизироватьПоУмолчанию = Истина;
	Иначе
		РаботаИлиОтсутствие = 2;
		Элементы.ПричинаОтсутствия.АктивизироватьПоУмолчанию = Истина;
	КонецЕсли;
	
	УстановитьВидимостьЭлементов();
	УстановитьДоступностьЭлементов();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьЭлементов()
	
	Элементы.ТорговаяТочка.Видимость = (РаботаИлиОтсутствие = 1);
	Элементы.ПричинаОтсутствия.Видимость = (РаботаИлиОтсутствие = 2);
	Элементы.КоличествоЧасовПочасовика.Видимость = СвойствоПродавца = 1 И (ТорговаяТочка.ТипРозничнойТочки = Перечисления.ТипыРозничныхТочек.Магазин);
	
КонецПроцедуры

&НаСервере
Процедура УстановитьДоступностьЭлементов()
	
	Элементы.СвойствоПродавца.Доступность = (РаботаИлиОтсутствие = 1) И ЗначениеЗаполнено(ТорговаяТочка);
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьИзменения(Команда)
	
	Если Не ПроверитьЗаполнение()Тогда
		Возврат;
	КонецЕсли;
	
	Если РаботаИлиОтсутствие = 1 И Не ЗначениеЗаполнено(ТорговаяТочка) Тогда
		
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст= НСтр("ru = 'Не заполнена торговая точка'");
		Сообщение.Поле = "ТорговаяТочка";
		Сообщение.Сообщить();
		Возврат;
		
	КонецЕсли;
	
	Если РаботаИлиОтсутствие = 2 И Не ЗначениеЗаполнено(Отсутствие) Тогда
		
		Сообщение = Новый СообщениеПользователю();
		Сообщение.Текст= НСтр("ru = 'Не заполнена причина отсутствия'");
		Сообщение.Поле = "Отсутствие";
		Сообщение.Сообщить();
		Возврат;
		
	КонецЕсли;
	
	//+++ziga 26.10.2017
	Если РаботаИлиОтсутствие=2 или РаботаИлиОтсутствие=1 Тогда 
		Если Не ПолучитьАктивный(Сотрудник) Тогда
		Ответ = Вопрос("Сотрудник "+Сотрудник.Наименование+" не активный, сделать активным?", РежимДиалогаВопрос.ДаНет);
		Если (Ответ = КодВозвратаДиалога.Да) Тогда
			ИзменитьСотрудникаСервер(Сотрудник);
		КонецЕсли;		
		КонецЕсли; 	
	КонецЕсли;
	//---ziga 26.10.2017
	СтруктураВозврата = Новый Структура;
	
	СтруктураВозврата.Вставить("Сотрудник", 		Сотрудник);
	СтруктураВозврата.Вставить("ТорговаяТочка", 	ТорговаяТочка);
	СтруктураВозврата.Вставить("Отсутствие", 		Отсутствие);
	СтруктураВозврата.Вставить("СвойствоПродавца", 	СвойствоПродавца);
	
	КоличествоЧасов = ?(СвойствоПродавца = 1 И ЭтоМагазин(), КоличествоЧасовПочасовика, 0);
	СтруктураВозврата.Вставить("КоличествоЧасов", КоличествоЧасов);	
	
	Закрыть(СтруктураВозврата);
	
КонецПроцедуры
//+++ziga 30.10.2017
&НаСервере
Процедура ИзменитьСотрудникаСервер(Сотр)
	Сотр=Сотрудник.Получитьобъект();
	Сотр.Активный=Истина;
	Сотр.записать();
КонецПроцедуры
&НаСервере
Функция ПолучитьАктивный(Сотр)
	Запрос=Новый Запрос;
	Запрос.Текст="ВЫБРАТЬ
	             |	ФизическиеЛица.Активный
	             |ИЗ
	             |	Справочник.ФизическиеЛица КАК ФизическиеЛица
	             |ГДЕ
	             |	ФизическиеЛица.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка",Сотр);
	Выборка=Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Возврат	Выборка.Активный;	
	КонецЦикла; 	
	
КонецФункции

//---ziga 30.10.2017

&НаКлиенте
Процедура ТорговаяТочкаПриИзменении(Элемент)
	
	УстановитьВидимостьЭлементов();
	УстановитьДоступностьЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура ТорговаяТочкаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ПараметрыОтбора = Новый Структура("ГоловноеПодразделение", ГруппаТорговыхТочек);
	Результат = ОткрытьФормуМодально("Обработка.ГрафикРаботыПродавцов_ТЗ.Форма.ФормаВыбораСтруктурнойЕдиницы", ПараметрыОтбора);
	Если ЗначениеЗаполнено(Результат)Тогда
		ТорговаяТочка = Результат;
	КонецЕсли;
	
	УстановитьВидимостьЭлементов();
	УстановитьДоступностьЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура СвойствоПродавцаПриИзменении(Элемент)
	
	Если СвойствоПродавца <> 1 Тогда
		КоличествоЧасовПочасовика = 0;
	КонецЕсли;
	
	УстановитьВидимостьЭлементов();
	
КонецПроцедуры

&НаСервере
Функция ЭтоМагазин()
	
	Возврат ТорговаяТочка.ТипРозничнойТочки = Перечисления.ТипыРозничныхТочек.Магазин;	
	
КонецФункции







