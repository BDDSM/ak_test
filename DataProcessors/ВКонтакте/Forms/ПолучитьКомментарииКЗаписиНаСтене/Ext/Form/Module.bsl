
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Объект.access_token = РаботаССайтомВКонтакте.access_tokenПолучить();
	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьФайл(Команда)
	
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Если Диалог.Выбрать() Тогда
		Объект.file_name = Диалог.ПолноеИмяФайла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьЗаписи(Команда)
	
	Попытка
		МассивКомментариев = РаботаССайтомВКонтакте.ПолучитьКомментарииКЗаписиНаСтене(Объект.access_token, Объект.owner_id, Формат(Объект.post_id, "ЧГ="));
		ЗаполнитьКомментарииНаСервере(МассивКомментариев);
	Исключение
		Сообщить("Ошибка при получении комментариев к записи на стене: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьКомментарииНаСервере(МассивКомментариев)
	
	Объект.Комментарии.Очистить();
	
	// создаём реквизиты
	ДобавляемыеРеквизиты = Новый Массив;
	СтруктураРеквизитов = МассивКомментариев[0];
	Для Каждого КлючИЗначение Из СтруктураРеквизитов Цикл
		ТипДобавляемогоЗначения = ?(КлючИЗначение.Значение = Неопределено, "Строка", Строка(ТипЗнч(КлючИЗначение.Значение)));
		Если КлючИЗначение.Ключ = "date" Тогда ТипДобавляемогоЗначения = "Дата"; КонецЕсли;
		ДобавляемыеРеквизиты.Добавить(Новый РеквизитФормы(КлючИЗначение.Ключ, Новый ОписаниеТипов(ТипДобавляемогоЗначения), "Объект.Комментарии"));
	КонецЦикла;
	
	// пакетное создание и удаление
	Попытка
		ИзменитьРеквизиты(ДобавляемыеРеквизиты);
		
		// создаём элементы
		Для Каждого КлючИЗначение Из СтруктураРеквизитов Цикл
			Элемент = Элементы.Добавить(КлючИЗначение.Ключ, Тип("ПолеФормы"), Элементы.Комментарии); 
			Элемент.Вид = ВидПоляФормы.ПолеВвода;
			Элемент.ПутьКДанным = "Объект.Комментарии." + КлючИЗначение.Ключ;
		КонецЦикла;
	Исключение КонецПопытки;
	
	Для Каждого СтруктураКомментарий Из МассивКомментариев Цикл
		НоваяСтрокаТЧ = Объект.Комментарии.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаТЧ, СтруктураКомментарий);
		Если СтруктураКомментарий.Свойство("date") Тогда
			НоваяСтрокаТЧ.date = МестноеВремя(РаботаСВнешнимВебСервером.ПолучитьДатуВремяИзUnixTime(СтруктураКомментарий.date));
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
