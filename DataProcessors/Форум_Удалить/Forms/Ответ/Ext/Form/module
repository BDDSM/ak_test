
Процедура ЗаполнитьФайлы()
	
	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Тема"		, ЭтаФорма.Тема);
	Запрос.УстановитьПараметр("НомерПоста"	, ЭтаФорма.НомерПоста);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ФорумФайлы.ЭтоКартинка,
	|	ФорумФайлы.ИмяФайла,
	|	ФорумФайлы.ПолноеИмяФайла,
	|	ФорумФайлы.Файл,
	|	ФорумФайлы.Размер,
	|	ЛОЖЬ КАК Новый
	|ИЗ
	|	РегистрСведений.ФорумФайлы КАК ФорумФайлы
	|ГДЕ
	|	ФорумФайлы.Объект = &Тема
	|	И ФорумФайлы.Номер = &НомерПоста";
	
	//
	ЭтаФорма.ФорумФайлы = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры


Процедура ПриОткрытии()
	
	Если ЗначениеЗаполнено(ЭтаФорма.НомерПоста) Тогда
		ЗаполнитьФайлы();
	КонецЕсли;
	
КонецПроцедуры


Процедура КоманднаяПанель1ВставитьФайл(Кнопка)
	
	СтрФ = ЭтаФорма.ФорумФайлы.ВыбратьСтроку("Выберите файл");
	Если СтрФ = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	//
	Имя = СтрФ.ИмяФайла;
	Если СтрФ.ЭтоКартинка Тогда
		Если Вопрос("Вставить картинку? (нет - вставить файл)", РежимДиалогаВопрос.ДаНет,, КодВозвратаДиалога.Да) = КодВозвратаДиалога.Да Тогда
			Имя = "#IMG_" + Имя + "#";
		Иначе	
			Имя = "#FILE_" + Имя + "#";
		КонецЕсли;	
	Иначе	
		Имя = "#FILE_" + Имя + "#";
	КонецЕсли;	
	ЭлементыФормы.ПолеHTMLДокумента1.Документ.Selection.createRange().text = Имя;
	
КонецПроцедуры

Процедура КоманднаяПанель2ДобавитьФайл(Кнопка)
	
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогОткрытияФайла.ПолноеИмяФайла		= "";
	ДиалогОткрытияФайла.Фильтр				= "Любые файлы(*.*)|*.*";
	ДиалогОткрытияФайла.МножественныйВыбор	= Ложь;
	ДиалогОткрытияФайла.Заголовок			= "Выберите файл";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
		МасФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
		Для каждого ТекФайл из МасФайлов Цикл
			ПутьКФайлу = ТекФайл;
		конецЦикла;
	КонецЕсли;
	Если СокрЛП(ПутьКФайлу) = "" Тогда 
		Сообщить("Не выбран файл !", СтатусСообщения.Важное);
		Возврат;
	КонецЕсли;
	
	Файл = Новый Файл(ПутьКФайлу);
	Если НЕ Файл.Существует() Тогда 
		Сообщить("Не выбран файл !", СтатусСообщения.Важное);
		Возврат;
	КонецЕсли;
	
	Попытка
		АватарП = Новый Картинка(ПутьКФайлу);
		Если АватарП.Формат() <> ФорматКартинки.НеизвестныйФормат Тогда
			ЭтоКартинка = Истина;
		Иначе
			ЭтоКартинка = Ложь;
		КонецЕсли;	
	Исключение
	    ЭтоКартинка = Ложь;
	КонецПопытки;
		
	
	ИмяФайла = Прав(ДиалогОткрытияФайла.ПолноеИмяФайла, СтрДлина(ДиалогОткрытияФайла.ПолноеИмяФайла) - СтрДлина(ДиалогОткрытияФайла.Каталог));
	ИмяФайла = СтрЗаменить(ИмяФайла, "_", "");
	
	//
	НоваяСтрока = ЭтаФорма.ФорумФайлы.Добавить();
	НоваяСтрока.ЭтоКартинка 	= ЭтоКартинка;
	НоваяСтрока.ИмяФайла 		= ИмяФайла;
	НоваяСтрока.ПолноеИмяФайла 	= ПутьКФайлу;
	НоваяСтрока.Размер 			= Файл.Размер();
	НоваяСтрока.Новый 			= Истина;
	
КонецПроцедуры

Процедура КоманднаяПанель2УдалитьФайл(Кнопка)
	
	Если ЭлементыФормы.ТабличноеПоле1.ТекущаяСтрока <> Неопределено Тогда
		ЭтаФорма.ФорумФайлы.Удалить(ЭлементыФормы.ТабличноеПоле1.ТекущаяСтрока);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОК(Кнопка)
	
	Если НЕ ЗначениеЗаполнено(ЭтаФорма.НомерПоста) Тогда
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Тема", ЭтаФорма.Тема);
		Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	МАКСИМУМ(Форум.Номер) КАК Номер
		|ИЗ
		|	РегистрСведений.Форум КАК Форум
		|ГДЕ
		|	Форум.Тема = &Тема";
		
		ТЗ = Запрос.Выполнить().Выгрузить();
		
	КонецЕсли;
	
	ТекстПоста = ЭлементыФормы.ПолеHTMLДокумента1.Документ.body.innerHTML;
	
	Запись = РегистрыСведений.Форум.СоздатьМенеджерЗаписи();
	Запись.Пост  	= ТекстПоста;
	Запись.Период 	= ТекущаяДата();
	Запись.Тема 	= ЭтаФорма.Тема;
	Запись.Автор 	= ЭтаФорма.Пользователь;
	Если НЕ ЗначениеЗаполнено(ЭтаФорма.НомерПоста) Тогда
		Если ТЗ.Количество() Тогда
			Запись.Номер = ТЗ[0].Номер;
			Запись.Номер = Запись.Номер + 1;
		Иначе
			Запись.Номер = 1;
		КонецЕсли;	
	Иначе
		Запись.Номер = ЭтаФорма.НомерПоста;
	КонецЕсли;	
	
	Запись.Записать();
	
	
	// регистр "ФорумФайлы" - добавить
	РегФорумФайлы = РегистрыСведений.ФорумФайлы;
	Для Каждого СтрокаТаблицы Из ЭтаФорма.ФорумФайлы Цикл
		Если НЕ СтрокаТаблицы.Новый Тогда
			Продолжить;
		КонецЕсли;	
		ЗаписьФ = РегФорумФайлы.СоздатьМенеджерЗаписи();
		ЗаписьФ.Объект 			= ЭтаФорма.Тема;
		ЗаписьФ.ИмяФайла 		= СтрокаТаблицы.ИмяФайла;
		ЗаписьФ.ЭтоКартинка 	= СтрокаТаблицы.ЭтоКартинка;
		ЗаписьФ.Номер 			= Запись.Номер;
		ЗаписьФ.Размер 			= СтрокаТаблицы.Размер;
		ЗаписьФ.КоличествоСкачиваний = 0;
		ЗаписьФ.ПолноеИмяФайла 	= СтрЗаменить("" + ЭтаФорма.Тема.Код + ЗаписьФ.Номер + СтрокаТаблицы.ИмяФайла, " ", "");
		ЗаписьФ.Файл 			= Новый ХранилищеЗначения(Новый ДвоичныеДанные(СтрокаТаблицы.ПолноеИмяФайла), Новый СжатиеДанных(6));
		ЗаписьФ.Записать();
	КонецЦикла;	
	
	//
	СпрОбФорум = ЭтаФорма.Тема.ПолучитьОбъект();
	СпрОбФорум.КоличествоПостов 	= СпрОбФорум.КоличествоПостов + 1;
	СпрОбФорум.ДатаПоследнегоПоста 	= Запись.Период;
	СпрОбФорум.АвторПоследнегоПоста = ЭтаФорма.Пользователь;
	СпрОбФорум.НомерПоследнегоПоста = Запись.Номер;
	СпрОбФорум.ПоследнийПост 		= ТекстПоста;
	СпрОбФорум.Записать();
	
	//
	СпрОбЮзер = ЭтаФорма.Пользователь.ПолучитьОбъект();
	СпрОбЮзер.КоличествоСообщений = СпрОбЮзер.КоличествоСообщений + 1;
	СпрОбЮзер.Записать();
	
	//
	ОбработкаФорум.ТекущаяТема = ЭтаФорма.Тема;
	ОбработкаФорум.СформироватьУведомления();

	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Тема"		, ЭтаФорма.Тема);
	Запрос.УстановитьПараметр("НомерПоста"	, Запись.Номер);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ФорумФайлы.ЭтоКартинка,
	|	ФорумФайлы.ИмяФайла,
	|	ФорумФайлы.ПолноеИмяФайла,
	|	ФорумФайлы.Размер,
	|	ЛОЖЬ КАК Новый
	|ИЗ
	|	РегистрСведений.ФорумФайлы КАК ФорумФайлы
	|ГДЕ
	|	ФорумФайлы.Объект = &Тема
	|	И ФорумФайлы.Номер = &НомерПоста";
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		МассивСтрок = ЭтаФорма.ФорумФайлы.НайтиСтроки(Новый Структура("ЭтоКартинка, ИмяФайла", Выборка.ЭтоКартинка, Выборка.ИмяФайла));
		Удалять = Ложь;
		Если МассивСтрок = Неопределено Тогда //файла из регистра нет в таблице файлов
			Удалять = Истина;
		Иначе
			Если НЕ МассивСтрок.Количество() Тогда
				Удалять = Истина;
			КонецЕсли;
		КонецЕсли;	
		Если Удалять Тогда
			ЗаписьФайлы = РегФорумФайлы.СоздатьМенеджерЗаписи();
			ЗаписьФайлы.Объект 		= ЭтаФорма.Тема;
			ЗаписьФайлы.ЭтоКартинка = Выборка.ЭтоКартинка;
			ЗаписьФайлы.Номер 		= ЗаписьФайлы.Номер;
			ЗаписьФайлы.ИмяФайла 	= Выборка.ИмяФайла;
			ЗаписьФайлы.Прочитать();
			Если ЗаписьФайлы.Выбран() Тогда
				ЗаписьФайлы.Удалить();
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;
	
	Если НЕ ЭтаФорма.ВладелецФормы = Неопределено Тогда
		Если НЕ ТипЗнч(ЭтаФорма.ВладелецФормы) = Тип("ТабличноеПоле") Тогда
			ЭтаФорма.ВладелецФормы.НомерПоста = ЭтаФорма.Тема.КоличествоПостов + 1;
			ЭтаФорма.ВладелецФормы.Обновить1(0);
			ЭтаФорма.ВладелецФормы.Активизировать();
		КонецЕсли;
	КонецЕсли;
	
	//
	ЭтаФорма.Закрыть(Истина);
	
КонецПроцедуры

Процедура ОсновныеДействияФормыЗакрыть(Кнопка)
	
	ЭтаФорма.Закрыть(Ложь);
	
КонецПроцедуры
