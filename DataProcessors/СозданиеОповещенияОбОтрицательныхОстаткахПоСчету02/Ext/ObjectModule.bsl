
Функция ПолучитьТабличныйДокумент(мЗаголовокОтчета)
	
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ОтрицательныеОстаткиПоСчету02";
	
	мСхемаКомпоновкиДанных = ЭтотОбъект.ПолучитьМакет("Макет");
	
	// Настройки
	мНастройкиОтчета = мСхемаКомпоновкиДанных.ВариантыНастроек.Получить(0).Настройки;
	мНастройкиОтчета.ПараметрыВывода.УстановитьЗначениеПараметра("Заголовок", мЗаголовокОтчета);
	
	// Макет компоновки
	мКомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	мМакетКомпоновки = мКомпоновщикМакета.Выполнить(мСхемаКомпоновкиДанных, мНастройкиОтчета);	
	
	// Компоновка данных
	мПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	мПроцессорКомпоновки.Инициализировать(мМакетКомпоновки);	
	
	// Вывод на форму
	мПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	мПроцессорВывода.УстановитьДокумент(ТабДокумент);
	мПроцессорВывода.Вывести(мПроцессорКомпоновки, Истина);
	
	Возврат ТабДокумент;
	
КонецФункции

Процедура ПослатьОповещение() Экспорт
	
	ТекстПисьма = "Отрицательные остатки по счету 02.1 на " + Формат(ТекущаяДата(), "ДЛФ=Д");
	
	ТабДокумент = ПолучитьТабличныйДокумент(ТекстПисьма);
	Если ТабДокумент.КоличествоСтраниц() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	мИмяФайла = КаталогВременныхФайлов() + ТекстПисьма + ".xls";
	Попытка
		ТабДокумент.Записать(мИмяФайла, ТипФайлаТабличногоДокумента.XLS); 
	Исключение
		Возврат;
	КонецПопытки;
	
	
	УчетнаяЗапись = ОбщиеПроцедуры.ПолучитьУчетнуюЗаписьДляРассылки();  // no-reply@vkusvill.ru
	
	Почта = Новый ИнтернетПочта;
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
	Письмо = Новый ИнтернетПочтовоеСообщение;
	Попытка
		Почта.Подключиться(Профиль);
		Письмо.Тема 			= ТекстПисьма;
		Письмо.ИмяОтправителя  	= СокрЛП(УчетнаяЗапись.Наименование);
		Письмо.Отправитель     	= Письмо.ИмяОтправителя;
		Получатель = Письмо.Получатели.Добавить();
		Получатель.Адрес           = "zamgb@vkusvill.ru";
		Получатель.ОтображаемоеИмя = "Наталия Ларина";
		
		ТекстСообщения = Письмо.Тексты.Добавить();
		ТекстСообщения.Текст     = ТекстПисьма;
		ТекстСообщения.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
		

		Письмо.Вложения.Добавить(мИмяФайла, ТекстПисьма);
		
		
		Почта.Послать(Письмо);
		Почта.Отключиться();
		
	Исключение
		Сообщить(ОписаниеОшибки());
	КонецПопытки;
	
	ВременныйФайл = Новый Файл(мИмяФайла);
	Если ВременныйФайл.Существует() Тогда
		Попытка
		    УдалитьФайлы(мИмяФайла);
		Исключение
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры
