
&НаСервере
Процедура ЗаполнитьНаСервере()
		
	ТекстЗапроса="ВЫБРАТЬ
	             |	СтруктурныеЕдиницы.Ссылка КАК Точка,
	             |	ВидыВложенийВКонверты.Ссылка КАК ВидВложения
	             |ПОМЕСТИТЬ ВсеТочкиИВложения
	             |ИЗ
	             |	Справочник.СтруктурныеЕдиницы КАК СтруктурныеЕдиницы,
	             |	Справочник.ВидыВложенийВКонверты КАК ВидыВложенийВКонверты
	             |ГДЕ
	             |	СтруктурныеЕдиницы.СтатусТорговойТочки = ЗНАЧЕНИЕ(Перечисление.СтатусыТорговыхТочек.Открыт)
	             |	И ВидыВложенийВКонверты.Актуально
	             |	И НЕ ВидыВложенийВКонверты.ПометкаУдаления
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	МАКСИМУМ(НАЧАЛОПЕРИОДА(РеестрПолученныхКонвертовВложения.Ссылка.Дата, ДЕНЬ)) КАК ДатаПолучения,
	             |	РеестрПолученныхКонвертовВложения.ВидВложения,
	             |	РеестрПолученныхКонвертовВложения.Магазин
	             |ПОМЕСТИТЬ Последние
	             |ИЗ
	             |	Документ.РеестрПолученныхКонвертов.Вложения КАК РеестрПолученныхКонвертовВложения
	             |ГДЕ
	             |	РеестрПолученныхКонвертовВложения.Ссылка.Проведен
	             |	И РеестрПолученныхКонвертовВложения.Ссылка.Дата < &НаДату
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	РеестрПолученныхКонвертовВложения.ВидВложения,
	             |	РеестрПолученныхКонвертовВложения.Магазин
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ВсеТочкиИВложения.Точка,
	             |	ВсеТочкиИВложения.ВидВложения,
	             |	Последние.ДатаПолучения КАК ДатаПолучения,
	             |	ВЫБОР
	             |		КОГДА ВсеТочкиИВложения.ВидВложения.ПериодичностьПолученияДеньМесяца <> 0
	             |			ТОГДА ВЫБОР
	             |					КОГДА Последние.ДатаПолучения ЕСТЬ NULL
	             |						ТОГДА ВЫБОР
	             |								КОГДА ДЕНЬ(&НаДату) = ВсеТочкиИВложения.ВидВложения.ПериодичностьПолученияДеньМесяца
	             |									ТОГДА &НаДату
	             |								ИНАЧЕ ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(&НаДату, МЕСЯЦ), ДЕНЬ, ВсеТочкиИВложения.ВидВложения.ПериодичностьПолученияДеньМесяца - 1)
	             |							КОНЕЦ
	             |					ИНАЧЕ ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(Последние.ДатаПолучения, МЕСЯЦ, 1), МЕСЯЦ), ДЕНЬ, ВсеТочкиИВложения.ВидВложения.ПериодичностьПолученияДеньМесяца - 1)
	             |				КОНЕЦ
	             |		КОГДА ВсеТочкиИВложения.ВидВложения.ПериодичностьПолучения <> 0
	             |			ТОГДА ВЫБОР
	             |					КОГДА Последние.ДатаПолучения ЕСТЬ NULL
	             |						ТОГДА &НаДату
	             |					ИНАЧЕ ДОБАВИТЬКДАТЕ(Последние.ДатаПолучения, ДЕНЬ, ВсеТочкиИВложения.ВидВложения.ПериодичностьПолучения)
	             |				КОНЕЦ
	             |		ИНАЧЕ ДАТАВРЕМЯ(1, 1, 1)
	             |	КОНЕЦ КАК ДолжноПрийти
	             |ПОМЕСТИТЬ План
	             |ИЗ
	             |	ВсеТочкиИВложения КАК ВсеТочкиИВложения
	             |		ЛЕВОЕ СОЕДИНЕНИЕ Последние КАК Последние
	             |		ПО ВсеТочкиИВложения.Точка = Последние.Магазин
	             |			И ВсеТочкиИВложения.ВидВложения = Последние.ВидВложения
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	НАЧАЛОПЕРИОДА(РеестрПолученныхКонвертовВложения.Ссылка.Дата, ДЕНЬ) КАК ДатаПолучения,
	             |	РеестрПолученныхКонвертовВложения.Дата КАК ДатаОтправки,
	             |	РеестрПолученныхКонвертовВложения.ВидВложения КАК ВидВложения,
	             |	РеестрПолученныхКонвертовВложения.Магазин КАК Магазин,
	             |	НАЧАЛОПЕРИОДА(РеестрПолученныхКонвертовВложения.Ссылка.Дата, ДЕНЬ) > РеестрПолученныхКонвертовВложения.Дата КАК ПришлоСОпозданием
	             |ПОМЕСТИТЬ АктуальныеДанные
	             |ИЗ
	             |	Документ.РеестрПолученныхКонвертов.Вложения КАК РеестрПолученныхКонвертовВложения
	             |ГДЕ
	             |	РеестрПолученныхКонвертовВложения.Ссылка.Дата МЕЖДУ &ДатаС И &ДатаПо
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ЕСТЬNULL(План.Точка, АктуальныеДанные.Магазин) КАК Магазин,
	             |	ЕСТЬNULL(План.ВидВложения, АктуальныеДанные.ВидВложения) КАК ВидВложения,
	             |	План.ДатаПолучения КАК ДатаПредыдущегоПолучения,
	             |	План.ДолжноПрийти,
	             |	АктуальныеДанные.ДатаОтправки,
	             |	АктуальныеДанные.ПришлоСОпозданием,
	             |	АктуальныеДанные.ДатаПолучения,
	             |	ЛОЖЬ КАК Пометка,
	             |	ЕСТЬNULL(План.Точка.АдресЭлектроннойПочты, АктуальныеДанные.Магазин.АдресЭлектроннойПочты) КАК Почта
	             |ИЗ
	             |	План КАК План
	             |		ПОЛНОЕ СОЕДИНЕНИЕ АктуальныеДанные КАК АктуальныеДанные
	             |		ПО План.Точка = АктуальныеДанные.Магазин
	             |			И План.ВидВложения = АктуальныеДанные.ВидВложения
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Магазин";
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ДатаС",Дата);
	Запрос.УстановитьПараметр("НаДату",Дата);
	Запрос.УстановитьПараметр("ДатаПо",КонецДня(Дата));
	ТЗ = Запрос.Выполнить().Выгрузить();
	ЗначениеВРеквизитФормы(ТЗ,"ТабПолученных");
КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	ЗаполнитьНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Дата = ТекущаяДата();
КонецПроцедуры

&НаКлиенте
Процедура ОтметитьВсе(Команда)
	Для Каждого Стр ИЗ ТабПолученных Цикл
		Стр.Пометка = Истина;
	КонецЦикла;	
КонецПроцедуры

&НаКлиенте
Процедура СнятьПометки(Команда)
	Для Каждого Стр ИЗ ТабПолученных Цикл
		Стр.Пометка = Ложь;
	КонецЦикла;	
КонецПроцедуры

&НаСервере
Процедура ОтправитьПисьмаОбОтклоненияхНаСервере()
	ТабОтмеченных = ТабПолученных.Выгрузить(Новый Структура("Пометка",Истина));
	ТЗточек = ТабОтмеченных.Скопировать();
	ТЗТочек.Свернуть("Магазин,Почта");
	Для Каждого СтрМагазина ИЗ ТЗТочек Цикл
		Если Не ЗначениеЗаполнено(СтрМагазина.Почта) Тогда
			Продолжить;
		КонецЕсли;	
		СписокКому = Новый СписокЗначений;
		
		СписокКому.Добавить("pozm@automacon.ru");
		СписокКому.Добавить(СтрМагазина.Почта);
				
				
		УчетнаяЗапись = ОбщиеПроцедуры.ПолучитьУчетнуюЗаписьДляРассылки();
				
		Почта = Новый ИнтернетПочта;
		Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчетнаяЗапись);
		Письмо = Новый ИнтернетПочтовоеСообщение;
			
		Почта.Подключиться(Профиль);
		Письмо.Тема = "Отчет по вложениям";
		Письмо.ИмяОтправителя 	= "" + УчетнаяЗапись + "";
		Письмо.ИмяОтправителя  	= "" + СокрЛП(УчетнаяЗапись) + "";
		Письмо.Отправитель     	= "" + СокрЛП(УчетнаяЗапись) + "";
		Для Каждого ПолучательЭлемент Из СписокКому Цикл
			Получатель = Письмо.Получатели.Добавить();
			Получатель.Адрес = ПолучательЭлемент.Значение;
		КонецЦикла;	
				
		ТекстСообщения = Письмо.Тексты.Добавить();
		ТекстСообщения.Текст     = "Во вложении находится по вложениям за "+Формат(Дата,"ДФ=dd.MM.yyyy");
		СтрокиМагазина = ТабОтмеченных.Скопировать(Новый Структура("Магазин",СтрМагазина.Магазин));
		
		Построитель = Новый ПостроительОтчета;
    	Построитель.ИсточникДанных = Новый ОписаниеИсточникаДанных(СтрокиМагазина);
		//Построитель.МакетОформления = ПолучитьМакетОформления(СтандартноеОформление.Асфальт);
		Построитель.ВыводитьЗаголовокОтчета = Ложь;
		Построитель.Выполнить();
		
		//Для каждого Колонка Из Построитель.ВыбранныеПоля Цикл
		//	Колонка.Представление = СтрокиМагазина.Получить(Колонка.Имя).Заголовок;
		//КонецЦикла; 
		ТабДок = Новый ТабличныйДокумент;
		Построитель.Вывести(ТабДок);
		
		ИмяФайла=Новый УникальныйИдентификатор;
		ИмяФайла=КаталогВременныхФайлов()+ИмяФайла+".pdf";
		
		ТабДок.ОриентацияСтраницы=ОриентацияСтраницы.Портрет;
		ТабДок.АвтоМасштаб = Истина;
		
		ТабДок.Записать(ИмяФайла,ТипФайлаТабличногоДокумента.PDF);
		
		Письмо.Вложения.Добавить(ИмяФайла);
				
		ТекстСообщения.ТипТекста = ТипТекстаПочтовогоСообщения.ПростойТекст;
			
		Почта.Послать(Письмо);
		Почта.Отключиться();
	КонецЦикла;	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьПисьмаОбОтклонениях(Команда)
	ОтправитьПисьмаОбОтклоненияхНаСервере();
КонецПроцедуры
