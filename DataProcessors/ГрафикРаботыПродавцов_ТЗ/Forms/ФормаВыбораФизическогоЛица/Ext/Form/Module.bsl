
&НаКлиенте
Процедура Выбрать(Команда)
	
	ТекДанные = Элементы.Список.ТекущиеДанные;
	
	//+++АК mika 2018.05.24 ИП-00018578
	Если ТекДанные <> Неопределено И НЕ ЗначениеЗаполнено(ТекДанные.ПомощникТУ) Тогда
		ПоказатьПредупреждение(,"Запрещено добавлять в график сотрудников с не указанным Помощником ТУ!");
		Возврат;
	КонецЕсли;
	//---АК mika
	
	Закрыть(ТекДанные.ФизЛицо);
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Список.Параметры.УстановитьЗначениеПараметра("ФизЛицо", Параметры.ТекущийПомощник);
	
	//+++АК mika 2018.01.09 ИП-00016863.01
	//Установка отбора по всем "Помощникам ТУ" 
	Если Параметры.Свойство("ВсеПомощники") Тогда
		
		Отбор = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных")); 
		Отбор.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("ФизЛицо"); 
		Отбор.ВидСравнения 		= ВидСравненияКомпоновкиДанных.ВСписке; 
		Отбор.Использование 	= Истина; 
		Отбор.РежимОтображения 	= РежимОтображенияЭлементаНастройкиКомпоновкиДанных.БыстрыйДоступ;
		Отбор.ПравоеЗначение 	= ПолучитьСписокПомощниковТУ();

	    ЭтаФорма.Список.ТекстЗапроса = СтрЗаменить(ЭтаФорма.Список.ТекстЗапроса, "ФизическиеЛица.Ссылка <> &ФизЛицо", "Истина");

		Параметры.ТекущийПомощник = Неопределено;
		
		Элементы.СписокКоманднаяПанель.ПодчиненныеЭлементы.СписокОтключитьОтбор.Видимость = Ложь;
		
		Элементы.Список.Отображение = ОтображениеТаблицы.Список;

	КонецЕсли;
	//---АК mika ИП-00016863.01
	
	//Установка отбора по доступным "Помощнику ТУ" сотрудникам
	Если ЗначениеЗаполнено(Параметры.ТекущийПомощник) Тогда
		Отбор = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных")); 
		Отбор.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("ФизЛицо.ПомощникТУ"); 
		Отбор.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно; 
		Отбор.Использование 	= Истина; 
		Отбор.РежимОтображения 	= РежимОтображенияЭлементаНастройкиКомпоновкиДанных.БыстрыйДоступ;
		Отбор.ПравоеЗначение 	= Параметры.ТекущийПомощник;
	КонецЕсли;

	// Открытие из формы передачи помощнику ТТ
	Если Параметры.Адрес <> "" Тогда
		
		СписокЗначений = Новый СписокЗначений;
		СписокЗначений.ЗагрузитьЗначения(ПолучитьИзВременногоХранилища(Параметры.Адрес).ВыгрузитьКолонку("Значение"));
		
		Отбор = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных")); 
		Отбор.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("ФизЛицо"); 
		Отбор.ВидСравнения 		= ВидСравненияКомпоновкиДанных.ВСписке; 
		Отбор.Использование 	= Истина; 
		Отбор.РежимОтображения 	= РежимОтображенияЭлементаНастройкиКомпоновкиДанных.БыстрыйДоступ;
		Отбор.ПравоеЗначение 	= СписокЗначений;
		
	Иначе
		
		//mind попросил Валера отключить
		//Отбор = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных")); 
		//Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ЦФО"); 
		//Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно; 
		//Отбор.Использование = Истина; 
		//Отбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.БыстрыйДоступ;
		//Отбор.ПравоеЗначение = Параметры.ЦФО;
		
	КонецЕсли;
	
	//+++ЗНК Zionek 2018.11.16 ИП-00020474
	Если Параметры.Свойство("ПоказыватьКодФизическогоЛица") И Параметры.ПоказыватьКодФизическогоЛица Тогда
		Элементы.СписокКод.Видимость = Истина;
	КонецЕсли;
	
	Если Параметры.Свойство("ОтображатьПоиск") И Параметры.ОтображатьПоиск Тогда
		Элементы.ДополнениеСтрокаПоиска.Видимость = Истина;
		ТекущийЭлемент = Элементы.Список;
	КонецЕсли;
	//---ЗНК Zionek 2018.11.16 ИП-00020474
	
КонецПроцедуры

&НаКлиенте
Процедура СписокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекДанные = Элементы.Список.ТекущиеДанные;
	
	//+++АК mika 2018.05.24 ИП-00018578
	Если ТекДанные <> Неопределено И НЕ ЗначениеЗаполнено(ТекДанные.ПомощникТУ) Тогда
		СтандартнаяОбработка = Ложь;
		ПоказатьПредупреждение(,"Запрещено добавлять в график сотрудников с не указанным Помощником ТУ!");
		Возврат;
	КонецЕсли;
	//---АК mika

	Закрыть(ТекДанные.ФизЛицо);	
	
КонецПроцедуры

&НаКлиенте
Процедура ОтключитьОтбор(Команда)
	
	Элементы.СписокОтключитьОтбор.Доступность = Ложь;
	ОчиститьОтборыНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьОтборыНаСервере()
	
	Список.Отбор.Элементы.Очистить();
	
КонецПроцедуры

&НаСервере
// Функция возвращает перечень помощников торговых управляющих
//
// Возвращаемое значение:
//   <Тип.Массив>   - Массив ссылок физических лиц
//
Функция ПолучитьСписокПомощниковТУ()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РолиПользователейСоставРоли.Сотрудник КАК ПомощникУправляющего
	|ИЗ
	//+++ AK suvv 2018.06.08 ИП-00018376.01
	//|	РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаСреза, ТипРоли = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыРолейПользователя.ПомощникТерриториальногоУправляющего)) КАК СоответствиеОбъектРольСрезПоследних
	|	РегистрСведений.СоответствиеОбъектРоль.СрезПоследних(&ДатаСреза, ТипРоли = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыРолейПользователя.ПомощникТерриториальногоУправляющего) или ТипРоли = ЗНАЧЕНИЕ(ПланВидовХарактеристик.ТипыРолейПользователя.ПомощникСтороннейРозницы)) КАК СоответствиеОбъектРольСрезПоследних
	//--- AK suvv
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
	|		ПО СоответствиеОбъектРольСрезПоследних.РольПользователя = РолиПользователейСоставРоли.Ссылка
	|ГДЕ
	|	НЕ РолиПользователейСоставРоли.Сотрудник ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	РолиПользователейСоставРоли.Сотрудник";
	
	Запрос.УстановитьПараметр("ДатаСреза", ТекущаяДата());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		Возврат РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("ПомощникУправляющего");
		
	КонецЕсли;
	
	Возврат Справочники.ФизическиеЛица.ПустаяСсылка();
	
КонецФункции // ПолучитьСписокПомощниковТУ()
 
