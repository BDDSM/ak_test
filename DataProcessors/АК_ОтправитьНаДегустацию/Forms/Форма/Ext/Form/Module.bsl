
&НаКлиенте
Процедура ОтправитьНаДегустацию(Команда)
	ОтправитьНаДегустациюНаСервере();
	ЗаполнитьСписок();
КонецПроцедуры

&НаСервере
Процедура ОтправитьНаДегустациюНаСервере()
	Отбор = Новый Структура("Пометка", Истина);
	МассивОтбора = ТабНоменклатуры.НайтиСтроки(Отбор);
	Для каждого СтрокаСписка Из МассивОтбора Цикл
		НоваяЗапись = РегистрыСведений.АК_ЗаданияНаДегустациюНочные.СоздатьМенеджерЗаписи();
		НоваяЗапись.Номенклатура = СтрокаСписка.Номенклатура;
		НоваяЗапись.Характеристика = СтрокаСписка.Характеристика;
		НоваяЗапись.ДатаРегистрации = ТекущаяДата();
		НоваяЗапись.ДатаПроизводства = СтрокаСписка.ДатаПроизводства;
		НоваяЗапись.Комментарий = СтрокаСписка.Комментарий;
		НоваяЗапись.Записать(Истина);
	КонецЦикла; 
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСписок()
	ВремТаб = ТабНоменклатуры.Выгрузить();
	Отбор = Новый Структура("Пометка", Истина);
	МассивОтбора = ВремТаб.НайтиСтроки(Отбор);
	
	ТабНоменклатуры.Очистить();
	
	ТабНоменклатуры.Загрузить(ВремТаб);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	АК_ЗаданияНаДегустациюНочные.Номенклатура,
		|	АК_ЗаданияНаДегустациюНочные.Характеристика,
		|	АК_ЗаданияНаДегустациюНочные.ДатаРегистрации,
		|	АК_ЗаданияНаДегустациюНочные.ДатаПроизводства,
		|	АК_ЗаданияНаДегустациюНочные.Комментарий,
		|	АК_ЗаданияНаДегустациюНочные.ДатаДегустации,
		|	АК_ЗаданияНаДегустациюНочные.Результат
		|ИЗ
		|	РегистрСведений.АК_ЗаданияНаДегустациюНочные КАК АК_ЗаданияНаДегустациюНочные
		|ГДЕ
		|	АК_ЗаданияНаДегустациюНочные.ДатаРегистрации МЕЖДУ &ДатаНачала И &ДатаОкончания";
	
	Если Фильтр = 3 Тогда
		Запрос.Текст = Запрос.Текст + "
		|	И АК_ЗаданияНаДегустациюНочные.ДатаДегустации = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)";
	ИначеЕсли Фильтр = 2 Тогда
		Запрос.Текст = Запрос.Текст + "
		|	И Не АК_ЗаданияНаДегустациюНочные.ДатаДегустации = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)";
	КонецЕсли; 
	
	Запрос.Текст = Запрос.Текст + "
		|УПОРЯДОЧИТЬ ПО
		|	АК_ЗаданияНаДегустациюНочные.ДатаРегистрации УБЫВ";
		
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	
	ТабНоменклатуры.Загрузить(Запрос.Выполнить().Выгрузить());
	
	Для каждого СтрокаМассива Из МассивОтбора Цикл
		НоваяСтрока = ТабНоменклатуры.Вставить(0);
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаМассива);
	КонецЦикла; 
	
КонецПроцедуры
 

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Не ЗначениеЗаполнено(ДатаНачала) Тогда
		ДатаНачала = НачалоМесяца(ТекущаяДата());
	КонецЕсли; 
	Если Не ЗначениеЗаполнено(ДатаОкончания) Тогда
		ДатаОкончания = ТекущаяДата();
	КонецЕсли; 
	
	Фильтр = 3;
	
	ЗаполнитьСписок();
	
КонецПроцедуры

&НаКлиенте
Процедура ТабНоменклатурыПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	Элемент.ТекущиеДанные.Пометка = Истина;
	Элемент.ТекущиеДанные.ДатаРегистрации = ТекущаяДата();
КонецПроцедуры

&НаКлиенте
Процедура ФильтрПриИзменении(Элемент)
	ЗаполнитьСписок();
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	ЗаполнитьСписок();

КонецПроцедуры

&НаКлиенте
Процедура ТабНоменклатурыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Если Не Элемент.ТекущиеДанные.Пометка = Истина Тогда
		СтандартнаяОбработка = Ложь;
		Возврат;
	КонецЕсли; 
КонецПроцедуры
