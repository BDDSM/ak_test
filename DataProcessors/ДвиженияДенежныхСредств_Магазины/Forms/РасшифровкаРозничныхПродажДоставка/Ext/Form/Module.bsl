
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ
	               |	ПерсоналККМ.Ссылка,
	               |	ПерсоналККМ.Код
	               |ИЗ
	               |	Справочник.ПерсоналККМ КАК ПерсоналККМ";
				   
	ТабКеш = Запрос.Выполнить().Выгрузить();
	
	ОбъектОбр = РеквизитФормыВЗначение("Объект");
	Макет = ОбъектОбр.ПолучитьМакет("РасшифровкаРозничныхПродаж");
	
	Область = Макет.ПолучитьОбласть("Шапка");
	Область.Параметры.ДатаОтчета = Формат(Параметры.ДатаРасшифровки, "ДФ=dd.MM.yyyy");
	Область.Параметры.Касса = Формат(Параметры.Касса, "ДФ=dd.MM.yyyy");
	ТабДокумент.Вывести(Область);
	
	ADOСоединение = ВнешниеДанные.ПолучитьADOСоединение();
	
	ИмяБд = "SMS_Repl";
	НомерМагазина = ВнешниеДанные.ФорматПоля(ПараметрыСеанса.НомерТочкиПоАйпи);
	
	ЗапросСкуль = "SELECT 
				|      Checks.CloseDate as CloseDate,
				|      Checks.CashierID as CashierID
				|      , Checks.SumCash * CASE WHEN Checks.OperationType = 1 THEN 1 ELSE 0 END as Prihod
				|      , Checks.SumCash * CASE WHEN Checks.OperationType = 3 THEN 1 ELSE 0 END as Rashod
				|      
				|  FROM " + ИмяБд + ".[dbo].[Checks] as Checks (nolock)
				|  WHERE Checks.closedate >= " + ВнешниеДанные.ФорматПоля(НачалоДня(Параметры.ДатаРасшифровки)) + " and Checks.closedate <= " + ВнешниеДанные.ФорматПоля(КонецДня(Параметры.ДатаРасшифровки)) + "
				//+++АК ILIK 2018.06.25 ИП-00018883
				//|	and Checks.SumCash <> 0 and Checks.ShopNo_rep = " + НомерМагазина + " and isnull(Checks.N_terminal, '') <> '' and Checks.cashid = " + ВнешниеДанные.ФорматПоля(Параметры.Касса);
				|	and Checks.SumCash <> 0 and Checks.ShopNo_rep = " + НомерМагазина + " and 1 <> 1 and Checks.cashid = " + ВнешниеДанные.ФорматПоля(Параметры.Касса);
				//---АК ILIK
				
	Попытка			
		Выборка = ADOСоединение.Execute(ЗапросСкуль);
		
		Выборка.MoveFirst();
		Пока НЕ Выборка.EOF() Цикл
			Область = Макет.ПолучитьОбласть("Строка");
			Область.Параметры.ДатаОперации = Выборка.Fields("CloseDate").Value;
			СтрокаКешПродавец = ТабКеш.Найти(Прав("0000000000" + ВнешниеДанные.ФорматПоля(Выборка.Fields("CashierID").Value), 10));
			Если СтрокаКешПродавец <> Неопределено Тогда
				Область.Параметры.Продавец = СтрокаКешПродавец.Ссылка;
			КонецЕсли;	
			Область.Параметры.ДатаОперации = Выборка.Fields("CloseDate").Value;
			Область.Параметры.СуммаПриход = Выборка.Fields("Prihod").Value;
			Область.Параметры.СуммаРасход = Выборка.Fields("Rashod").Value;
			ТабДокумент.Вывести(Область);
			Выборка.MoveNext();
		КонецЦикла;	
	Исключение
	КонецПопытки;
	
КонецПроцедуры
