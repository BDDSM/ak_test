
Процедура ОшибкиПриПолученииДанных(Элемент, ОформленияСтрок)
	
	МассивДоговоров = Новый Массив;
	Для Каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		
		ТекущийДоговор = ОформлениеСтроки.ДанныеСтроки.ДоговорКонтрагента;
		Если МассивДоговоров.Найти(ТекущийДоговор) = Неопределено Тогда
			МассивДоговоров.Добавить(ТекущийДоговор);
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ДоговорыКонтрагентовСоставСтруктурныхЕдиниц.Ссылка КАК ДоговорКонтрагента,
	|	ДоговорыКонтрагентовСоставСтруктурныхЕдиниц.СтруктурнаяЕдиница,
	|	ДоговорыКонтрагентовСоставСтруктурныхЕдиниц.КонецПериодаНачисления
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов.СоставСтруктурныхЕдиниц КАК ДоговорыКонтрагентовСоставСтруктурныхЕдиниц
	|ГДЕ
	|	ДоговорыКонтрагентовСоставСтруктурныхЕдиниц.Ссылка В(&МассивДоговоров)");
	
	Запрос.УстановитьПараметр("МассивДоговоров", МассивДоговоров);
	ТаблицаДанных = Запрос.Выполнить().Выгрузить();
	
	Для Каждого ОформлениеСтроки Из ОформленияСтрок Цикл
		
		ДанныеСтроки = ОформлениеСтроки.ДанныеСтроки;
		НайденныеСтроки = ТаблицаДанных.НайтиСтроки(Новый Структура("ДоговорКонтрагента, СтруктурнаяЕдиница", ДанныеСтроки.ДоговорКонтрагента, ДанныеСтроки.СтруктурнаяЕдиница));
		Если НайденныеСтроки.Количество()Тогда
			ОформлениеСтроки.Ячейки.НачислятьПо.УстановитьТекст(Формат(НайденныеСтроки[0].КонецПериодаНачисления, "ДФ=dd.MM.yyyy"));	
		Иначе
			ОформлениеСтроки.Ячейки.НачислятьПо.УстановитьТекст("");
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОшибкиВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	Если Колонка.Имя = "ДоговорКонтрагента" Тогда
		Форма = ВыбраннаяСтрока.ДоговорКонтрагента.ПолучитьФорму();
		Форма.ОткрытьМодально();
		ЭлементыФормы.Ошибки.ОбновитьСтроки();
		
	ИначеЕсли Колонка.Имя = "СтруктурнаяЕдиница" Тогда
		Форма = ВыбраннаяСтрока.СтруктурнаяЕдиница.ПолучитьФорму();
		Форма.ОткрытьМодально();
		
	ИначеЕсли Колонка.Имя = "НачислятьПо" Тогда
		ВыбранноеЗначение = Дата(1,1,1);
		Если ВвестиЗначение(ВыбранноеЗначение, "Введите дату окончания начисления", Новый ОписаниеТипов("Дата",,,,, Новый КвалификаторыДаты(ЧастиДаты.Дата)))Тогда
			
			ДоговорОбъект = ВыбраннаяСтрока.ДоговорКонтрагента.ПолучитьОбъект();
			
			НайденныеСтроки = ДоговорОбъект.СоставСтруктурныхЕдиниц.НайтиСтроки(Новый Структура("СтруктурнаяЕдиница", ВыбраннаяСтрока.СтруктурнаяЕдиница));
			Для Каждого Стр Из НайденныеСтроки Цикл
				Стр.КонецПериодаНачисления = ВыбранноеЗначение;
			КонецЦикла;
			
			Попытка
				ДоговорОбъект.Записать();
			Исключение КонецПопытки;
			
			ЭлементыФормы.Ошибки.ОбновитьСтроки();
			
		КонецЕсли;
		
	КонецЕсли;
	
	
КонецПроцедуры

Процедура ОсновныеДействияФормыЗакрытьФорму(Кнопка)
	Закрыть();
КонецПроцедуры
