
&НаКлиенте
Процедура Печать(Команда)
	//Фл=Ложь;	
	//Попытка
	//	ЗагрузитьВнешнююКомпоненту("NameDecl.dll");
	//	Компонента = Новый("AddIn.NameDeclension");
	//Исключение
	//   Фл=Истина;
	//КонецПопытки;
	//Если Фл Тогда
	//	Попытка
	//		УстановитьВнешнююКомпоненту("ОбщийМакет.КомпонентаNameDecl");
	//		ПодключитьВнешнююКомпоненту("ОбщийМакет.КомпонентаNameDecl", "Склонение", ТипВнешнейКомпоненты.Native);
	//		Компонента = Новый("AddIn.Склонение.NameDeclension");
	//	Исключение
	//		Сообщить("Не удалось установить компоненту склонения");
	//		Фл=Ложь;
	//	КонецПопытки;
	//КонецЕсли; 
	
    ФИОДир="";
	ФИОКлиента="";
	ПолучитьФИО(ФИОДир,ФИОКлиента);
	ОбщиеПроцедуры.ПросклонятьФИО(ФИОДир, 2,,ФИОДир);
	//ОбщиеПроцедуры.ПросклонятьФИО(ФИОКлиента, 2,,ФИОКлиента);
	ТабДок = ПечатьДопСоглашение(ФИОДир,ФИОКлиента,Объект.Организация,Объект.Контрагент,Объект.ДоговорКонтрагента);
  	Если ТабДок = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ТабДок.ОтображатьСетку 		= Ложь;
	ТабДок.Защита 				= Ложь;
	ТабДок.ТолькоПросмотр 		= Истина;
	ТабДок.ОтображатьЗаголовки 	= Ложь;
	ТабДок.Показать();
	Наим=СокрЛП(Объект.Контрагент);
	Наим=СтрЗаменить(Наим,"""","");
	Наим=СтрЗаменить(Наим,"\","");
	Наим=СтрЗаменить(Наим,"/","");
	Наим=СтрЗаменить(Наим,"|","");
	Наим=СтрЗаменить(Наим,":","");
	Наим=СтрЗаменить(Наим,"*","");
	Наим=СтрЗаменить(Наим,">","");
	Наим=СтрЗаменить(Наим,"<","");
	Наим=СтрЗаменить(Наим,"?","");
	ПутьКПапке=РаботаСДиалогамиКлиент.ПолучитьПапкуКонтрагента(Наим);
	НаименФайла=ПутьКПапке+"\Договор транспортных услуг "+Наим+".docx"; 
	ТабДок.Записать(НаименФайла,ТипФайлаТабличногоДокумента.DOCX);
КонецПроцедуры

&НаСервере
Процедура ПолучитьФИО(ФИОДир,ФИОКлиента)
	Руководители 		= ОбщегоНазначения.ОтветственныеЛица(Объект.Организация, ТекущаяДата(),);
	
	ФИОДир = Строка(Руководители.Руководитель);
	
	ФИОКлиента = Объект.Контрагент.ГенеральныйДиректор;

КонецПроцедуры

&НаСервере
Функция ПечатьДопСоглашение(ФИОДир,ФИОКлиента,ВыбОрганизация,ВыбКонтрагент,ВыбДоговорКонтрагента) Экспорт 

	
//	
	ТабДокумент = Новый ТабличныйДокумент;
  
	Макет = Обработки.ПечатьДоговораТранспортныхУслуг.ПолучитьМакет("Договор");
  
	СведенияОПокупателе = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыбКонтрагент, ТекущаяДата());
	СведенияОПоставщике = УправлениеКонтактнойИнформацией.СведенияОЮрФизЛице(ВыбОрганизация, ТекущаяДата());
	Руководители 		= ОбщегоНазначения.ОтветственныеЛица(ВыбОрганизация, ТекущаяДата());
//	
//	//Вывод
//	
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	ОбластьМакета.Параметры.Организация = СведенияОПоставщике.ПолноеНаименование;
	
	Контрагент=	?(Врег(Лев(СведенияОПокупателе.ПолноеНаименование,2))="ИП","Индивидуальный предприниматель"+Сред(СведенияОПокупателе.ПолноеНаименование,3),СведенияОПокупателе.ПолноеНаименование);
	ОбластьМакета.Параметры.Клиент		= Контрагент;
	ОбластьМакета.Параметры.ДатаДог = Формат(ВыбДоговорКонтрагента.Дата,"ДЛФ=DD");
	ОбластьМакета.Параметры.ДатаДействия = Формат(ВыбДоговорКонтрагента.СрокДействия,"ДЛФ=DD");
	ОбластьМакета.Параметры.НомерДог		= ВыбДоговорКонтрагента.Номер;
	
	ОснованиеКлиент="";                            
	Если ВыбКонтрагент.ЮрФизЛицо=Перечисления.ЮрФизЛицо.ФизЛицо Тогда
		ОснованиеКлиент="серия "+?(Найти(ВыбКонтрагент.СвидетельствоСерияНомер,"№")>0,ВыбКонтрагент.СвидетельствоСерияНомер,СтрЗаменить(ВыбКонтрагент.СвидетельствоСерияНомер," "," №"))+", выданного "+Формат(ВыбКонтрагент.СвидетельствоДатаВыдачи,"ДЛФ=DD");
	КонецЕсли; 
	ОбластьМакета.Параметры.ОснованиеКлиент		= ОснованиеКлиент;
	//	
	ОбластьМакета.Параметры.ФИОДир = ФИОДир;
	
	
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("Подвал");
	ОбластьМакета.Параметры.Организация = СведенияОПоставщике.НаименованиеСокращенное;
	ОбластьМакета.Параметры.Покупатель		= СведенияОПокупателе.ПолноеНаименование;
	
	ФИОДир = Руководители.Руководитель;
	МасФИО=Справочники.Контрагенты.РазложитьСтрокуВМассивПодстрок(ФИОДир," ");
	Для каждого Эл Из МасФИО Цикл
	   Эл=СокрЛП(Эл);
	КонецЦикла; 
	ФИОДир=""+?(МасФИО.Количество()>1,Лев(МасФИО[1],1)+".","")+?(МасФИО.Количество()>2,Лев(МасФИО[2],1)+".","")+" "+МасФИО[0];
	ОбластьМакета.Параметры.ФИОДир = ФИОДир;
	
	
	                                                                        
	ФИОКлиента = СведенияОПокупателе.Представление;
	
	МасФИО=Справочники.Контрагенты.РазложитьСтрокуВМассивПодстрок(ФИОКлиента," ");
	Для каждого Эл Из МасФИО Цикл
	   Эл=СокрЛП(Эл);
	КонецЦикла; 
	ФИОКлиента=""+?(МасФИО.Количество()>1,Лев(МасФИО[1],1)+".","")+?(МасФИО.Количество()>2,Лев(МасФИО[2],1)+".","")+" "+МасФИО[0];
	ОбластьМакета.Параметры.ФИОКлиента = ФИОКлиента;
	
	ОбластьМакета.Параметры.ИННОрганизация = СведенияОПоставщике.ИНН;
	ОбластьМакета.Параметры.ИННПокупатель		= СведенияОПокупателе.ИНН;
	
	
	СтрКорреспондент= "Р/с " + СведенияОПоставщике.НомерСчета;	
	СтрБанк 		= ""+СведенияОПоставщике.Банк + " " + СведенияОПоставщике.Банк.Город;
	СтрБик 			= "БИК " + СведенияОПоставщике.Банк.Код;
	СтрКС			= "К/с " + СведенияОПоставщике.Банк.КоррСчет;
	ОбластьМакета.Параметры.НомерСчетаПоставщика 	= СтрКорреспондент;
	ОбластьМакета.Параметры.БанкПоставщика 			= СтрБанк;
	ОбластьМакета.Параметры.БИКПоставщика 					= СтрБИК;
	ОбластьМакета.Параметры.КСПоставщика 					= СтрКС;
	ОбластьМакета.Параметры.ЮридическийАдрес 					= СведенияОПоставщике.ЮридическийАдрес;
	
	
	
	СтрКорреспондент= "Р/с " + СведенияОПокупателе.НомерСчета;	
	СтрБанк 		= ""+СведенияОПокупателе.Банк + " " + СведенияОПокупателе.Банк.Город;
	СтрБик 			= "БИК " + СведенияОПокупателе.Банк.Код;
	СтрКС			= "К/с " + СведенияОПокупателе.Банк.КоррСчет;
	ОбластьМакета.Параметры.НомерСчетаПолучателя 	= СтрКорреспондент;
	ОбластьМакета.Параметры.БанкПолучателя 			= СтрБанк;
	ОбластьМакета.Параметры.БИКПолучателя 				= СтрБИК; 
	ОбластьМакета.Параметры.КСПолучателя  					= СтрКС;
	ОбластьМакета.Параметры.ЮридическийАдресКлиента 					= СведенияОПокупателе.ЮридическийАдрес;
	
	
	//Руководители 		= ОбщегоНазначения.ОтветственныеЛица(ВыбОрганизация, ТекущаяДата(),);
	//ФИОДир = Руководители.Руководитель;
	//Факсимиле=Справочники.Факсимиле.НайтиПоРеквизиту("ФизЛицо",ФИОДир);
	//Если ЗначениеЗаполнено(Факсимиле) Тогда
	//	ДД=Факсимиле.Подпись.Получить();
	//	Если ТипЗнч(ДД)=Тип("Картинка") Тогда
	//		//Картинка = Новый Картинка(ДД); 
	//		ОбластьМакета.Рисунки.Факсимиле.Картинка = ДД; 
	//	КонецЕсли; 
	//КонецЕсли; 
	
	ТабДокумент.Вывести(ОбластьМакета);
	
    ТабДокумент.ИмяПараметровПечати="ПечатьДоговораТранспортныхУслуг";
	ТабДокумент.АвтоМасштаб = Истина;
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;



	Возврат ТабДокумент;
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ЗаполнитьЗначенияСвойств(Объект,Параметры);
КонецПроцедуры


&НаКлиенте
Процедура ЗаполнитьТабДоговоров(Команда)
	ЗаполнитьТабДоговоровСервер();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТабДоговоровСервер()
	ТекстЗапроса="ВЫБРАТЬ
	             |	РасходИзБанка.Организация КАК Организация,
	             |	РасходИзБанка.Контрагент КАК Контрагент,
	             |	РасходИзБанка.ДоговорКонтрагента КАК Договор
	             |ИЗ
	             |	Документ.РасходИзБанка КАК РасходИзБанка
	             |ГДЕ
	             |	РасходИзБанка.Проведен
	             |	И (РасходИзБанка.Организация = &Организация
	             |			ИЛИ &ПоВсемОрганизациям)
	             |	И РасходИзБанка.СтатьяДвиженияДенежныхСредств = &СтатьяДвиженияДенежныхСредств
	             |	И РасходИзБанка.Оплачено
	             |	И РасходИзБанка.Дата МЕЖДУ &ДатаС И &ДатаПо
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	РасходИзБанка.Организация,
	             |	РасходИзБанка.ДоговорКонтрагента,
	             |	РасходИзБанка.Контрагент
	             |
	             |УПОРЯДОЧИТЬ ПО
	             |	Организация,
	             |	Контрагент,
	             |	РасходИзБанка.ДоговорКонтрагента";
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.УстановитьПараметр("ДатаС",Период.ДатаНачала);
	Запрос.УстановитьПараметр("ДатаПо",КонецДня(Период.ДатаОкончания));
	Запрос.УстановитьПараметр("Организация",Организация);
	Если ЗначениеЗаполнено(Организация) Тогда
		Запрос.УстановитьПараметр("ПоВсемОрганизациям",Ложь);
	Иначе
		Запрос.УстановитьПараметр("ПоВсемОрганизациям",Истина);
	КонецЕсли;	
	Запрос.УстановитьПараметр("СтатьяДвиженияДенежныхСредств",СтатьяДДС);
	Таб=Запрос.Выполнить().Выгрузить();
	ЗначениеВРеквизитФормы(Таб,"ТабДоговоров");
КонецПроцедуры	


&НаКлиенте
Процедура СохранитьДоговоры(Команда)
	Для Каждого Стр Из ТабДоговоров Цикл
		ФИОДир="";
		ФИОКлиента="";
		ПолучитьФИОДляОрганизацииИКонтрагента(ФИОДир,ФИОКлиента,Стр.Организация,Стр.Контрагент);
		ОбщиеПроцедуры.ПросклонятьФИО(ФИОДир, 2,,ФИОДир);
		ТабДок = ПечатьДопСоглашение(ФИОДир,ФИОКлиента,Стр.Организация,Стр.Контрагент,Стр.Договор);
		Если ТабДок = Неопределено Тогда
			Продолжить;
		КонецЕсли;

		ТабДок.ОтображатьСетку 		= Ложь;
		ТабДок.Защита 				= Ложь;
		ТабДок.ТолькоПросмотр 		= Истина;
		ТабДок.ОтображатьЗаголовки 	= Ложь;
		//ТабДок.Показать();
		Наим=СокрЛП(Стр.Контрагент);
		Наим=СтрЗаменить(Наим,"""","");
		Наим=СтрЗаменить(Наим,"\","");
		Наим=СтрЗаменить(Наим,"/","");
		Наим=СтрЗаменить(Наим,"|","");
		Наим=СтрЗаменить(Наим,":","");
		Наим=СтрЗаменить(Наим,"*","");
		Наим=СтрЗаменить(Наим,">","");
		Наим=СтрЗаменить(Наим,"<","");
		Наим=СтрЗаменить(Наим,"?","");
		//ПутьКПапке=РаботаСДиалогамиКлиент.ПолучитьПапкуКонтрагента(Наим);
		НаименФайла=ПутьКПапке+"\Договор транспортных услуг "+Наим+".docx"; 
		ТабДок.Записать(НаименФайла,ТипФайлаТабличногоДокумента.DOCX);	
	КонецЦикла	
	

КонецПроцедуры
&НаСервере
Процедура ПолучитьФИОДляОрганизацииИКонтрагента(ФИОДир,ФИОКлиента,Организация,Контрагент)
	Руководители 		= ОбщегоНазначения.ОтветственныеЛица(Организация, ТекущаяДата(),);
	
	ФИОДир = Строка(Руководители.Руководитель);
	
	ФИОКлиента = Контрагент.ГенеральныйДиректор;

КонецПроцедуры


&НаКлиенте
Процедура ПутьКПапкеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.МножественныйВыбор = Ложь;
	ДиалогОткрытияФайла.Заголовок = "Выберите папку";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
	    ПутьКПапке=ДиалогОткрытияФайла.Каталог;
	Иначе
	    Текст = "ru = ""Каталог не выбран!""; en = ""File(s) not selected!""";
	    Предупреждение(НСтр(Текст));
КонецЕсли;

КонецПроцедуры

