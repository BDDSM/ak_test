
//+++АК sole 2018.08.29 ИП-00018320.11
&НаКлиенте
Процедура СформироватьПисьмо(Команда)
	
	Перем мТекстПисьмаHTML;
	
	Если ЗначениеЗаполнено(ЭтаФорма.КлиентИмяФайлаЛого) Тогда
		УдалитьФайлы(ЭтаФорма.КлиентИмяФайлаЛого);
	КонецЕсли;
	
	ддСтруктура = СформироватьПисьмо_НаСервере();	
	
	ЭтаФорма.КлиентИмяФайлаЛого = ПолучитьИмяВременногоФайла("png");
	
	//+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлена печать в тело письма
	//дд.Записать(ЭтаФорма.КлиентИмяФайлаЛого);
	ддСтруктура.ддЛого.Записать(ЭтаФорма.КлиентИмяФайлаЛого);
	
	ЭтаФорма.КлиентИмяФайлаПечать = ПолучитьИмяВременногоФайла("png");
	ддСтруктура.ддПечать.Записать(ЭтаФорма.КлиентИмяФайлаПечать);
	//---АК LAGP
	
	мТекстПисьмаHTML = Объект.ТекстПисьмаHTML;
	мТекстПисьмаHTML = СтрЗаменить(мТекстПисьмаHTML, "@Logo", 	ЭтаФорма.КлиентИмяФайлаЛого);
	мТекстПисьмаHTML = СтрЗаменить(мТекстПисьмаHTML, "@Stamp", 	ЭтаФорма.КлиентИмяФайлаПечать); //+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлена печать в тело письма
	ЭтаФорма.КлиентТекстПисьмаHTML = мТекстПисьмаHTML;
	
	УстановитьДоступностьКнопкиОтправить();
	
КонецПроцедуры

//+++АК sole 2018.08.29 ИП-00018320.11
&НаСервере
Функция СформироватьПисьмо_НаСервере()
	
	Перем ОбъектОбработки;
	
	ЗаполнитьВложенияПриходныхОрдеров(); //+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлены вложения приходных ордеров в письмо
	
	Если ЗначениеЗаполнено(Объект.ИмяФайлаЛого) Тогда
		УдалитьФайлы(Объект.ИмяФайлаЛого);	
	КонецЕсли;	
	
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	ОбъектОбработки.СформироватьПисьмо();
	ЗначениеВРеквизитФормы(ОбъектОбработки,"Объект");
	
	ддЛого 		= Новый ДвоичныеДанные(ОбъектОбработки.ИмяФайлаЛого);
	ддПечать 	= Новый ДвоичныеДанные(ОбъектОбработки.ИмяФайлаПечать); //+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлена печать в тело письма
	
	Возврат Новый Структура("ддЛого, ддПечать", ддЛого, ддПечать);  //+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлена печать в тело письма
	
КонецФункции

//+++АК sole 2018.08.29 ИП-00018320.11
&НаКлиенте
Процедура ПриЗакрытии()
	Если ЗначениеЗаполнено(ЭтаФорма.КлиентИмяФайлаЛого) Тогда
		УдалитьФайлы(ЭтаФорма.КлиентИмяФайлаЛого);
	КонецЕсли;	
	ПриЗакрытии_НаСервере();	
КонецПроцедуры

//+++АК sole 2018.08.29 ИП-00018320.11
&НаСервере
Процедура ПриЗакрытии_НаСервере()
	
	Если ЗначениеЗаполнено(Объект.ИмяФайлаЛого) Тогда
		УдалитьФайлы(Объект.ИмяФайлаЛого);	
	КонецЕсли;	

КонецПроцедуры

//+++АК sole 2018.08.30 ИП-00018320.11
&НаКлиенте
Процедура ДокументОснованиеПриИзменении(Элемент)
	
	ДокументОснованиеПриИзменении_НаСервере();	
	
КонецПроцедуры

//+++АК sole 2018.08.30 ИП-00018320.11
&НаСервере
Процедура ДокументОснованиеПриИзменении_НаСервере()
	
	Перем ОбъектОбработки;
	
	Объект.ТекстПисьмаHTML = "";
	ЭтаФорма.КлиентТекстПисьмаHTML = "";
	
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	ОбъектОбработки.ЗаполнитьРеквизитыПоДокументуОснованию();
	ЗначениеВРеквизитФормы(ОбъектОбработки,"Объект");
	
	УстановитьДоступностьКнопкиОтправить();
	
КонецПроцедуры

//+++АК sole 2018.08.30 ИП-00018320.11
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьДоступностьКнопкиОтправить();
	
КонецПроцедуры

//+++АК sole 2018.08.30 ИП-00018320.11
&НаКлиенте
Процедура ОтправитьПисьмо(Команда)
	ОтправитьПисьмо_НаСервере();	
КонецПроцедуры

//+++АК sole 2018.08.30 ИП-00018320.11
&НаСервере
Процедура ОтправитьПисьмо_НаСервере()
	
	Перем ОбъектОбработки;
	
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	ОбъектОбработки.ОтправитьПисьмо();
			
КонецПроцедуры

//+++АК sole 2018.08.31 ИП-00018320.11
Процедура УстановитьДоступностьКнопкиОтправить()
	
	мДоступность = (
							ЗначениеЗаполнено(Объект.АдресОтправителя) 
						И	ЗначениеЗаполнено(Объект.АдресПолучателя)
						И	ЗначениеЗаполнено(ЭтаФорма.КлиентТекстПисьмаHTML)
					);
					
	ЭтаФорма.Элементы.Отправить.Доступность = мДоступность;

КонецПроцедуры

//+++АК sole 2018.08.31 ИП-00018320.11
Процедура УстановитьДокументОснование(Документ) Экспорт
	Объект.ДокументОснование = Документ;
	ДокументОснованиеПриИзменении_НаСервере();	
КонецПроцедуры

//+++АК LAGP 2018.10.09 ИП-00018320.13 Добавлены вложения приходных ордеров в письмо
&НаСервере
Процедура ЗаполнитьВложенияПриходныхОрдеров()
	
	МассивПТУ = Объект.ПоступленияТоваровУслуг.Выгрузить(,"Документ");		
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПоступлениеТоваровУслугПриходныеОрдера.ПриходныйОрдер
		|ПОМЕСТИТЬ ПриходныеОрдера
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг.ПриходныеОрдера КАК ПоступлениеТоваровУслугПриходныеОрдера
		|ГДЕ
		|	ПоступлениеТоваровУслугПриходныеОрдера.Ссылка В(&МассивПТУ)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПриходныеОрдера.ПриходныйОрдер,
		|	ПриходныйОрдерСкладПрикрепленныеФайлы.Файл
		|ИЗ
		|	ПриходныеОрдера КАК ПриходныеОрдера
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПриходныйОрдерСклад.ПрикрепленныеФайлы КАК ПриходныйОрдерСкладПрикрепленныеФайлы
		|		ПО ПриходныеОрдера.ПриходныйОрдер = ПриходныйОрдерСкладПрикрепленныеФайлы.Ссылка";
	
	Запрос.УстановитьПараметр("МассивПТУ", МассивПТУ);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Объект.ПрикрепленныеФайлы.Загрузить(РезультатЗапроса.Выгрузить());
	КонецЕсли;
	
КонецПроцедуры

//