
&НаСервереБезКонтекста
Функция ПолучитьМесяцПоТексту(ТекстМесяца)
	
	Если ТекстМесяца = "ЯНВ" Тогда
	    Возврат 1;
	ИначеЕсли ТекстМесяца = "ФЕВ" Тогда
	    Возврат 2;
	ИначеЕсли ТекстМесяца = "МАР" Тогда
	    Возврат 3;
	ИначеЕсли ТекстМесяца = "АПР" Тогда
	    Возврат 4;
	ИначеЕсли ТекстМесяца = "МАЙ" Тогда
	    Возврат 5;
	ИначеЕсли ТекстМесяца = "ИЮН" Тогда
	    Возврат 6;
	ИначеЕсли ТекстМесяца = "ИЮЛ" Тогда
	    Возврат 7;
	ИначеЕсли ТекстМесяца = "АВГ" Тогда
	    Возврат 8;
	ИначеЕсли ТекстМесяца = "СЕН" Тогда
	    Возврат 9;
	ИначеЕсли ТекстМесяца = "ОКТ" Тогда
	    Возврат 10;
	ИначеЕсли ТекстМесяца = "НОЯ" Тогда
	    Возврат 11;
	ИначеЕсли ТекстМесяца = "ДЕК" Тогда
	    Возврат 12;
	Иначе
	    Возврат 0;
	КонецЕсли;
		
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьОрганизациюПоТексту(ТекстОрг)
	
	Если ТекстОрг = "ЛУГ ДА ПОЛЕ" Тогда
	    Возврат Справочники.Организации.НайтиПоКоду("000000004");
	ИначеЕсли ТекстОрг = "ПРОЕКТ ИЗБЁНКА" Тогда
	    Возврат Справочники.Организации.НайтиПоКоду("000000005");
	ИначеЕсли ТекстОрг = "ООО ВКУСВИЛЛ" Тогда
	    Возврат Справочники.Организации.НайтиПоКоду("000000006");
	КонецЕсли;
	
	Возврат Справочники.Организации.ПустаяСсылка();
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьКорпКартуПоНомеру(ТекстНомераКарты)
	
	Возврат Справочники.КорпоративныеБанковскиеКарты.НайтиПоРеквизиту("НомерКорпоративнойКарты", ТекстНомераКарты);
	
КонецФункции

&НаКлиенте
Функция ПолучитьТекстВорд(мФайлWord)
	
	//
	КомОбъект = Новый COMОбъект("Word.Application");
	
	Ворд_документ = КомОбъект.Documents.Open(мФайлWord);
	
	ДокументВорда = КомОбъект.ActiveDocument;
	
	ТекстВорда = "";
	
	Для н = 1 по ДокументВорда.Paragraphs.Count Цикл
		ТекстВорда = ТекстВорда + ДокументВорда.Paragraphs(н).Range.Text;
	КонецЦикла;
	
	Ворд_документ.Close();
	
	КомОбъект.Quit();
	
	ПозицияНедопустСимв = НайтиНедопустимыеСимволыXML(ТекстВорда);
	Пока ПозицияНедопустСимв > 0 Цикл
		ТекстВорда = Лев(ТекстВорда, ПозицияНедопустСимв - 1) + Сред(ТекстВорда, ПозицияНедопустСимв + 1);
		ПозицияНедопустСимв = НайтиНедопустимыеСимволыXML(ТекстВорда);
	КонецЦикла;
	
	Возврат ТекстВорда;
	
КонецФункции


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтаФорма.ФлагПрочитать 			= Истина;
	ЭтаФорма.ФлагСоздаватьДокументы = Истина;
	
	Элементы.ТекстWord.Видимость = Ложь;
	
КонецПроцедуры


&НаКлиенте
Процедура ФайлWordНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ДиалогВыбораФайла =	Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);

	ДиалогВыбораФайла.Заголовок					= "Выберите файл (Word)";
	ДиалогВыбораФайла.ПредварительныйПросмотр	= Ложь;
	ДиалогВыбораФайла.ИндексФильтра				= 0;
	ДиалогВыбораФайла.ПолноеИмяФайла			= ЭтаФорма.ФайлWord;
	
	Если ДиалогВыбораФайла.Выбрать() Тогда
		ЭтаФорма.ФайлWord = ДиалогВыбораФайла.ПолноеИмяФайла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ФайлWordОткрытие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ЗапуститьПриложение("explorer " + ЭтаФорма.ФайлWord);
	
КонецПроцедуры


Функция СоздатьДокументы(ТекстВорда, Знач мСоздаватьДокументы, Знач мПрочитать, мТекстПрочитанный)
	
	// проверки на правильность
	Позиция1 = Найти(ТекстВорда, "ОТЧЕТ ЗА ");
	Если Позиция1 = 0 Тогда
        Сообщить("Текст Word: некорректный текст шапки отчета!");
		Возврат Неопределено;
	КонецЕсли;;
	
	ТекстГода = Сред(ТекстВорда, Позиция1 + 12, 4);
	Попытка
		ТекГод = Число(ТекстГода);
	Исключение
        Сообщить("Текст Word: некорректный год периода отчета [" + ТекстГода + "]");
		Возврат Неопределено;
	КонецПопытки;
	
	ТекстМесяца = Сред(ТекстВорда, Позиция1 + 9, 3);
	ТекМесяц = ПолучитьМесяцПоТексту(ТекстМесяца);
	Если ТекМесяц = 0 Тогда
        Сообщить("Текст Word: некорректный месяц периода отчета [" + ТекстМесяца + "]");
		Возврат Неопределено;
	КонецЕсли;;
	
	МассивДокументов = Новый Массив;
	
	//
	ДокАвОтчеты 	= Документы.АвансовыйОтчет;
	ВидОпБезнал 	= Перечисления.ВидыОперацийАвансовогоОтчета.БезНаличные;
	Счет443			= ПланыСчетов.Финансовый.ЗатратыТочекДляРаспределения;
	Счет712			= ПланыСчетов.Финансовый.РасчетыСПодотчетнымиЛицамиНаКартах;
	ТекОтвественный = ПараметрыСеанса.ТекущийПользователь;
	
	// обход организаций
	ПозицияОрг = Найти(ТекстВорда, "БИЗНЕС-ОРГАНИЗАЦИЯ: ");
	Пока ПозицияОрг > 0 Цикл 
		
		ТекстВорда = Сред(ТекстВорда, ПозицияОрг + 20);
		ПозицияОрг = Найти(ТекстВорда, "БИЗНЕС-ОРГАНИЗАЦИЯ: ");
		Если ПозицияОрг > 0 Тогда
			ТекстОрг = Лев(ТекстВорда, ПозицияОрг - 1);
		Иначе
			ТекстОрг = ТекстВорда;
		КонецЕсли;
		
		ПозицияСлед = Найти(ТекстОрг, "АДРЕС: ");
		ТекОргНаименование = СокрЛП(Лев(ТекстОрг, ПозицияСлед - 1));
		ТекОрганизация = ПолучитьОрганизациюПоТексту(ТекОргНаименование);  // Организация
		Если ТекОрганизация.Пустая() Тогда
	        Сообщить("Текст Word: не определена организация " + ТекОргНаименование);
			Продолжить;
		КонецЕсли;;
		Если мПрочитать Тогда
			мТекстПрочитанный = мТекстПрочитанный + Символы.ПС + "-----------------------------------------";
			мТекстПрочитанный = мТекстПрочитанный + Символы.ПС + "БИЗНЕС-ОРГАНИЗАЦИЯ: " + ТекОргНаименование;
		КонецЕсли;;
		
		// обход по картам
		ПозицияКарта = Найти(ТекстОрг, "КАРТА No.: ");
		Пока ПозицияКарта > 0 Цикл 
			
			ТекстОрг = Сред(ТекстОрг, ПозицияКарта + 11);
			ПозицияКарта = Найти(ТекстОрг, "КАРТА No.: ");
			Если ПозицияКарта > 0 Тогда
				ВнутреннийТекст = Лев(ТекстОрг, ПозицияКарта - 1);
			Иначе
				ВнутреннийТекст = ТекстОрг;
			КонецЕсли;
			
			
			ТекстНомераКарты = СтрЗаменить(Лев(ТекстОрг, 19), " ", "");
			ТекКарта = ПолучитьКорпКартуПоНомеру(ТекстНомераКарты);   			
			Если ТекКарта.Пустая() Тогда
		        Сообщить("Текст Word: не найдена корпоративная карта с номером " + ТекстНомераКарты);
				Продолжить;
			КонецЕсли;;
			ТекФЛ = ТекКарта.ФизЛицо;  // Физлицо
			Если мПрочитать Тогда
				мТекстПрочитанный = мТекстПрочитанный + Символы.ПС + "---";
				мТекстПрочитанный = мТекстПрочитанный + Символы.ПС + "КАРТА No.: " + ТекстНомераКарты;
			КонецЕсли;;
			
			
			СтрОпераций = 8;
			ТекСтрока = СтрПолучитьСтроку(ВнутреннийТекст, СтрОпераций);
			ПозицияМесяц = Найти(ТекСтрока, ТекстМесяца + " ");
			Пока ПозицияМесяц > 0 Цикл
				
				ТекстЧислоМесяца = Сред(ТекСтрока, ПозицияМесяц - 2, 2);
				Если Лев(ТекстЧислоМесяца, 1) = "0" Тогда
					ТекстЧислоМесяца = Сред(ТекстЧислоМесяца, 2);
				КонецЕсли;
				Попытка
					ТекЧислоМесяца = Число(ТекстЧислоМесяца);
				Исключение
			        Сообщить("Текст Word: некорректное число месяца даты операции [" + ТекстЧислоМесяца + "]");
					СтрОпераций = СтрОпераций + 1;
					ТекСтрока = СтрПолучитьСтроку(ВнутреннийТекст, СтрОпераций);
					ПозицияМесяц = Найти(ТекСтрока, ТекстМесяца + " ");
					Продолжить;                                                  
				КонецПопытки;
				
				ТекСтрока = СокрЛ(ТекСтрока);
				ПозицияПробел = Найти(ТекСтрока, " ");
				ТекСтрока = СокрЛ(Сред(ТекСтрока, ПозицияПробел));
				ПозицияПробел = Найти(ТекСтрока, " ");
				ТекСтрока = СокрЛ(Сред(ТекСтрока, ПозицияПробел));
				ПозицияПробел = Найти(ТекСтрока, " ");
				ТекСтрока = СокрЛ(Сред(ТекСтрока, ПозицияПробел));
				ПозицияRUR = Найти(ТекСтрока, "RUR");
				ТекСодержание = СокрП(Лев(ТекСтрока, ПозицияRUR - 1));  	// Содержание
				
				ТекСтрока = СокрЛ(Сред(ТекСтрока, ПозицияRUR + 3));
				ПозицияПробел = Найти(ТекСтрока, " ");
				ТекстСуммы = Лев(ТекСтрока, ПозицияПробел - 1);
				Попытка
					ТекСумма = Число(ТекстСуммы);
				Исключение
			        Сообщить("Текст Word: некорректная сумма операции [" + ТекстСуммы + "]");
					СтрОпераций = СтрОпераций + 1;
					ТекСтрока = СтрПолучитьСтроку(ВнутреннийТекст, СтрОпераций);
					ПозицияМесяц = Найти(ТекСтрока, ТекстМесяца + " ");
					Продолжить;
				КонецПопытки;
				Если мПрочитать Тогда
					мТекстПрочитанный = мТекстПрочитанный + Символы.ПС +
						"Дата транзакции: " + ТекстЧислоМесяца + " " + ТекстМесяца + " " + ТекстГода + "г.; Сумма транзакции: " + ТекстСуммы;
				КонецЕсли;
				
				
				///////////////////////////////////////////////
				// создание документа "Авансовый отчет"
				Если мСоздаватьДокументы Тогда
					
					НовыйДокумент = ДокАвОтчеты.СоздатьДокумент();
					НовыйДокумент.Дата 				= Дата(ТекГод, ТекМесяц, ТекЧислоМесяца, 23, 59, 59);
					НовыйДокумент.ВидОперации 		= ВидОпБезнал;
					НовыйДокумент.Организация		= ТекОрганизация;
					НовыйДокумент.ФизЛицо			= ТекФЛ;
					НовыйДокумент.Ответственный		= ТекОтвественный;

					НовыйДокумент.СписаниеСКорпоративнойКарты 	= Истина;
					НовыйДокумент.СуммаТранзакцииБанка			= ТекСумма;
					НовыйДокумент.НаименованиеОперацииБанка		= ТекСодержание;
					НовыйДокумент.Комментарий		= "Загружен из отчета банка по корпоративным картам";
					
					Попытка
						НовыйДокумент.Записать();
						
						МассивДокументов.Добавить(НовыйДокумент.Ссылка);
						
					Исключение
						Сообщить(ОписаниеОшибки());
					КонецПопытки;
					
				КонецЕсли;
				///////////////////////////////////////////////
				
				СтрОпераций = СтрОпераций + 1;
				ТекСтрока = СтрПолучитьСтроку(ВнутреннийТекст, СтрОпераций);
				ПозицияМесяц = Найти(ТекСтрока, ТекстМесяца + " ");
				
			КонецЦикла;
			
		КонецЦикла;	
		
	КонецЦикла;	
	
	Возврат МассивДокументов;
	
КонецФункции

&НаКлиенте
Процедура ЗагрузитьИзВорд(Команда)
	
	Если СокрЛП(ЭтаФорма.ФайлWord) = "" Тогда
		Сообщить("Не указан файл (Word)!");
		Возврат;
	КонецЕсли;
	
	Если ЭтаФорма.ТаблицаДокументов.Количество() > 0 Тогда
		ЭтаФорма.ТаблицаДокументов.Очистить();
	КонецЕсли;
	
	//
	ТекстВорда = ПолучитьТекстВорд(ЭтаФорма.ФайлWord);
	Если ТекстВорда = "" Тогда
		ЭтаФорма.ТекстWord = "";
		Сообщить("Нет данных для загрузки!");
		Возврат;
	КонецЕсли;
	
	Если ЭтаФорма.ФлагСодержание Тогда
		ЭтаФорма.ТекстWord = ТекстВорда;
	КонецЕсли;
	
	
	мТекстПрочитанный = "";
	
	// основная функция
	МассивДокументов = СоздатьДокументы(ТекстВорда, ЭтаФорма.ФлагСоздаватьДокументы, ЭтаФорма.ФлагПрочитать, мТекстПрочитанный);
	
	Если ЭтаФорма.ФлагПрочитать Тогда
		ЭтаФорма.ТекстПрочитанный = мТекстПрочитанный;
	КонецЕсли;
	Если НЕ МассивДокументов = Неопределено Тогда
		Для Каждого ТекДокумент Из МассивДокументов Цикл
			НоваяСтрока = ЭтаФорма.ТаблицаДокументов.Добавить();
			НоваяСтрока.АвансовыйОтчет = ТекДокумент;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ФлагСодержаниеПриИзменении(Элемент)
	
	Если ЭтаФорма.ФлагСодержание
			И ЗначениеЗаполнено(ЭтаФорма.ФайлWord) Тогда
		ЭтаФорма.ТекстWord = ПолучитьТекстВорд(ЭтаФорма.ФайлWord);
	КонецЕсли;
	
	Элементы.ТекстWord.Видимость = ЭтаФорма.ФлагСодержание;
	
КонецПроцедуры

&НаКлиенте
Процедура ФлагПрочитатьПриИзменении(Элемент)
	
	Элементы.ТекстПрочитанный.Видимость = ЭтаФорма.ФлагПрочитать;
	
КонецПроцедуры
