
/////////////////////////////////////////////////////////////////////////////
// ФОРМА, ЭЛЕМЕНТЫ
////////////////////////////////////////////////////////////////////////////

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗагрузитьОсновныеТаблицыСервер();	
	РежимВыбораПромо = Параметры.РежимВыбораПромо;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаЗаписиНового(НовыйОбъект, Источник, СтандартнаяОбработка)
	
	ЗагрузитьОсновныеТаблицыСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	
	ЗагрузитьОсновныеТаблицыСервер();
	
КонецПроцедуры

&НаКлиенте
Процедура PromoВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если РежимВыбораПромо Тогда
		ОповеститьОВыборе(Новый Структура("Режим, ИдПромо", "ВыборПромо", Элементы.Promo.ТекущиеДанные.id_promo));
	Иначе	
		ОткрытьФормуРедактированияСтроки(Элементы.Promo.ТекущиеДанные.id_promo);
	КонецЕсли;	
		
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьТекущееПромо(Команда)
	
	ОткрытьФормуРедактированияСтроки(Элементы.Promo.ТекущиеДанные.id_promo);
	
КонецПроцедуры


/////////////////////////////////////////////////////////////////////////////
// ОСТАЛЬНОЕ
/////////////////////////////////////////////////////////////////////////////

&НаСервере
Процедура ЗагрузитьОсновныеТаблицыСервер()
	
	Об = РеквизитФормыВЗначение("Объект");
	Об.ЗаполнитьТаблицуPromo();
	ЗначениеВРеквизитФормы(Об, "Объект");
	
КонецПроцедуры

&НаСервере
Функция ВыгрузитьДанныеСервер(ИмяТЧ, УИД)
	
	Если ИмяТЧ = "promo" Тогда
		ТЗ = Объект.Promo.Выгрузить();
	Иначе
		Тз = Объект.fields_znach.Выгрузить();
	КонецЕсли;
	
	Возврат ПоместитьВоВременноеХранилище(ТЗ, УИД);
	
КонецФункции

&НаКлиенте
Процедура ДобавитьНовоеПромо(Команда)
	
	ОткрытьФормуРедактированияСтроки(0);		
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуРедактированияСтроки(ИдПромо)
	
	АдресХранилищаPromo = ВыгрузитьДанныеСервер("promo", ЭтаФорма.УникальныйИдентификатор);
	АдресХранилищаFieldsZnach = ВыгрузитьДанныеСервер("fields_znach", ЭтаФорма.УникальныйИдентификатор);
	
	фрм = ПолучитьФорму("Обработка.РаботаСПромоАкциями.Форма.РедактированиеСтрокиПромоУправляемая", Новый Структура("Идпромо", ИдПромо), ЭтаФорма);
	фрм.АдресХранилищаPromo = АдресХранилищаPromo; 
	фрм.АдресХранилищаFieldsZnach = АдресХранилищаFieldsZnach;
	фрм.Открыть();

КонецПроцедуры

&НаКлиенте
Процедура ВыолнитьExec(Команда)
	
	ТекДанные = Элементы.Promo.ТекущиеДанные;
	
	Если ТекДанные = Неопределено Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Для пересчета необходимо выделить строку с акцией, которую необходимо пересчитать.");
		Возврат;
	КонецЕсли;
	
	Если текДанные.is_active Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Пересчитывать можно только неактивные акции.");
		Возврат;
	КонецЕсли;
	
	ВыполнитьExecСервер(текДанные.id_promo)
	
КонецПроцедуры

&НаСервере
Процедура ВыполнитьExecСервер(Ид)
	
	Об = РеквизитФормыВЗначение("Объект");
	Об.ПересчетПромо(Ид);
	ЗначениеВРеквизитФормы(Об, "Объект");
	
КонецПроцедуры




