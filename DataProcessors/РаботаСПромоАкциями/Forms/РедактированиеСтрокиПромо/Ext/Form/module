
Процедура ПодставитьСписокВыбораУПоляПоТаблицеFields_znach(field, Элемент, ЗначениеДляСравнения, ДобавитьТипПромоВПоиск = Ложь)
	
	СтруктураПоиска = Новый Структура;
	СтруктураПоиска.Вставить("field", field);
	
	Если ДобавитьТипПромоВПоиск Тогда
		СтруктураПоиска.Вставить("promo_type", ЭлементыФормы.ТипПромо.Значение);
	КонецЕсли;
	
	НайдСтр = fields_znach.НайтиСтроки(СтруктураПоиска);
	
	Для Каждого Стр Из НайдСтр Цикл
		Элемент.СписокВыбора.Добавить(Стр.znach_f, Стр.name_f);
		
		Если Стр.znach_f = ЗначениеДляСравнения Тогда
			Элемент.Значение = Стр.znach_f;			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбновитьПараметры()
	
	НайдСтр = promo.Найти(ИДПромо, "id_promo");
	
	ЗаполнитьЗначенияСвойств(ЭтаФорма, НайдСтр);
	
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("promo..Promo_type", ЭлементыФормы.ТипПромо, promo_type);
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("promo..Type_perc", ЭлементыФормы.ТипНачисленияПроцента, Type_perc, Истина);		
		
КонецПроцедуры

Процедура ОбновитьНаборыТовары()
	
	// Наборы
	СтруктураПолей = "*";
	ИмяТаблицы = "promo_nabor";
	
	РеквизитыТЧ = Новый Массив;
	РеквизитыТч.Добавить("id_promo");
	РеквизитыТч.Добавить("nabor");
	РеквизитыТч.Добавить("all_tovar");
	РеквизитыТч.Добавить("is_fact");
	РеквизитыТч.Добавить("is_rasch");
	РеквизитыТч.Добавить("is_nachisl");
	
	СоответствиеУсловий = Новый Соответствие;
	СоответствиеУсловий.Вставить("id_promo", ИДПромо);
	
	ЗаполнитьТаблицу(Promo_Nabor, СтруктураПолей, ИмяТаблицы, РеквизитыТЧ, СоответствиеУсловий);	
	
	// Товары
	СтруктураПолей = "*";
	ИмяТаблицы = "promo_tovar";
	
	РеквизитыТЧ = Новый Массив;
	РеквизитыТч.Добавить("id_promo");
	РеквизитыТч.Добавить("nabor");
	РеквизитыТч.Добавить("id_tov");
	
	СоответствиеУсловий = Новый Соответствие;
	СоответствиеУсловий.Вставить("id_promo", ИДПромо);
	
	ЗаполнитьТаблицу(Promo_tovar, СтруктураПолей, ИмяТаблицы, РеквизитыТЧ, СоответствиеУсловий);
	
	ПодобратьНоменклатуруВТовары();

КонецПроцедуры

Процедура ОбновитьТорговыеТочки()
	
	СтруктураПолей = "*";
	ИмяТаблицы = "promo_tt";
	
	РеквизитыТЧ = Новый Массив;
	РеквизитыТч.Добавить("id_promo");
	РеквизитыТч.Добавить("id_tt");
	РеквизитыТч.Добавить("is_pok");
	РеквизитыТч.Добавить("plan_pr");
	
	СоответствиеУсловий = Новый Соответствие;
	СоответствиеУсловий.Вставить("id_promo", ИДПромо);
	
	ЗаполнитьТаблицу(promo_tt, СтруктураПолей, ИмяТаблицы, РеквизитыТЧ, СоответствиеУсловий);
	
КонецПроцедуры

Процедура ОбновитьСеткуНачислений()
	
	СтруктураПолей = "*";
	ИмяТаблицы = "promo_nach";
	
	РеквизитыТЧ = Новый Массив;
	РеквизитыТч.Добавить("id_promo");
	РеквизитыТч.Добавить("param");
	РеквизитыТч.Добавить("Proc_nach");
		
	СоответствиеУсловий = Новый Соответствие;
	СоответствиеУсловий.Вставить("id_promo", ИДПромо);
	
	ЗаполнитьТаблицу(promo_nach, СтруктураПолей, ИмяТаблицы, РеквизитыТЧ, СоответствиеУсловий);
	
КонецПроцедуры

Процедура ОбновитьeLU()
	
	СтруктураПолей = "*";
	ИмяТаблицы = "promo_ELU";
	
	РеквизитыТЧ = Новый Массив;
	РеквизитыТч.Добавить("id_promo");
	РеквизитыТч.Добавить("text_eLU");
	РеквизитыТч.Добавить("shapka_elu");
	РеквизитыТч.Добавить("rn");
		
	СоответствиеУсловий = Новый Соответствие;
	СоответствиеУсловий.Вставить("id_promo", ИДПромо);
	
	ЗаполнитьТаблицу(Promo_elu, СтруктураПолей, ИмяТаблицы, РеквизитыТЧ, СоответствиеУсловий);	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТЗЕЛУ.id_promo,
	               |	ТЗЕЛУ.text_eLU,
	               |	ТЗЕЛУ.shapka_elu
	               |ПОМЕСТИТЬ Сводная
	               |ИЗ
	               |	&ТЗЕЛУ КАК ТЗЕЛУ
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Сводная.id_promo,
	               |	Сводная.text_eLU,
	               |	Сводная.shapka_elu КАК shapka_elu
	               |ИЗ
	               |	Сводная КАК Сводная
	               |ГДЕ
	               |	Сводная.id_promo = &id_promo
	               |ИТОГИ ПО
	               |	shapka_elu";
				   
	Запрос.УстановитьПараметр("ТзЕлу", Promo_elu.Выгрузить());
	Запрос.УстановитьПараметр("id_promo", ИдПромо);
	
	ВыборкаСорт = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаСорт.Следующий() Цикл
		
		НовСтр = ТзЕлу.Добавить();
		
		Выборка = Выборкасорт.Выбрать();
		
		Пока Выборка.Следующий() Цикл		
			НовСтр.ТекстЕЛУ = НовСтр.ТекстЕЛУ + Выборка.text_eLU + Символы.ПС;
		КонецЦикла;
		
	КонецЦикла; 	
	
КонецПроцедуры

Процедура ОбновитьДанныеПоПромо()
	
	ОбновитьПараметры();
	ОбновитьНаборыТовары();
	ОбновитьТорговыеТочки();
	ОбновитьСеткуНачислений();
	ОбновитьeLU();
	
КонецПроцедуры

Процедура ПриОткрытии()
	
	ОбновитьДанныеПоПромо();
	
КонецПроцедуры

	

Процедура Promo_NaborПриАктивизацииСтроки(Элемент)
	
	ПрочитатьНабор();
	
	ТекСтр = ЭлементыФормы.Promo_Nabor.ТекущаяСтрока;
	
	ЭлементыФормы.Promo_tovar.ОтборСтрок.nabor.Установить(ТекСтр.nabor);
	
КонецПроцедуры

Процедура КоманднаяПанельТекстeLUДобавитьТекстeLU(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура КоманднаяПанельТекстeLUИзменитьТекстeLU(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ТзЕлуПриАктивизацииСтроки(Элемент)
	
	ЭлементыФормы.ТекстЕлу.Значение = ЭлементыФормы.ТзЕлу.ТекущаяСтрока.ТекстЕлу;
	
КонецПроцедуры



////////////////////////////////////////////////////////////////////////////////////

Процедура ПрочитатьНабор()
	
	ТекСтр = ЭлементыФормы.Promo_Nabor.ТекущаяСтрока;
	
	ЗаполнитьЗначенияСвойств(ЭтаФорма, ТекСтр);
	
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("Promo_nabor..All_tovar", ЭлементыФормы.ВключатьВсеТоварыИзЧека, all_tovar);
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("Promo_nabor..is_fact", ЭлементыФормы.СчитатьНаборВФактДляПродавцов, is_fact);	
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("Promo_nabor..Is_rasch", ЭлементыФормы.ИспользоватьВРасчетеПоказателя, is_rasch);	
	ПодставитьСписокВыбораУПоляПоТаблицеFields_znach("Promo_nabor..Is_nachisl", ЭлементыФормы.АлгоритмСуммыНачисленияБонусов, is_nachisl);		
	
КонецПроцедуры

Процедура ПодобратьНоменклатуруВТовары()
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТзНом.id_tov,
	               |	ТзНом.id_promo,
	               |	ТзНом.nabor
	               |ПОМЕСТИТЬ Временная
	               |ИЗ
	               |	&ТзНом КАК ТзНом
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Временная.id_tov,
	               |	Временная.id_promo,
	               |	Временная.nabor,
	               |	ЕСТЬNULL(Номенклатура.Ссылка, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК Номенклатура
	               |ИЗ
	               |	Временная КАК Временная
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
	               |		ПО Временная.id_tov = Номенклатура.id_tov";
				   
	Запрос.УстановитьПараметр("ТзНом", Promo_tovar.Выгрузить());
	
	Promo_tovar.Загрузить(Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры




