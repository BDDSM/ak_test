Перем НП Экспорт;

Процедура КнопкаВыполнитьНажатие(Кнопка)
	//Если Вопрос("Таблицы будут очищены. Продолжить?", РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
	//	Возврат;
	//КонецЕсли;
	Если Не ЗначениеЗаполнено(Контрагент) Тогда
	    Сообщить("Не заполнен контрагент");
		Возврат;
	КонецЕсли;
	Если Не ЗначениеЗаполнено(ДатаНачала) Или Не ЗначениеЗаполнено(ДатаОкончания) Тогда
		Сообщить("Выберите даты");
		Возврат;
	КонецЕсли;
	ЭлементыФормы.ТаблицаРасчеты.Очистить();
	ТаблицаЗаказы.Очистить();
	
	//Результат=Константы.Константа1.Получить();
	//
	//СтруктураРезультат=ЗначениеИзСтрокиВнутр(Константы.Константа1.Получить());
	//ЭлементыФормы.ТаблицаРасчеты.Вывести(СтруктураРезультат.ТД);
	//Возврат;
	
	
	Прокси = ПолучитьПрокси();
	
	Если Прокси = Неопределено Тогда
		Сообщить(НСтр("ru='Не удалось установить соединение с информационной базой.';en='Could not establish a connection to the database.'"));
		Возврат;
	КонецЕсли;
	
	СтруктураДанных = Новый Структура("ИНН, ДатаНачала, ДатаОкончания, НаименованиеПолное, НаименованиеКонтрагента", Логин, ДатаНачала,?(ЗначениеЗаполнено(ДатаОкончания), ДатаОкончания,'39991231235959'),Справочники.Организации.НайтиПоРеквизиту("ИНН",Логин).НаименованиеПолное,Контрагент);
	ДанныеМП = Новый ХранилищеЗначения(СтруктураДанных, Новый СжатиеДанных(9));
	
	Попытка 
		СтруктураОтвета = Прокси.ПолучитьДанныеСверки(ДанныеМП).Получить();	
	Исключение
		Сообщить("Не удалось получить данные по причине: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки; 
	Если СтруктураОтвета.Свойство("ОписаниеОшибок") Тогда
		Сообщить(СтруктураОтвета.ОписаниеОшибок);
		Возврат;
	КонецЕсли; 
	
	Результат=ЗначениеВСтрокуВнутр(СтруктураОтвета);
	
	СоответствиеТД=СтруктураОтвета.ТД;
	Для каждого Эл Из СоответствиеТД Цикл
		ЭлементыФормы.ТаблицаРасчеты.Вывести(Эл.Значение);
		ЭлементыФормы.ТаблицаРасчеты.ВывестиГоризонтальныйРазделительСтраниц();
	КонецЦикла; 
	
	ТЗЗаказы=СтруктураОтвета.ТаблицаЗаказы;
	Для каждого Стр Из ТЗЗаказы Цикл
	    НовСтр=ТаблицаЗаказы.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр,Стр);
		НовСтр.Заказ="Заказ №"+Стр.НомерЗаказа+" от "+Строка(Формат(Стр.ДатаЗаказа,"ДФ=dd.MM.yyyy"));
	КонецЦикла; 
КонецПроцедуры

Процедура КнопкаНастройкаПериодаНажатие(Элемент)

	Если НП.Редактировать() Тогда
		ДатаНачала    = НП.ПолучитьДатуНачала();
		ДатаОкончания = НП.ПолучитьДатуОкончания();
	КонецЕсли;

КонецПроцедуры

Процедура ДатаНачалаПриИзменении(Элемент)

	НП.УстановитьПериод(ДатаНачала, ДатаОкончания, Истина);

КонецПроцедуры

Процедура ДатаОкончанияПриИзменении(Элемент)

	НП.УстановитьПериод(ДатаНачала, ДатаОкончания, Истина);

КонецПроцедуры

//
Процедура ПриОткрытии()
	Прокси = ПолучитьПрокси();
	
	Если Прокси = Неопределено Тогда
		Сообщить(НСтр("ru='Не удалось установить соединение с информационной базой.';en='Could not establish a connection to the database.'"));
		Возврат;
	КонецЕсли;
	Попытка 
		СтруктураОтвета = Прокси.ПолучитьОрганизации();	
	Исключение
		Сообщить("Не удалось данные по причине: " + ОписаниеОшибки());
		Возврат;
	КонецПопытки;
	СписокКонтрагентов=СтруктураОтвета.Получить();
	Для каждого Эл Из СписокКонтрагентов Цикл
		Если Эл.Значение="Вкусвилл" Или Эл.Значение="Луг да Поле" Тогда
			ЭлементыФормы.Контрагент.СписокВыбора.Добавить(Эл.Значение);
		КонецЕсли;
	КонецЦикла;
	ДатаНачала=НачалоМесяца(ТекущаяДата());
	ДатаОкончания=КонецМесяца(ТекущаяДата());
КонецПроцедуры

Процедура ТаблицаРасчетыВыбор(Элемент, Область, СтандартнаяОбработка)
	СтандартнаяОбработка=Ложь;
	Если Область.Низ=Область.Верх и Область.Лево=Область.Право и Область.Лево=7 и Область.Верх>=10 Тогда
		СтруктураРезультат=ЗначениеИзСтрокиВнутр(Результат);
		ИнДок=Область.Верх-10;
		ИндексыДокументов=СтруктураРезультат.ИндексыДокументов;
		ДанныеДокументов=СтруктураРезультат.ДанныеДокументов;
		СсылкаДок=ИндексыДокументов.Получить(ИнДок);
		Если СсылкаДок<>Неопределено Тогда
			СтруктураДок=ДанныеДокументов.Получить(СсылкаДок);
			СтруктураРекв=СтруктураДок.Реквизиты;
			Если СтруктураРекв.ВидДок="РасходИзБанка" Тогда
				ФормаДок=ПолучитьФорму("ФормаРасходИзБанкаОбычная");
		        ЗаполнитьЗначенияСвойств(ФормаДок,СтруктураРекв);
				ФормаДок.Открыть();
			ИначеЕсли СтруктураРекв.ВидДок="ПоступлениеВБанк" Тогда
				ФормаДок=ПолучитьФорму("ФормаПоступлениеВБанкОбычная");
		        ЗаполнитьЗначенияСвойств(ФормаДок,СтруктураРекв);
				ФормаДок.Открыть();
			ИначеЕсли СтруктураРекв.ВидДок="ПоступлениеТоваровУслуг" Тогда
				Товары.Очистить();
				ТоварыКЗагрузке=СтруктураДок.ТабличныеЧасти.Товары;
				Для каждого Стр Из ТоварыКЗагрузке Цикл
				    СтрНов=Товары.Добавить();
					ЗаполнитьЗначенияСвойств(СтрНов,Стр.Значение);
				КонецЦикла; 

				
				ФормаДок=ПолучитьФорму("ФормаПоступлениеТоваровУслугОбычная");
		        ЗаполнитьЗначенияСвойств(ФормаДок,СтруктураРекв);
				ФормаДок.ОбработкаОбъект=ЭтотОбъект;
				ФормаДок.Открыть();
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли; 
КонецПроцедуры

НП = Новый НастройкаПериода;
