
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	АйдиОтчета = Параметры.АйдиОтчета;
	
КонецПроцедуры

Процедура ЗаполнитьДанные()
	
	ADOСоединение = Новый COMОбъект("ADODB.Connection");
	ADOСоединение.ConnectionTimeOut = 0;
	ADOСоединение.CommandTimeOut    = 0;
	
	СтрСоедиение = ОбменСAccess.ПолучитьСтрокуСоединения("sms_izbenka");
	
	ADOСоединение.ConnectionString  = СтрСоедиение;
	ADOСоединение.Open();
	
	СтрЗапрос = "SELECT zadanie.N_r_z
				  |	,zadanie.Name_r_z
				  |	
				  |FROM [Reports].[dbo].[r_zadanie] (nolock) zadanie
				  |Where zadanie.N_r_z = " + ВнешниеДанные.ФорматПоля(АйдиОтчета) + "
				  |
				  |UNION ALL
				  |SELECT zadanie.Id_Report
				  |	,zadanie.Name
				  |	
				  |FROM [Reports].[dbo].[Report_Pokazatel] (nolock) zadanie
				  |Where zadanie.Id_Report = " + ВнешниеДанные.ФорматПоля(АйдиОтчета) + "";
				  
	rs = ADOСоединение.Execute(СтрЗапрос);
	
	Попытка
		rs.MoveFirst();
		
		Пока НЕ rs.EOF() Цикл
			ТемаОтчета = Rs.Fields("Name_r_z").Value;
			rs.MoveNext();
		КонецЦикла;
	Исключение
	КонецПопытки;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("Объект", ПараметрыСеанса.ТекущийПользователь.ФизЛицо);
	Запрос.Текст = "ВЫБРАТЬ
	               |	КонтактнаяИнформация.Представление
	               |ИЗ
	               |	РегистрСведений.КонтактнаяИнформация КАК КонтактнаяИнформация
	               |ГДЕ
	               |	КонтактнаяИнформация.Объект = &Объект
	               |	И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
	               |	И КонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.EmailФизЛица)";
				   
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		ПочтаПользователя = Выборка.Представление;
	КонецЕсли;	
	
	СтрЗапрос = "SELECT zadanie.Descr, zadanie.id
				  |	
				  |	
				  |FROM [Reports].[dbo].[Report_Unsubscribe_Reason] (nolock) zadanie
				  |Where zadanie.id_report = " + ВнешниеДанные.ФорматПоля(АйдиОтчета) + "
				  |and zadanie.email = " + ВнешниеДанные.ФорматПоля(ПочтаПользователя);
				  
	rs = ADOСоединение.Execute(СтрЗапрос);
	
	Попытка
		rs.MoveFirst();
		
		Пока НЕ rs.EOF() Цикл
			ПричинаОтпискиОтОтчета = Rs.Fields("Descr").Value;
			АйдиОтписки = Rs.Fields("id").Value;
			rs.MoveNext();
		КонецЦикла;
	Исключение
	КонецПопытки;
	
КонецПроцедуры	

Процедура ОтписатьсяОтОтчетаСервер()
	
	ADOСоединение = Новый COMОбъект("ADODB.Connection");
	ADOСоединение.ConnectionTimeOut = 0;
	ADOСоединение.CommandTimeOut    = 0;
	
	СтрСоедиение = ОбменСAccess.ПолучитьСтрокуСоединения("sms_izbenka");
	
	ADOСоединение.ConnectionString  = СтрСоедиение;
	ADOСоединение.Open();
	
	Если ЗначениеЗаполнено(АйдиОтписки) Тогда
		СтрЗапрос = "UPDATE [Reports].[dbo].[Report_Unsubscribe_Reason]
					 |  SET [email] = " + ВнешниеДанные.ФорматПоля(ПочтаПользователя) + "
					 |	 ,[Descr] = " + ВнешниеДанные.ФорматПоля(ПричинаОтпискиОтОтчета) + "
					 |	 ,[date_add] = " + ВнешниеДанные.ФорматПоля(ТекущаяДата()) + "
					 |WHERE [id] = " + ВнешниеДанные.ФорматПоля(АйдиОтписки);
	Иначе
		СтрЗапрос = "INSERT INTO [Reports].[dbo].[Report_Unsubscribe_Reason]
					 |	  ([id_report]
					 |	  ,[email]
					 |	  ,[Descr]
					 |	  ,[date_add])
					 |VALUES
					 |	  (" + ВнешниеДанные.ФорматПоля(АйдиОтчета) + "
					 |	  ," + ВнешниеДанные.ФорматПоля(ПочтаПользователя) + "
					 |	  ," + ВнешниеДанные.ФорматПоля(ПричинаОтпискиОтОтчета) + "
					 |	  ," + ВнешниеДанные.ФорматПоля(ТекущаяДата()) + ")";
	КонецЕсли;	
				 
	ADOСоединение.Execute(СтрЗапрос);
	
КонецПроцедуры	

&НаКлиенте
Процедура ОтписатьсяОтОтчета(Команда)
	
	Если Не ЗначениеЗаполнено(ПочтаПользователя) Тогда
		Сообщить("Не указана почта пользователя");
		Возврат;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ПричинаОтпискиОтОтчета) Тогда
		Сообщить("Не указана причина отписки от отчета");
		Возврат;
	КонецЕсли;
	
	ОтписатьсяОтОтчетаСервер();
	
	Сообщить("Выполнено успешно");
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если АйдиОтчета = -1 Тогда
		АйдиОтчета = 0;
		ВвестиЧисло(АйдиОтчета, "Введите Id отчета", 10, 0);
		Если НЕ ЗначениеЗаполнено(АйдиОтчета) Тогда
			Отказ = Истина;
			Возврат;
		КонецЕсли;	
	КонецЕсли;	
	
	Элементы.ФормаВозобновитьПодписку.Доступность = ЗначениеЗаполнено(АйдиОтписки);
	
КонецПроцедуры

Процедура ВозобновитьПодпискуСервер()
	
	ADOСоединение = Новый COMОбъект("ADODB.Connection");
	ADOСоединение.ConnectionTimeOut = 0;
	ADOСоединение.CommandTimeOut    = 0;
	
	СтрСоедиение = ОбменСAccess.ПолучитьСтрокуСоединения("sms_izbenka");
	
	ADOСоединение.ConnectionString  = СтрСоедиение;
	ADOСоединение.Open();
	
	Если ЗначениеЗаполнено(АйдиОтписки) Тогда
		СтрЗапрос = "DELETE FROM [Reports].[dbo].[Report_Unsubscribe_Reason]
					 |  
					 |WHERE [id] = " + ВнешниеДанные.ФорматПоля(АйдиОтписки);
	КонецЕсли;	
				 
	ADOСоединение.Execute(СтрЗапрос);
	
КонецПроцедуры	

&НаКлиенте
Процедура ВозобновитьПодписку(Команда)
	
	ВозобновитьПодпискуСервер();
	Сообщить("Выполнено успешно");
	Закрыть();
	
КонецПроцедуры
