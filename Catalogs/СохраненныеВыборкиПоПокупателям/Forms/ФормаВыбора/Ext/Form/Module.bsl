&НаСервереБезКонтекста
Функция НоменклатураОбработкаВыбораНаСервере(Номенклатура)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СохраненныеВыборкиПоПокупателям.ХранилищеОтбора,
		|	СохраненныеВыборкиПоПокупателям.Код
		|ИЗ
		|	Справочник.СохраненныеВыборкиПоПокупателям КАК СохраненныеВыборкиПоПокупателям";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	СписокОтбора = новый СписокЗначений;
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Отбор = ВыборкаДетальныеЗаписи.ХранилищеОтбора.Получить();
		Если ТипЗнч(Отбор) = Тип("ОтборКомпоновкиДанных") тогда
			Для Каждого ЗначенияОтбора из Отбор.Элементы цикл
				Если ЗначенияОтбора.ЛевоеЗначение = новый ПолеКомпоновкиДанных("Номенклатура") тогда
					Если ТипЗнч(ЗначенияОтбора.ПравоеЗначение) = Тип("СписокЗначений") тогда
						Для Каждого ЗначениеИзСписка из ЗначенияОтбора.ПравоеЗначение цикл
							Если ЗначениеИзСписка = Номенклатура тогда
								СписокОтбора.Добавить(ВыборкаДетальныеЗаписи.Код);
							КонецЕсли;	
						КонецЦикла;	
					Иначе
						Если ЗначенияОтбора.ПравоеЗначение = Номенклатура тогда
							СписокОтбора.Добавить(ВыборкаДетальныеЗаписи.Код);
						КонецЕсли;	
					КонецЕсли;	
				КонецЕсли;	
					Отбор.Элементы[0].ЛевоеЗначение = новый ПолеКомпоновкиДанных("Номенклатура")
			КонецЦикла;	
		КонецЕсли;	
	КонецЦикла;
	
	Возврат СписокОтбора;
	
КонецФункции

&НаКлиенте
Процедура НоменклатураОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	СписокОтбора = НоменклатураОбработкаВыбораНаСервере(ВыбранноеЗначение);
	
	ЭлОтбора = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлОтбора.ЛевоеЗначение = новый ПолеКомпоновкиДанных("Код");
	ЭлОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	ЭлОтбора.Использование = Истина;
	ЭлОтбора.ПравоеЗначение = СписокОтбора;
	
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураОчистка(Элемент, СтандартнаяОбработка)
	Список.Отбор.Элементы.Очистить();
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	Текст = Элемент.ТекстРедактирования;
	
	Если НайтиНоменклатуруПоНаименованию(Текст) тогда
		Список.Отбор.Элементы.Очистить();
	КонецЕсли; 
КонецПроцедуры

&НаСервереБезКонтекста
Функция НайтиНоменклатуруПоНаименованию(Текст)
	Возврат Справочники.Номенклатура.НайтиПоНаименованию(Текст, Истина).Пустая();
КонецФункции // НайтиНоменклатуруПоНаименованию()
