
Функция ПолучитьТаблицуСписка(ОбъектЗапроса, ЭлементыФормыСписок)     
    
    ВидыСравнения = Новый Соответствие;
    ВидыСравнения.Вставить(ВидСравнения.Равно,            " = ");
    ВидыСравнения.Вставить(ВидСравнения.НеРавно,            " <> ");
    ВидыСравнения.Вставить(ВидСравнения.Больше,            " > ");
    ВидыСравнения.Вставить(ВидСравнения.Меньше,            " < ");
    ВидыСравнения.Вставить(ВидСравнения.БольшеИлиРавно,        " >= ");
    ВидыСравнения.Вставить(ВидСравнения.МеньшеИлиРавно,        " <= ");
    ВидыСравнения.Вставить(ВидСравнения.ВСписке,            " В ");
    ВидыСравнения.Вставить(ВидСравнения.НеВСписке,            " В ");
    ВидыСравнения.Вставить(ВидСравнения.ВИерархии,            " В ИЕРАРХИИ ");
    ВидыСравнения.Вставить(ВидСравнения.НеВИерархии,        " В ИЕРАРХИИ ");
    ВидыСравнения.Вставить(ВидСравнения.ВСпискеПоИерархии,        " В ИЕРАРХИИ ");
    ВидыСравнения.Вставить(ВидСравнения.НеВСпискеПоИерархии,    " В ИЕРАРХИИ ");
    ВидыСравнения.Вставить(ВидСравнения.Содержит,            " ПОДОБНО ");
    ВидыСравнения.Вставить(ВидСравнения.НеСодержит,            " ПОДОБНО ");
    ВидыСравнения.Вставить(ВидСравнения.ИнтервалВключаяГраницы,    " МЕЖДУ ");
    ВидыСравнения.Вставить(ВидСравнения.Интервал,            " МЕЖДУ ");
    ВидыСравнения.Вставить(ВидСравнения.ИнтервалВключаяНачало,    " МЕЖДУ ");
    ВидыСравнения.Вставить(ВидСравнения.ИнтервалВключаяОкончание,    " МЕЖДУ ");
    
    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ
    |    ОбъектЗапроса.Ссылка
    |ИЗ
    |    "+ОбъектЗапроса+" КАК ОбъектЗапроса ";
    
    пОтбор = ЭлементыФормыСписок.Значение.Отбор;
    Если пОтбор.Количество() > 0 Тогда
        
        СтрокаОтбора = "ГДЕ ";
        Для Каждого ТекОтбор Из пОтбор Цикл
            
            Если ТекОтбор.Использование = Истина Тогда
                Если ТекОтбор.ВидСравнения = ВидСравнения.НеВСписке 
                    ИЛИ ТекОтбор.ВидСравнения = ВидСравнения.НеВИерархии 
                    ИЛИ ТекОтбор.ВидСравнения = ВидСравнения.НеВСпискеПоИерархии 
                    ИЛИ ТекОтбор.ВидСравнения = ВидСравнения.НеСодержит Тогда 
                    сНЕ = "НЕ ";
                Иначе 
                    сНЕ = "";
                КонецЕсли;
                
                Если ВидыСравнения.Получить(ТекОтбор.ВидСравнения) = " МЕЖДУ " Тогда 
                    СтрокаОтбора = СтрокаОтбора + сНе +"ОбъектЗапроса." + ТекОтбор.Имя + ВидыСравнения.Получить(ТекОтбор.ВидСравнения) +"&" + ТекОтбор.Имя + "С И &" + ТекОтбор.Имя + "По И ";
                    Запрос.УстановитьПараметр(""+ТекОтбор.Имя+"С", ТекОтбор.ЗначениеС);
                    Запрос.УстановитьПараметр(""+ТекОтбор.Имя+"По", ТекОтбор.ЗначениеПо);
                    
                    Если ТекОтбор.ВидСравнения = ВидСравнения.Интервал Тогда
                        СтрокаОтбора = СтрокаОтбора + "ОбъектЗапроса." + ТекОтбор.Имя +"<> &" + ТекОтбор.Имя + "С И " + "ОбъектЗапроса." + ТекОтбор.Имя +"<> &" + ТекОтбор.Имя + "По И ";
                    ИначеЕсли ТекОтбор.ВидСравнения = ВидСравнения.ИнтервалВключаяНачало Тогда
                        СтрокаОтбора = СтрокаОтбора + "ОбъектЗапроса." + ТекОтбор.Имя +"<> &" + ТекОтбор.Имя + "По И ";
                    ИначеЕсли ТекОтбор.ВидСравнения = ВидСравнения.ИнтервалВключаяОкончание Тогда 
                        СтрокаОтбора = СтрокаОтбора + "ОбъектЗапроса." + ТекОтбор.Имя +"<> &" + ТекОтбор.Имя + "С И ";
                    КонецЕсли;
                Иначе     
                    СтрокаОтбора = СтрокаОтбора + сНе +"ОбъектЗапроса." + ТекОтбор.Имя + ВидыСравнения.Получить(ТекОтбор.ВидСравнения) +" ( &" + ТекОтбор.Имя + ") И ";
                    Запрос.УстановитьПараметр(ТекОтбор.Имя, ТекОтбор.Значение);
                КонецЕсли;
                
            КонецЕсли;
        КонецЦикла;
        Если СтрДлина(СтрокаОтбора)>4 Тогда 
            СтрокаОтбора = Лев(СтрокаОтбора, СтрДлина(СтрокаОтбора) - 2);
            Запрос.Текст = Запрос.Текст + СтрокаОтбора;
        КонецЕсли;
    КонецЕсли;
    
    пПорядок = ЭлементыФормыСписок.Значение.Порядок;
    Если пПорядок.Количество() > 0 И Не (пПорядок.Количество() = 1 И пПорядок.Получить(0).Имя = "Порядок") Тогда
        
        СтрокаПорядка = "УПОРЯДОЧИТЬ ПО ";
        Для Каждого ТекПорядок Из пПорядок Цикл
            Если ТекПорядок.Имя = "Порядок" Тогда
                Продолжить;
            КонецЕсли;
            СтрокаПорядка = СтрокаПорядка + ТекПорядок.Имя + ?(ТекПорядок.Направление = НаправлениеСортировки.Убыв, " УБЫВ", "") + ", ";
        КонецЦикла;
        
        Если СтрДлина(СтрокаПорядка)>15 Тогда 
            СтрокаПорядка = Лев(СтрокаПорядка, СтрДлина(СтрокаПорядка) - 2);
            Запрос.Текст = Запрос.Текст + СтрокаПорядка;
        КонецЕсли;
    КонецЕсли;
    
    Возврат Запрос.Выполнить().Выгрузить();
    
КонецФункции


Процедура ДействияФормыСформироватьЗаявки(Кнопка)
	
	ТЗСправочникСписок = ПолучитьТаблицуСписка("Справочник.АК_Размен", ЭлементыФормы.СправочникСписок);
	мСправочникСписок = ТЗСправочникСписок.ВыгрузитьКолонку("Ссылка");
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЛистУчета.Ссылка,
	|	ЛистУчета.ТорговаяТочка.Ссылка КАК ТТ
	|ИЗ
	|	Документ.ЛистУчета КАК ЛистУчета
	|ГДЕ
	|	НАЧАЛОПЕРИОДА(ЛистУчета.Дата, ДЕНЬ) = &Дата
	|	И ЛистУчета.СуммаДокумента = 0
	|	И ЛистУчета.ТорговаяТочка В ИЕРАРХИИ(&ТорговаяТочка)";
	
	Запрос.УстановитьПараметр("Дата", НачалоДня(ТекущаяДата()-86400));
	Запрос.УстановитьПараметр("ТорговаяТочка", мСправочникСписок);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = Результат.Выбрать();
	ЕстьНеСоответствия = Ложь;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Сообщить("У магазина "+ВыборкаДетальныеЗаписи.ТТ+" не соответсвует статус ТТ.");
		ЕстьНеСоответствия = Истина;
	КонецЦикла;
	
	
	
	Если ЕстьНеСоответствия Тогда	
		Режим = РежимДиалогаВопрос.ДаНет;
		Текст = "Продолжить выполнение операции?";
		Ответ = Вопрос(Текст, Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли; 
	
	Для каждого Стр Из мСправочникСписок Цикл
		
		ЗапросР = Новый Запрос;
		ЗапросР.Текст = 
		"ВЫБРАТЬ
		|	АК_Размен.ГрафикРазмена,
		|	АК_Размен.СуммаРазмена,
		|	АК_Размен.СтатусТорговойТочкиЗакрыто,
		|	АК_Размен.ПометкаУдаления,
		|	АК_Размен.ДатаОтсрочки
		|ИЗ
		|	Справочник.АК_Размен КАК АК_Размен
		|ГДЕ
		|	АК_Размен.Ссылка = &Ссылка";
		
		ЗапросР.УстановитьПараметр("Ссылка", Стр.Ссылка);
		
		РезультатР = ЗапросР.Выполнить();
		
		ВыборкаР = РезультатР.Выбрать();
		
		Если ВыборкаР.Следующий() = Ложь Тогда 
			Продолжить;
		КонецЕсли;
		
		ДатаРазмена = ДатаРазмена(ВыборкаР.ГрафикРазмена);
		Если ДатаРазмена>ВыборкаР.ДатаОтсрочки Тогда
		Иначе
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.СтатусТорговойТочкиЗакрыто Тогда
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.ПометкаУдаления  Тогда
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.СуммаРазмена = 0 Тогда			
			Продолжить;				
		КонецЕсли;
		
		//Сформировать файл
		ИмяФайлаСохранения = Константы.АК_ПапкаХраненияРазмен.Получить();//"C:\Users\automacon21\Desktop\automacon\bara\РАЗМЕН МЕШКИ.xls";
		
		Попытка
			Excel = Новый COMОбъект("Excel.Application");
			Excel.DisplayAlerts = 0;
			Excel.ScreenUpdating = 0;
			Excel.EnableEvents = 0;    
			Excel.Visible = 0;
			РабочаяКнига = Excel.WorkBooks.Open(ИмяФайлаСохранения, 0);
			Лист = Excel.Sheets(1);
		Исключение
			Сообщить("Не удалось загрузить объект ""Ёксель""!");
			Возврат;
		КонецПопытки;
				
		Лист.Cells(2,10).Value = Формат(ТекущаяДата(),"ДЛФ=DD");
		Лист.Cells(4,3).Value = Формат(ДатаРазмена,"ДФ=dd.MM.yyyy");
		Лист.Cells(5,1).Value = "ООО «Вкусвилл», "+Стр.Ссылка.Магазин.Город.Наименование+", "+Стр.Ссылка.Магазин.Адрес;
		Лист.Cells(8,4).Value = ""+Стр.Ссылка.НомерЯвочнойТочки;
		
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	АК_РазменРаскладка.ДостоинствоВалюты.Номинал КАК Номинал,
		|	АК_РазменРаскладка.ДостоинствоВалюты,
		|	СУММА(АК_РазменРаскладка.КоличествоМешков) КАК КоличествоМешков
		|ИЗ
		|	Справочник.АК_Размен.Раскладка КАК АК_РазменРаскладка
		|ГДЕ
		|	АК_РазменРаскладка.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	АК_РазменРаскладка.ДостоинствоВалюты,
		|	АК_РазменРаскладка.ДостоинствоВалюты.Номинал";
		Запрос.УстановитьПараметр("Ссылка",Стр.Ссылка);
		Результат = Запрос.Выполнить();
		
		Выборка = Результат.Выбрать();
		
		Лист.Cells(15,5).Value = 0;	
		Лист.Cells(16,5).Value = 0;	
		Лист.Cells(17,5).Value = 0;	
		Лист.Cells(18,5).Value = 0;	
		Лист.Cells(19,5).Value = 0;	
		Лист.Cells(20,5).Value = 0;	
		Лист.Cells(15,11).Value = 0;	
		Лист.Cells(16,11).Value = 0;	
		Лист.Cells(17,11).Value = 0;	
		Лист.Cells(18,11).Value = 0;			
		
		Пока Выборка.Следующий() Цикл
			Если Выборка.Номинал = 0.1 Тогда
				Лист.Cells(15,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 0.5 Тогда
				Лист.Cells(16,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 1 Тогда
				Лист.Cells(17,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 2 Тогда
				Лист.Cells(18,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 5 Тогда
				Лист.Cells(19,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 10 Тогда
				Лист.Cells(20,5).Value = Выборка.КоличествоМешков;	
			ИначеЕсли Выборка.Номинал = 50 Тогда
				Лист.Cells(15,11).Value = Выборка.КоличествоМешков;		
			ИначеЕсли Выборка.Номинал = 100 Тогда
				Лист.Cells(16,11).Value = Выборка.КоличествоМешков;				
			ИначеЕсли Выборка.Номинал = 500 Тогда
				Лист.Cells(17,11).Value = Выборка.КоличествоМешков;				
			ИначеЕсли Выборка.Номинал = 1000 Тогда
				Лист.Cells(18,11).Value = Выборка.КоличествоМешков;					
			КонецЕсли;		
		КонецЦикла;
		
		ИмяФайлаСохранения = СтрЗаменить(ИмяФайлаСохранения,"шаблон.xls","");		
		НовКаталог = ИмяФайлаСохранения+"Размен & "+Формат(ДатаРазмена,"ДФ=ddMMyyyy");
		СоздатьКаталог(НовКаталог);
		ИмяФайлаСохранения = НовКаталог+"\"+Стр.Ссылка.Наименование+"_"+Стр.Ссылка.НомерЯвочнойТочки+" & "+Формат(ДатаРазмена,"ДФ=ddMMyyyy")+".xls";
		РабочаяКнига.SaveAs(ИмяФайлаСохранения);
		
		Excel.Quit();
		Excel = Неопределено;
	КонецЦикла;	
	  Предупреждение("Файлы созданы." );
КонецПроцедуры


Функция ДатаРазмена(ГрафикРазмена)
	
	ДобавитьДниНедели = 0;	
	
	
	Если ГрафикРазмена = Перечисления.ДниНедели.Вторник Тогда
		ДобавитьДниНедели = 86400; 
	ИначеЕсли ГрафикРазмена = Перечисления.ДниНедели.Среда Тогда
		ДобавитьДниНедели = 86400*2; 
	ИначеЕсли ГрафикРазмена = Перечисления.ДниНедели.Четверг Тогда
		ДобавитьДниНедели = 86400*3; 
	ИначеЕсли ГрафикРазмена = Перечисления.ДниНедели.Пятница Тогда
		ДобавитьДниНедели = 86400*4; 
	ИначеЕсли ГрафикРазмена = Перечисления.ДниНедели.Суббота Тогда
		ДобавитьДниНедели = 86400*5; 
	ИначеЕсли ГрафикРазмена = Перечисления.ДниНедели.Воскресенье Тогда
		ДобавитьДниНедели = 86400*6; 	
	КонецЕсли;
	
	
	ДатаРазмена1 = НачалоНедели(ТекущаяДата())+ДобавитьДниНедели;	
	Если ДатаРазмена1< ТекущаяДата() Тогда 
		ДатаРазмена1 = НачалоНедели(ТекущаяДата()+604800)+ДобавитьДниНедели;
	КонецЕсли;
	Возврат ДатаРазмена1;
КонецФункции // ()


Процедура ДействияФормыНастройки(Кнопка)
	
	ОткрытьФорму("ОбщаяФорма.АК_НастройкаРазмена");

КонецПроцедуры


Процедура ДействияФормыДействие9(Кнопка)
	Обработки.ОбработкаРазменовДенег.ПолучитьФорму("Форма").Открыть();
КонецПроцедуры

Процедура ОтправитьПисьмо(Тема,Текст,Кому)
	
	АдресОтправки = "no-reply@vkusvill.ru";
		   	
	УчёткаДляНастройки =  МеханизмОбменаСообщениями.ПолучитьУчетнуюЗаписьПоАдресу( АдресОтправки);	
	Профиль = УправлениеЭлектроннойПочтой.ПолучитьИнтернетПочтовыйПрофиль(УчёткаДляНастройки);
	
	Почта = Новый ИнтернетПочта;
	Почта.Подключиться(Профиль, ПротоколИнтернетПочты.IMAP);
	
	Письмо = Новый ИнтернетПочтовоеСообщение;
	Письмо.Тема = Тема;
	Письмо.ИмяОтправителя  = ""+СокрЛП(УчёткаДляНастройки)+"";
	Письмо.Отправитель.Адрес = АдресОтправки;
	
	Получатель = Письмо.Получатели.Добавить();
	Получатель.Адрес = Кому;
	
	ТекстСообщения = Письмо.Тексты.Добавить(Текст);
	Попытка
		Почта.Послать(Письмо);
	Исключение
		Сообщить("Письмо не отправлено. " + ОписаниеОшибки());
	КонецПопытки;	
	Почта.Отключиться();	

КонецПроцедуры

Процедура ДействияФормыОтправитьПисьма(Кнопка)	
	
	ТЗСправочникСписок = ПолучитьТаблицуСписка("Справочник.АК_Размен", ЭлементыФормы.СправочникСписок);
	мСправочникСписок = ТЗСправочникСписок.ВыгрузитьКолонку("Ссылка");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЛистУчета.Ссылка,
	|	ЛистУчета.ТорговаяТочка.Ссылка КАК ТТ
	|ИЗ
	|	Документ.ЛистУчета КАК ЛистУчета
	|ГДЕ
	|	НАЧАЛОПЕРИОДА(ЛистУчета.Дата, ДЕНЬ) = &Дата
	|	И ЛистУчета.СуммаДокумента = 0
	|	И ЛистУчета.ТорговаяТочка В ИЕРАРХИИ(&ТорговаяТочка)";
	
	Запрос.УстановитьПараметр("Дата", НачалоДня(ТекущаяДата()-86400));
	Запрос.УстановитьПараметр("ТорговаяТочка", мСправочникСписок);
	
	Результат = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = Результат.Выбрать();
	ЕстьНеСоответствия = Ложь;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Сообщить("У магазина "+ВыборкаДетальныеЗаписи.ТТ+" не соответсвует статус ТТ.");
		ЕстьНеСоответствия = Истина;
	КонецЦикла;	
	
	Если ЕстьНеСоответствия Тогда	
		Режим = РежимДиалогаВопрос.ДаНет;
		Текст = "Продолжить выполнение операции?";
		Ответ = Вопрос(Текст, Режим, 0);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	АК_Размен.ГрафикРазмена,
	|	АК_Размен.СуммаРазмена,
	|	АК_Размен.СтатусТорговойТочкиЗакрыто,
	|	АК_Размен.ПометкаУдаления,
	|	АК_Размен.ДатаОтсрочки,
	|	АК_Размен.Раскладка.(
	|		ДостоинствоВалюты,
	|		СУММА(СуммаРуб),
	|		СУММА(КоличествоМешков),
	|		ДостоинствоВалюты.Номинал КАК НоминалВалюты
	|	),
	|	АК_Размен.Магазин.АдресЭлектроннойПочты КАК Емайл,
	|	АК_Размен.Магазин.Наименование КАК Магазин,
	|	АК_Размен.НомерЯвочнойТочки
	|ИЗ
	|	Справочник.АК_Размен КАК АК_Размен
	|ГДЕ
	|	АК_Размен.Ссылка В(&СсылкаРазмен)
	|
	|СГРУППИРОВАТЬ ПО
	|	АК_Размен.Раскладка.(ДостоинствоВалюты,
	|	ДостоинствоВалюты.Номинал)";
	
	Запрос.УстановитьПараметр("СсылкаРазмен", мСправочникСписок);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаР = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаР.Следующий() Цикл
		
		
		ДатаРазмена = ДатаРазмена(ВыборкаР.ГрафикРазмена);
		Если ДатаРазмена<=ВыборкаР.ДатаОтсрочки Тогда
			ТекстПисьма = "У магазина установлена дата отсрочки размена %ДатаОтсрочки";
			ТемаПисьма = "Размен на дату %ДатаРазмена";
			ТемаПисьма = СтрЗаменить(ТемаПисьма,"%ДатаРазмена",Формат(ДатаРазмена,"ДФ=dd.MM.yyyy"));
			ТекстПисьма = СтрЗаменить(ТекстПисьма,"%ДатаОтсрочки",Формат(ВыборкаР.ДатаОтсрочки,"ДФ=dd.MM.yyyy"));
			ТекстПисьма = СтрЗаменить(ТекстПисьма,"магазина","магазина "+ВыборкаР.Магазин);
			ОтправитьПисьмо(ТемаПисьма,ТекстПисьма,ВыборкаР.Емайл);
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.СтатусТорговойТочкиЗакрыто Тогда
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.ПометкаУдаления  Тогда
			Продолжить;
		КонецЕсли;
		Если ВыборкаР.СуммаРазмена = 0 Тогда	
			ТекстПисьма = "У магазина не определена схема размена.";
			ТемаПисьма = "Размен на дату %ДатаРазмена";
			ТемаПисьма = СтрЗаменить(ТемаПисьма,"%ДатаРазмена",Формат(ДатаРазмена,"ДФ=dd.MM.yyyy"));
			ТекстПисьма = СтрЗаменить(ТекстПисьма,"магазина","магазина "+ВыборкаР.Магазин);
			ОтправитьПисьмо(ТемаПисьма,ТекстПисьма,ВыборкаР.Емайл);
			Продолжить;
		КонецЕсли;
		АдресОтправки = "no-reply@vkusvill.ru";
		
		Выборка = ВыборкаР.Раскладка.Выбрать();
		РазменТекст = "";
		Пока Выборка.Следующий() Цикл
			Если Выборка.КоличествоМешков <> 0 Тогда 
				Стр = "%ДостоинствоВалюты-%КоличествоМешков мешков"+Символы.ПС+Символы.ПС;
				Стр = СтрЗаменить(Стр,"%ДостоинствоВалюты",Строка(Выборка.НоминалВалюты)+"р");
				Стр = СтрЗаменить(Стр,"%КоличествоМешков",Выборка.КоличествоМешков);
				Если Выборка.НоминалВалюты>=50 Тогда
					Если Выборка.КоличествоМешков=1 Тогда  
						Стр = СтрЗаменить(Стр,"мешков","пачка");
					Иначе
						Стр = СтрЗаменить(Стр,"мешков","пачек");
					КонецЕсли;
				Иначе
					Если Выборка.КоличествоМешков=1 Тогда  
						Стр = СтрЗаменить(Стр,"мешков","мешок");
					КонецЕсли;
				КонецЕсли;
				РазменТекст = РазменТекст +Стр;
			КонецЕсли;
		КонецЦикла;
		//РазменТекст = РазменТекст + "Общая сумма размена "+ВыборкаР.СуммаРазмена+" рублей.";
		ТекстПисьма = "Отправлен Размен на дату %ДатаРазмена для магазина %Магазин "+Символы.ПС+Символы.ПС+"Состав сумки=%СуммаРазмена"+Символы.ПС+Символы.ПС+РазменТекст;
		ТемаПисьма = "Размен на дату %ДатаРазмена";
		ТемаПисьма = СтрЗаменить(ТемаПисьма,"%ДатаРазмена",Формат(ДатаРазмена,"ДФ=dd.MM.yyyy")); 
		ТекстПисьма = СтрЗаменить(ТекстПисьма,"%Магазин",""+ВыборкаР.Магазин+",як"+ВыборкаР.НомерЯвочнойТочки);
		ТекстПисьма = СтрЗаменить(ТекстПисьма,"%ДатаРазмена",Формат(ДатаРазмена,"ДФ=dd.MM")+"("+ВыборкаР.ГрафикРазмена+")");
		ТекстПисьма = СтрЗаменить(ТекстПисьма,"%СуммаРазмена",Строка(ВыборкаР.СуммаРазмена));

		ОтправитьПисьмо(ТемаПисьма,ТекстПисьма,ВыборкаР.Емайл);
	КонецЦикла;	
	
	Предупреждение("Письма отправлены." );
	
КонецПроцедуры

