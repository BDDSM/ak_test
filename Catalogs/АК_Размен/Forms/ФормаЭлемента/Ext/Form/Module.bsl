
&НаКлиенте
Процедура РаскладкаСуммаРубПриИзменении(Элемент)
	ТекСтр = Элементы.Раскладка.ТекущиеДанные;
	//ПроверитьСумму(ТекСтр);
	КоличествоВМешке = ПолучитьКоличествоВМешке(ТекСтр.ДостоинствоВалюты) ;
	Номинал = ПолучитьНоминал(ТекСтр.ДостоинствоВалюты) ; 
	
	Если ЗначениеЗаполнено(ТекСтр.ДостоинствоВалюты) и ЗначениеЗаполнено(КоличествоВМешке) и ЗначениеЗаполнено(Номинал) и Номинал <> 0 и КоличествоВМешке<>0 Тогда
		Рез = ТекСтр.СуммаРуб / КоличествоВМешке / Номинал;
		ТекСтр.СуммаРуб = Цел( ТекСтр.СуммаРуб / КоличествоВМешке / номинал) * КоличествоВМешке *  Номинал;	
		ТекСтр.КоличествоМешков = Цел(Рез);	
		Если ТекСтр.КоличествоМешков = 0 Тогда
		   ТекСтр.СуммаРуб = 0;
		КонецЕсли;
	ИНАЧЕ
	ТекСтр.СуммаРуб = 0;
	ТекСтр.КоличествоМешков = 0;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция  ПолучитьКоличествоВМешке(ДостоинствоВалюты)
	
	 КоличествоВМешке = Справочники.АК_НоминалыДенежныхЕдиниц.КоличествоВМешке(Объект.Магазин,ДостоинствоВалюты) ;

	//Возврат ДостоинствоВалюты.КоличествоВМешке ;
	Возврат КоличествоВМешке ;
КонецФункции
&НаСервере
Функция  ПолучитьНоминал(ДостоинствоВалюты)
	
	
	Возврат ДостоинствоВалюты.Номинал ;
КонецФункции


&НаСервере
Процедура ПроверитьСумму(ТекСтр)
	
	Если ЗначениеЗаполнено(ТекСтр.ДостоинствоВалюты) и ЗначениеЗаполнено(ТекСтр.ДостоинствоВалюты.КоличествоВМешке) и ЗначениеЗаполнено(ТекСтр.ДостоинствоВалюты.Номинал) Тогда
		Рез = ТекСтр.СуммаРуб / ТекСтр.ДостоинствоВалюты.КоличествоВМешке / ТекСтр.ДостоинствоВалюты.Номинал;
		Если Рез = Цел(Рез) Тогда 
			ТекСтр.СуммаРуб = Цел( ТекСтр.СуммаРуб / ТекСтр.ДостоинствоВалюты.КоличествоВМешке / ТекСтр.ДостоинствоВалюты.Номинал) * ТекСтр.ДостоинствоВалюты.КоличествоВМешке *  ТекСтр.ДостоинствоВалюты.Номинал;	
		КонецЕсли;
		ТекСтр.КоличествоМешков =  ТекСтр.СуммаРуб / ТекСтр.ДостоинствоВалюты.КоличествоВМешке / ТекСтр.ДостоинствоВалюты.Номинал;			
	КонецЕсли;
	
КонецПроцедуры


&НаСервереБезКонтекста
Функция  ПолучитьСсылкуУстановкаДопДняРазмена()
	
	Возврат ПланыВидовХарактеристик.ПраваПользователей.УстановкаДопДняРазмена;
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	СсылкаУстановкаДопДняРазмена = ПолучитьСсылкуУстановкаДопДняРазмена();
	
	Если УправлениеДопПравамиПользователей.ПолучитьПравоПользователяУпр(СсылкаУстановкаДопДняРазмена, Ложь) Тогда 
	Элементы.ДопДеньРазмена.Доступность = Истина;
	КонецЕсли;


	СуммаЛимитаРазмена = АК_СуммаЛимитаРазмена;
	ДатаРазмена =  ДатаРазмена();     
     //Вариант 1
	//Элементы.Декорация1.Заголовок = "Редактирование карты размена возможно до "+Формат(АК_ВремяОкончанияРедактированияРазмен,"ДФ=чч:мм")+" предыдушего дня.";
	//ТекущаяДата =    ТекущаяДата();
	//
	//Если (ДатаРазмена-86400)<ТекущаяДата и НачалоДня(ДатаРазмена)>=НачалоДня(ТекущаяДата)  Тогда
	//	Рез = "Редактирование запрещено. Карта размена на ближайшую дату "+Формат(ДатаРазмена,"ДФ=dd.MM.yy")+" сформирована. Редактирвоание карты размена на следующую неделю будет возможно на следующий день после размена.";
	//	
	//	Если РольДоступнаСервер("Финансист")= Ложь ИЛИ  РольДоступнаСервер("ПолныеПрава")= Ложь Тогда   //Роль Размен не доступна    ФИнансис и продавец
	//		Элементы.Декорация2.Заголовок = Рез;
	//		Элементы.Декорация2.Видимость = Истина;
	//		ЭтаФорма.ТолькоПросмотр = Истина;		
	//	КонецЕсли;
	//Иначе
	//	Рез ="";
	//	Если ДатаРазмена<ТекущаяДата Тогда
	//	
	//		ДатаРазмена = ДатаРазмена + 604800;
	//	
	//	КонецЕсли;
	//КонецЕсли;
	//Вариант 2
	Элементы.Декорация1.Заголовок = "Редактирование карты размена возможно до "+Формат(АК_ВремяОкончанияРедактированияРазмен,"ДФ=чч:мм")+" четверга. Дата формирования карты размена пятница.";
	ТекущаяДата =    ТекущаяДата();
	Если ДатаРазмена<ТекущаяДата Тогда
		
		ДатаРазмена = ДатаРазмена + 604800;
		
	КонецЕсли;

	// ДеньНедели(ТекущаяДата) = "Пятница" или (ДеньНедели(ТекущаяДата) = "Четверг"  и (ТекущаяДата - НачалоДня(ТекущаяДата))>= АК_ВремяОкончанияРедактированияРазмен  )
	Если  ДеньНедели(ТекущаяДата) = 5 или (ДеньНедели(ТекущаяДата) = 4  и (ТекущаяДата - НачалоДня(ТекущаяДата))>= (Час(АК_ВремяОкончанияРедактированияРазмен) * 3600) + (Минута(АК_ВремяОкончанияРедактированияРазмен) * 60) + Секунда(АК_ВремяОкончанияРедактированияРазмен))  Тогда
		Рез = "Редактирование запрещено. Карта размена на ближайшую дату "+Формат(ДатаРазмена,"ДФ=dd.MM.yy")+" сформирована. Редактирование карты размена будет доступно с субботы до "+Формат(АК_ВремяОкончанияРедактированияРазмен,"ДФ=чч:мм")+" четверга.";
		
		Если РольДоступнаСервер("Финансист")= Ложь ИЛИ  РольДоступнаСервер("ПолныеПрава")= Ложь Тогда   //Роль Размен не доступна    ФИнансис и продавец
			Элементы.Декорация2.Заголовок = Рез;
			Элементы.Декорация2.Видимость = Истина;
			ЭтаФорма.ТолькоПросмотр = Истина;		
		КонецЕсли;
	Иначе
		Рез ="";
		Если ДатаРазмена<ТекущаяДата Тогда
		
			ДатаРазмена = ДатаРазмена + 604800;
		
		КонецЕсли;
	КонецЕсли;

	//+++АК LAGP 2018.09.25 ИП-00019420 Таблица "график инкассаций"	
	Отбор = ГрафикИнкассаций.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	//Отбор.Родитель = ГруппаОтбор;
	Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("ТорговаяТочка");
	Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	Отбор.Использование = Истина;
	//Отбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
	Отбор.ПравоеЗначение = Объект.Магазин;	
	//---АК LAGP
	
КонецПроцедуры

&НаСервере
Функция РольДоступнаСервер(Роль)

	
Возврат РольДоступна(Роль);
КонецФункции // ()


&НаКлиенте
Процедура РаскладкаПриИзменении(Элемент)
	Объект.СуммаРазмена = Объект.Раскладка.Итог("СуммаРуб");
КонецПроцедуры

&НаСервере
Функция ДатаРазмена()

ДобавитьДниНедели = 0;	
	
	
	Если Объект.ГрафикРазмена = Перечисления.ДниНедели.Вторник Тогда
	 ДобавитьДниНедели = 86400; 
	ИначеЕсли Объект.ГрафикРазмена = Перечисления.ДниНедели.Среда Тогда
	 ДобавитьДниНедели = 86400*2; 
	ИначеЕсли Объект.ГрафикРазмена = Перечисления.ДниНедели.Четверг Тогда
	 ДобавитьДниНедели = 86400*3; 
	ИначеЕсли Объект.ГрафикРазмена = Перечисления.ДниНедели.Пятница Тогда
	 ДобавитьДниНедели = 86400*4; 
	ИначеЕсли Объект.ГрафикРазмена = Перечисления.ДниНедели.Суббота Тогда
	 ДобавитьДниНедели = 86400*5; 
	ИначеЕсли Объект.ГрафикРазмена = Перечисления.ДниНедели.Воскресенье Тогда
	 ДобавитьДниНедели = 86400*6; 	
	КонецЕсли;
	
	
ДатаРазмена1 = НачалоНедели(ТекущаяДата())+ДобавитьДниНедели;	
ДатаРазмена1 =  ДатаРазмена1 + Час(АК_ВремяОкончанияРедактированияРазмен)*3600 + Минута(АК_ВремяОкончанияРедактированияРазмен)*60;
 Возврат ДатаРазмена1;
КонецФункции // ()


&НаКлиенте
Процедура ГрафикРазменаПриИзменении(Элемент)
	ДатаРазмена =  ДатаРазмена();
КонецПроцедуры


&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Объект.СуммаЛимита <> 0 Тогда 	
		АК_СуммаЛимитаРазмена  = Объект.СуммаЛимита;
	Иначе
		АК_СуммаЛимитаРазмена =	Константы.АК_СуммаЛимитаРазмена.Получить();
	КонецЕсли;
	АК_ВремяОкончанияРедактированияРазмен = Константы.АК_ВремяОкончанияРедактированияРазмен.Получить();
	
КонецПроцедуры


&НаКлиенте
Процедура РаскладкаКоличествоМешковПриИзменении(Элемент)
	
	ТекСтр = Элементы.Раскладка.ТекущиеДанные;
	КоличествоВМешке = ПолучитьКоличествоВМешке(ТекСтр.ДостоинствоВалюты) ;
	Номинал = ПолучитьНоминал(ТекСтр.ДостоинствоВалюты) ; 
	
	Если ЗначениеЗаполнено(ТекСтр.ДостоинствоВалюты) и ЗначениеЗаполнено(КоличествоВМешке) и ЗначениеЗаполнено(Номинал) и Номинал <> 0 и КоличествоВМешке<>0 Тогда
		ТекСтр.СуммаРуб = Элементы.Раскладка.ТекущиеДанные.КоличествоМешков * КоличествоВМешке *  Номинал;	
	Иначе
		ТекСтр.СуммаРуб = 0;
		ТекСтр.КоличествоМешков = 0;
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
КонецПроцедуры

