
Функция ОбязательныеРеквизитыЗаполнены()
	
	Если Организация.Пустая() Тогда 
		Сообщить("Не заполнена Организация!");
		Возврат Ложь;
	КонецЕсли;
	
	Если ДатаНачалаДействияНастройки = Дата(01,01,0001) Тогда 
		Сообщить("Не заполнена дата действия настройки!");
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция УжеЕстьНастройкаВЭтомМесяце()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НастройкиЧекЛиста.Ссылка
	|ИЗ
	|	Справочник.НастройкиЧекЛиста КАК НастройкиЧекЛиста
	|ГДЕ
	|	НастройкиЧекЛиста.Ссылка <> &ТекСсылка
	|	И НЕ НастройкиЧекЛиста.ПометкаУдаления
	|	И НастройкиЧекЛиста.Организация = &Организация
	|	И НастройкиЧекЛиста.ДатаНачалаДействияНастройки = &ДатаНачалаДействияНастройки
	|
	|СГРУППИРОВАТЬ ПО
	|	НастройкиЧекЛиста.Ссылка";
	Запрос.УстановитьПараметр("ТекСсылка", Ссылка);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ДатаНачалаДействияНастройки", ДатаНачалаДействияНастройки);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Количество() = 0 Тогда 
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
	
	
КонецФункции

Процедура ПередЗаписью(Отказ)
	
	Если НЕ ОбязательныеРеквизитыЗаполнены() Тогда 
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если УжеЕстьНастройкаВЭтомМесяце() Тогда 
		Сообщить("В этом месяце уже есть настройка закрытия месяца!");
		Отказ = Истина;
		Возврат;
	КонецЕсли;

КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	НЗ = РегистрыСведений.СписокНастроекЧекЛиста.СоздатьНаборЗаписей();
	НЗ.Отбор.Организация.Установить(Организация);
	НЗ.Отбор.Период.Установить(НачалоМесяца(ДатаНачалаДействияНастройки));
	НЗ.Прочитать();
	
	Если не ПометкаУдаления Тогда
		
		Если НЗ.Количество() = 0 Тогда 
			НовЗапись = НЗ.Добавить();
			НовЗапись.Организация = Организация;
			НовЗапись.Период = НачалоМесяца(ДатаНачалаДействияНастройки);
			НовЗапись.Настройка = Ссылка;
		Иначе
			НЗ[0].Настройка = Ссылка;
		КонецЕсли;
	Иначе
		НЗ.Очистить();
	КонецЕсли;
	
	НЗ.Записать();
	
КонецПроцедуры
