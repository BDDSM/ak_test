
&НаКлиенте
Процедура УстановитьКартинку()
	
	Если ЗначениеЗаполнено(ИмяФайлаИсточник) Тогда
		Картинка = Новый Картинка(ИмяФайлаИсточник);
		СтрокаКартинка = ПоместитьВоВременноеХранилище(Картинка);
	Иначе
		УстановитьКартинкуИзФайла()
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Функция УстановитьКартинкуИзФайла()
	
	Если ЗначениеЗаполнено(Объект.РасширениеФайла) Тогда
		КаталогКЗаписи = Константы.КаталогХраненияФайловКартинок.Получить();
		Если Прав(КаталогКЗаписи, 1) <> "\" Тогда
			КаталогКЗаписи = КаталогКЗаписи + "\";
		КонецЕсли;	
		КаталогКЗаписи = КаталогКЗаписи + "КартинкиСвойствДляСайта\";
		ИмяФайла = КаталогКЗаписи + Строка(Объект.Ссылка.УникальныйИдентификатор()) + Объект.РасширениеФайла;
		
		СтрокаКартинка = ПоместитьВоВременноеХранилище(Новый Картинка(ИмяФайла));
	КонецЕсли;	
	
КонецФункции

&НаКлиенте
Процедура СтрокаКартинкаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	СтруктураВозврат = ОткрытьФормуМодально("Справочник.Номенклатура.Форма.ФормаВыбораФайлаКартинки", Новый Структура("Фильтр", "(*.png)|*.png"));
	Если СтруктураВозврат <> Неопределено
			И СтруктураВозврат.БылВыборФайла Тогда
		ИмяФайлаИсточник = СтруктураВозврат.ИмяФайла;
		УстановитьКартинку();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	УстановитьКартинку();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если НЕ ЗначениеЗаполнено(ИмяФайлаИсточник)
		И НЕ ЗначениеЗаполнено(Объект.РасширениеФайла) Тогда
		Сообщить("Нельзя записать свойство без привязки файла");
		Отказ = Истина;
		Возврат;
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(ИмяФайлаИсточник) Тогда
		Файл = Новый Файл(ИмяФайлаИсточник);
		Объект.РасширениеФайла = Файл.Расширение;
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	Если ЗначениеЗаполнено(ИмяФайлаИсточник) Тогда
		КаталогКЗаписи = Константы.КаталогХраненияФайловКартинок.Получить();
		Если Прав(КаталогКЗаписи, 1) <> "\" Тогда
			КаталогКЗаписи = КаталогКЗаписи + "\";
		КонецЕсли;	
		КаталогКЗаписи = КаталогКЗаписи + "КартинкиСвойствДляСайта\";
		Картинка = ПолучитьИзВременногоХранилища(СтрокаКартинка);
		Картинка.Записать(КаталогКЗаписи + Строка(Объект.Ссылка.УникальныйИдентификатор()) + Объект.РасширениеФайла);
	КонецЕсли;
	
КонецПроцедуры
