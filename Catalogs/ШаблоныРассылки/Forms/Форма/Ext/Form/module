Перем Документ;
Перем Адрес;
Перем ПредыдущийРежим;
Перем ЗаменятьКартинки;

Процедура ВыполнитьКомандуМеню(Элемент)
	//ОбАвторе(Элемент);
КонецПроцедуры

Процедура ЗагрузитьДокумент(Адрес)
	ЭлементыФормы.ПолеHTMLДокумента.Перейти(Адрес);
КонецПроцедуры

Процедура ВыполнитьКоманду(Кнопка)
	Команда = Сред(Кнопка.Имя, 8);	
	Если ЭлементыФормы.ПолеHTMLДокумента.Документ.queryCommandSupported(Команда) Тогда
		Если ТипЗнч(Кнопка) = Тип("ПолеВыбора") Тогда
			ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand(Команда, Истина, Кнопка.Значение);
		Иначе
			ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand(Команда, Ложь);
		КонецЕсли; 
		ПоказатьРежимыКнопок();
	КонецЕсли;
КонецПроцедуры

Процедура КоманднаяПанельОткрыть(Кнопка)
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.ПолноеИмяФайла = Адрес;
	Диалог.Заголовок = "Выберите html-файл";
	Диалог.Фильтр = "HTML файлы|*.htm*|Все файлы|*.*";
	Диалог.Расширение = "htm";
	
	Если Диалог.Выбрать() Тогда
		Адрес = Диалог.ПолноеИмяФайла;
		ЗагрузитьДокумент(Диалог.ПолноеИмяФайла);
	КонецЕсли;
КонецПроцедуры

Процедура ВыборЦвета(Кнопка)
	Цвет = ЭтотОбъект.ПолучитьФорму("ВыборЦвета").ОткрытьМодально();
	Если Цвет <> Неопределено Тогда
		Команда = Сред(Кнопка.Имя, 8);
		Если ЭлементыФормы.ПолеHTMLДокумента.Документ.queryCommandSupported(Команда) Тогда
			ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand(Команда, Ложь, "" + ПеревестиИз10(Цвет.Красный) + ПеревестиИз10(Цвет.Зеленый) + ПеревестиИз10(Цвет.Синий));
		КонецЕсли;
	КонецЕсли;
	ПоказатьРежимыКнопок();
КонецПроцедуры

Функция ПеревестиИз10(Знач Значение = 0) Экспорт
	Значение = Число(Значение);
	Если Значение <= 0 Тогда
		Возврат "00";
	КонецЕсли;
	
	Значение = Цел(Значение);
	Результат = "";
	
	Пока Значение > 0 Цикл
		Результат = Сред("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",Значение%16+1,1) + Результат;
		Значение = Цел(Значение/16);
	КонецЦикла;
	
	Если СтрДлина(Результат) = 1 Тогда
		Результат = "0" + Результат;
	КонецЕсли; 
	
	Возврат Результат;
КонецФункции

Процедура ПолеHTMLДокументаДокументСформирован(Элемент)
	
	Документ = ЭлементыФормы.ПолеHTMLДокумента.Документ;
	
	Если Не ЗаменятьКартинки Тогда
		
		Возврат
		
	КонецЕсли;
	
	Если ОписаниеHTML <> "" Тогда
		
		ОбщегоНазначения.ЗаменитьНеСуществующиеФайлыВременнымиФайлами(ЭлементыФормы.ПолеHTMLДокумента.Документ.all.tags("img"),ОписаниеHTML);	
		
	КонецЕсли;
	
	ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ОписаниеHTML);
	
	ЗаменятьКартинки = Ложь;
	
КонецПроцедуры

Процедура КоманднаяПанельРисунок(Кнопка)
	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Заголовок = "Выберите файл с рисунком";
	Диалог.Фильтр = "Файлы рисунков|*.gif;*.dib;*.jpg;*.jpeg;*.bmp;*.ico;*.emf;*.wmf;*.tga;*.tif;*.tiff;*.rle;*.iff;*.lbm;*.ilbm;*.jpe;*.jif;*.jfif;*.kdc;*.pcd;*.pcx;*.dcx;*.pic;*.pix;*.png;*.psd;*.sgi;*.bw;*.rgb;*.rgba|Все файлы|*.*";
	Диалог.ПредварительныйПросмотр = Истина;
	
	Если Диалог.Выбрать() Тогда
		
		Картинка = Новый Картинка(Диалог.ПолноеИмяФайла);
		
		НайденныйФайл = НайтиФайлы(Диалог.ПолноеИмяФайла); 
		Расширение = Сред(НайденныйФайл[0].Расширение,2);
		
		СтрокаКартинки=Base64Строка(Картинка.ПолучитьДвоичныеДанные()); 
		//МояКартинка=Новый Картинка(Base64Значение(СтрокаКартинки));
		
		ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand("InsertImage", Ложь, Диалог.ПолноеИмяФайла);
		//Документ.execCommand("InsertImage", Ложь, Диалог.ПолноеИмяФайла);
		//ТекстПисьма = ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
		
		//ЭлементыФормы.ПолеHTMLДокумента.получ
		//ТекстПисьма = СтрЗаменить(ТекстПисьма,"</HEAD>"+Символы.ПС+"<BODY><IMG src="""""+Диалог.ПолноеИмяФайла+""""+"></P></BODY></HTML>","<html><body><img src='data:image/"+Расширение+";base64,"+СтрокаКартинки+"'></img></body></html>");
		
		//ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ТекстПисьма);
	КонецЕсли;
	
	ПоказатьРежимыКнопок();
КонецПроцедуры

Процедура КоманднаяПанельГиперссылка(Кнопка)
	Гиперссылка = ЭтотОбъект.ПолучитьФорму("ВыборГиперссылки").ОткрытьМодально();
	Если Гиперссылка <> Неопределено Тогда
		ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand("CreateLink", Ложь, Гиперссылка);
		//Документ.execCommand("CreateLink", Ложь, Гиперссылка);
	КонецЕсли;
	ПоказатьРежимыКнопок();
КонецПроцедуры

Процедура ПоказатьРежимыКнопок()
	Для каждого Кнопка Из ЭлементыФормы.КоманднаяПанель.Кнопки Цикл
		Если Кнопка.ТипКнопки =  ТипКнопкиКоманднойПанели.Действие Тогда
			Команда = Сред(Кнопка.Имя, 8);
			Если ЭлементыФормы.ПолеHTMLДокумента.Документ.queryCommandSupported(Команда) Тогда
				//Если Документ.queryCommandSupported(Команда) Тогда
				Попытка
					Кнопка.Пометка = ЭлементыФормы.ПолеHTMLДокумента.Документ.queryCommandState(Команда);
					//Кнопка.Пометка = Документ.queryCommandState(Команда);
				Исключение
				КонецПопытки;
			КонецЕсли;
		КонецЕсли; 
	КонецЦикла;
КонецПроцедуры
// Процедура вставляет скриншоты в текст письма
// 
Процедура ВставитьСкриншотНажатие(Элемент)
	сообщить("кнопка скриншот");
	ФайлСкриншота = ПолучитьБуферОбмена();
	Файл = Новый Файл(СокрЛП(ФайлСкриншота));
	Если Не Файл.Существует() Тогда
		Возврат;
	КонецЕсли;
	ЭлементыФормы.ПолеHTMLДокумента.Документ.execCommand("InsertImage", Ложь, Файл.ПолноеИмя);
	
	//Документ.execCommand("InsertImage", Ложь, Файл.ПолноеИмя);
КонецПроцедуры

// Конец командной панели визуальное редактирование

Процедура ПриОткрытии()
	//Вложения.Колонки.Добавить("АдресФайла",,"Адрес прикрепляемого файла");
	//ЭлементыФормы.Вложения.СоздатьКолонки();
	//ДоступныеУЗ=УправлениеЭлектроннойПочтой.ПолучитьДоступныеУчетныеЗаписи(глЗначениеПеременной("глТекущийПользователь"));
	//ДостНаЗапись=ДоступныеУЗ.Запись;
	//Для каждого ЭлМассива из ДостНаЗапись цикл
	//ЭтаФорма.ЭлементыФормы.УчетнаяЗапись.СписокВыбора.Добавить(ЭлМассива);
	//Сообщить(ЭлМассива.Представление+" "+ЭлМассива.Значение);
	//КонецЦикла;
	
	// Для визуальной панели
	ЗаменятьКартинки = Истина;
	// Заполнение списка стилей
	СтилиТекста = ЭлементыФормы.КомандаformatBlock.СписокВыбора;
	СтилиТекста.Добавить("<p>", "Обычный");
	СтилиТекста.Добавить("<h1>", "Заголовок 1");
	СтилиТекста.Добавить("<h2>", "Заголовок 2");
	СтилиТекста.Добавить("<h3>", "Заголовок 3");
	СтилиТекста.Добавить("<h4>", "Заголовок 4");
	СтилиТекста.Добавить("<h5>", "Заголовок 5");
	СтилиТекста.Добавить("<h6>", "Заголовок 6");
	СтилиТекста.Добавить("<pre>", "Форматированный");
	СтилиТекста.Добавить("<address>", "Адрес");
	ЭлементыФормы.КомандаformatBlock.Значение = СтилиТекста[0].Значение;
	
	// Заполнение списка шрифтов
	Список = ЭлементыФормы.КомандаFontName.СписокВыбора;
	Список.Добавить("Arial");
	Список.Добавить("Arial Black");
	Список.Добавить("Arial Narrow");
	Список.Добавить("Comic Sans MS");
	Список.Добавить("Courier New");
	Список.Добавить("System");
	Список.Добавить("Tahoma");
	Список.Добавить("Times New Roman");
	Список.Добавить("Verdana");
	Список.Добавить("Wingdings");
	ЭлементыФормы.КомандаFontName.Значение = Список[0].Значение;
	
	// Заполнение списка размеров
	Список = ЭлементыФормы.КомандаFontSize.СписокВыбора;
	Для Ном = 1 По 14 Цикл
		Список.Добавить(Ном);
	КонецЦикла;
	ЭлементыФормы.КомандаFontSize.Значение = Список[2].Значение;
	ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.УстановитьРежим(РежимПоляHTMLДокумента.Редактирование);
	ЭлементыФормы.ДействияФормы.Кнопки.РедактироватьВнешнимХТМЛРедактором.Доступность = Истина;
	
	ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ОписаниеHTML);
	
	
КонецПроцедуры

Процедура Послать(АдресПолучателя)
	ТекстПисьма = ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
	УЗ=ЭтаФорма.ЭлементыФормы.УчетнаяЗапись.Значение.Значение;
	ИПП=Новый ИнтернетПочтовыйПрофиль;
	ИПП.АдресСервераSMTP=УЗ.SMTPСервер;
	ИПП.ПортSMTP=УЗ.ПортSMTP;
	Если УЗ.ТребуетсяSMTPАутентификация Тогда
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.ПоУмолчанию;
		ИПП.ПарольSMTP         = УЗ.ПарольSMTP;
		ИПП.ПользовательSMTP   = УЗ.ЛогинSMTP;
	Иначе
		ИПП.АутентификацияSMTP = СпособSMTPАутентификации.БезАутентификации;
		ИПП.ПарольSMTP         = "";
		ИПП.ПользовательSMTP   = "";
	КонецЕсли;
	Письмо=Новый ИнтернетПочтовоеСообщение;
	Письмо.Отправитель=УЗ.АдресЭлектроннойПочты;
	Письмо.Получатели.Добавить(АдресПолучателя);
	Для Каждого ТекАдр Из Вложения Цикл
		Письмо.Вложения.Добавить(ТекАдр.АдресФайла);
	КонецЦикла;
	Письмо.Тема=Тема;
	Письмо.Тексты.Добавить(ТекстПисьма,ТипТекстаПочтовогоСообщения.HTML);
	Почта=Новый ИнтернетПочта;
	Почта.Подключиться(ИПП);
	Почта.Послать(Письмо);
	Почта.Отключиться();
КонецПроцедуры

Процедура ДобавитьВложение(Элемент)
	Диалог=Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр="Файл *.* (*.*)|*.*";
	Диалог.Заголовок="Выберите файл";
	Диалог.ПредварительныйПросмотр=Ложь;
	Диалог.ПроверятьСуществованиеФайла=	Истина;
	Если Диалог.Выбрать() Тогда
		НовыйАдрес=Вложения.Добавить();
		НовыйАдрес.АдресФайла=Диалог.ПолноеИмяФайла;
	КонецЕсли;
КонецПроцедуры

Процедура УдалитьВложение(Элемент)
	Если Вложения.Количество()>0 Тогда
		Вложения.Удалить(ЭлементыФормы.Вложения.ТекущаяСтрока);
	КонецЕсли;
КонецПроцедуры

Процедура УдалитьВсеВложения(Элемент)
	Вложения.Очистить();
КонецПроцедуры

Процедура ПолеHTMLДокументаonclick(Элемент, pEvtObj)
	ПоказатьРежимыКнопок();
КонецПроцедуры

Процедура Панель1ПриСменеСтраницы(Элемент, ТекущаяСтраница)
	Если Не ЭтаФорма.ЭлементыФормы.Панель1.ТекущаяСтраница=ЭтаФорма.ЭлементыФормы.Панель1.Страницы.Страница1 тогда
		ОписаниеHTML = ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
	Иначе
		ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ОписаниеHTML);
	КонецЕсли;
	
	
	
КонецПроцедуры

Процедура НадписьИнфостартНажатие(Элемент)
	ЗапуститьПриложение(СокрЛП(ЭлементыФормы.АдресИнфостарт.Заголовок));
КонецПроцедуры

Процедура ДействияФормыРедактироватьВнешнимХТМЛРедактором(Кнопка)
	
	Если ЗначениеЗаполнено(ИмяФайлаРедактированияХТМЛТекста) Тогда
		Файл = Новый Файл(ИмяФайлаРедактированияХТМЛТекста);
		Если НЕ Файл.Существует() Тогда
			ОтветНаВопрос = Вопрос("Файл редактирования текста не найден. Сделать письмо доступным для редактирования?", РежимДиалогаВопрос.ОКОтмена);
			Если ОтветНаВопрос = КодВозвратаДиалога.ОК Тогда
				ОтветНаВопрос = Вопрос("Текст письма будет очищен!", РежимДиалогаВопрос.ОКОтмена);
				Если ОтветНаВопрос = КодВозвратаДиалога.ОК Тогда
					ИмяФайлаРедактированияХТМЛТекста      = "";
					ИмяКомпьютераРедактированияХТМЛТекста = "";
					ТекстПисьма = "";
				КонецЕсли; 
			КонецЕсли; 
		Иначе
			ОсвободитьТекст();
		КонецЕсли;
	Иначе
		ТекстПисьма = ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
		Если НЕ ЗахватитьТекст() Тогда
			Возврат;
		КонецЕсли; 
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ИмяФайлаРедактированияХТМЛТекста) Тогда
		ЭлементыФормы.ПолеHTMLДокумента.УстановитьРежим(РежимПоляHTMLДокумента.Просмотр);
	Иначе
		ЭлементыФормы.ПолеHTMLДокумента.УстановитьРежим(РежимПоляHTMLДокумента.Редактирование);
	КонецЕсли; 
	
	ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ТекстПисьма);
	
КонецПроцедуры

Процедура КоманднаяПанельПолучитьТекстHTML(Кнопка)
	
	ОткрытьФорму("ВнешняяОбработка.МассоваяРассылка.ФормаЭлемента");
	
	
	// Вставить содержимое обработчика.
КонецПроцедуры

Процедура ПослеЗаписи()
	
	ОписаниеHTML = ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.ПолучитьТекст();
	
	Картинки = ЭлементыФормы.ПолеHTMLДокумента.Документ.all.tags("img");	
	
	Соответствие = Новый Соответствие;
	
	Для каждого ТекКартинка Из Картинки Цикл
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ХранилищеДополнительнойИнформации.Ссылка
		|ИЗ
		|	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
		|ГДЕ
		|	ХранилищеДополнительнойИнформации.ИмяФайла ПОДОБНО &ИмяФайла"; 
		
		Если Найти(ТекКартинка.href,"http") Тогда
		
			Продолжить;
		
		КонецЕсли;
		
		ФайлКартинки = Новый Файл(СтрЗаменить(ТекКартинка.href,"file:///",""));
		
		Запрос.УстановитьПараметр("ИмяФайла",ФайлКартинки.ИмяБезРасширения);
		
		Результат = Запрос.Выполнить();
		
		Если Результат.Пустой() Тогда
			
			СпрОбъект = Справочники.ХранилищеДополнительнойИнформации.СоздатьЭлемент();
			
			УИД = Новый УникальныйИдентификатор; 
			
			СпрОбъект.УстановитьСсылкуНового(Справочники.ХранилищеДополнительнойИнформации.ПолучитьСсылку(УИД));
			
			СпрОбъект.ИмяФайла = Строка(УИД);
			
			СпрОбъект.Наименование = Строка(УИД);
			
			Попытка
				
				Картинка = Новый ДвоичныеДанные(ФайлКартинки.ПолноеИмя);     			
				
			Исключение
				
				Продолжить;
				
			КонецПопытки;
			
			СпрОбъект.Объект = Ссылка;
			
			СпрОбъект.Хранилище = Новый ХранилищеЗначения(Картинка);
			
			СпрОбъект.Записать(); 
			
			ИмяВременногоФайла = КаталогВременныхФайлов()+УИД+Прав(ТекКартинка.href,4);
			
			Соответствие.Вставить("<IMG src="+""""+ИмяВременногоФайла+""""+">",ТекКартинка.outerHTML);
			
			Картинка.Записать(ИмяВременногоФайла);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Для каждого ТекСоответствие Из Соответствие Цикл
		
		ОписаниеHTML = СтрЗаменить(ОписаниеHTML,ТекСоответствие.Значение,ТекСоответствие.Ключ);
		
	КонецЦикла;
	
	ЭтаФорма.ЭлементыФормы.ПолеHTMLДокумента.УстановитьТекст(ОписаниеHTML);
	
КонецПроцедуры

