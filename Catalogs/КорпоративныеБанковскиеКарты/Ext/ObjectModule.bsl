
Функция ЕстьДубльКарты()
	
	Если СокрЛП(ЭтотОбъект.НомерКорпоративнойКарты) = "" Тогда
		Возврат Ложь;	
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТекущийЭлемент"	, ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Номер"			, ЭтотОбъект.НомерКорпоративнойКарты);
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	СпрКарты.Ссылка
	|ИЗ
	|	Справочник.КорпоративныеБанковскиеКарты КАК СпрКарты
	|ГДЕ
	|	СпрКарты.НомерКорпоративнойКарты = &Номер
	|	И НЕ СпрКарты.Ссылка = &ТекущийЭлемент
	|	И НЕ СпрКарты.ПометкаУдаления";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции


Процедура ПередЗаписью(Отказ)
	
	Если ЕстьДубльКарты() Тогда
		Сообщить("Данный номер корпоративной карты (" + ЭтотОбъект.НомерКорпоративнойКарты + ") уже используется!");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	ТекНаименование = СокрЛП(ЭтотОбъект.ФизЛицо.Наименование) + " " + ЭтотОбъект.НомерКорпоративнойКарты;
	Если НЕ ЭтотОбъект.Наименование = ТекНаименование Тогда
		ЭтотОбъект.Наименование = ТекНаименование;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	Если НЕ ЭтотОбъект.ФизЛицо.НомерКорпоративнойКарты = ЭтотОбъект.Ссылка Тогда
		//ЭтотОбъект.ФизЛицо.НомерКорпоративнойКарты = ЭтотОбъект.Ссылка; 
		ОбъектСправочника = ЭтотОбъект.ФизЛицо.ПолучитьОбъект();
		ОбъектСправочника.НомерКорпоративнойКарты = ЭтотОбъект.Ссылка;
		Попытка
			ОбъектСправочника.Записать();;
		Исключение
			
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры
