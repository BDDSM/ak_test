
&НаКлиенте
Процедура ИмпортИзExcel(Команда)
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	
	ДиалогВыбораФайла.Заголовок = "Открыть файл с данными";
	ДиалогВыбораФайла.Фильтр    = "Файл Excel (*.xls)|*.xls";
	
	Если НЕ ДиалогВыбораФайла.Выбрать() Тогда
		Возврат;
	КонецЕсли;
	
	xl = Новый COMОбъект("Excel.Application");
	xl_документ = xl.Workbooks.Open(ДиалогВыбораФайла.ПолноеИмяФайла);
	xl_лист  = xl_документ.Sheets(1);
	
	й=1;
	КоличествоПустых = 10;
	Пока КоличествоПустых>0 Цикл	
		й = й + 1;
		ТекстВопроса = СокрЛП(xl_лист.cells(й,2).value);
		ТекстОтвета = СокрЛП(xl_лист.cells(й,3).value);
		Папка = СокрЛП(xl_лист.cells(й,4).value);
		Если НЕ ЗначениеЗаполнено(ТекстВопроса) Тогда
			КоличествоПустых = КоличествоПустых - 1;
			Продолжить;
		КонецЕсли;
		СтруктураВопроса=Новый Структура;
		СтруктураВопроса.Вставить("ТекстВопроса",ТекстВопроса);
		СтруктураВопроса.Вставить("ТекстОтвета",ТекстОтвета);
		СтруктураВопроса.Вставить("Папка",Папка);
		ЗаписатьЭлементНаСервере(СтруктураВопроса);
	КонецЦикла;	
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьЭлементНаСервере(СтруктураВопроса)
	Папка=Справочники.ОпросникДляЭкзаменацииПродавца.НайтиПоНаименованию(СтруктураВопроса.Папка);
	Если Папка.Пустая() Тогда
		Папка=Справочники.ОпросникДляЭкзаменацииПродавца.СоздатьГруппу();
		Папка.Наименование=СтруктураВопроса.Папка;
		Папка.Записать();
		Папка=Папка.Ссылка;
	КонецЕсли;
	Вопрос=Справочники.ОпросникДляЭкзаменацииПродавца.СоздатьЭлемент();
	ЗаполнитьЗначенияСвойств(Вопрос,СтруктураВопроса);
	Вопрос.Родитель=Папка;
	Вопрос.Наименование=Вопрос.ТекстВопроса;
	Вопрос.Проект = Истина;
	Вопрос.Записать();
	
КонецПроцедуры	

&НаКлиенте
Процедура ВсеВАрхив(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "ru = ""Внимание! ВСЕ АКТУАЛЬНЫЕ ВОПРОСЫ БУДУТ ПЕРЕНЕСЕНЫ В АРХИВ.Продолжить выполнение операции?"";";
	Ответ = Вопрос(НСтр(Текст), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	ПеренестиВсеВопросыВАрхивСервер(, Ложь);
	ЭтаФорма.ОбновитьОтображениеДанных();
КонецПроцедуры

&НаСервере
Процедура ПеренестиВсеВопросыВАрхивСервер(Папка = Неопределено,ТолькоПриНаличииПроектных = Истина);
	//+++АК POZM 2018.02.05 ИП-00017762 
	//ТекстЗапроса="ВЫБРАТЬ
	//             |	ОпросникДляЭкзаменацииПродавца.Ссылка
	//             |ИЗ
	//             |	Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца
	//             |ГДЕ
	//             |	НЕ ОпросникДляЭкзаменацииПродавца.Устарел
	//             |	И НЕ ОпросникДляЭкзаменацииПродавца.Проект
	//             |	И НЕ ОпросникДляЭкзаменацииПродавца.ЭтоГруппа
	//             |	И (ОпросникДляЭкзаменацииПродавца.Родитель = &Родитель
	//             |			ИЛИ &ВсеПапки)";
	
	ТекстЗапроса="ВЫБРАТЬ
	             |	ОпросникДляЭкзаменацииПродавца.Ссылка,
	             |	ОпросникДляЭкзаменацииПродавца.Родитель,
	             |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ОпросникДляЭкзаменацииПродавца1.Ссылка) КАК ПроектныхВПапке
	             |ИЗ
	             |	Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца
	             |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца1
	             |		ПО ОпросникДляЭкзаменацииПродавца.Родитель = ОпросникДляЭкзаменацииПродавца1.Родитель
	             |			И (ОпросникДляЭкзаменацииПродавца1.Проект)
	             |ГДЕ
	             |	НЕ ОпросникДляЭкзаменацииПродавца.Устарел
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.Проект
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.ЭтоГруппа
	             |	И (ОпросникДляЭкзаменацииПродавца.Родитель = &Родитель
	             |			ИЛИ &ВсеПапки)
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	ОпросникДляЭкзаменацииПродавца.Ссылка,
	             |	ОпросникДляЭкзаменацииПродавца.Родитель";
	
	//---АК POZM 
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.УстановитьПараметр("ВсеПапки",Папка = Неопределено);
	Запрос.УстановитьПараметр("Родитель",Папка);
	Выборка=Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		//+++АК POZM 2018.02.05 ИП-00017762 
		Если ТолькоПриНаличииПроектных И Выборка.ПроектныхВПапке = 0 Тогда
			Продолжить;
		КонецЕсли;	
		//---АК POZM 
		Спр=Выборка.Ссылка.ПолучитьОбъект();
		Спр.Устарел=Истина;
		Спр.Записать();
		
	КонецЦикла;	
КонецПроцедуры	

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ТолькоАктуальные=Истина;
	ТолькоАктуальныеПриИзмененииСервер();
	СрокСообщенияОНовыхВопросах = Константы.СрокОповещенияОНовыхВопросахТестированияПродавцов.Получить();
КонецПроцедуры

&НаКлиенте
Процедура ТолькоАктуальныеПриИзменении(Элемент)
	Если ТолькоАктуальные Тогда
		ТолькоПроект = ЛОЖЬ;
	КонецЕсли;	
	
	ТолькоАктуальныеПриИзмененииСервер();
	Элементы.Список.Обновить();
КонецПроцедуры	
&НаСервере
Процедура ТолькоАктуальныеПриИзмененииСервер()
	Для Каждого Эл Из	Список.Отбор.Элементы Цикл
		Если СокрЛП(Эл.ЛевоеЗначение)="Устарел" Тогда
			Если ТолькоАктуальные Тогда
				Эл.Использование=Истина;
				Эл.ПравоеЗначение = Ложь;
			Иначе
				Эл.Использование=Ложь;
			КонецЕсли;	
		ИначеЕсли СокрЛП(Эл.ЛевоеЗначение)="Проект" Тогда
			Если ТолькоПроект Тогда
				Эл.Использование=Истина;
				Эл.ПравоеЗначение = Истина;
			ИначеЕсли ТолькоАктуальные Тогда
				Эл.Использование=Истина;
				Эл.ПравоеЗначение = Ложь;	
			Иначе
				Эл.Использование=Ложь;
			КонецЕсли;		
		КонецЕсли;	
	КонецЦикла;	
	
	
	
КонецПроцедуры

&НаКлиенте
Процедура ТолькоПроектПриИзменении(Элемент)
	Если ТолькоПроект Тогда
		ТолькоАктуальные = ЛОЖЬ;
	КонецЕсли;
	ТолькоАктуальныеПриИзмененииСервер();
	Элементы.Список.Обновить();
КонецПроцедуры

&НаКлиенте
Процедура ТекущиеВАрхивПроектВТекущие(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Текст = "ru = ""Внимание! ВСЕ АКТУАЛЬНЫЕ ВОПРОСЫ БУДУТ ПЕРЕНЕСЕНЫ В АРХИВ.Продолжить выполнение операции?"";";
	Ответ = Вопрос(НСтр(Текст), Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли; 
	КолВо=0;
	ПеренестиВсеВопросыВАрхивСервер();
	ПроектВТекущиеНаСервере();
	ЭтаФорма.ОбновитьОтображениеДанных();
КонецПроцедуры

&НаСервере
Процедура ТекущиеВАрхивПроектВТекущиеНаСервере(Папка = Неопределено)
	ТекстЗапроса="ВЫБРАТЬ
	             |	ОпросникДляЭкзаменацииПродавца.Ссылка
	             |ИЗ
	             |	Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца
	             |ГДЕ
	             |	НЕ ОпросникДляЭкзаменацииПродавца.Устарел
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.Проект
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.ЭтоГруппа
	             |	И (ОпросникДляЭкзаменацииПродавца.Родитель = &Родитель
	             |			ИЛИ &ВсеПапки)
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ОпросникДляЭкзаменацииПродавца.Ссылка
	             |ИЗ
	             |	Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца
	             |ГДЕ
	             |	НЕ ОпросникДляЭкзаменацииПродавца.Устарел
	             |	И ОпросникДляЭкзаменацииПродавца.Проект
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.ЭтоГруппа
	             |	И (ОпросникДляЭкзаменацииПродавца.Родитель = &Родитель
	             |			ИЛИ &ВсеПапки)";
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.УстановитьПараметр("ВсеПапки",Папка = Неопределено);
	Запрос.УстановитьПараметр("Родитель",Папка);
	Результат = Запрос.ВыполнитьПакет();
	Выборка = Результат[0].Выбрать();
	Пока Выборка.Следующий() Цикл
		Спр=Выборка.Ссылка.ПолучитьОбъект();
		Спр.Устарел=Истина;
		Спр.Записать();
	КонецЦикла;	
	
	Выборка = Результат[1].Выбрать();
	Пока Выборка.Следующий() Цикл
		Спр=Выборка.Ссылка.ПолучитьОбъект();
		Спр.Проект=ЛОЖЬ;
		Спр.Записать();
	КонецЦикла;	
КонецПроцедуры	


&НаСервере
Процедура ПроектВТекущиеНаСервере(Папка = Неопределено)
	ТекстЗапроса="ВЫБРАТЬ
	             |	ОпросникДляЭкзаменацииПродавца.Ссылка
	             |ИЗ
	             |	Справочник.ОпросникДляЭкзаменацииПродавца КАК ОпросникДляЭкзаменацииПродавца
	             |ГДЕ
	             |	НЕ ОпросникДляЭкзаменацииПродавца.Устарел
	             |	И ОпросникДляЭкзаменацииПродавца.Проект
	             |	И НЕ ОпросникДляЭкзаменацииПродавца.ЭтоГруппа
	             |	И (ОпросникДляЭкзаменацииПродавца.Родитель = &Родитель
	             |			ИЛИ &ВсеПапки)";
	Запрос=Новый Запрос(ТекстЗапроса);			 
	Запрос.УстановитьПараметр("ВсеПапки",Папка = Неопределено);
	Запрос.УстановитьПараметр("Родитель",Папка);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Спр=Выборка.Ссылка.ПолучитьОбъект();
		Спр.Проект=Ложь;
		Спр.Записать();
	КонецЦикла;	
КонецПроцедуры


&НаКлиенте
Процедура ПроектВТекущие(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Перенести все проектные вопросы в текущие?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
    	Возврат;
	КонецЕсли;

	ПроектВТекущиеНаСервере();
	Элементы.Список.Обновить();
КонецПроцедуры


&НаКлиенте
Процедура ПапкуВАрхив(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Перенести все текущие вопросы папки в архив?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
    	Возврат;
	КонецЕсли;
	ПеренестиВсеВопросыВАрхивСервер(Элементы.Дерево.ТекущаяСтрока,Ложь);
	Элементы.Список.Обновить();
КонецПроцедуры


&НаКлиенте
Процедура ПроектВТекущиеПапка(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Перенести все проектные вопросы папки в текущие?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
    	Возврат;
	КонецЕсли;
	ПроектВТекущиеНаСервере(Элементы.Дерево.ТекущаяСтрока);
	Элементы.Список.Обновить();
КонецПроцедуры


&НаКлиенте
Процедура ТекущиеВАрхивПроектВТекущиеПапка(Команда)
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос("Перенести все текущие вопросы папки в архив, а все проектные вопросы папки в текущие?", Режим, 0);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
    	Возврат;
	КонецЕсли;
	ТекущиеВАрхивПроектВТекущиеНаСервере(Элементы.Дерево.ТекущаяСтрока);
	Элементы.Список.Обновить();
КонецПроцедуры


&НаКлиенте
Процедура СрокСообщенияПриИзменении(Элемент)
	СрокСообщенияПриИзмененииСервер();
	
КонецПроцедуры

&НаСервере
Процедура СрокСообщенияПриИзмененииСервер()
	Константы.СрокОповещенияОНовыхВопросахТестированияПродавцов.Установить(СрокСообщенияОНовыхВопросах);
КонецПроцедуры	

