Процедура ПередЗаписью(Отказ)
	
	Если ОбменДанными.Загрузка тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаблицаСостава.КодКладр КАК КодКладр
		|ПОМЕСТИТЬ Состав
		|ИЗ
		|	&ТаблицаСостава КАК ТаблицаСостава
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	КодКладр
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТаблицаТехнологов.Технолог КАК Технолог,
		|	ТаблицаТехнологов.ПродуктоваяКатегория КАК ПродуктоваяКатегория
		|ПОМЕСТИТЬ Технологи
		|ИЗ
		|	&ТаблицаТехнологов КАК ТаблицаТехнологов
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Технолог,
		|	ПродуктоваяКатегория
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
		|	АК_УправлениеКачестваСостав.Ссылка.Наименование КАК Наименование,
		|	АК_УправлениеКачестваСостав.КодКладр
		|ИЗ
		|	Справочник.АК_УправлениеКачества.Состав КАК АК_УправлениеКачестваСостав
		|ГДЕ
		|	АК_УправлениеКачестваСостав.Ссылка <> &Ссылка
		|	И АК_УправлениеКачестваСостав.КодКладр В
		|			(ВЫБРАТЬ
		|				Состав.КодКладр
		|			ИЗ
		|				Состав)
		|
		|УПОРЯДОЧИТЬ ПО
		|	Наименование
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
		|	АК_УправлениеКачестваТехнологи.Ссылка.Наименование КАК Наименование,
		|	АК_УправлениеКачестваТехнологи.Технолог.Наименование КАК ТехнологНаименование,
		|	АК_УправлениеКачестваТехнологи.ПродуктоваяКатегория КАК ПродуктоваяКатегория
		|ИЗ
		|	Справочник.АК_УправлениеКачества.Технологи КАК АК_УправлениеКачестваТехнологи
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Технологи КАК Технологи
		|		ПО АК_УправлениеКачестваТехнологи.Технолог = Технологи.Технолог
		|			И АК_УправлениеКачестваТехнологи.ПродуктоваяКатегория = Технологи.ПродуктоваяКатегория
		|ГДЕ
		|	АК_УправлениеКачестваТехнологи.Ссылка <> &Ссылка
		|	И АК_УправлениеКачестваТехнологи.Технолог В
		|			(ВЫБРАТЬ
		|				Технологи.Технолог
		|			ИЗ
		|				Технологи)
		|	И АК_УправлениеКачестваТехнологи.ПродуктоваяКатегория В
		|			(ВЫБРАТЬ
		|				Технологи.ПродуктоваяКатегория
		|			ИЗ
		|				Технологи)
		|
		|УПОРЯДОЧИТЬ ПО
		|	Наименование,
		|	ТехнологНаименование,
		|	ПродуктоваяКатегория
		|АВТОУПОРЯДОЧИВАНИЕ";

	Запрос.Параметры.Вставить("Ссылка", Ссылка);
	Запрос.Параметры.Вставить("ТаблицаСостава ", Состав.Выгрузить());
	Запрос.Параметры.Вставить("ТаблицаТехнологов ", Технологи.Выгрузить());

	Результаты = Запрос.ВыполнитьПакет();

	
	Результат=Результаты[2];
	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Если ВыборкаДетальныеЗаписи.Следующий() тогда
		
		КлассификаторАдресов = РегистрыСведений.АдресныйКлассификатор.ПолучитьМакет("ТаблицаРегионов");
		
		ВсегоЗаписей = КлассификаторАдресов.ВысотаТаблицы - 1;
		
		Для Сч = 2 По КлассификаторАдресов.ВысотаТаблицы Цикл
			
			КодКладр = СокрЛП(КлассификаторАдресов.Область(Сч, 1, Сч, 1).Текст);
			Если ВыборкаДетальныеЗаписи.КодКладр=КодКладр тогда
				Наименование = СокрЛП(КлассификаторАдресов.Область(Сч, 2, Сч, 2).Текст);
				Сокращение   = СокрЛП(КлассификаторАдресов.Область(Сч, 3, Сч, 3).Текст);
				Если врег(лев(Сокращение,1))=лев(Сокращение,1) тогда
					Наименование=Наименование+" "+Сокращение;
				иначе
				    Наименование=Наименование+", "+Сокращение;
				КонецЕсли;
				ОбщегоНазначения.СообщитьОбОшибке(сокрлп("Пересечение по составу с "+ВыборкаДетальныеЗаписи.Наименование)+", регион "+Наименование,Отказ);
				возврат;
			КонецЕсли;		
		КонецЦикла;
		//если вдруг регион не найден
		ОбщегоНазначения.СообщитьОбОшибке(сокрлп("Пересечение по составу с "+ВыборкаДетальныеЗаписи.Наименование)+", регион НЕ НАЙДЕН",Отказ);
		Возврат;
	КонецЕсли;

	Результат=Результаты[3];
	ВыборкаДетальныеЗаписи = Результат.Выбрать();

	Если ВыборкаДетальныеЗаписи.Следующий() тогда
		ОбщегоНазначения.СообщитьОбОшибке(сокрлп("Пересечение с "+ВыборкаДетальныеЗаписи.Наименование)+", технолог: "+сокрлп(ВыборкаДетальныеЗаписи.ТехнологНаименование)+", категория: "+сокрлп(""+ВыборкаДетальныеЗаписи.ПродуктоваяКатегория),Отказ);
	КонецЕсли;

КонецПроцедуры
