
Процедура ЗаполнитьФайлы()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Тема"	, ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Номер"	, 0);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ФорумФайлы.ЭтоКартинка,
	|	ФорумФайлы.ИмяФайла,
	|	ФорумФайлы.ПолноеИмяФайла,
	|	ФорумФайлы.Файл,
	|	ФорумФайлы.Размер,
	|	ЛОЖЬ КАК Новый
	|ИЗ
	|	РегистрСведений.ФорумФайлы КАК ФорумФайлы
	|ГДЕ
	|	ФорумФайлы.Объект = &Тема
	|	И ФорумФайлы.Номер = &Номер";
	
	//
	ЭтаФорма.ФорумФайлы = Запрос.Выполнить().Выгрузить();
	
КонецПроцедуры	


Процедура ПриОткрытии()
	
	Если ЭтотОбъект.ЭтоНовый() Тогда
		ЭтотОбъект.КартинкаТемы = "icon1000.gif";
		ЭлементыФормы.НадписьКартинкаТемы.Картинка = БиблиотекаКартинок[СтрЗаменить(ЭтотОбъект.КартинкаТемы, ".", "")];
		ЭтотОбъект.КоличествоПостов 		= 0;
		ЭтотОбъект.КоличествоПросмотров 	= 0;
		
		ЭтотОбъект.ДатаСоздания 		= ТекущаяДата();
		ЭтотОбъект.ДатаПоследнегоПоста 	= ЭтотОбъект.ДатаСоздания;
		
		ЭтотОбъект.Прикреплена 			= Ложь;
		ЭтотОбъект.Закрыта 				= Ложь;
		ЭтотОбъект.Автор 				= ЭтаФорма.Пользователь;
		ЭтотОбъект.АвторПоследнегоПоста = ЭтаФорма.Пользователь;
	Иначе
		ЗаполнитьФайлы();
		КартинкаТемыПриИзменении(0);
	КонецЕсли;
	
	Если ЭтаФорма.ИспользоватьФормуОбъектаКонфигурации Тогда
		ЭлементыФормы.НадписьСсылкаНаОбъект.Видимость 	= Истина;
		ЭлементыФормы.СсылкаНаОбъект.Видимость 			= Истина;
		ЭлементыФормы.СсылкаНаОбъект.Доступность 		= Ложь;
		ЭлементыФормы.Наименование.Доступность 			= Ложь;
		ЭлементыФормы.НадписьНаименование.Доступность 	= Ложь;
	КонецЕсли;	
	
	ЭлементыФормы.ПолеHTMLДокумента1.УстановитьТекст(ЭтотОбъект.Описание);
	
	//+++ AK suvv 19.06.2018 ИП-00018230
	//Если ОбработкаФорум.ТекущийПользовательАдмин() Тогда
	Если ТекущийПользовательАдмин() Тогда 
	//--- AK suvv
		ЭлементыФормы.Закрыта.Видимость 		= Истина;
		ЭлементыФормы.Закрыта.Доступность 		= Истина;
		
		ЭлементыФормы.Прикреплена.Видимость 	= Истина;
		ЭлементыФормы.Прикреплена.Доступность 	= Истина;
	КонецЕсли;
	
КонецПроцедуры


Процедура КартинкаТемыПриИзменении(Элемент)
	
	ЭлементыФормы.НадписьКартинкаТемы.Картинка = БиблиотекаКартинок[СтрЗаменить(ЭтотОбъект.КартинкаТемы, ".", "")];
	
КонецПроцедуры

Процедура СсылкаНаОбъектПриИзменении(Элемент)
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.СсылкаНаОбъект) Тогда
		Возврат;
	КонецЕсли;
	
КонецПроцедуры


Процедура КоманднаяПанель2ДобавитьФайл(Кнопка)
	
	// выбор файла
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогОткрытияФайла.ПолноеИмяФайла		= "";
	ДиалогОткрытияФайла.Фильтр				= "Любые файлы(*.*)|*.*";
	ДиалогОткрытияФайла.МножественныйВыбор	= Ложь;
	ДиалогОткрытияФайла.Заголовок			= "Выберите файл";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
		МасФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
		Для каждого ТекФайл из МасФайлов Цикл
			ПутьКФайлу = ТекФайл;
		КонецЦикла;
	КонецЕсли;
	Если СокрЛП(ПутьКФайлу) = "" Тогда 
		Сообщить("Не выбран файл !", СтатусСообщения.Важное);
		Возврат;
	КонецЕсли;
	Файл = Новый Файл(ПутьКФайлу);
	Если НЕ Файл.Существует() Тогда 
		Сообщить("Не выбран файл !", СтатусСообщения.Важное);
		Возврат;
	КонецЕсли;
	
	//
	Попытка
		АватарП = Новый Картинка(ПутьКФайлу);
		Если АватарП.Формат() <> ФорматКартинки.НеизвестныйФормат Тогда
			ЭтоКартинка = Истина;
		Иначе
			ЭтоКартинка = Ложь;
		КонецЕсли;	
	Исключение
	    ЭтоКартинка = Ложь;
	КонецПопытки;
	
	ИмяФайла = Прав(ДиалогОткрытияФайла.ПолноеИмяФайла, СтрДлина(ДиалогОткрытияФайла.ПолноеИмяФайла) - СтрДлина(ДиалогОткрытияФайла.Каталог));
	ИмяФайла = СтрЗаменить(ИмяФайла, "_", "");
	
	//
	НоваяСтрока = ЭтаФорма.ФорумФайлы.Добавить();
	НоваяСтрока.ЭтоКартинка 	= ЭтоКартинка;
	НоваяСтрока.ИмяФайла 		= ИмяФайла;
	НоваяСтрока.Размер 			= Файл.Размер();
	НоваяСтрока.ПолноеИмяФайла 	= ПутьКФайлу;
	НоваяСтрока.Новый 			= Истина;
	
КонецПроцедуры

Процедура КоманднаяПанель2УдалитьФайл(Кнопка)
	
	Если ЭлементыФормы.ТабличноеПоле1.ТекущаяСтрока <> Неопределено Тогда
		ФорумФайлы.Удалить(ЭлементыФормы.ТабличноеПоле1.ТекущаяСтрока);
	КонецЕсли;
	
КонецПроцедуры

Процедура КоманднаяПанель1ВставитьФайл(Кнопка)
	
	СтрФ = ЭтаФорма.ФорумФайлы.ВыбратьСтроку("Выберите файл");
	Если СтрФ = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	//
	Имя = СтрФ.ИмяФайла;
	Если СтрФ.ЭтоКартинка Тогда
		Если Вопрос("Вставить картинку? (нет - вставить файл)", РежимДиалогаВопрос.ДаНет,, КодВозвратаДиалога.Да) = КодВозвратаДиалога.Да Тогда
			Имя = "#IMG_" + Имя + "#";
		Иначе	
			Имя = "#FILE_" + Имя + "#";
		КонецЕсли;	
	Иначе	
		Имя = "#FILE_" + Имя + "#";
	КонецЕсли;	
	ЭлементыФормы.ПолеHTMLДокумента1.Документ.Selection.createRange().text = Имя;

КонецПроцедуры	

Процедура ОсновныеДействияФормыОсновныеДействияФормыОК(Кнопка)
	
	ЭтотОбъект.Описание = ЭлементыФормы.ПолеHTMLДокумента1.Документ.body.innerHTML;
	
	Если ЭтаФорма.ИспользоватьФормуОбъектаКонфигурации Тогда
		
		Если Найти(ТипЗнч(ЭтотОбъект.СсылкаНаОбъект), "Документ") Тогда
			ВерхнийУровень = Справочники.Форум.Документы;
		ИначеЕсли Найти(ТипЗнч(ЭтотОбъект.СсылкаНаОбъект), "Справочник") Тогда
			ВерхнийУровень = Справочники.Форум.Справочники;
		Иначе	
			Возврат;
		КонецЕсли;	
		
		Род = Справочники.Форум.НайтиПоНаименованию(ЭтотОбъект.ВидОбъекта, Истина, ВерхнийУровень);
		Если НЕ ЗначениеЗаполнено(Род) Тогда
			Род = Справочники.Форум.СоздатьГруппу();
			Род.Родитель 		= ВерхнийУровень;
			Род.Наименование 	= ЭтотОбъект.ВидОбъекта;
			Род.Записать();
			Род = Род.Ссылка;
		КонецЕсли;
		Родитель = Род;
	КонецЕсли;	
	
	Если ЭтотОбъект.ЭтоНовый() Тогда
		ЭтоНовый = Истина;
	Иначе
		ЭтоНовый = Ложь;
	КонецЕсли;	
	
	Записать();
	
	//
	Если ЭтоНовый Тогда
		ПользовательОб = ЭтаФорма.Пользователь.ПолучитьОбъект();
		ПользовательОб.КоличествоСообщений = ПользовательОб.КоличествоСообщений + 1;
		ПользовательОб.Записать();
	КонецЕсли;	
	
	РегФорумФайлы = РегистрыСведений.ФорумФайлы;
	
	//
	Для Каждого СтрокаТаблицы Из ЭтаФорма.ФорумФайлы Цикл
		
		Если НЕ СтрокаТаблицы.Новый Тогда
			Продолжить;
		КонецЕсли;	
		
		ЗаписьФ = РегФорумФайлы.СоздатьМенеджерЗаписи();
		ЗаписьФ.Объект 					= ЭтотОбъект.Ссылка;
		ЗаписьФ.ИмяФайла 				= СтрокаТаблицы.ИмяФайла;
		ЗаписьФ.ЭтоКартинка 			= СтрокаТаблицы.ЭтоКартинка;
		ЗаписьФ.Размер 					= СтрокаТаблицы.Размер;
		ЗаписьФ.КоличествоСкачиваний 	= 0;
		ЗаписьФ.Номер 					= 0;
		ЗаписьФ.ПолноеИмяФайла 			= СтрЗаменить("" + ЭтотОбъект.Ссылка.Код + 0 + СтрокаТаблицы.ИмяФайла, " ", "");
		ЗаписьФ.Файл 					= Новый ХранилищеЗначения(Новый ДвоичныеДанные(СтрокаТаблицы.ПолноеИмяФайла), Новый СжатиеДанных(6));
		ЗаписьФ.Записать();
		
	КонецЦикла;
	
	//
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Тема"	, ЭтотОбъект.Ссылка);
	Запрос.УстановитьПараметр("Номер"	, 0);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ФорумФайлы.ЭтоКартинка,
	|	ФорумФайлы.ИмяФайла,
	|	ФорумФайлы.ПолноеИмяФайла,
	|	ФорумФайлы.Размер,
	|	ЛОЖЬ КАК Новый
	|ИЗ
	|	РегистрСведений.ФорумФайлы КАК ФорумФайлы
	|ГДЕ
	|	ФорумФайлы.Объект = &Тема
	|	И ФорумФайлы.Номер = &Номер";
	ТаблицаЗапроса = Запрос.Выполнить().Выгрузить();
	Для Каждого СтрокаТаблицы ИЗ ТаблицаЗапроса Цикл
		МассивСтрок = ЭтаФорма.ФорумФайлы.НайтиСтроки(Новый Структура("ЭтоКартинка, ИмяФайла", СтрокаТаблицы.ЭтоКартинка, СтрокаТаблицы.ИмяФайла));
		Удалять = Ложь;
		Если МассивСтрок = Неопределено Тогда // файла из регистра нет в таблице файлов
			Удалять = Истина;
		Иначе
			Если НЕ МассивСтрок.Количество() Тогда
				Удалять = Истина;
			КонецЕсли;
		КонецЕсли;	
		Если Удалять Тогда
			Запись = РегФорумФайлы.СоздатьМенеджерЗаписи();
			Запись.Объект 		= ЭтотОбъект.Ссылка;
			Запись.ЭтоКартинка 	= СтрокаТаблицы.ЭтоКартинка;
			Запись.ИмяФайла 	= СтрокаТаблицы.ИмяФайла;
			Запись.Номер 		= 0;
			Запись.Прочитать();
			Если Запись.Выбран() Тогда
				Запись.Удалить();
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЦикла;	
		
	Если ТипЗнч(ЭтаФорма.ВладелецФормы) <> Тип("ТабличноеПоле") Тогда
		ЭтаФорма.ВладелецФормы.Тема = Родитель;
		ЭтаФорма.ВладелецФормы.ОбновитьСписокТем(0);
		ЭтаФорма.ВладелецФормы.Активизировать();
	КонецЕсли;	
	
	//
	ЭтаФорма.Закрыть(Истина);
	
КонецПроцедуры

Процедура ОсновныеДействияФормыОсновныеДействияФормыЗакрыть(Кнопка)
	
	ЭтаФорма.Закрыть(Ложь);
	
КонецПроцедуры


Процедура СсылкиНаСообщенияПриПолученииДанных(Элемент, ОформленияСтрок)
	
	
	
КонецПроцедуры

Процедура СсылкиНаСообщенияПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	
	
КонецПроцедуры

Процедура СсылкиНаСообщенияПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)

	
КонецПроцедуры

Процедура СсылкиНаСообщенияПередНачаломИзменения(Элемент, Отказ)
	
	
	
КонецПроцедуры

//+++ AK suvv 19.06.2018 ИП-00018230
Функция ТекущийПользовательАдмин()
	
	Пользователь = Справочники.ФорумПользователи.НайтиПоРеквизиту("Пользователь", ПараметрыСеанса.ТекущийПользователь);
	ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоИмени(Пользователь);
	Если ПользовательИБ <> Неопределено Тогда
		Если ПользовательИБ.Роли.Содержит(Метаданные.Роли["ПолныеПрава"])
			ИЛИ ПользовательИБ.Роли.Содержит(Метаданные.Роли["АК_ФорумАдминистратор"]) Тогда 
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции //--- AK suvv