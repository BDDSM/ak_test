
Процедура ПриОткрытии()
	
	Если НЕ ЭтотОбъект.ЭтоНовый() Тогда
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("СтатьяДДС", ЭтотОбъект.Ссылка);
		Запрос.Текст =
		//+++АК SUVV 2018.02.28 ИП-00017941
		//"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		//|	СоответствияСтатейСчетов.Счет
		//|ИЗ
		//|	РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
		//|ГДЕ
		//|	СоответствияСтатейСчетов.СтатьяДДС = &СтатьяДДС";
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СоответствияСтатейСчетовСрезПоследних.СтатьяДДС,
		|	МАКСИМУМ(СоответствияСтатейСчетовСрезПоследних.Период) КАК МаксПериод
		|ПОМЕСТИТЬ ВТ_МаксПериодПоСтатьеДДС
		|ИЗ
		|	РегистрСведений.СоответствияСтатейСчетов.СрезПоследних(, СтатьяДДС = &СтатьяДДС) КАК СоответствияСтатейСчетовСрезПоследних
		|
		|СГРУППИРОВАТЬ ПО
		|	СоответствияСтатейСчетовСрезПоследних.СтатьяДДС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СоответствияСтатейСчетов.Счет
		|ИЗ
		|	ВТ_МаксПериодПоСтатьеДДС КАК ВТ_МаксПериодПоСтатьеДДС
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствияСтатейСчетов КАК СоответствияСтатейСчетов
		|		ПО ВТ_МаксПериодПоСтатьеДДС.СтатьяДДС = СоответствияСтатейСчетов.СтатьяДДС
		|			И ВТ_МаксПериодПоСтатьеДДС.МаксПериод = СоответствияСтатейСчетов.Период";
		//---АК SUVV
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ЭтаФорма.СчетУчетаПоУмолчаню = Выборка.Счет;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ)
	
	Если НЕ ЗначениеЗаполнено(ЭтаФорма.СчетУчетаПоУмолчаню) Тогда
		ОбщегоНазначения.СообщитьОбОшибке("Не указан счет учета по умолчанию");
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	Набор = РегистрыСведений.СоответствияСтатейСчетов.СоздатьНаборЗаписей();
	Набор.Отбор.СтатьяДДС.Значение 		= ЭтотОбъект.Ссылка;
	Набор.Отбор.СтатьяДДС.Использование = Истина;
	//+++АК SUVV 2018.02.28 ИП-00017941
	Набор.Отбор.Период.Установить(НачалоДня(ТекущаяДата())); //возможно, пользователь должен указать
	//---АК SUVV
	Набор.Прочитать();
	Если Набор.Количество() > 0 Тогда
		Для Каждого Запись Из Набор Цикл
			Запись.Счет = ЭтаФорма.СчетУчетаПоУмолчаню;
		КонецЦикла;
	Иначе
		Запись = Набор.Добавить();
		Запись.СтатьяДДС 	= ЭтотОбъект.Ссылка;
		Запись.Счет 		= ЭтаФорма.СчетУчетаПоУмолчаню;
		//+++АК SUVV 2018.02.28 ИП-00017941
		Запись.Период       = ТекущаяДата(); //возможно, пользователь должен указать
		//---АК SUVV
	КонецЕсли;
	Набор.Записать(Истина);
	
КонецПроцедуры
