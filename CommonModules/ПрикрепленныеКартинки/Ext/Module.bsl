
Процедура ВнестиЗаписьПриложенногоФайла(СтруктураЗаписи) Экспорт
	
	Запись = РегистрыСведений.ПрикрепленныеФотоКОбъектам.СоздатьМенеджерЗаписи();
	ЗаполнитьЗначенияСвойств(Запись, СтруктураЗаписи);
	Если НЕ ЗначениеЗаполнено(Запись.УинЗаписи) Тогда
		Запись.УинЗаписи = Строка(Новый УникальныйИдентификатор());
	КонецЕсли;
	Если Не ЗначениеЗаполнено(Запись.ДатаДобавления) Тогда
		Запись.ДатаДобавления = ТекущаяДата();
	КонецЕсли;	
	Запись.Записать();
	
КонецПроцедуры

Функция ПолучитьПриложенныеКартинкиПоОтбору(СтруктураОтбор) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос();
	Текст = "ВЫБРАТЬ
	        |	ПрикрепленныеФотоКОбъектам.Номенклатура,
	        |	ПрикрепленныеФотоКОбъектам.Характеристика,
	        |	ПрикрепленныеФотоКОбъектам.Объект,
	        |	ПрикрепленныеФотоКОбъектам.ТипЗаписи,
	        |	ПрикрепленныеФотоКОбъектам.УинЗаписи,
	        |	ПрикрепленныеФотоКОбъектам.ОтносительноеИмяФайла,
	        |	ПрикрепленныеФотоКОбъектам.ДатаДобавления,
	        |	ПрикрепленныеФотоКОбъектам.Расширение,
	        |	ПрикрепленныеФотоКОбъектам.ТипОперацииМагазина,
	        |	ПрикрепленныеФотоКОбъектам.СтруктурнаяЕдиница,
	        |	ПрикрепленныеФотоКОбъектам.Текст
	        |ИЗ
	        |	РегистрСведений.ПрикрепленныеФотоКОбъектам КАК ПрикрепленныеФотоКОбъектам
	        |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.КаталогХраненияФайлов КАК КаталогХраненияФайлов
	        |		ПО (ИСТИНА)
	        |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.КаталогХраненияФайловКартинок КАК КаталогХраненияФайловКартинок
	        |		ПО (ИСТИНА)
	        |ГДЕ
	        |	ПрикрепленныеФотоКОбъектам.ВАрхиве = ЛОЖЬ";
				   
	Если СтруктураОтбор.Свойство("Номенклатура") Тогда
		Если ТипЗнч(СтруктураОтбор.Номенклатура) = Тип("Массив") Тогда
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.Номенклатура В (&Номенклатура)";
		Иначе
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.Номенклатура = &Номенклатура";
		КонецЕсли;
		Запрос.УстановитьПараметр("Номенклатура", СтруктураОтбор.Номенклатура);
	КонецЕсли;
	
	Если СтруктураОтбор.Свойство("Характеристика") Тогда
		Если ТипЗнч(СтруктураОтбор.Характеристика) = Тип("Массив") Тогда
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.Характеристика В (&Характеристика)";
		Иначе
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.Характеристика = &Характеристика";
		КонецЕсли;
		Запрос.УстановитьПараметр("Характеристика", СтруктураОтбор.Характеристика);
	КонецЕсли;
	
	Если СтруктураОтбор.Свойство("ТипЗаписи") Тогда
		Если ТипЗнч(СтруктураОтбор.ТипЗаписи) = Тип("Массив") Тогда
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.ТипЗаписи В (&ТипЗаписи)";
		Иначе
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.ТипЗаписи = &ТипЗаписи";
		КонецЕсли;
		Запрос.УстановитьПараметр("ТипЗаписи", СтруктураОтбор.ТипЗаписи);
	КонецЕсли;
	
	Если СтруктураОтбор.Свойство("Объект") Тогда
		Если ТипЗнч(СтруктураОтбор.Объект) = Тип("Массив") Тогда
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.ТипЗаписи В (&Объект)";
		Иначе
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.ТипЗаписи = &Объект";
		КонецЕсли;
		Запрос.УстановитьПараметр("Объект", СтруктураОтбор.Объект);
	КонецЕсли;
	
	Если СтруктураОтбор.Свойство("СтруктурнаяЕдиница") Тогда
		Если ТипЗнч(СтруктураОтбор.СтруктурнаяЕдиница) = Тип("Массив") Тогда
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.СтруктурнаяЕдиница В (&СтруктурнаяЕдиница)";
		Иначе
			Текст = Текст + Символы.ПС + "И ПрикрепленныеФотоКОбъектам.СтруктурнаяЕдиница = &СтруктурнаяЕдиница";
		КонецЕсли;
		Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктураОтбор.СтруктурнаяЕдиница);
	КонецЕсли;
	
	Запрос.Текст = Текст;
	
	КаталогФайловКартинок = Константы.КаталогХраненияФайловКартинок.Получить();
	Если Прав(КаталогФайловКартинок, 1) <> "\" Тогда
		КаталогФайловКартинок = КаталогФайловКартинок + "\";
	КонецЕсли;	
	КаталогФайлов = Константы.КаталогХраненияФайлов.Получить();
	Если Прав(КаталогФайлов, 1) <> "\" Тогда
		КаталогФайлов = КаталогФайлов + "\";
	КонецЕсли;
	МП_КаталогФайлов = Константы.МП_КаталогХраненияФайловЗадачМП.Получить();
	Если Прав(МП_КаталогФайлов, 1) <> "\" Тогда
		МП_КаталогФайлов = МП_КаталогФайлов + "\";
	КонецЕсли;
	ТабКВозврату = Запрос.Выполнить().Выгрузить();
	ТабКВозврату.Колонки.Добавить("ПолноеИмяФайла");
	Для Каждого СтрокаТаб Из ТабКВозврату Цикл
		Если СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.Сертификат Тогда
			СтрокаТаб.ПолноеИмяФайла = КаталогФайловКартинок + "Сертификаты\" + СтрокаТаб.ОтносительноеИмяФайла;
		ИначеЕсли СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.ГостТУ
			ИЛИ СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.ПроверкаКачестваТоваров Тогда
			СтрокаТаб.ПолноеИмяФайла = КаталогФайлов + СтрокаТаб.ОтносительноеИмяФайла;	
		ИначеЕсли СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.КартинкаДляСайта
			ИЛИ СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.СписаниеНаМагазине
			ИЛИ СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.ИнвентаризацияУпаковки Тогда
			СтрокаТаб.ПолноеИмяФайла = КаталогФайловКартинок + СтрокаТаб.ОтносительноеИмяФайла;
		ИначеЕсли СтрокаТаб.ТипЗаписи = Перечисления.ТипыЗаписейПриложенныхКартинок.МакетЭтикетки Тогда
			СтрокаТаб.ПолноеИмяФайла = КаталогФайловКартинок + СтрокаТаб.ОтносительноеИмяФайла;	
		КонецЕсли;	
	КонецЦикла;	
	
	Возврат ТабКВозврату;
	
КонецФункции	