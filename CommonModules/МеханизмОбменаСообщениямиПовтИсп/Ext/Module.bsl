
Функция ПолучитьРолиПользователяИлиФизЛица(Пользователь_ФизЛицо) Экспорт

	Если ТипЗнч(Пользователь_ФизЛицо) = Тип("СправочникСсылка.ФизическиеЛица") Тогда
		ФизЛицо = Пользователь_ФизЛицо;
	ИначеЕсли ТипЗнч(Пользователь_ФизЛицо) = Тип("СправочникСсылка.Пользователи") Тогда
		ФизЛицо = Пользователь_ФизЛицо.ФизЛицо;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	МСРез = Новый Массив;
	
	Запрос1 = Новый Запрос;
	Запрос1.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РолиПользователейСоставРоли.Ссылка
	|ИЗ
	|	Справочник.РолиПользователей.СоставРоли КАК РолиПользователейСоставРоли
	|ГДЕ
	|	РолиПользователейСоставРоли.Ссылка.ПометкаУдаления = ЛОЖЬ
	|	И РолиПользователейСоставРоли.Сотрудник = &Сотрудник";
	
	Запрос1.УстановитьПараметр("Сотрудник", ФизЛицо);
	
	Рез1 = Запрос1.Выполнить();
	Выб1 = Рез1.Выбрать();
	
	Пока Выб1.Следующий() Цикл
		МСРез.Добавить(Выб1.Ссылка);
	КонецЦикла;
	
	Возврат МСРез;

КонецФункции // ()


Функция ПолучитьСоединениеСБДSQL(ИмяБазы) Экспорт

	СоединениеСБазойSQL = Новый COMОбъект("ADODB.Connection");
	СоединениеСБазойSQL.ConnectionTimeOut = 0;
	СоединениеСБазойSQL.CommandTimeOut    = 0;
	СтрСоединение = ПолучитьСтрокуСоединения(ИмяБазы);
	СоединениеСБазойSQL.ConnectionString  = СтрСоединение;
	Попытка
		СоединениеСБазойSQL.Open();
	Исключение
		СоединениеСБазойSQL = Неопределено;
		Сообщить("Не удалось открыть базу данных SQL. Работа с сообщениями невозможна.");
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат СоединениеСБазойSQL;
	
КонецФункции // ()

Функция ПолучитьСтрокуСоединения(ИмяБазы)

	СтрСоединения = ВнешниеДанные.ПолучитьСтрокуСоединенияSQL("SQL Server","10.0.0.40",ИмяБазы,,,"LANGUAGE=русский; OLE DB Services=-2;");
	Возврат СтрСоединения;
	
КонецФункции

Функция стар_ПолучитьТЗСмен(Дата1 = Неопределено) Экспорт
	
	Если Дата1 = Неопределено Тогда
		Дата1 = Обработки.СообщенияМОС.ПолучитьРабочуюДатуМОС();
	КонецЕсли;
	
	ОТЧисло = Новый ОписаниеТипов("Число");
	ОТДата = Новый ОписаниеТипов("Дата");
	ОТБулево = Новый ОписаниеТипов("Булево");
	ОТСтрока = Новый ОписаниеТипов("Строка");
	
	ТЗСмен = Новый ТаблицаЗначений();
	ТЗСмен.Колонки.Добавить("НомерМагазина", ОТЧисло);
	ТЗСмен.Колонки.Добавить("ИмяМагазина", ОТСтрока);
	ТЗСмен.Колонки.Добавить("КодФизЛица", ОТЧисло);
	ТЗСмен.Колонки.Добавить("ДатаСмены", ОТДата);
	ТЗСмен.Колонки.Добавить("ЭтоСтаршийСмены", ОТБулево);
	
	СоединениеСБДSQL = МеханизмОбменаСообщениямиПовтИсп.ПолучитьСоединениеСБДSQL("IzbenkaFin");
	
	ДатаДляSQL = "'" + Строка(НачалоДня(Дата1)) + "'";
	
	//ТекстЗапросаSQL = "SELECT distinct SDN.ShopNo
	//|,dateadd(year,-2000,ZapisiRegistra._Period) Period
	// |,FizLica._Code CodeFL, TT._Description NameTT
	// |,CASE WHEN ZapisiRegistra._Fld4374 = 2 THEN 1 ELSE 0 END Senior
	//|  FROM [IzbenkaFin].[dbo].[_InfoRg2389] AS ZapisiRegistra (nolock)
	//|  inner JOIN [IzbenkaFin].[dbo].[_Reference39] AS FizLica (nolock)
	//|     ON ZapisiRegistra._Fld2390RRef = FizLica._IDRRef
	//|  inner JOIN [IzbenkaFin].[dbo].[_Reference42] AS TT (nolock)
	//|     ON ZapisiRegistra._Fld2391RRef = TT._IDRRef
	//|  inner join M2..tt tt_m2 on TT._Fld758=tt_m2.id_TT 
	//|  INNER JOIN SMS_UNION..ShopDataBaseName SDN ON SDN.ID_TT = tt._Fld758
	//|where tt_m2.tt_format=2
	//|and dateadd(year,-2000,ZapisiRegistra._Period) = " + ДатаДляSQL;
	
	ТекстЗапросаSQL = "SELECT distinct tt_m2.N ShopNo
	|,dateadd(year,-2000,ZapisiRegistra._Period) Period
 	|,FizLica._Code CodeFL, TT._Description NameTT
 	|,CASE WHEN ZapisiRegistra._Fld4374 = 2 THEN 1 ELSE 0 END Senior
	|  FROM [IzbenkaFin].[dbo].[_InfoRg2389] AS ZapisiRegistra (nolock)
	|  inner JOIN [IzbenkaFin].[dbo].[_Reference39] AS FizLica (nolock)
	|     ON ZapisiRegistra._Fld2390RRef = FizLica._IDRRef
	|  inner JOIN [IzbenkaFin].[dbo].[_Reference42] AS TT (nolock)
	|     ON ZapisiRegistra._Fld2391RRef = TT._IDRRef
	|  inner join M2..tt tt_m2 on TT._Fld758=tt_m2.id_TT 
	|where tt_m2.tt_format=2
	|and dateadd(year,-2000,ZapisiRegistra._Period) = " + ДатаДляSQL;
	
	ResultQuery = СоединениеСБДSQL.Execute(ТекстЗапросаSQL);
	
	Пока НЕ ResultQuery.EOF() Цикл
		СтрокаТЗС = ТЗСмен.Добавить();
		СтрокаТЗС.НомерМагазина = ResultQuery.Fields("ShopNo").Value;
		Если МеханизмОбменаСообщениямиПовтИсп.ЭтоТестовыйРежимМОС() Тогда
			Если СтрокаТЗС.НомерМагазина = 191 Тогда
				СтрокаТЗС.НомерМагазина = 99999;
			КонецЕсли;
		КонецЕсли;
		СтрокаТЗС.ИмяМагазина = ResultQuery.Fields("NameTT").Value;
		СтрокаТЗС.КодФизЛица = ResultQuery.Fields("CodeFL").Value;
		СтрокаТЗС.ДатаСмены = ResultQuery.Fields("Period").Value;
		Сеньор = ResultQuery.Fields("Senior").Value;
		Если Сеньор = 1 Тогда
			СтрокаТЗС.ЭтоСтаршийСмены = Истина;
		КонецЕсли;
		ResultQuery.MoveNext();
	КонецЦикла;
	
	Возврат ТЗСмен;
	
КонецФункции // ()

Функция ПолучитьТЗКоличестваМагазиновRecipients() Экспорт

	ТЗРез = Новый ТаблицаЗначений;
	ОТЧисло = Новый ОписаниеТипов("Число");
	ТЗРез.Колонки.Добавить("ИДСообщения",ОТЧисло);
	ТЗРез.Колонки.Добавить("КолВоТТ",ОТЧисло);
	
	СоединениеСБДSQL = МеханизмОбменаСообщениямиПовтИсп.ПолучитьСоединениеСБДSQL("SMS_REPL");
	
	ТекстКомандыSQL = "
	|SELECT COUNT(ShopNo) AS CountTT, IDMes
	|FROM   info_exch_Recipients
	|GROUP BY IDMes";
	
	ResultQuery = СоединениеСБДSQL.Execute(ТекстКомандыSQL);
	Пока НЕ ResultQuery.EOF() Цикл
		СтрокаТЗРез = ТЗРез.Добавить();
		СтрокаТЗРез.ИДСообщения = ResultQuery.Fields("IDMes").Value;
		СтрокаТЗРез.КолВоТТ = ResultQuery.Fields("CountTT").Value;
		ResultQuery.MoveNext();
	КонецЦикла;
	
	Возврат ТЗРез;
	
КонецФункции // ()

Функция ПолучитьСписокПодразделений(ИмяСписка) Экспорт
	
	СЗ1 = Новый СписокЗначений;
	
	СоединениеСБДSQLM2 = МеханизмОбменаСообщениямиПовтИсп.ПолучитьСоединениеСБДSQL("M2");
	Условие1 = "";
	Если ИмяСписка = "Магазины" Тогда
		Условие1 = "tt_format = 2";
	ИначеЕсли ИмяСписка = "Все" Тогда
		//Условие1 = "is_active = 1";
		Условие1 = "1 = 1"; // вечно истинное условие
	КонецЕсли;
	
	
	ТекстКомандыSQL = "
	|SELECT N,
	|	name_tt,
	|	tt_format
	|FROM M2.dbo.tt as tt (nolock)
	|WHERE " + Условие1 + "
	|ORDER BY name_tt ASC
	|";
	ResultQuery = СоединениеСБДSQLM2.Execute(ТекстКомандыSQL);
	Пока НЕ ResultQuery.eof() Цикл
		//ИдТТ = Формат(ResultQuery.Fields("N").Value, "ЧГ=0");
		ИдТТ = ResultQuery.Fields("N").Value;
		ИмяТТ = СокрЛП(ResultQuery.Fields("name_tt").Value);
		Если МеханизмОбменаСообщениямиПовтИсп.ЭтоТестовыйРежимМОС() Тогда
			// подмена 191-го на 99999 для тестирования
			Если ИдТТ = 191 Тогда
				ИдТТ = 99999;
			КонецЕсли;
		КонецЕсли;
		СЗ1.Добавить(ИдТТ, ИмяТТ);
		ResultQuery.MoveNext();
	КонецЦикла;
	Возврат СЗ1;
	
КонецФункции // ()

Функция ЭтоТестовыйРежимМОС() Экспорт

	Возврат Истина;

КонецФункции // ()
